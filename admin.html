<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Painel Admin â€” Zion Lisboa</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/tokens.css">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/components.css">
    <script src="config.js"></script>
    <script src="auth.js"></script>
</head>
<body>
<div class="page-wrapper">
    <div class="banner">
        <img src="banner%20zion.jpg" alt="Zion Lisboa" onerror="this.onerror=null;this.style.display='none';document.querySelector('.banner-fallback').classList.add('show');">
        <div class="banner-fallback"><div class="banner-title">ZION</div><div class="banner-sub">Lisboa Â· Portugal</div></div>
    </div>
    <div class="gold-line"></div>
    <div class="user-bar">
        <a href="index.html" class="user-bar-back">&#8592; Inicio</a>
        <div class="user-bar-center">
            <div class="user-bar-section" id="secao-label">Cadastros</div>
            <div class="user-bar-date" id="data-hoje"></div>
        </div>
        <div class="user-bar-right">
            <div class="user-bar-nome" id="top-user"></div>
            <button class="logout-btn" onclick="ZionAuth.logout()">Sair</button>
        </div>
    </div>

    <!-- Nav -->
    <div class="nav-bar" id="nav-bar">
        <div class="nav-item active" onclick="setSecao('membros')">Membros</div>
        <div class="nav-item" onclick="setSecao('pastores')">Pastores</div>
        <div class="nav-item" onclick="setSecao('links')">Links</div>
        <div class="nav-item" onclick="setSecao('cultos')">Cultos</div>
        <div class="nav-item" onclick="setSecao('ministerios')">Ministerios</div>
        <div class="nav-item" onclick="setSecao('salas')">Salas</div>
        <div class="nav-item" onclick="setSecao('cursos')">Cursos ZAO</div>
        <div class="nav-item" onclick="setSecao('keola')">Keola</div>
        <div class="nav-item" onclick="setSecao('loja')">Loja</div>
        <div class="nav-item" onclick="setSecao('eventos')">Eventos</div>
    </div>

    <!-- Content -->
    <div class="content" id="main-content">
        <div class="loading"><div class="spin"></div>A verificar acesso...</div>
    </div>
    <div class="footer">
        <div class="footer-links">
            <a class="footer-link" href="https://zionchurch.org.br/" target="_blank"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="12" height="12"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>Site Oficial</a>
            <a class="footer-link" href="https://www.instagram.com/zionlisboa/" target="_blank"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="12" height="12"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"/></svg>@ZionLisboa</a>
        </div>
        <div class="footer-div"></div>
        <div class="footer-copy">2026 Zion Lisboa â€” Todos os direitos reservados</div>
        <div class="footer-addr">Rua do Centro Cultural, 11 Â· 1700-036 Alvalade Â· Lisboa, Portugal</div>
    </div>
</div>

<!-- Drawer / Modal de form -->
<div class="overlay hidden" id="overlay" onclick="closeDrawerOutside(event)">
    <div class="drawer" id="drawer">
        <div class="drawer-head">
            <div class="drawer-title" id="drawer-title">Novo Registo</div>
            <button class="drawer-x" onclick="closeDrawer()">x</button>
        </div>
        <div class="drawer-body" id="drawer-body">
        </div>
    </div>
</div>

<script>
    ZionAuth.protect();
    const currentUser = ZionAuth.getUser();
    const SUPA_URL    = window.SUPABASE_URL || '';
    const SUPA_KEY    = window.SUPABASE_ANON_KEY || '';

    let secaoAtiva  = 'pastores';
    let subTabAtiva = 0;
    let registos    = [];
    let filtroInativo = false;
    let membros     = [];
    let links_cache       = [];
    let ministeriosCache  = [];

    // â”€â”€ SUPABASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function sb(path, opts = {}) {
        const r = await fetch(`${SUPA_URL}/rest/v1/${path}`, {
            ...opts,
            headers:{
                'apikey':SUPA_KEY,'Authorization':`Bearer ${SUPA_KEY}`,
                'Content-Type':'application/json','Prefer':'return=representation',
                ...opts.headers
            }
        });
        if (!r.ok) { const e = await r.json().catch(()=>{}); throw e; }
        const txt = await r.text();
        return txt ? JSON.parse(txt) : [];
    }

    // â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function init() {
        document.getElementById('top-user').textContent = currentUser.nome?.split(' ')[0] || '';
        const hoje = new Date().toLocaleDateString('pt-PT',{weekday:'long',day:'numeric',month:'long'});
        document.getElementById('data-hoje').textContent = hoje.charAt(0).toUpperCase()+hoje.slice(1);

        const check = await sb(`membros?select=e_admin,e_presbitero&email=eq.${encodeURIComponent(currentUser.email)}&ativo=eq.true`);
        const m = check?.[0];
        if (!m || (!m.e_admin && !m.e_presbitero)) {
            document.getElementById('nav-bar').style.display = 'none';
            document.getElementById('main-content').innerHTML = `
      <div class="acesso-negado">
        <div class="acesso-negado-icon">ğŸ”’</div>
        <div class="acesso-negado-title">Acesso Restrito</div>
        <div class="acesso-negado-txt">Esta area e exclusiva para Administradores e Presbiteros.</div>
      </div>`;
            return;
        }

        membros = await sb('membros?select=id,nome&ativo=eq.true&order=nome') || [];
        await setSecao('membros');
    }

    // â”€â”€ SECOES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function setSecao(secao) {
        secaoAtiva    = secao;
        filtroInativo = false;
        subTabAtiva   = 0;

        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        const secaoNomes = {membros:'Cadastro de Membros',pastores:'Cadastro de Pastores',links:'Cadastro de Links',cultos:'Cadastro dos Cultos',ministerios:'Cadastro de Ministerio',salas:'Cadastro de Salas',cursos:'Cadastro de Cursos ZAO',keola:'Cadastro do Keola',loja:'Cadastro da Loja',eventos:'Cadastro de Eventos'};
        const sl = document.getElementById('secao-label');
        if(sl) sl.textContent = secaoNomes[secao]||'Cadastros';
        const idx = ['membros','pastores','links','cultos','ministerios','salas','cursos','keola','loja','eventos'];
        const ni  = document.querySelectorAll('.nav-item')[idx.indexOf(secao)];
        if (ni) ni.classList.add('active');

        await carregarSecao();
    }

    async function carregarSecao() {
        document.getElementById('main-content').innerHTML = '<div class="loading"><div class="spin"></div>A carregar...</div>';
        const cfg = SECOES[secaoAtiva];
        if (secaoAtiva === 'eventos') {
            eventosData  = await sb('eventos?select=*&order=data_inicio') || [];
            eventoAtivo  = null;
            eventoSubTab = 0;
            renderEventos();
            return;
        }
        registos  = await sb(`${cfg.tabela}?select=*&order=${cfg.orderBy||'nome'}`) || [];
        if (secaoAtiva === 'membros') {
            if (!links_cache.length) links_cache = await sb('links?select=id,nome&ativo=eq.true&order=nome') || [];
            await carregarVisitantes();
        }
        renderSecao();
    }

    // â”€â”€ CONFIG DAS SECOES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const SECOES = {
        membros:     { tabela:'membros',     label:'Cadastro de Membros',               orderBy:'nome', campos: camposMembros, subTabs:['Membro','Filhos','Visitantes'] },
        pastores:    { tabela:'pastores',    label:'Cadastro de Pastores',              orderBy:'nome', campos: camposPastores },
        links:       { tabela:'links',       label:'Cadastro de Links',                 orderBy:'nome', campos: camposLinks },
        cultos:      { tabela:'cultos',      label:'Cadastro dos Cultos',               orderBy:'nome', campos: camposCultos },
        ministerios: { tabela:'ministerios', label:'Cadastro de Ministerio',            orderBy:'nome', campos: camposMinisterios, subTabs:['Ministerio','Lideres'] },
        salas:       { tabela:'salas',       label:'Cadastro de Salas',                 orderBy:'nome', campos: camposSalas },
        cursos:      { tabela:'zao_cursos',  label:'Cadastro de Cursos ZAO',            orderBy:'nome', campos: camposCursos, subTabs:['Curso','Instrutores'] },
        keola:       { tabela:'keola_menu',  label:'Cadastro de Produtos do Keola',     orderBy:'categoria,nome', campos: camposKeola, ativoKey:'disponivel' },
        loja:        { tabela:'loja_produtos',label:'Cadastro de Produtos da Loja',     orderBy:'categoria,nome', campos: camposLoja },
        eventos:     { tabela:'eventos',      label:'Cadastro de Eventos',               orderBy:'data_inicio',    campos: camposEventos, customRender: true },
    };

    // â”€â”€ RENDER SECAO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderSecao() {
        const cfg      = SECOES[secaoAtiva];
        if (cfg.customRender && secaoAtiva === 'eventos') { renderEventos(); return; }
        const ativoKey = cfg.ativoKey || 'ativo';
        const temSubTabs = !!cfg.subTabs;
        const q        = document.querySelector('.toolbar-search')?.value?.toLowerCase() || '';

        let lista = [...registos];
        if (!filtroInativo) lista = lista.filter(r => r[ativoKey] !== false);
        else lista = lista.filter(r => r[ativoKey] === false);
        if (q) lista = lista.filter(r => (r.nome||r.categoria||'').toLowerCase().includes(q));

        let html = `
    <div class="section-toolbar" style="top:0">
      <input class="toolbar-search" placeholder="Pesquisar..." oninput="renderSecao()">
      <button class="toolbar-filter ${filtroInativo?'active':''}" onclick="toggleFiltroInativo()">Inativos</button>
      <button class="btn-new" onclick="abrirForm(null)">+ Novo</button>
    </div>`;

        if (temSubTabs && subTabAtiva >= 1) {
            if (secaoAtiva === 'membros' && subTabAtiva === 1) {
                const cfg2 = SECOES['membros'];
                html += `<div class="sub-tabs">${cfg2.subTabs.map((t,i)=>`<button class="sub-tab ${subTabAtiva===i?'active':''}" onclick="setSubTab(${i})">${t}</button>`).join('')}</div>`;
                html += `<div class="admin-list"><div style="background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-md);padding:20px;text-align:center;color:var(--text-faint);font-size:13px;line-height:1.8">Para gerir os filhos de um membro, abre o registo do membro e edita a partir dai.</div></div>`;
                document.getElementById('main-content').innerHTML = html;
                return;
            }
            if (secaoAtiva === 'membros' && subTabAtiva === 2) {
                html += renderSubTabLideres();
                document.getElementById('main-content').innerHTML = html;
                return;
            }
            if (secaoAtiva !== 'membros' && subTabAtiva === 1) {
                html += renderSubTabLideres();
                document.getElementById('main-content').innerHTML = html;
                return;
            }
        }

        if (temSubTabs) {
            html += `<div class="sub-tabs">
      ${cfg.subTabs.map((t,i)=>`<button class="sub-tab ${subTabAtiva===i?'active':''}" onclick="setSubTab(${i})">${t}</button>`).join('')}
    </div>`;
        }

        if (lista.length === 0) {
            html += `<div class="empty"><div class="empty-icon">ğŸ“­</div><div class="empty-txt">${filtroInativo?'Nenhum registo inativo.':'Nenhum registo. Clica em Novo.'}</div></div>`;
            document.getElementById('main-content').innerHTML = html;
            return;
        }

        html += '<div class="admin-list">';
        lista.forEach((r, i) => {
            const ativo    = r[ativoKey] !== false;
            const fotoHtml = r.foto_url || r.imagem_url
                ? `<div class="admin-row-foto"><img src="${r.foto_url||r.imagem_url}" alt="${r.nome}"></div>`
                : `<div class="admin-row-foto">${(r.nome||r.categoria||'-')[0]}</div>`;

            const sub = buildSub(r);
            const badges = buildBadges(r);

            html += `
      <div class="admin-row ${ativo?'':'inativo'}" style="animation-delay:${Math.min(i,12)*0.02}s">
        ${fotoHtml}
        <div class="admin-row-info">
          <div class="admin-row-nome">${r.nome||r.categoria||'-'}</div>
          ${sub ? `<div class="admin-row-sub">${sub}</div>` : ''}
          ${badges ? `<div class="admin-row-badges">${badges}</div>` : ''}
        </div>
        <div class="admin-row-actions">
          <button class="btn-edit" onclick="abrirForm('${r.id}')">Editar</button>
          <button class="btn-toggle ${ativo?'ativo':'inativo'}" onclick="toggleAtivo('${r.id}','${ativoKey}',${ativo})">${ativo?'Inativar':'Ativar'}</button>
        </div>
      </div>`;
        });
        html += '</div>';
        document.getElementById('main-content').innerHTML = html;
    }

    function buildSub(r) {
        const s = secaoAtiva;
        if (s==='membros')     return [r.tipo,r.zona,r.genero].filter(Boolean).join(' Â· ');
        if (s==='pastores')    return [r.cargo,r.email].filter(Boolean).join(' â€” ');
        if (s==='links')       return [r.tipo,r.zona,r.dia].filter(Boolean).join(' Â· ');
        if (s==='cultos')      return [r.dia_semana,r.hora_inicio].filter(Boolean).join(' â€” ');
        if (s==='ministerios') return [r.tipo?'['+r.tipo+']':null, r.descricao?.substring(0,50)].filter(Boolean).join(' â€” ');
        if (s==='salas')       return [r.espaco,r.capacidade?r.capacidade+' pessoas':null].filter(Boolean).join(' Â· ');
        if (s==='cursos')      return [r.carga_horaria,r.gratuito?'Gratuito':r.valor?'â‚¬'+r.valor:null].filter(Boolean).join(' Â· ');
        if (s==='keola')       return [r.categoria,r.preco?'â‚¬'+Number(r.preco).toFixed(2):null].filter(Boolean).join(' Â· ');
        if (s==='loja')        return [r.categoria,r.preco?'â‚¬'+Number(r.preco).toFixed(2):null].filter(Boolean).join(' Â· ');
        return '';
    }

    function buildBadges(r) {
        const badges = [];
        if (r.e_lider)       badges.push(`<span class="badge badge-primary">Lider</span>`);
        if (r.e_presbitero)  badges.push(`<span class="badge badge-primary">Presbitero</span>`);
        if (r.e_voluntario)  badges.push(`<span class="badge badge-green">Voluntario</span>`);
        if (r.e_admin)       badges.push(`<span class="badge badge-red">Admin</span>`);
        if (r.online)        badges.push(`<span class="badge badge-primary">Online</span>`);
        if (r.recorrente)    badges.push(`<span class="badge badge-green">Recorrente</span>`);
        if (r.gratuito)      badges.push(`<span class="badge badge-green">Gratuito</span>`);
        if (r.especial_hoje) badges.push(`<span class="badge badge-primary">Especial hoje</span>`);
        if (r.destaque)      badges.push(`<span class="badge badge-primary">Destaque</span>`);
        if (r.disponivel===false || r.ativo===false) badges.push(`<span class="badge badge-gray">Inativo</span>`);
        return badges.join('');
    }

    function toggleFiltroInativo() { filtroInativo = !filtroInativo; renderSecao(); }
    function setSubTab(idx) { subTabAtiva = idx; renderSecao(); }

    // â”€â”€ SUB-TAB LIDERES / INSTRUTORES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderSubTabLideres() {
        const cfg = SECOES[secaoAtiva];
        if (secaoAtiva === 'membros' && subTabAtiva === 2) return renderVisitantes();
        const isMin   = secaoAtiva === 'ministerios';
        const label   = isMin ? 'Lideres' : 'Instrutores';
        const parentLabel = isMin ? 'Ministerio' : 'Curso';
        return `
    <div class="sub-tabs">
      ${cfg.subTabs.map((t,i)=>`<button class="sub-tab ${subTabAtiva===i?'active':''}" onclick="setSubTab(${i})">${t}</button>`).join('')}
    </div>
    <div class="admin-list">
      <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-md);padding:16px;text-align:center;color:var(--text-faint);font-size:13px;line-height:1.7">
        Para gerir ${label.toLowerCase()}, abre o registo do ${parentLabel.toLowerCase()} e edita a partir dai.
      </div>
    </div>`;
    }

    // â”€â”€ VISITANTES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let visitantes = [];
    async function carregarVisitantes() {
        visitantes = await sb('visitantes?select=*&order=nome') || [];
    }

    function renderVisitantes() {
        const cfg = SECOES['membros'];
        const q   = document.querySelector('.toolbar-search')?.value?.toLowerCase() || '';
        let lista = [...visitantes];
        if (!filtroInativo) lista = lista.filter(r => r.ativo !== false && !r.convertido);
        else lista = lista.filter(r => r.convertido || r.ativo === false);
        if (q) lista = lista.filter(r => (r.nome||'').toLowerCase().includes(q));

        let html = `
    <div class="sub-tabs">
      ${cfg.subTabs.map((t,i)=>`<button class="sub-tab ${subTabAtiva===i?'active':''}" onclick="setSubTab(${i})">${t}</button>`).join('')}
    </div>
    <div class="section-toolbar" style="top:0">
      <input class="toolbar-search" placeholder="Pesquisar visitante..." oninput="renderSecao()">
      <button class="toolbar-filter ${filtroInativo?'active':''}" onclick="toggleFiltroInativo()">${filtroInativo?'Ativos':'Convertidos'}</button>
      <button class="btn-new" onclick="abrirFormVisitante(null)">+ Novo</button>
    </div>`;

        if (lista.length === 0) {
            html += '<div class="empty"><div class="empty-icon">ğŸ™‹</div><div class="empty-txt">Nenhum visitante encontrado.</div></div>';
            return html;
        }

        html += '<div class="admin-list">';
        lista.forEach((v, i) => {
            const ativo = v.ativo !== false;
            const conv  = v.convertido ? '<span class="badge badge-green">Convertido</span>' : '';
            html += `
      <div class="admin-row ${ativo?'':'inativo'}" style="animation-delay:${Math.min(i,12)*0.02}s">
        <div class="admin-row-foto">${(v.nome||'V')[0]}</div>
        <div class="admin-row-info">
          <div class="admin-row-nome">${v.nome||'â€”'}</div>
          <div class="admin-row-sub">${[v.zona,v.data_visita?new Date(v.data_visita).toLocaleDateString('pt-PT'):null].filter(Boolean).join(' Â· ')}</div>
          <div class="admin-row-badges">${conv}</div>
        </div>
        <div class="admin-row-actions">
          <button class="btn-edit" onclick="abrirFormVisitante('${v.id}')">Editar</button>
          ${!v.convertido ? `<button class="btn-toggle ativo" onclick="converterEmMembro('${v.id}')">Converter</button>` : ''}
          <button class="btn-toggle ${ativo?'ativo':'inativo'}" onclick="toggleAtivoVisitante('${v.id}',${ativo})">${ativo?'Inativar':'Ativar'}</button>
        </div>
      </div>`;
        });
        html += '</div>';
        return html;
    }

    function abrirFormVisitante(id) {
        const v = id ? visitantes.find(x=>x.id===id) : null;
        document.getElementById('drawer-title').textContent = v ? 'Editar Visitante' : 'Novo Visitante';
        document.getElementById('drawer-body').innerHTML = buildFormVisitante(v);
        document.getElementById('overlay').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function buildFormVisitante(v) {
        const fv = (key,def='') => v?.[key] ?? def;
        return `<div class="form-grid">
    <div class="msg-form" id="form-msg"></div>
    <div class="form-group form-full"><label class="form-label">Nome</label><input class="form-input" id="fv_nome" type="text" placeholder="Nome completo" value="${fv('nome')}"></div>
    <div class="form-group"><label class="form-label">Email</label><input class="form-input" id="fv_email" type="email" placeholder="email@exemplo.com" value="${fv('email')}"></div>
    <div class="form-group"><label class="form-label">Telefone</label><input class="form-input" id="fv_telefone" type="tel" placeholder="+351 9XX XXX XXX" value="${fv('telefone')}"></div>
    <div class="form-group"><label class="form-label">Zona</label><input class="form-input" id="fv_zona" type="text" placeholder="Ex: Lisboa" value="${fv('zona')}"></div>
    <div class="form-group"><label class="form-label">Data da Visita</label><input class="form-input" id="fv_data_visita" type="date" value="${fv('data_visita')}"></div>
    <div class="form-group form-full"><label class="form-label">Onde Conheceu</label><input class="form-input" id="fv_onde_conheceu" type="text" placeholder="Como soube da igreja?" value="${fv('onde_conheceu')}"></div>
    <div class="form-group form-full"><label class="form-label">Observacoes</label><textarea class="form-textarea" id="fv_observacoes" placeholder="Notas sobre o visitante...">${fv('observacoes')}</textarea></div>
    <div class="form-group"><label class="form-toggle"><input type="checkbox" id="fv_convertido" ${fv('convertido')?'checked':''}><span>Convertido</span></label></div>
    <div class="form-group"><label class="form-toggle"><input type="checkbox" id="fv_ativo" ${fv('ativo')!==false?'checked':''}><span>Ativo</span></label></div>
    <div class="form-actions">
      <button class="btn-cancel-form" onclick="closeDrawer()">Cancelar</button>
      <button class="btn-save" id="btn-save" onclick="salvarVisitante('${v?.id||''}')">Guardar</button>
    </div>
  </div>`;
    }

    async function salvarVisitante(id) {
        const get = k => { const el=document.getElementById('fv_'+k); return el ? el.value||null : null; };
        const chk = k => { const el=document.getElementById('fv_'+k); return el ? el.checked : false; };
        const body = {
            nome: get('nome'), email: get('email'), telefone: get('telefone'),
            zona: get('zona'), data_visita: get('data_visita'), onde_conheceu: get('onde_conheceu'),
            observacoes: get('observacoes'), convertido: chk('convertido'), ativo: chk('ativo'),
        };
        if (!body.nome) { showFormMsg('Nome obrigatorio.','error'); return; }
        const btn = document.getElementById('btn-save');
        btn.disabled=true; btn.textContent='A guardar...';
        try {
            if (!id) await sb('visitantes', {method:'POST', body:JSON.stringify(body)});
            else await sb(`visitantes?id=eq.${id}`, {method:'PATCH', body:JSON.stringify(body)});
            showFormMsg('Guardado!','success');
            await carregarVisitantes();
            setTimeout(closeDrawer, 700);
        } catch(e) {
            showFormMsg(`Erro: ${e?.message||JSON.stringify(e)}`, 'error');
            btn.disabled=false; btn.textContent='Guardar';
        }
    }

    async function toggleAtivoVisitante(id, ativoAtual) {
        await sb(`visitantes?id=eq.${id}`, {method:'PATCH', body:JSON.stringify({ativo:!ativoAtual})});
        await carregarVisitantes();
        renderSecao();
    }

    async function converterEmMembro(visitanteId) {
        if (!confirm('Converter este visitante em membro?')) return;
        const v = visitantes.find(x=>x.id===visitanteId);
        if (!v) return;
        try {
            const novoMembro = await sb('membros', {method:'POST', body:JSON.stringify({
                    nome: v.nome, email: v.email, telefone: v.telefone,
                    zona: v.zona, onde_conheceu: v.onde_conheceu,
                    tipo: 'membro', ativo: true,
                    convertido_de_visitante_id: visitanteId,
                    data_entrada: new Date().toISOString().split('T')[0],
                })});
            const membroId = novoMembro?.[0]?.id;
            await sb(`visitantes?id=eq.${visitanteId}`, {method:'PATCH', body:JSON.stringify({convertido:true, membro_id:membroId})});
            alert('Visitante convertido em membro com sucesso!');
            await carregarVisitantes();
            renderSecao();
        } catch(e) { alert('Erro ao converter: '+JSON.stringify(e)); }
    }

    // â”€â”€ TOGGLE ATIVO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function toggleAtivo(id, key, ativoAtual) {
        try {
            await sb(`${SECOES[secaoAtiva].tabela}?id=eq.${id}`, {
                method:'PATCH', body:JSON.stringify({[key]: !ativoAtual})
            });
            await carregarSecao();
        } catch(e) { alert('Erro ao alterar estado.'); }
    }

    // â”€â”€ FORM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function abrirForm(id) {
        const cfg     = SECOES[secaoAtiva];
        const registo = id ? registos.find(r=>r.id===id) : null;
        const isNovo  = !registo;

        if (secaoAtiva==='ministerios'||secaoAtiva==='cursos') {
            try {
                const filtroMembro = secaoAtiva==='cursos' ? '&professor=eq.true' : '';
                const res = await sb(`membros?select=id,nome&ativo=eq.true${filtroMembro}&order=nome`);
                if (Array.isArray(res) && res.length > 0) membros = res;
            } catch(e) { console.warn('Erro ao carregar membros:', e); }
        }
        if (secaoAtiva==='membros') {
            try {
                const resMembros = await sb('membros?select=id,nome&ativo=eq.true&order=nome');
                if (Array.isArray(resMembros) && resMembros.length > 0) membros = resMembros;
                ministeriosCache = await sb('ministerios?select=id,nome,tipo&ativo=eq.true&order=tipo,nome') || [];
            } catch(e) { console.warn('Erro ao carregar ministerios:', e); }
        }

        document.getElementById('drawer-title').textContent = isNovo ? `Novo ${cfg.label}` : `Editar ${cfg.label}`;
        document.getElementById('drawer-body').innerHTML    = buildForm(cfg, registo);
        document.getElementById('overlay').classList.remove('hidden');
        document.body.style.overflow = 'hidden';

        if (!isNovo && secaoAtiva==='membros') {
            await carregarFilhos(registo.id);
            await carregarMembroMinisterios(registo.id);
        } else if (!isNovo && (secaoAtiva==='ministerios'||secaoAtiva==='cursos')) {
            await carregarSubList(registo.id);
        }
    }

    function buildForm(cfg, r) {
        const campos = typeof cfg.campos === 'function' ? cfg.campos(r) : cfg.campos;
        let html = `<div class="form-grid"><div class="msg-form" id="form-msg"></div>`;
        campos.forEach(c => {
            if (c.key === 'link_id' && secaoAtiva === 'membros') {
                const val2 = r?.[c.key] ?? '';
                const opts2 = links_cache.map(l=>`<option value="${l.id}" ${val2===l.id?'selected':''}>${l.nome}</option>`).join('');
                html += `<div class="form-group form-full"><label class="form-label">${c.label}</label><select class="form-select" id="f_link_id"><option value="">-- Sem Link --</option>${opts2}</select></div>`;
                return;
            }
            if (c.type === 'section') { html += `<div class="form-section-title">${c.label}</div>`; return; }
            const val = r?.[c.key] ?? c.default ?? '';
            const fullClass = c.full ? 'form-full' : '';
            if (c.type === 'checkbox') {
                html += `<div class="form-group ${fullClass}"><label class="form-toggle"><input type="checkbox" id="f_${c.key}" ${val?'checked':''}><span>${c.label}</span></label></div>`;
            } else if (c.type === 'select') {
                const opts = c.options.map(o => `<option value="${o.v}" ${val==o.v?'selected':''}>${o.l}</option>`).join('');
                html += `<div class="form-group ${fullClass}"><label class="form-label">${c.label}</label><select class="form-select" id="f_${c.key}"><option value="">-- Seleciona --</option>${opts}</select></div>`;
            } else if (c.type === 'textarea') {
                html += `<div class="form-group ${fullClass}"><label class="form-label">${c.label}</label><textarea class="form-textarea" id="f_${c.key}" placeholder="${c.ph||''}">${val}</textarea></div>`;
            } else if (c.type === 'image') {
                html += buildImageUpload(c.key, c.label, val, c.bucket||'imagens');
            } else {
                html += `<div class="form-group ${fullClass}"><label class="form-label">${c.label}</label><input class="form-input" id="f_${c.key}" type="${c.type||'text'}" placeholder="${c.ph||''}" value="${val}"></div>`;
            }
        });

        if (r && secaoAtiva==='membros') {
            html += `
      <div class="form-section-title">Filhos (membros_filhos)</div>
      <div class="form-full">
        <div class="sub-list" id="sub-list"><div class="sub-list-empty">A carregar...</div></div>
      </div>
      <div class="sub-add-row">
        <select class="form-select" id="sub-filho-id"><option value="">Seleciona filho (membro)</option>${membros.map(m=>`<option value="${m.id}">${m.nome}</option>`).join('')}</select>
        <button class="btn-sub-add" onclick="addFilho('${r.id}')">Adicionar Filho</button>
      </div>`;
        }

        if (r && secaoAtiva==='membros') {
            const minsOpts = ministeriosCache.map(m=>`<option value="${m.id}">[${m.tipo||'?'}] ${m.nome}</option>`).join('');
            html += `
      <div class="form-section-title">Ministerios e Areas</div>
      <div class="form-full">
        <div class="sub-list" id="sub-list-mins"><div class="sub-list-empty">A carregar...</div></div>
      </div>
      <div class="sub-add-row">
        <select class="form-select" id="sub-min-id"><option value="">Seleciona ministerio/area</option>${minsOpts}</select>
        <input class="form-input" id="sub-min-papel" placeholder="Papel (ex: Lider)" style="max-width:130px">
        <button class="btn-sub-add" onclick="addMembroMinisterio('${r.id}')">Adicionar</button>
      </div>`;
        }

        if (r && (secaoAtiva==='ministerios'||secaoAtiva==='cursos')) {
            const sublabel = secaoAtiva==='ministerios' ? 'Lideres' : 'Instrutores';
            html += `
      <div class="form-section-title">${sublabel}</div>
      <div class="form-full">
        <div class="sub-list" id="sub-list"><div class="sub-list-empty">A carregar...</div></div>
      </div>
      <div class="sub-add-row">
        <select class="form-select" id="sub-membro-id"><option value="">Seleciona membro</option>${membros.map(m=>`<option value="${m.id}">${m.nome}</option>`).join('')}</select>
        <input class="form-input" id="sub-cargo" placeholder="Cargo" style="max-width:130px">
        <button class="btn-sub-add" onclick="addSubItem('${r.id}')">Adicionar</button>
      </div>`;
        }

        if (r && secaoAtiva==='cursos') {
            html = html.replace(
                `<button class="btn-sub-add" onclick="addSubItem('${r.id}')">Adicionar</button>`,
                `<input class="form-input" id="sub-nome-instrutor" placeholder="Nome (se nao membro)" style="max-width:130px"><button class="btn-sub-add" onclick="addSubItem('${r.id}')">Adicionar</button>`
            );
        }

        html += `
    <div class="form-actions">
      <button class="btn-cancel-form" onclick="closeDrawer()">Cancelar</button>
      <button class="btn-save" id="btn-save" onclick="salvar('${r?.id||''}')">Guardar</button>
    </div>
  </div>`;
        return html;
    }

    // â”€â”€ GUARDAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function salvar(id) {
        const cfg    = SECOES[secaoAtiva];
        const isNovo = !id;
        const campos = typeof cfg.campos === 'function' ? cfg.campos(null) : cfg.campos;
        const body   = {};

        campos.forEach(c => {
            if (c.type==='section') return;
            const el = document.getElementById(`f_${c.key}`);
            if (!el) return;
            if (c.type==='checkbox') body[c.key] = el.checked;
            else if (c.type==='number') body[c.key] = el.value ? Number(el.value) : null;
            else body[c.key] = el.value || null;
        });

        if (cfg.ativoKey && !(cfg.ativoKey in body) && isNovo) body[cfg.ativoKey] = true;
        if (!('ativo' in body) && isNovo && cfg.tabela !== 'keola_menu') body.ativo = true;

        const btn = document.getElementById('btn-save');
        btn.disabled = true; btn.textContent = 'A guardar...';

        try {
            if (isNovo) await sb(cfg.tabela, { method:'POST', body:JSON.stringify(body) });
            else await sb(`${cfg.tabela}?id=eq.${id}`, { method:'PATCH', body:JSON.stringify(body) });
            showFormMsg('Guardado com sucesso!', 'success');
            await carregarSecao();
            setTimeout(closeDrawer, 800);
        } catch(e) {
            showFormMsg(`Erro: ${e?.message||e?.details||JSON.stringify(e)}`, 'error');
            btn.disabled = false; btn.textContent = 'Guardar';
        }
    }

    function showFormMsg(txt, tipo) {
        const el = document.getElementById('form-msg');
        if (!el) return;
        el.textContent = txt; el.className = `msg-form ${tipo}`;
        el.scrollIntoView({behavior:'smooth',block:'nearest'});
    }

    // â”€â”€ SUB-ITEMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let membroMinisteriosData = [];

    async function carregarMembroMinisterios(membroId) {
        const items = await sb(`membro_ministerios?select=*,ministerios(id,nome,tipo)&membro_id=eq.${membroId}&ativo=eq.true&order=created_at`) || [];
        membroMinisteriosData = items;
        renderSubListMins(membroId);
    }

    function renderSubListMins(membroId) {
        const el = document.getElementById('sub-list-mins');
        if (!el) return;
        if (!membroMinisteriosData.length) { el.innerHTML = '<div class="sub-list-empty">Sem ministerios/areas associados.</div>'; return; }
        el.innerHTML = membroMinisteriosData.map(item => {
            const tipo  = item.ministerios?.tipo || '?';
            const nome  = item.ministerios?.nome || 'â€”';
            const tipoCurto = tipo === 'ministerio' ? 'MIN' : 'AE';
            return `<div class="sub-list-item">
      <span class="badge badge-gray" style="flex-shrink:0">${tipoCurto}</span>
      <div class="sub-list-nome">${nome}</div>
      <div class="sub-list-cargo">${item.papel||''}</div>
      <button class="sub-list-remove" onclick="removeMembroMinisterio('${item.id}','${membroId}')">Remover</button>
    </div>`;
        }).join('');
    }

    async function addMembroMinisterio(membroId) {
        const minId = document.getElementById('sub-min-id')?.value;
        const papel = document.getElementById('sub-min-papel')?.value?.trim();
        if (!minId) { alert('Seleciona um ministerio ou area.'); return; }
        if (membroMinisteriosData.find(m=>m.ministerio_id===minId)) { alert('Este membro ja esta associado a este ministerio/area.'); return; }
        try {
            await sb('membro_ministerios', {method:'POST', body:JSON.stringify({
                    membro_id: membroId, ministerio_id: minId, papel: papel||null, ativo: true,
                    data_entrada: new Date().toISOString().split('T')[0]
                })});
            await carregarMembroMinisterios(membroId);
            document.getElementById('sub-min-id').value = '';
            document.getElementById('sub-min-papel').value = '';
        } catch(e) { alert('Erro: '+JSON.stringify(e)); }
    }

    async function removeMembroMinisterio(itemId, membroId) {
        if (!confirm('Remover desta area/ministerio?')) return;
        await sb(`membro_ministerios?id=eq.${itemId}`, {method:'PATCH', body:JSON.stringify({ativo:false})});
        await carregarMembroMinisterios(membroId);
    }

    async function carregarFilhos(membroId) {
        const items = await sb(`membros_filhos?select=*&pai_id=eq.${membroId}&order=created_at`) || [];
        const el    = document.getElementById('sub-list');
        if (!el) return;
        if (!items.length) { el.innerHTML = '<div class="sub-list-empty">Sem filhos registados.</div>'; return; }
        el.innerHTML = items.map(item => {
            const filho = membros.find(m=>m.id===item.filho_id);
            return `<div class="sub-list-item">
      <div class="sub-list-nome">${filho?.nome||item.filho_id}</div>
      <div class="sub-list-cargo">Filho/a</div>
      <button class="sub-list-remove" onclick="removeFilho('${item.id}','${membroId}')">Remover</button>
    </div>`;
        }).join('');
    }

    async function addFilho(paiId) {
        const filhoId = document.getElementById('sub-filho-id')?.value;
        if (!filhoId) { alert('Seleciona um membro.'); return; }
        try {
            await sb('membros_filhos', {method:'POST', body:JSON.stringify({pai_id:paiId, filho_id:filhoId})});
            membros = await sb('membros?select=id,nome&ativo=eq.true&order=nome') || [];
            await carregarFilhos(paiId);
            document.getElementById('sub-filho-id').value = '';
        } catch(e) { alert('Erro ao adicionar filho: '+JSON.stringify(e)); }
    }

    async function removeFilho(itemId, paiId) {
        if (!confirm('Remover este filho?')) return;
        await sb(`membros_filhos?id=eq.${itemId}`, {method:'DELETE'});
        await carregarFilhos(paiId);
    }

    async function carregarSubList(parentId) {
        const isMin   = secaoAtiva === 'ministerios';
        const tabela  = isMin ? 'ministerio_lideres' : 'zao_curso_instrutores';
        const fkKey   = isMin ? 'ministerio_id' : 'curso_id';
        const items   = await sb(`${tabela}?select=*&${fkKey}=eq.${parentId}&order=created_at`) || [];
        const el      = document.getElementById('sub-list');
        if (!el) return;
        if (!items.length) { el.innerHTML = '<div class="sub-list-empty">Sem registos.</div>'; return; }
        el.innerHTML = items.map(item => {
            const membro = membros.find(m=>m.id===item.membro_id);
            const nome   = membro?.nome || item.nome_instrutor || 'â€”';
            return `
      <div class="sub-list-item">
        <div class="sub-list-nome">${nome}</div>
        <div class="sub-list-cargo">${item.cargo||''}</div>
        <button class="sub-list-remove" onclick="removeSubItem('${item.id}','${tabela}','${parentId}')">Remover</button>
      </div>`;
        }).join('');
    }

    async function addSubItem(parentId) {
        const isMin   = secaoAtiva === 'ministerios';
        const tabela  = isMin ? 'ministerio_lideres' : 'zao_curso_instrutores';
        const fkKey   = isMin ? 'ministerio_id' : 'curso_id';
        const memId   = document.getElementById('sub-membro-id')?.value;
        const cargo   = document.getElementById('sub-cargo')?.value;
        const nomeExt = document.getElementById('sub-nome-instrutor')?.value;
        if (!memId && !nomeExt) { alert('Seleciona um membro ou indica um nome.'); return; }
        const body = { [fkKey]: parentId, cargo: cargo||null };
        if (memId) body.membro_id = memId;
        if (!isMin && nomeExt) body.nome_instrutor = nomeExt;
        try {
            await sb(tabela, { method:'POST', body:JSON.stringify(body) });
            await carregarSubList(parentId);
            if(document.getElementById('sub-membro-id')) document.getElementById('sub-membro-id').value = '';
            if(document.getElementById('sub-cargo')) document.getElementById('sub-cargo').value = '';
            if(document.getElementById('sub-nome-instrutor')) document.getElementById('sub-nome-instrutor').value = '';
        } catch(e) { alert('Erro ao adicionar.'); }
    }

    async function removeSubItem(itemId, tabela, parentId) {
        if (!confirm('Remover?')) return;
        await sb(`${tabela}?id=eq.${itemId}`, { method:'DELETE' });
        await carregarSubList(parentId);
    }

    // â”€â”€ IMAGE UPLOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function buildImageUpload(key, label, currentUrl, bucket) {
        const hasImg = !!currentUrl;
        const imgHtml = hasImg
            ? `<img class="img-upload-preview" src="${currentUrl}" alt="${label}" onerror="this.style.display='none'">`
            : `<div class="img-upload-placeholder">
        <div class="img-upload-placeholder-icon">ğŸ“·</div>
        <div class="img-upload-placeholder-txt">Clica para escolher uma imagem<br>ou usa a camara / URL abaixo</div>
       </div>`;
        return `
    <div class="form-group img-upload-wrap">
      <label class="form-label">${label}</label>
      <div class="img-upload-box ${hasImg?'has-img':''}" id="img-box-${key}" onclick="triggerFileInput('${key}')">
        ${imgHtml}
      </div>
      <div class="img-upload-progress" id="img-prog-${key}"><div class="img-upload-progress-bar" id="img-prog-bar-${key}"></div></div>
      <div class="img-upload-status" id="img-status-${key}"></div>
      <div class="img-upload-actions">
        <button type="button" class="img-upload-btn" onclick="triggerFileInput('${key}')">Escolher Ficheiro</button>
        <button type="button" class="img-upload-btn" onclick="triggerCamera('${key}')">Tirar Foto</button>
        ${currentUrl ? `<button type="button" class="img-upload-btn danger" onclick="removeImage('${key}','f_${key}')">Remover</button>` : ''}
      </div>
      <div class="img-upload-url">
        <input type="text" id="img-url-input-${key}" placeholder="Ou cola um URL aqui..." value="${currentUrl||''}">
        <button type="button" class="img-upload-btn" onclick="applyUrlInput('${key}','${bucket}')">Usar URL</button>
      </div>
      <input type="hidden" id="f_${key}" value="${currentUrl||''}">
      <input type="file" id="img-file-${key}" accept="image/*" style="display:none" onchange="handleFileSelect('${key}','${bucket}',this)">
      <input type="file" id="img-cam-${key}"  accept="image/*" capture="environment" style="display:none" onchange="handleFileSelect('${key}','${bucket}',this)">
    </div>`;
    }

    function triggerFileInput(key) { document.getElementById('img-file-'+key)?.click(); }
    function triggerCamera(key)    { document.getElementById('img-cam-'+key)?.click(); }
    function applyUrlInput(key, bucket) {
        const url = document.getElementById('img-url-input-'+key)?.value?.trim();
        if (!url) return;
        document.getElementById('f_'+key).value = url;
        updateImagePreview(key, url);
        setImgStatus(key, 'URL aplicado.', 'ok');
    }
    function removeImage(key, hiddenId) {
        document.getElementById(hiddenId).value = '';
        document.getElementById('img-url-input-'+key).value = '';
        const box = document.getElementById('img-box-'+key);
        box.innerHTML = `<div class="img-upload-placeholder"><div class="img-upload-placeholder-icon">ğŸ“·</div><div class="img-upload-placeholder-txt">Clica para escolher uma imagem</div></div>`;
        box.classList.remove('has-img');
        setImgStatus(key, '', '');
    }
    function updateImagePreview(key, url) {
        const box = document.getElementById('img-box-'+key);
        if (!box) return;
        box.classList.add('has-img');
        box.innerHTML = `<img class="img-upload-preview" src="${url}" alt="preview" onerror="this.parentElement.classList.remove('has-img');this.style.display='none'">`;
    }
    function setImgStatus(key, msg, tipo) {
        const el = document.getElementById('img-status-'+key);
        if (!el) return;
        el.textContent = msg;
        el.className = 'img-upload-status' + (tipo?' '+tipo:'');
    }

    function resizeImage(file, maxW=800, maxH=800, quality=0.82) {
        return new Promise((resolve) => {
            const img = new Image();
            const url = URL.createObjectURL(file);
            img.onload = () => {
                let {width:w, height:h} = img;
                if (w > maxW || h > maxH) { const ratio = Math.min(maxW/w, maxH/h); w = Math.round(w*ratio); h = Math.round(h*ratio); }
                const canvas = document.createElement('canvas');
                canvas.width=w; canvas.height=h;
                canvas.getContext('2d').drawImage(img,0,0,w,h);
                URL.revokeObjectURL(url);
                canvas.toBlob(blob => resolve(blob), 'image/jpeg', quality);
            };
            img.onerror = () => { URL.revokeObjectURL(url); resolve(file); };
            img.src = url;
        });
    }

    async function handleFileSelect(key, bucket, input) {
        const file = input.files?.[0];
        if (!file) return;
        const localUrl = URL.createObjectURL(file);
        updateImagePreview(key, localUrl);
        setImgStatus(key, 'A comprimir imagem...', '');
        const prog = document.getElementById('img-prog-'+key);
        const bar  = document.getElementById('img-prog-bar-'+key);
        if (prog) prog.classList.add('active');
        if (bar) bar.style.width = '20%';
        try {
            const blob     = await resizeImage(file);
            const filename = `${Date.now()}-${Math.random().toString(36).slice(2)}.jpg`;
            const path     = `${secaoAtiva}/${filename}`;
            setImgStatus(key, 'A fazer upload...', '');
            if (bar) bar.style.width = '50%';
            const formData = new FormData();
            formData.append('file', new File([blob], filename, {type:'image/jpeg'}));
            formData.append('path', path);
            formData.append('bucket', bucket);
            const res = await fetch('/api/upload', {
                method:  'POST',
                headers: { 'Authorization': `Bearer ${currentUser?.token || ''}` },
                body:    formData,
            });
            if (!res.ok) { const err = await res.json().catch(()=>({})); throw new Error(err?.error || err?.message || 'Erro no upload'); }
            const data      = await res.json();
            const publicUrl = data.url;
            if (bar) bar.style.width = '100%';
            document.getElementById('f_'+key).value = publicUrl;
            document.getElementById('img-url-input-'+key).value = publicUrl;
            updateImagePreview(key, publicUrl);
            const kb = Math.round(blob.size/1024);
            setImgStatus(key, `Upload concluido! (${kb} KB)`, 'ok');
        } catch(e) {
            setImgStatus(key, 'Erro: '+e.message, 'err');
        } finally {
            setTimeout(()=>{ if(prog) prog.classList.remove('active'); if(bar) bar.style.width='0%'; }, 2000);
            input.value = '';
        }
    }

    // â”€â”€ DRAWER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function closeDrawer() {
        document.getElementById('overlay').classList.add('hidden');
        document.body.style.overflow = '';
    }
    function closeDrawerOutside(e) {
        if (e.target === document.getElementById('overlay')) closeDrawer();
    }
    document.addEventListener('keydown', e => { if (e.key==='Escape') closeDrawer(); });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CAMPOS DAS SECOES (idÃªntico ao original)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function camposMembros() { return [
        {type:'section', label:'Identificacao'},
        {key:'nome',        label:'Nome',           ph:'Nome completo',     full:true},
        {key:'email',       label:'Email',          type:'email',           ph:'email@exemplo.com'},
        {key:'telefone',    label:'Telefone',       ph:'+351 9XX XXX XXX'},
        {key:'genero',      label:'Genero',         type:'select', options:[{v:'masculino',l:'Masculino'},{v:'feminino',l:'Feminino'},{v:'outro',l:'Outro'}]},
        {key:'data_nascimento', label:'Data Nascimento', type:'date'},
        {key:'estado_civil',label:'Estado Civil',   type:'select', options:[{v:'solteiro',l:'Solteiro'},{v:'casado',l:'Casado'},{v:'divorciado',l:'Divorciado'},{v:'viuvo',l:'Viuvo'}]},
        {key:'nif',         label:'NIF',            ph:'000 000 000'},
        {key:'foto_url',    label:'Foto',           type:'image', bucket:'imagens', full:true},
        {type:'section', label:'Morada'},
        {key:'rua',         label:'Rua',            ph:'Nome da rua',       full:true},
        {key:'numero',      label:'Numero',         ph:'Nr'},
        {key:'complemento', label:'Complemento',    ph:'Andar, porta...'},
        {key:'bairro',      label:'Bairro',         ph:'Bairro'},
        {key:'cidade',      label:'Cidade',         ph:'Lisboa'},
        {key:'distrito_estado', label:'Distrito',   ph:'Lisboa'},
        {key:'codigo_postal',label:'Codigo Postal', ph:'0000-000'},
        {key:'pais',        label:'Pais',           ph:'Portugal', default:'Portugal'},
        {key:'zona',        label:'Zona (Link)',     ph:'Ex: Montijo'},
        {type:'section', label:'Igreja'},
        {key:'tipo',        label:'Tipo',           type:'select', options:[{v:'membro',l:'Membro'},{v:'admin',l:'Administrador'}]},
        {key:'data_entrada',label:'Membro Desde',   type:'date'},
        {key:'onde_conheceu',label:'Onde Conheceu', ph:'Como soube da Zion?', full:true},
        {key:'foi_batizado',label:'Foi Batizado',   type:'checkbox'},
        {key:'data_batismo',label:'Data Batismo',   type:'date'},
        {key:'tem_filhos',  label:'Tem Filhos',     type:'checkbox'},
        {key:'numero_filhos',label:'Nr Filhos',     type:'number', ph:'0'},
        {type:'section', label:'Funcoes'},
        {key:'e_lider',     label:'Lider',          type:'checkbox'},
        {key:'e_presbitero',label:'Presbitero',     type:'checkbox'},
        {key:'e_voluntario',label:'Voluntario',     type:'checkbox'},
        {key:'e_admin',     label:'Administrador',  type:'checkbox'},
        {key:'professor',   label:'Professor',      type:'checkbox'},
        {type:'section', label:'Historia'},
        {key:'historia',    label:'Historia',       type:'textarea', ph:'Historia do membro...', full:true},
        {key:'ativo',       label:'Ativo',          type:'checkbox', default:true},
        {type:'section',    label:'Ministerios e Areas'},
    ];}

    function camposPastores() { return [
        {key:'nome',       label:'Nome',         ph:'Nome completo',      full:true},
        {key:'cargo',      label:'Cargo',        ph:'Ex: Pastor Principal'},
        {key:'email',      label:'Email',        type:'email',            ph:'email@exemplo.com'},
        {key:'telefone',   label:'Telefone',     ph:'+351 9XX XXX XXX'},
        {key:'instagram',  label:'Instagram',    ph:'@handle'},
        {key:'foto_url',   label:'Foto URL',     ph:'https://...',        full:true},
        {key:'bio',        label:'Biografia',    type:'textarea',         ph:'Breve biografia...', full:true},
        {key:'ativo',      label:'Ativo',        type:'checkbox',         default:true},
    ];}

    function camposLinks() { return [
        {type:'section',      label:'Identificacao'},
        {key:'nome',          label:'Nome',           ph:'Ex: LINK Montijo',       full:true},
        {key:'tipo',          label:'Tipo',           type:'select', options:[
                {v:'Familias',l:'Familias'},{v:'FLOW',l:'FLOW'},{v:'VOX',l:'VOX'},{v:'Diamantes',l:'Diamantes'},{v:'EKLECTOS',l:'EKLECTOS'}
            ]},
        {key:'faixa_etaria',  label:'Faixa Etaria',   ph:'Ex: 18-35 anos'},
        {key:'capacidade',    label:'Capacidade',     type:'number', ph:'Ex: 20'},
        {type:'section',      label:'Lideranca'},
        {key:'responsavel',   label:'Responsavel',    ph:'Nome do lider',          full:true},
        {key:'co_responsavel',label:'Co-Responsavel', ph:'Nome do co-lider',       full:true},
        {key:'anfitrioes',    label:'Anfitrioes',     ph:'Nomes dos anfitrioes',   full:true},
        {type:'section',      label:'Horario'},
        {key:'dia',           label:'Dia',            type:'select', options:[
                {v:'Segunda-feira',l:'Segunda-feira'},{v:'Terca-feira',l:'Terca-feira'},
                {v:'Quarta-feira',l:'Quarta-feira'},{v:'Quinta-feira',l:'Quinta-feira'},
                {v:'Sexta-feira',l:'Sexta-feira'},{v:'Sabado',l:'Sabado'},{v:'Domingo',l:'Domingo'}
            ]},
        {key:'horario',       label:'Horario',        ph:'Ex: 20h00'},
        {key:'online',        label:'E Online',       type:'checkbox'},
        {type:'section',      label:'Localizacao'},
        {key:'zona',          label:'Zona',           ph:'Ex: Montijo'},
        {key:'distrito',      label:'Distrito',       ph:'Ex: Setubal'},
        {key:'morada',        label:'Morada',         ph:'Rua...',                 full:true},
        {key:'codigo_postal', label:'Cod. Postal',    ph:'Ex: 2870-001'},
        {type:'section',      label:'Contacto'},
        {key:'contato',       label:'Contato (WhatsApp)', ph:'+351 9XX XXX XXX',  full:true},
        {key:'ativo',         label:'Ativo',          type:'checkbox', default:true},
    ];}

    function camposCultos() { return [
        {key:'nome',           label:'Nome',          ph:'Ex: Culto de Domingo',    full:true},
        {key:'dia_semana',     label:'Dia da Semana', type:'select', options:[
                {v:'Domingo',l:'Domingo'},{v:'Segunda-feira',l:'Segunda-feira'},
                {v:'Terca-feira',l:'Terca-feira'},{v:'Quarta-feira',l:'Quarta-feira'},
                {v:'Quinta-feira',l:'Quinta-feira'},{v:'Sexta-feira',l:'Sexta-feira'},{v:'Sabado',l:'Sabado'}
            ]},
        {key:'hora_inicio',    label:'Hora Inicio',   type:'time'},
        {key:'hora_fim',       label:'Hora Fim',      type:'time'},
        {key:'recorrente',     label:'Recorrente',    type:'checkbox', default:true},
        {key:'data_especifica',label:'Data Especifica (se nao recorrente)', type:'date', full:true},
        {key:'descricao',      label:'Descricao',     type:'textarea', ph:'Descricao do culto...', full:true},
        {key:'ativo',          label:'Ativo',         type:'checkbox', default:true},
    ];}

    function camposMinisterios() { return [
        {key:'nome',        label:'Nome',         ph:'Ex: Ministerio de Louvor',  full:true},
        {key:'tipo',        label:'Tipo',         type:'select', options:[
                {v:'ministerio',l:'Ministerio'},{v:'area',l:'Area de Equipa'}
            ]},
        {key:'slug',        label:'Slug',         ph:'Ex: louvor'},
        {key:'faixa_etaria',label:'Faixa Etaria', ph:'Ex: Todas as idades'},
        {key:'instagram',   label:'Instagram',    ph:'@handle'},
        {key:'descricao',   label:'Descricao',    type:'textarea', ph:'Descricao do ministerio...', full:true},
        {key:'ativo',       label:'Ativo',        type:'checkbox', default:true},
    ];}

    function camposSalas() { return [
        {key:'nome',          label:'Nome',         ph:'Ex: Sala Principal',  full:true},
        {key:'espaco',        label:'Espaco',       ph:'Ex: Piso 1'},
        {key:'capacidade',    label:'Capacidade',   type:'number', ph:'Ex: 20'},
        {key:'hora_inicio',   label:'Hora Abertura',type:'time'},
        {key:'hora_fim',      label:'Hora Fecho',   type:'time'},
        {key:'descricao',     label:'Descricao',    type:'textarea', ph:'Descricao da sala...', full:true},
        {key:'aviso_entrega', label:'Aviso de Entrega', type:'textarea', ph:'Ex: Entregar limpa...', full:true},
        {key:'foto_url',      label:'Foto',         type:'image', bucket:'imagens', full:true},
        {key:'google_calendar_id', label:'Google Calendar ID', ph:'calendar@group.calendar.google.com', full:true},
        {type:'section', label:'Equipamentos'},
        {key:'tem_som',       label:'Som',          type:'checkbox'},
        {key:'tem_iluminacao',label:'Iluminacao',   type:'checkbox'},
        {key:'tem_projecao',  label:'Projecao',     type:'checkbox'},
        {key:'tem_mesas',     label:'Mesas',        type:'checkbox'},
        {key:'tem_cadeiras',  label:'Cadeiras',     type:'checkbox'},
        {key:'ativo',         label:'Ativo',        type:'checkbox', default:true},
    ];}

    function camposCursos() { return [
        {key:'nome',          label:'Nome',           ph:'Ex: Curso de Louvor',   full:true},
        {key:'carga_horaria', label:'Carga Horaria',  ph:'Ex: 40 horas'},
        {key:'valor',         label:'Valor (â‚¬)',      type:'number', ph:'0.00'},
        {key:'gratuito',      label:'Gratuito',       type:'checkbox'},
        {key:'descricao',     label:'Descricao',      type:'textarea', ph:'Descricao do curso...', full:true},
        {key:'ativo',         label:'Ativo',          type:'checkbox', default:true},
    ];}

    function camposKeola() { return [
        {key:'nome',          label:'Nome',          ph:'Ex: Cafe Especial',  full:true},
        {key:'categoria',     label:'Categoria',     ph:'Ex: Bebidas'},
        {key:'preco',         label:'Preco (â‚¬)',     type:'number', ph:'0.00'},
        {key:'ordem',         label:'Ordem',         type:'number', ph:'1'},
        {key:'descricao',     label:'Descricao',     type:'textarea', ph:'Descricao...', full:true},
        {key:'imagem_url',    label:'Imagem',        type:'image', bucket:'imagens', full:true},
        {key:'disponivel',    label:'Disponivel',    type:'checkbox', default:true},
        {key:'especial_hoje', label:'Especial Hoje', type:'checkbox'},
    ];}

    function camposLoja() { return [
        {type:'section', label:'Identificacao'},
        {key:'nome',              label:'Nome',             ph:'Ex: Camisola ZION',                 full:true},
        {key:'categoria',         label:'Categoria',        type:'select', options:[
                {v:'Vestuario',l:'Vestuario'},{v:'Acessorios',l:'Acessorios'},{v:'Livros',l:'Livros'},
                {v:'Musica',l:'Musica'},{v:'Decoracao',l:'Decoracao'},{v:'Infantil',l:'Infantil'},{v:'Outros',l:'Outros'}
            ]},
        {key:'subcategoria',      label:'Subcategoria',     ph:'Ex: Camisolas'},
        {key:'sku',               label:'SKU',              ph:'Ex: ZN-CAM-001'},
        {key:'codigo_barras',     label:'Codigo de Barras', ph:'EAN / ISBN'},
        {key:'marca',             label:'Marca',            ph:'Ex: Zion'},
        {key:'fornecedor',        label:'Fornecedor',       ph:'Nome do fornecedor'},
        {key:'tags',              label:'Tags',             ph:'Ex: lancamento,verao',              full:true},
        {key:'data_lancamento',   label:'Data Lancamento',  type:'date'},
        {key:'descricao',         label:'Descricao',        type:'textarea', ph:'Descricao do produto...', full:true},
        {type:'section', label:'Precos'},
        {key:'preco',             label:'Preco Normal (â‚¬)',        type:'number', ph:'0.00'},
        {key:'preco_custo',       label:'Preco de Custo (â‚¬)',      type:'number', ph:'0.00'},
        {key:'preco_promocional', label:'Preco Promocional (â‚¬)',   type:'number', ph:'0.00'},
        {key:'desconto_pct',      label:'Desconto (%)',            type:'number', ph:'0'},
        {key:'margem_lucro',      label:'Margem de Lucro (%)',     type:'number', ph:'0'},
        {key:'data_inicio_promo', label:'Inicio Promocao',        type:'date'},
        {key:'data_fim_promo',    label:'Fim Promocao',           type:'date'},
        {type:'section', label:'Estoque e Logistica'},
        {key:'stock',             label:'Quantidade em Estoque',  type:'number', ph:'0'},
        {key:'stock_minimo',      label:'Estoque Minimo',         type:'number', ph:'0'},
        {key:'stock_maximo',      label:'Estoque Maximo',         type:'number', ph:'0'},
        {key:'localizacao',       label:'Localizacao no Estoque', ph:'Ex: Prateleira A1'},
        {key:'controlar_estoque', label:'Controlar Estoque',      type:'checkbox', default:true},
        {key:'venda_sem_estoque', label:'Vender Sem Estoque',     type:'checkbox'},
        {key:'peso',              label:'Peso (kg)',              type:'number', ph:'0.00'},
        {key:'altura',            label:'Altura (cm)',            type:'number', ph:'0'},
        {key:'largura',           label:'Largura (cm)',           type:'number', ph:'0'},
        {key:'comprimento',       label:'Comprimento (cm)',       type:'number', ph:'0'},
        {key:'frete_gratis',      label:'Frete Gratis',           type:'checkbox'},
        {key:'classe_envio',      label:'Classe de Envio',        ph:'Ex: Standard'},
        {type:'section', label:'Variacao e Material'},
        {key:'cor',               label:'Cor',                    ph:'Ex: Preto'},
        {key:'tamanho',           label:'Tamanho',                ph:'Ex: M / 42'},
        {key:'modelo',            label:'Modelo',                 ph:'Ex: Classic Fit'},
        {key:'material',          label:'Material',               ph:'Ex: 100% Algodao'},
        {key:'tipo_tecido',       label:'Tipo de Tecido',         ph:'Ex: Jersey'},
        {key:'genero',            label:'Genero',                 type:'select', options:[{v:'unissex',l:'Unissex'},{v:'masculino',l:'Masculino'},{v:'feminino',l:'Feminino'},{v:'infantil',l:'Infantil'}]},
        {key:'estacao',           label:'Estacao',                type:'select', options:[{v:'todas',l:'Todas'},{v:'verao',l:'Verao'},{v:'inverno',l:'Inverno'},{v:'primavera',l:'Primavera'},{v:'outono',l:'Outono'}]},
        {key:'voltagem',          label:'Voltagem',               ph:'Ex: 110V / 220V'},
        {key:'edicao',            label:'Edicao',                 ph:'Ex: Edicao Limitada'},
        {key:'sku_variacao',      label:'SKU da Variacao',        ph:'Ex: ZN-CAM-001-PT-M'},
        {key:'preco_variacao',    label:'Preco da Variacao (â‚¬)',  type:'number', ph:'0.00'},
        {key:'estoque_variacao',  label:'Estoque da Variacao',    type:'number', ph:'0'},
        {type:'section', label:'Livros e Publicacoes'},
        {key:'autor',             label:'Autor',                  ph:'Nome do autor'},
        {key:'editora',           label:'Editora',                ph:'Nome da editora'},
        {key:'isbn',              label:'ISBN',                   ph:'000-0-000-00000-0'},
        {key:'num_paginas',       label:'Numero de Paginas',      type:'number', ph:'0'},
        {key:'ano_publicacao',    label:'Ano de Publicacao',      type:'number', ph:'2025'},
        {key:'idioma',            label:'Idioma',                 ph:'Ex: Portugues'},
        {key:'tipo_capa',         label:'Tipo de Capa',           type:'select', options:[{v:'mole',l:'Mole'},{v:'dura',l:'Dura'},{v:'espiralada',l:'Espiralada'}]},
        {type:'section', label:'Imagem e Destaque'},
        {key:'imagem_url',        label:'Imagem Principal',       type:'image', bucket:'imagens', full:true},
        {key:'ordem',             label:'Ordem de Exibicao',      type:'number', ph:'1'},
        {key:'disponivel',        label:'Disponivel',             type:'checkbox', default:true},
        {key:'ativo',             label:'Ativo',                  type:'checkbox', default:true},
        {key:'destaque',          label:'Produto em Destaque',    type:'checkbox'},
        {key:'novo_lancamento',   label:'Novo Lancamento',        type:'checkbox'},
        {key:'mais_vendido',      label:'Mais Vendido',           type:'checkbox'},
    ];}

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // EVENTOS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const STATUS_EVENTO = {
        aberto:    { label:'Aberto',    cls:'badge-green'   },
        em_curso:  { label:'Em Curso',  cls:'badge-primary' },
        concluido: { label:'Concluido', cls:'badge-gray'    },
        cancelado: { label:'Cancelado', cls:'badge-red'     },
    };

    let eventosData     = [];
    let presencasData   = [];
    let lideresData     = [];
    let eventoAtivo        = null;
    let lideresMinisterios = {};
    let presSearchQ        = '';
    let eventoSubTab    = 0;

    function renderEventos() {
        const q         = document.querySelector('.toolbar-search')?.value?.toLowerCase() || '';
        const filtroSt  = document.getElementById('evt-filtro-status')?.value || '';
        let lista = [...eventosData].sort((a,b)=> new Date(a.data_inicio)-new Date(b.data_inicio));
        if (q)       lista = lista.filter(e => (e.titulo||'').toLowerCase().includes(q) || (e.local||'').toLowerCase().includes(q));
        if (filtroSt) lista = lista.filter(e => e.status === filtroSt);

        if (eventoAtivo && eventoSubTab === 1) { renderPresencas(); return; }

        let html = `
    <div class="section-toolbar" style="position:sticky;top:0;z-index:10">
      <input class="toolbar-search" placeholder="Pesquisar evento..." oninput="renderEventos()">
      <select class="toolbar-filter" id="evt-filtro-status" onchange="renderEventos()" style="border-radius:var(--radius-full);padding:7px 12px;border:1px solid var(--border);background:var(--bg-input);font-family:var(--font-title);font-size:9px;color:var(--text-muted);cursor:pointer">
        <option value="">Todos</option>
        <option value="aberto">Abertos</option>
        <option value="em_curso">Em Curso</option>
        <option value="concluido">Concluidos</option>
        <option value="cancelado">Cancelados</option>
      </select>
      <button class="btn-new" onclick="abrirFormEvento(null)">+ Novo</button>
    </div>`;

        if (lista.length === 0) {
            html += '<div class="empty"><div class="empty-icon">ğŸ“…</div><div class="empty-txt">Nenhum evento encontrado.</div></div>';
            document.getElementById('main-content').innerHTML = html;
            return;
        }

        html += '<div class="admin-list" style="padding:12px 16px">';
        lista.forEach((e, i) => {
            const st     = STATUS_EVENTO[e.status] || STATUS_EVENTO.aberto;
            const dInicio = e.data_inicio ? new Date(e.data_inicio).toLocaleDateString('pt-PT',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}) : 'â€”';
            const dFim    = e.data_fim    ? new Date(e.data_fim).toLocaleDateString('pt-PT',{day:'2-digit',month:'short'}) : '';

            const btns = [];
            if (e.status === 'aberto')   btns.push(`<button class="btn-edit" onclick="abrirFormEvento('${e.id}')">Editar</button>`);
            if (e.status === 'aberto')   btns.push(`<button class="btn-toggle inativo" onclick="iniciarEvento('${e.id}')">Iniciar</button>`);
            if (e.status === 'em_curso') btns.push(`<button class="btn-edit" onclick="abrirPresencas('${e.id}')">Presencas</button>`);
            if (e.status === 'em_curso') btns.push(`<button class="btn-toggle inativo" onclick="concluirEvento('${e.id}')">Concluir</button>`);
            if (e.status !== 'cancelado' && e.status !== 'concluido') btns.push(`<button class="btn-toggle ativo" onclick="cancelarEvento('${e.id}')">Cancelar</button>`);
            if (e.status === 'concluido' || e.status === 'cancelado') btns.push(`<button class="btn-edit" onclick="abrirPresencas('${e.id}')">Ver Resumo</button>`);

            html += `
      <div class="admin-row" style="animation-delay:${Math.min(i,12)*0.02}s;flex-direction:column;align-items:stretch;gap:8px">
        <div style="display:flex;align-items:center;gap:12px">
          <div class="admin-row-foto">ğŸ“…</div>
          <div class="admin-row-info">
            <div class="admin-row-nome">${e.titulo||'â€”'}</div>
            <div class="admin-row-sub">${dInicio}${dFim?' â€” '+dFim:''} ${e.local?'Â· '+e.local:''}</div>
            <div class="admin-row-badges">
              <span class="badge ${st.cls}">${st.label}</span>
              ${e.gratuito?'<span class="badge badge-green">Gratuito</span>':''}
              ${e.destaque?'<span class="badge badge-primary">Destaque</span>':''}
              ${e.tipo?'<span class="badge badge-gray">'+e.tipo+'</span>':''}
            </div>
          </div>
        </div>
        <div class="admin-row-actions" style="justify-content:flex-end">${btns.join('')}</div>
      </div>`;
        });
        html += '</div>';
        document.getElementById('main-content').innerHTML = html;
    }

    async function iniciarEvento(id) {
        if (!confirm('Iniciar este evento? Sera criada a lista de presencas com todos os lideres.')) return;
        await sb(`eventos?id=eq.${id}`, {method:'PATCH', body:JSON.stringify({status:'em_curso'})});
        const lideres = await sb('membros?select=id,nome&e_lider=eq.true&ativo=eq.true');
        if (lideres?.length) {
            const rows = lideres.map(l => ({evento_id:id, membro_id:l.id, status:'pendente'}));
            await sb('evento_presencas', {method:'POST', body:JSON.stringify(rows)});
        }
        eventosData = await sb('eventos?select=*&order=data_inicio') || [];
        renderEventos();
    }

    async function cancelarEvento(id) {
        if (!confirm('Cancelar este evento?')) return;
        await sb(`eventos?id=eq.${id}`, {method:'PATCH', body:JSON.stringify({status:'cancelado'})});
        eventosData = await sb('eventos?select=*&order=data_inicio') || [];
        renderEventos();
    }

    async function concluirEvento(id) {
        if (!confirm('Concluir evento? Todos os lideres ainda pendentes serao marcados como faltaram.')) return;
        await sb(`evento_presencas?evento_id=eq.${id}&status=eq.pendente`, {method:'PATCH', body:JSON.stringify({status:'faltou'})});
        await sb(`eventos?id=eq.${id}`, {method:'PATCH', body:JSON.stringify({status:'concluido'})});
        eventosData = await sb('eventos?select=*&order=data_inicio') || [];
        eventoAtivo = null; eventoSubTab = 0;
        renderEventos();
    }

    async function abrirPresencas(id) {
        eventoAtivo  = eventosData.find(e => e.id === id);
        eventoSubTab = 1;
        presencasData = await sb(`evento_presencas?select=*,membros(id,nome,telefone)&evento_id=eq.${id}&order=created_at`) || [];
        const membroIds = presencasData.map(p=>p.membro_id).filter(Boolean);
        lideresMinisterios = {};
        if (membroIds.length) {
            const vincs = await sb(`membro_ministerios?select=membro_id,papel,ativo,ministerios(id,nome,tipo)&membro_id=in.(${membroIds.join(',')})&ativo=eq.true`) || [];
            vincs.forEach(v => {
                if (!lideresMinisterios[v.membro_id]) lideresMinisterios[v.membro_id] = [];
                lideresMinisterios[v.membro_id].push({ papel: v.papel, nome: v.ministerios?.nome || 'â€”', tipo: v.ministerios?.tipo || 'â€”' });
            });
        }
        renderPresencas();
    }

    function renderPresencas() {
        const evento  = eventoAtivo;
        const st      = STATUS_EVENTO[evento?.status] || STATUS_EVENTO.aberto;
        const emCurso = evento?.status === 'em_curso';
        const q = presSearchQ.toLowerCase();

        let lista = [...presencasData];
        if (q) lista = lista.filter(p => (p.membros?.nome||'').toLowerCase().includes(q));

        const total     = presencasData.length;
        const presentes = presencasData.filter(p=>p.status==='presente').length;
        const faltaram  = presencasData.filter(p=>p.status==='faltou').length;
        const comMotivo = presencasData.filter(p=>p.status==='faltou_motivo').length;
        const pendentes = presencasData.filter(p=>p.status==='pendente').length;

        let html = `
    <div class="section-toolbar" style="position:sticky;top:0;z-index:10;flex-wrap:wrap;gap:6px">
      <button class="btn-edit" style="border-radius:var(--radius-full);padding:5px 12px;font-size:10px" onclick="voltarListaEventos()">â† Voltar</button>
      <input class="toolbar-search" id="pres-search" placeholder="Pesquisar lider..." oninput="presSearchQ=this.value;renderPresencas()" style="flex:1;min-width:120px">
      ${emCurso ? `<button class="btn-new" onclick="finalizarEntradas()">Finalizar Entradas</button>` : ''}
    </div>
    <div style="padding:10px 16px 4px">
      <div style="font-family:var(--font-title);font-size:13px;color:var(--primary-dark);margin-bottom:4px">${evento?.titulo||'â€”'}</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <span class="badge ${st.cls}">${st.label}</span>
        <span class="badge badge-green">Presentes: ${presentes}</span>
        <span class="badge badge-red">Faltaram: ${faltaram+comMotivo}</span>
        ${comMotivo ? `<span class="badge badge-primary">Com motivo: ${comMotivo}</span>` : ''}
        ${pendentes ? `<span class="badge badge-gray">Pendentes: ${pendentes}</span>` : ''}
      </div>
    </div>
    <div class="gold-line" style="margin:8px 16px"></div>`;

        if (lista.length === 0) {
            html += '<div class="empty"><div class="empty-txt">Nenhum lider encontrado.</div></div>';
            document.getElementById('main-content').innerHTML = html;
            const si = document.getElementById('pres-search');
            if(si){si.value=presSearchQ;si.focus();si.setSelectionRange(si.value.length,si.value.length);}
            return;
        }

        const grupos = [
            {key:'presente',     label:'Presentes',         items: lista.filter(p=>p.status==='presente')},
            {key:'pendente',     label:'Pendentes',          items: lista.filter(p=>p.status==='pendente')},
            {key:'faltou_motivo',label:'Faltaram c/ Motivo', items: lista.filter(p=>p.status==='faltou_motivo')},
            {key:'faltou',       label:'Faltaram',           items: lista.filter(p=>p.status==='faltou')},
        ].filter(g => g.items.length > 0);

        grupos.forEach(grupo => {
            html += `<div style="padding:8px 16px 2px;font-family:var(--font-title);font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--text-faint)">${grupo.label} (${grupo.items.length})</div>`;
            html += '<div class="admin-list" style="padding:4px 16px 8px">';
            grupo.items.forEach((p, i) => {
                const nome   = p.membros?.nome || 'â€”';
                const stIcon = {presente:'âœ“', faltou:'âœ—', faltou_motivo:'!', pendente:'Â·'}[p.status]||'Â·';
                const stCls  = {presente:'badge-green', faltou:'badge-red', faltou_motivo:'badge-primary', pendente:'badge-gray'}[p.status]||'badge-gray';
                const mins = lideresMinisterios[p.membro_id] || [];
                const minsHtml = mins.map(m => {
                    const tipoCurto = m.tipo === 'ministerio' ? 'MIN' : 'AE';
                    return `<span class="badge badge-gray" style="font-size:8px">${tipoCurto} Â· ${m.nome}${m.papel?' Â· '+m.papel:''}</span>`;
                }).join('');

                let btns = '';
                if (emCurso && p.status !== 'presente')      btns += `<button class="btn-toggle inativo" onclick="marcarPresenca('${p.id}','presente')">Presente</button>`;
                if (emCurso && p.status !== 'faltou')        btns += `<button class="btn-toggle ativo" onclick="marcarPresenca('${p.id}','faltou')">Faltou</button>`;
                if (emCurso && p.status !== 'faltou_motivo') btns += `<button class="btn-edit" onclick="abrirMotivo('${p.id}','${nome.replace(/'/g,"\'")}')">Com Motivo</button>`;
                if (emCurso && p.status !== 'pendente')      btns += `<button class="btn-edit" style="color:var(--text-faint)" onclick="marcarPresenca('${p.id}','pendente')" title="Desfazer">Desfazer</button>`;
                if (p.membros?.telefone) {
                    const tel    = (p.membros.telefone).replace(/\D/g,'');
                    const dEvt   = eventoAtivo?.data_inicio ? new Date(eventoAtivo.data_inicio).toLocaleDateString('pt-PT',{weekday:'long',day:'numeric',month:'long',hour:'2-digit',minute:'2-digit'}) : '';
                    const titulo = eventoAtivo?.titulo || 'reuniao de lideranca';
                    const msg    = encodeURIComponent(`Ola ${p.membros.nome?.split(' ')[0]}! Gostariamos de confirmar a tua presenca na ${titulo} que acontecera ${dEvt}. Podes confirmar?`);
                    btns += `<a href="https://api.whatsapp.com/send?phone=${tel}&text=${msg}" target="_blank" rel="noopener" class="btn-edit" style="color:#25D366;border-color:rgba(37,211,102,0.3);background:rgba(37,211,102,0.06);text-decoration:none">WhatsApp</a>`;
                }

                html += `
        <div class="admin-row" style="animation-delay:${Math.min(i,20)*0.01}s;flex-wrap:wrap">
          <div class="admin-row-foto" style="font-size:13px;font-weight:bold;color:${{presente:'var(--green)',faltou:'var(--red)',faltou_motivo:'var(--orange)',pendente:'var(--text-faint)'}[p.status]}">${stIcon}</div>
          <div class="admin-row-info" style="min-width:0">
            <div class="admin-row-nome">${nome}</div>
            <div class="admin-row-badges" style="margin-top:3px;flex-wrap:wrap;gap:3px">${minsHtml || '<span style="font-size:10px;color:var(--text-faint)">Sem areas associadas</span>'}</div>
            ${p.motivo ? `<div class="admin-row-sub" style="color:var(--orange);margin-top:3px">${p.motivo}</div>` : ''}
          </div>
          <div class="admin-row-actions">${btns}</div>
        </div>`;
            });
            html += '</div>';
        });

        document.getElementById('main-content').innerHTML = html;
        const si = document.getElementById('pres-search');
        if(si){si.value=presSearchQ;si.focus();si.setSelectionRange(si.value.length,si.value.length);}
    }

    function voltarListaEventos() { eventoAtivo = null; eventoSubTab = 0; presSearchQ = ''; renderEventos(); }

    async function marcarPresenca(presencaId, novoStatus) {
        await sb(`evento_presencas?id=eq.${presencaId}`, {method:'PATCH', body:JSON.stringify({status:novoStatus, registado_em: new Date().toISOString()})});
        const idx = presencasData.findIndex(p=>p.id===presencaId);
        if (idx>=0) presencasData[idx].status = novoStatus;
        renderPresencas();
    }

    async function finalizarEntradas() {
        if (!eventoAtivo) return;
        if (!confirm('Finalizar entradas? Todos os lideres ainda pendentes serao marcados como faltaram.')) return;
        await sb(`evento_presencas?evento_id=eq.${eventoAtivo.id}&status=eq.pendente`, {method:'PATCH', body:JSON.stringify({status:'faltou'})});
        presencasData.forEach(p => { if (p.status==='pendente') p.status='faltou'; });
        renderPresencas();
    }

    let motivoPresencaId = null;

    function abrirMotivo(presencaId, nome) {
        motivoPresencaId = presencaId;
        document.getElementById('drawer-title').textContent = `Motivo â€” ${nome}`;
        document.getElementById('drawer-body').innerHTML = `
    <div class="form-grid">
      <div class="form-group form-full">
        <label class="form-label">Motivo da Falta</label>
        <textarea class="form-textarea" id="motivo-txt" placeholder="Descreve o motivo..." style="height:100px"></textarea>
      </div>
      <div class="form-actions">
        <button class="btn-cancel-form" onclick="closeDrawer()">Cancelar</button>
        <button class="btn-save" onclick="guardarMotivo()">Guardar</button>
      </div>
    </div>`;
        document.getElementById('overlay').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    async function guardarMotivo() {
        const motivo = document.getElementById('motivo-txt')?.value?.trim();
        if (!motivo) { alert('Escreve o motivo.'); return; }
        await sb(`evento_presencas?id=eq.${motivoPresencaId}`,
            {method:'PATCH', body:JSON.stringify({status:'faltou_motivo', motivo, registado_em:new Date().toISOString()})});
        const idx = presencasData.findIndex(p=>p.id===motivoPresencaId);
        if (idx>=0) { presencasData[idx].status='faltou_motivo'; presencasData[idx].motivo=motivo; }
        closeDrawer();
        renderPresencas();
    }

    function abrirFormEvento(id) {
        const e = id ? eventosData.find(x=>x.id===id) : null;
        document.getElementById('drawer-title').textContent = e ? 'Editar Evento' : 'Novo Evento';
        document.getElementById('drawer-body').innerHTML = buildFormEvento(e);
        document.getElementById('overlay').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function buildFormEvento(e) {
        const fv = (k, def='') => e?.[k] ?? def;
        const fdt = (k) => { const v = e?.[k]; if (!v) return ''; return new Date(v).toISOString().slice(0,16); };
        return `<div class="form-grid">
    <div class="msg-form" id="form-msg"></div>
    <div class="form-section-title">Identificacao</div>
    <div class="form-group form-full"><label class="form-label">Titulo</label><input class="form-input" id="fe_titulo" type="text" placeholder="Nome do evento" value="${fv('titulo')}"></div>
    <div class="form-group"><label class="form-label">Tipo</label>
      <select class="form-select" id="fe_tipo">
        <option value="">-- Seleciona --</option>
        ${['Reuniao de Lideres','Culto Especial','Conferencia','Retiro','Treinamento','Workshop','Outro'].map(t=>`<option value="${t}" ${fv('tipo')===t?'selected':''}>${t}</option>`).join('')}
      </select>
    </div>
    <div class="form-group"><label class="form-label">Local</label><input class="form-input" id="fe_local" type="text" placeholder="Ex: Sede Lisboa" value="${fv('local')}"></div>
    <div class="form-group form-full"><label class="form-label">Descricao</label><textarea class="form-textarea" id="fe_descricao" placeholder="Descricao do evento...">${fv('descricao')}</textarea></div>
    <div class="form-section-title">Data e Hora</div>
    <div class="form-group"><label class="form-label">Data Inicio</label><input class="form-input" id="fe_data_inicio" type="datetime-local" value="${fdt('data_inicio')}"></div>
    <div class="form-group"><label class="form-label">Data Fim</label><input class="form-input" id="fe_data_fim" type="datetime-local" value="${fdt('data_fim')}"></div>
    <div class="form-section-title">Inscricao</div>
    <div class="form-group"><label class="form-label">Valor (â‚¬)</label><input class="form-input" id="fe_valor" type="number" placeholder="0.00" value="${fv('valor')}"></div>
    <div class="form-group"><label class="form-label">Link Inscricao</label><input class="form-input" id="fe_link_inscricao" type="url" placeholder="https://..." value="${fv('link_inscricao')}"></div>
    <div class="form-group"><label class="form-toggle"><input type="checkbox" id="fe_gratuito" ${fv('gratuito')?'checked':''}><span>Gratuito</span></label></div>
    <div class="form-group"><label class="form-toggle"><input type="checkbox" id="fe_destaque" ${fv('destaque')?'checked':''}><span>Destaque</span></label></div>
    <div class="form-group"><label class="form-toggle"><input type="checkbox" id="fe_ativo" ${fv('ativo')!==false?'checked':''}><span>Ativo</span></label></div>
    <div class="form-actions">
      <button class="btn-cancel-form" onclick="closeDrawer()">Cancelar</button>
      <button class="btn-save" id="btn-save" onclick="salvarEvento('${e?.id||''}')">Guardar</button>
    </div>
  </div>`;
    }

    async function salvarEvento(id) {
        const get = k => { const el=document.getElementById('fe_'+k); return el?el.value||null:null; };
        const chk = k => { const el=document.getElementById('fe_'+k); return el?el.checked:false; };
        const body = {
            titulo: get('titulo'), tipo: get('tipo'), local: get('local'),
            descricao: get('descricao'), data_inicio: get('data_inicio'),
            data_fim: get('data_fim'), valor: get('valor')?Number(get('valor')):null,
            link_inscricao: get('link_inscricao'),
            gratuito: chk('gratuito'), destaque: chk('destaque'), ativo: chk('ativo'),
        };
        if (!body.titulo) { showFormMsg('Titulo obrigatorio.','error'); return; }
        const btn = document.getElementById('btn-save');
        btn.disabled=true; btn.textContent='A guardar...';
        try {
            if (!id) { body.status='aberto'; await sb('eventos',{method:'POST',body:JSON.stringify(body)}); }
            else await sb(`eventos?id=eq.${id}`,{method:'PATCH',body:JSON.stringify(body)});
            showFormMsg('Guardado!','success');
            eventosData = await sb('eventos?select=*&order=data_inicio') || [];
            setTimeout(()=>{ closeDrawer(); renderEventos(); }, 700);
        } catch(err) {
            showFormMsg('Erro: '+(err?.message||JSON.stringify(err)),'error');
            btn.disabled=false; btn.textContent='Guardar';
        }
    }

    function camposEventos() { return []; }

    init();
</script>
</body>
</html>
