<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Painel Admin ‚Äî Zion Lisboa</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/tokens.css">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/components.css">
    <script src="config.js"></script>
    <script src="auth.js"></script>
    <style>
        .welcome-card {
            display: flex;
            align-items: center;
            justify-content: center;   /* centralizado */
            gap: 10px;
            padding: 6px 16px;
            background: var(--primary-faint);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            text-align: center;
        }
        .welcome-card img {
            height: 28px;
            width: auto;
            object-fit: contain;
        }
        .welcome-card p {
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.4;
        }
        .welcome-card strong {
            color: var(--primary-dark);
            font-family: var(--font-title);
            font-size: 10px;
            letter-spacing: 1px;
        }
        /* Banner fixo em 70px */
        .banner { min-height: 70px !important; max-height: 70px !important; }
        .banner img { height: 70px !important; }
        .banner-fallback { height: 70px !important; }

        /* Tabela de configura√ß√µes */
        .config-table { width:100%; border-collapse:collapse; font-size:13px; }
        .config-table th {
            background:var(--bg-input); padding:8px 12px; text-align:left;
            font-family:var(--font-title); font-size:9px; letter-spacing:2px;
            text-transform:uppercase; color:var(--text-faint); border-bottom:1px solid var(--border);
        }
        .config-table td { padding:10px 12px; border-bottom:1px solid var(--border); vertical-align:top; }
        .config-table tr:last-child td { border-bottom:none; }
        .config-table tr:hover td { background:var(--primary-faint); }
        .config-chave { font-family:var(--font-title); font-size:10px; letter-spacing:1px; color:var(--primary-dark); white-space:nowrap; }
        .config-desc  { font-size:11px; color:var(--text-faint); }
        .config-date  { font-size:10px; color:var(--text-faint); white-space:nowrap; }
        .config-actions { display:flex; gap:6px; white-space:nowrap; }

        /* Painel adicionar membros ao evento */
        .add-member-panel {
            background: var(--bg-input); border: 1px solid var(--border);
            border-radius: 10px; padding: 12px; margin-top: 8px;
        }
        .add-member-panel-title {
            font-family: var(--font-title); font-size: 9px; letter-spacing: 2px;
            text-transform: uppercase; color: var(--text-faint); margin-bottom: 8px;
        }
        .add-member-row { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
        .add-member-list { display: flex; flex-direction: column; gap: 4px; margin-top: 8px; max-height: 200px; overflow-y: auto; }
        .add-member-item {
            display: flex; align-items: center; gap: 8px; padding: 6px 10px;
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px;
        }
        .add-member-item-nome { flex: 1; font-size: 12px; color: var(--text-main); }
        .add-member-item-remove {
            width: 20px; height: 20px; border-radius: 50%; border: none;
            background: rgba(220,80,60,0.1); color: var(--red); font-size: 12px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        /* Gr√°ficos resumo na tela */
        .resumo-graficos {
            padding: 0 16px 16px;
        }
        .grafico-wrap {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 12px; padding: 16px; margin-bottom: 12px;
        }
        .grafico-titulo {
            font-family: var(--font-title); font-size: 10px; letter-spacing: 2px;
            text-transform: uppercase; color: var(--text-faint); margin-bottom: 12px;
        }
        .grafico-barras { display: flex; flex-direction: column; gap: 8px; }
        .grafico-barra-row { display: flex; align-items: center; gap: 8px; }
        .grafico-barra-label { font-size: 11px; color: var(--text-main); width: 140px; flex-shrink: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .grafico-barra-track { flex: 1; background: var(--bg-input); border-radius: 20px; height: 18px; overflow: hidden; }
        .grafico-barra-fill { height: 100%; border-radius: 20px; display: flex; align-items: center; justify-content: flex-end; padding-right: 6px; font-size: 10px; font-weight: bold; color: #fff; transition: width 0.4s ease; min-width: 20px; }
        .grafico-barra-val { font-size: 11px; color: var(--text-faint); width: 50px; text-align: right; flex-shrink: 0; }

        /* Pizza mini */
        .pizza-wrap { display: flex; align-items: center; gap: 20px; flex-wrap: wrap; }
        .pizza-svg { flex-shrink: 0; }
        .pizza-legend { display: flex; flex-direction: column; gap: 6px; }
        .pizza-legend-item { display: flex; align-items: center; gap: 6px; font-size: 12px; }
        .pizza-legend-dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }

        /* Stats summary cards */
        .resumo-stats {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;
            padding: 12px 16px 8px;
        }
        .resumo-stat {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 10px; padding: 12px; text-align: center;
        }
        .resumo-stat-num { font-family: var(--font-title); font-size: 22px; font-weight: 700; }
        .resumo-stat-label { font-size: 10px; color: var(--text-faint); margin-top: 2px; }
        .resumo-stat-pct { font-size: 11px; font-weight: bold; margin-top: 2px; }
    </style>
</head>
<body>
<div class="page-wrapper">

    <div class="banner">
        <img src="assets/banner_zion.jpg" alt="Zion Lisboa"
             onerror="this.onerror=null;this.style.display='none';document.querySelector('.banner-fallback').classList.add('show');">
        <div class="banner-fallback">
            <div class="banner-title">ZION</div>
            <div class="banner-sub">Lisboa ¬∑ Portugal</div>
        </div>
    </div>

    <div class="gold-line"></div>

    <div class="welcome-card">
        <img src="assets/logo_zion.jpg" alt="Logo Zion"
             onerror="this.onerror=null;this.style.display='none';">
        <p><strong>Bem-vindo √† Zion Lisboa</strong><br>Painel de Administra√ß√£o</p>
    </div>

    <div class="user-bar">
        <a href="index.html" class="user-bar-back">&#8592; In√≠cio</a>
        <div class="user-bar-center">
            <div class="user-bar-section" id="secao-label">Cadastros</div>
            <div class="user-bar-date" id="data-hoje"></div>
        </div>
        <div class="user-bar-right">
            <div class="user-bar-nome" id="top-user"></div>
            <button class="logout-btn" onclick="ZionAuth.logout()">Sair</button>
        </div>
    </div>

    <div class="nav-bar" id="nav-bar">
        <div class="nav-item"         onclick="setSecao('dashboard')" data-secao="dashboard">Dashboard</div>
        <div class="nav-item active"  onclick="setSecao('membros')" data-secao="membros">Membros</div>
        <div class="nav-item"         onclick="setSecao('pastores')" data-secao="pastores">Pastores</div>
        <div class="nav-item"         onclick="setSecao('links')" data-secao="links">Links</div>
        <div class="nav-item"         onclick="setSecao('cultos')" data-secao="cultos">Cultos</div>
        <div class="nav-item"         onclick="setSecao('ministerios')" data-secao="ministerios">Minist√©rios</div>
        <div class="nav-item"         onclick="setSecao('salas')" data-secao="salas">Salas</div>
        <div class="nav-item"         onclick="setSecao('cursos')" data-secao="cursos">Cursos ZAO</div>
        <div class="nav-item"         onclick="setSecao('keola')" data-secao="keola">Keola</div>
        <div class="nav-item"         onclick="setSecao('loja')" data-secao="loja">Loja</div>
        <div class="nav-item"         onclick="setSecao('eventos')" data-secao="eventos">Eventos</div>
        <div class="nav-item"         onclick="setSecao('tipos_evento')" data-secao="eventos">Tipos Evento</div>
        <div class="nav-item"         onclick="setSecao('fornecedores')" data-secao="fornecedores">Fornecedores</div>
        <div class="nav-item"         onclick="setSecao('financeiro')" data-secao="financeiro">Financeiro</div>
        <div class="nav-item"         onclick="setSecao('utilizadores')" data-secao="utilizadores">üë§ Utilizadores</div>
        <div class="nav-item"         onclick="setSecao('configuracoes')" data-secao="configuracoes">‚öô Config</div>
    </div>

    <div class="content" id="main-content">
        <div class="loading"><div class="spin"></div>A verificar acesso...</div>
    </div>

    <div class="footer">
        <div class="footer-links">
            <a class="footer-link" href="https://zionchurch.org.br/" target="_blank">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="12" height="12"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                Site Oficial
            </a>
            <a class="footer-link" href="https://www.instagram.com/zionlisboa/" target="_blank">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="12" height="12"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"/></svg>
                @ZionLisboa
            </a>
        </div>
        <div class="footer-div"></div>
        <div class="footer-copy">¬© 2026 Zion Lisboa ‚Äî Todos os direitos reservados</div>
        <div class="footer-addr">Rua do Centro Cultural, 11 ¬∑ 1700-036 Alvalade ¬∑ Lisboa, Portugal</div>
    </div>
</div>

<div class="overlay hidden" id="overlay" onclick="closeDrawerOutside(event)">
    <div class="drawer" id="drawer">
        <div class="drawer-head">
            <div class="drawer-title" id="drawer-title">Novo Registo</div>
            <button class="drawer-x" onclick="closeDrawer()">‚úï</button>
        </div>
        <div class="drawer-body" id="drawer-body"></div>
    </div>
</div>

<script>
    ZionAuth.protect();
    const currentUser = ZionAuth.getUser();
    const SUPA_URL    = window.SUPABASE_URL      || '';
    const SUPA_KEY    = window.SUPABASE_ANON_KEY || '';

    let secaoAtiva       = 'membros';
    let subTabAtiva      = 0;
    let registos         = [];
    let filtroInativo    = false;
    let membros          = [];
    let links_cache      = [];
    let ministeriosCache = [];

    // ‚îÄ‚îÄ PERMISS√ïES DO UTILIZADOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let userPerms = {};  // preenchido no init com as flags da tabela usuarios

    // Verifica se o utilizador tem permiss√£o para uma ac√ß√£o numa sec√ß√£o
    // ac√ß√£o: 'ver' | 'criar' | 'editar' | 'eliminar'
    function perm(secao, accao = 'ver') {
        if (userPerms.e_admin) return true;            // admin v√™ tudo
        return userPerms[`${accao}_${secao}`] === true;
    }

    // Devolve os atributos de disabled para bot√µes consoante a permiss√£o
    function btnGuard(secao, accao) {
        if (perm(secao, accao)) return '';
        return 'disabled title="Sem permiss√£o" style="opacity:0.35;cursor:not-allowed"';
    }

    // ‚îÄ‚îÄ TIPOS DE EVENTO (carregados dinamicamente do localStorage) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Definido mais abaixo em TIPOS DE EVENTO ‚Äî gest√£o na tela,
    // mas precisamos do array dispon√≠vel para buildFormEvento.
    // Usamos uma proxy: getTiposEvento() √© definida mais abaixo;
    // buildFormEvento chama getTiposEvento() directamente em vez deste array.
    const TIPOS_EVENTO = []; // preenchido no init via syncTiposEvento

    function syncTiposEvento() {
        try {
            const saved = localStorage.getItem('zion_tipos_evento');
            const lista = saved ? JSON.parse(saved) : [
                'Reuni√£o de L√≠deres','Culto Especial','Confer√™ncia','Retiro',
                'Treinamento','Workshop','Confer√™ncia de Jovens','Encontro de Casais',
                'Culto de Ora√ß√£o','Semin√°rio','Outro',
            ];
            TIPOS_EVENTO.length = 0;
            lista.forEach(t => TIPOS_EVENTO.push(t));
        } catch { /* usa os existentes */ }
    }

    // ‚îÄ‚îÄ SUPABASE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function sb(path, opts = {}) {
        const r = await fetch(`${SUPA_URL}/rest/v1/${path}`, {
            ...opts,
            headers: {
                'apikey': SUPA_KEY, 'Authorization': `Bearer ${SUPA_KEY}`,
                'Content-Type': 'application/json', 'Prefer': 'return=representation',
                ...opts.headers,
            },
        });
        if (!r.ok) { const e = await r.json().catch(() => {}); throw e; }
        const txt = await r.text();
        return txt ? JSON.parse(txt) : [];
    }

    // ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function init() {
        document.getElementById('top-user').textContent =
            currentUser.nome?.split(' ')[0] || '';
        const hoje = new Date().toLocaleDateString('pt-PT',
            { weekday:'long', day:'numeric', month:'long' });
        document.getElementById('data-hoje').textContent =
            hoje.charAt(0).toUpperCase() + hoje.slice(1);

        // Carregar permiss√µes ‚Äî verificar tabela usuarios E membros em paralelo
        const SECOES_LISTA = ['dashboard','membros','pastores','links','cultos','ministerios',
            'salas','cursos','keola','loja','eventos','fornecedores','financeiro','utilizadores','configuracoes'];

        const darAcessoTotal = () => {
            userPerms = { e_admin: true };
            SECOES_LISTA.forEach(s => {
                userPerms[`ver_${s}`]      = true;
                userPerms[`criar_${s}`]    = true;
                userPerms[`editar_${s}`]   = true;
                userPerms[`eliminar_${s}`] = true;
            });
        };

        // 1. Verificar membros (sistema original ‚Äî mais fi√°vel)
        const membroRow = await sb(
            `membros?select=e_admin,e_presbitero&email=eq.${encodeURIComponent(currentUser.email)}&ativo=eq.true`
        ).catch(() => []);
        const m = membroRow?.[0];

        if (m?.e_admin) {
            // Admin via tabela membros ‚Äî acesso total, n√£o precisa de mais nada
            darAcessoTotal();
        } else {
            // 2. Verificar tabela usuarios (novo sistema)
            // N√£o filtrar por ativo=true para n√£o bloquear se a flag estiver errada
            const userRow = await sb(
                `usuarios?select=*&email=eq.${encodeURIComponent(currentUser.email)}`
            ).catch(() => []);
            const u = userRow?.[0];

            if (u?.e_admin) {
                darAcessoTotal();
            } else if (m?.e_presbitero) {
                // Presb√≠tero via membros
                userPerms = {
                    e_admin: false,
                    ver_dashboard:true, ver_membros:true, ver_eventos:true,
                    ver_ministerios:true, ver_links:true, ver_cultos:true,
                    criar_eventos:true, editar_eventos:true, editar_membros:true,
                    ...(u || {}),
                };
            } else if (u && Object.keys(u).some(k => k.startsWith('ver_') && u[k])) {
                // Utilizador com pelo menos uma permiss√£o activa
                userPerms = { e_admin: false, ...u };
            } else if (u) {
                // Utilizador existe mas sem permiss√µes espec√≠ficas ‚Äî dar acesso m√≠nimo ao dashboard
                userPerms = { e_admin: false, ver_dashboard: true, ...(u || {}) };
            } else {
                // Sem registo em nenhuma tabela ‚Äî bloquear
                document.getElementById('nav-bar').style.display = 'none';
                document.getElementById('main-content').innerHTML = `
                <div class="acesso-negado">
                    <div class="acesso-negado-icon">‚úï</div>
                    <div class="acesso-negado-title">Acesso Restrito</div>
                    <div class="acesso-negado-txt">N√£o tens permiss√µes de acesso ao painel.<br><small style="opacity:0.6">${currentUser.email}</small></div>
                </div>`;
                return;
            }
        }

        // Ocultar abas que o utilizador n√£o pode ver
        aplicarPermissoesNav();

        membros = await sb('membros?select=id,nome&ativo=eq.true&order=nome') || [];
        syncTiposEvento();
        // Ir para a primeira sec√ß√£o vis√≠vel
        const primeiraVisivel = ['dashboard','membros','pastores','links','cultos','ministerios',
            'salas','cursos','keola','loja','eventos','fornecedores','financeiro','configuracoes']
            .find(s => perm(s, 'ver')) || 'membros';
        await setSecao(primeiraVisivel);
    }

    // ‚îÄ‚îÄ SEC√á√ïES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function setSecao(secao) {
        secaoAtiva = secao; filtroInativo = false; subTabAtiva = 0;
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        const nomes = {
            dashboard:'Dashboard',
            membros:'Membros', pastores:'Pastores', links:'Links', cultos:'Cultos',
            ministerios:'Minist√©rios', salas:'Salas', cursos:'Cursos ZAO',
            keola:'Keola ‚Äî Menu', loja:'Loja', eventos:'Eventos',
            tipos_evento:'Tipos de Evento', configuracoes:'Configura√ß√µes',
            fornecedores:'Fornecedores', financeiro:'Financeiro', utilizadores:'Gest√£o de Utilizadores',
        };
        const sl = document.getElementById('secao-label');
        if (sl) sl.textContent = nomes[secao] || 'Cadastros';
        const idx = ['dashboard','membros','pastores','links','cultos','ministerios','salas',
            'cursos','keola','loja','eventos','tipos_evento','fornecedores','financeiro','utilizadores','configuracoes'];
        const ni = document.querySelectorAll('.nav-item')[idx.indexOf(secao)];
        if (ni) ni.classList.add('active');
        await carregarSecao();
    }

    async function carregarSecao() {
        document.getElementById('main-content').innerHTML =
            '<div class="loading"><div class="spin"></div>A carregar...</div>';
        if (secaoAtiva === 'dashboard') {
            renderDashboardGeral(); return;
        }
        if (secaoAtiva === 'tipos_evento') {
            renderTiposEvento(); return;
        }
        if (secaoAtiva === 'eventos') {
            eventosData = await sb('eventos?select=*&order=data_inicio') || [];
            eventoAtivo = null; eventoSubTab = 0;
            renderEventos(); return;
        }
        if (secaoAtiva === 'configuracoes') {
            await carregarConfiguracoes(); return;
        }
        if (secaoAtiva === 'utilizadores') {
            await carregarUtilizadores(); return;
        }
        if (secaoAtiva === 'fornecedores') {
            await carregarFornecedores(); return;
        }
        if (secaoAtiva === 'financeiro') {
            await carregarFinanceiro(); return;
        }
        const cfg = SECOES[secaoAtiva];
        registos = await sb(`${cfg.tabela}?select=*&order=${cfg.orderBy||'nome'}`) || [];
        if (secaoAtiva === 'keola') await carregarComponentesCache();
        if (secaoAtiva === 'membros') {
            if (!links_cache.length)
                links_cache = await sb('links?select=id,nome&ativo=eq.true&order=nome') || [];
            await carregarVisitantes();
        }
        renderSecao();
    }

    // ‚îÄ‚îÄ CONFIG DAS SEC√á√ïES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const SECOES = {
        membros:     { tabela:'membros',       orderBy:'nome',          campos:camposMembros,    subTabs:['Dashboard','Membros','Visitantes'] },
        pastores:    { tabela:'pastores',      orderBy:'nome',          campos:camposPastores },
        links:       { tabela:'links',         orderBy:'nome',          campos:camposLinks },
        cultos:      { tabela:'cultos',        orderBy:'nome',          campos:camposCultos },
        ministerios: { tabela:'ministerios',   orderBy:'nome',          campos:camposMinisterios, subTabs:['Minist√©rio','L√≠deres'] },
        salas:       { tabela:'salas',         orderBy:'nome',          campos:camposSalas },
        cursos:      { tabela:'zao_cursos',    orderBy:'nome',          campos:camposCursos,      subTabs:['Curso','Instrutores'] },
        keola:       { tabela:'keola_menu',    orderBy:'categoria,nome',campos:camposKeola,       ativoKey:'disponivel' },
        loja:        { tabela:'loja_produtos', orderBy:'categoria,nome',campos:camposLoja },
        eventos:     { tabela:'eventos',       orderBy:'data_inicio',   campos:camposEventos,     customRender:true },
    };

    // ‚îÄ‚îÄ RENDER SEC√á√ÉO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function getQ() {
        const el = document.getElementById('toolbar-search-input');
        return el ? el.value.toLowerCase() : '';
    }
    function restoreSearch(q) {
        const el = document.getElementById('toolbar-search-input');
        if (el && q) { el.value = q; el.focus(); el.setSelectionRange(q.length, q.length); }
    }
    function handleSearch() {
        if (secaoAtiva === 'eventos')       { renderEventos();        return; }
        if (secaoAtiva === 'configuracoes') { renderConfiguracoes();   return; }
        renderSecao();
    }

    async function renderSecao() {
        const cfg      = SECOES[secaoAtiva];
        if (!cfg) return;
        const ativoKey = cfg.ativoKey || 'ativo';
        const q        = getQ();
        const temSubTabs = !!cfg.subTabs;
        if (temSubTabs && secaoAtiva === 'membros') {
            if (subTabAtiva === 0) { renderDashboardMembros(); return; }
            if (subTabAtiva === 1) { /* cai para renderSecao normal abaixo */ }
            if (subTabAtiva === 2) { await renderVisitantesTab(); return; }
        } else if (temSubTabs && subTabAtiva >= 1) {
            if (secaoAtiva !== 'membros' && subTabAtiva === 1) { renderInfoSubTab(); return; }
        }
        let lista = [...registos];
        if (!filtroInativo) lista = lista.filter(r => r[ativoKey] !== false);
        else                lista = lista.filter(r => r[ativoKey] === false);
        if (q) lista = lista.filter(r =>
            (r.nome||r.categoria||r.titulo||'').toLowerCase().includes(q)
        );
        let html = `
    <div class="section-toolbar" style="position:sticky;top:0;z-index:10">
        <input class="toolbar-search" id="toolbar-search-input"
               placeholder="Pesquisar..." oninput="handleSearch()" value="">
        <button class="toolbar-filter ${filtroInativo?'active':''}" onclick="toggleFiltroInativo()">Inativos</button>
        <button class="btn-new" onclick="abrirForm(null)" ${btnGuard(secaoAtiva,'criar')}>+ Novo</button>
    </div>`;
        if (temSubTabs) {
            html += `<div class="sub-tabs">
            ${cfg.subTabs.map((t,i)=>`<button class="sub-tab ${subTabAtiva===i?'active':''}" onclick="setSubTab(${i})">${t}</button>`).join('')}
        </div>`;
        }
        if (!lista.length) {
            html += `<div class="empty"><div class="empty-icon">‚Äî</div>
            <div class="empty-txt">${filtroInativo?'Nenhum registo inativo.':'Nenhum registo. Clica em + Novo.'}</div></div>`;
            document.getElementById('main-content').innerHTML = html;
            restoreSearch(q); return;
        }
        html += '<div class="admin-list">';
        lista.forEach((r, i) => {
            const ativo   = r[ativoKey] !== false;
            const imgUrl  = r.foto_url || r.imagem_url;
            let fotoHtml;
            if (imgUrl) {
                const ini = (r.nome||r.categoria||'-')[0];
                fotoHtml = `<div class="admin-row-foto" style="overflow:hidden;padding:0">
                <img src="${imgUrl}" alt="${r.nome||''}"
                     style="width:100%;height:100%;object-fit:cover"
                     onerror="this.parentElement.style.padding='';this.parentElement.innerHTML='${ini}'">
            </div>`;
            } else {
                fotoHtml = `<div class="admin-row-foto">${(r.nome||r.categoria||'-')[0]}</div>`;
            }
            const sub    = buildSub(r);
            const badges = buildBadges(r);
            html += `
        <div class="admin-row ${ativo?'':'inativo'}" style="animation-delay:${Math.min(i,12)*0.02}s">
            ${fotoHtml}
            <div class="admin-row-info">
                <div class="admin-row-nome">${r.nome||r.categoria||'‚Äî'}</div>
                ${sub    ? `<div class="admin-row-sub">${sub}</div>`       : ''}
                ${badges ? `<div class="admin-row-badges">${badges}</div>` : ''}
            </div>
            <div class="admin-row-actions">
                ${secaoAtiva==='keola'&&r.tipo_item==='kit'?patchKeolaRow(r):''}
                <button class="btn-edit" onclick="abrirFormKeola_or_default('${r.id}')" ${btnGuard(secaoAtiva,'editar')}>Editar</button>
                <button class="btn-toggle ${ativo?'ativo':'inativo'}"
                        onclick="toggleAtivo('${r.id}','${ativoKey}',${ativo})" ${btnGuard(secaoAtiva,'eliminar')}>
                    ${ativo?'Inativar':'Ativar'}
                </button>
            </div>
        </div>`;
        });
        html += '</div>';
        document.getElementById('main-content').innerHTML = html;
        restoreSearch(q);
    }

    function renderInfoSubTab() {
        const cfg    = SECOES[secaoAtiva];
        const labels = {ministerios:'l√≠deres', cursos:'instrutores', membros:'filhos'};
        const parent = {ministerios:'minist√©rio', cursos:'curso', membros:'membro'};
        let html = `<div class="sub-tabs">
        ${cfg.subTabs.map((t,i)=>`<button class="sub-tab ${subTabAtiva===i?'active':''}" onclick="setSubTab(${i})">${t}</button>`).join('')}
    </div>
    <div class="admin-list">
        <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:20px;text-align:center;color:var(--text-faint);font-size:13px;line-height:1.8">
            Para gerir ${labels[secaoAtiva]||'itens'}, abre o registo do ${parent[secaoAtiva]||'item'} e edita a partir da√≠.
        </div>
    </div>`;
        document.getElementById('main-content').innerHTML = html;
    }

    async function renderVisitantesTab() {
        const mc = document.getElementById('main-content');
        if (!mc) { console.error('main-content n√£o existe'); return; }

        const cfg = SECOES['membros'];
        if (!cfg) { mc.innerHTML = '<div style="padding:20px;color:red">ERRO: SECOES[membros] n√£o definido</div>'; return; }

        // Loading
        mc.innerHTML = `
    <div class="sub-tabs">
        ${cfg.subTabs.map((t,i)=>`<button class="sub-tab ${subTabAtiva===i?'active':''}" onclick="setSubTab(${i})">${t}</button>`).join('')}
    </div>
    <div style="padding:20px;color:var(--text-faint)">‚è≥ A carregar visitantes do Supabase...</div>`;

        // Carrega SEMPRE directamente do Supabase
        let rawData = [];
        try {
            rawData = await sb('visitantes?select=*&order=nome') || [];
            visitantes = rawData;
            console.log('Visitantes carregados:', visitantes.length, visitantes);
        } catch(e) {
            console.error('Erro visitantes:', e);
            mc.innerHTML += `<div style="padding:16px;color:red;font-size:12px">Erro: ${e?.message||e?.code||JSON.stringify(e)}</div>`;
            return;
        }

        const q   = getQ();
        let lista = [...visitantes];

        const jaConvertido = v => v.convertido === true && v.membro_id;
        if (!filtroInativo) lista = lista.filter(r => r.ativo !== false && !jaConvertido(r));
        else                lista = lista.filter(r => jaConvertido(r) || r.ativo === false);
        if (q) lista = lista.filter(r => (r.nome||'').toLowerCase().includes(q));

        let html = `
    <div class="sub-tabs">
        ${cfg.subTabs.map((t,i)=>`<button class="sub-tab ${subTabAtiva===i?'active':''}" onclick="setSubTab(${i})">${t}</button>`).join('')}
    </div>
    <div class="section-toolbar" style="position:sticky;top:0;z-index:10">
        <input class="toolbar-search" id="toolbar-search-input"
               placeholder="Pesquisar visitante..." oninput="handleSearch()" value="${q}">
        <button class="toolbar-filter ${filtroInativo?'active':''}" onclick="toggleFiltroInativo()">
            ${filtroInativo?'Ver Ativos':'Ver Convertidos'}
        </button>
        <button class="btn-new" onclick="abrirFormVisitante(null)">+ Novo</button>
    </div>
    <div style="padding:6px 16px 2px;font-size:11px;color:var(--text-faint)">
        ${visitantes.length} visitante(s) total ¬∑ ${lista.length} a mostrar
    </div>`;

        if (!lista.length) {
            html += `<div class="empty"><div class="empty-icon">‚Äî</div>
            <div class="empty-txt">${filtroInativo ? 'Nenhum visitante convertido.' : 'Nenhum visitante por converter.'}</div></div>`;
            document.getElementById('main-content').innerHTML = html;
            return;
        }

        html += '<div class="admin-list">';
        lista.forEach((v, i) => {
            const ativo      = v.ativo !== false;
            const convertido = jaConvertido(v);
            const badgeConv  = convertido
                ? '<span class="badge badge-green">‚úì Membro</span>'
                : v.membro_id ? '<span class="badge badge-primary">Vinculado</span>' : '<span class="badge badge-gray">Visitante</span>';
            const sub = [
                v.telefone,
                v.data_visita ? new Date(v.data_visita).toLocaleDateString('pt-PT') : null,
                v.onde_conheceu ? `"${v.onde_conheceu}"` : null,
            ].filter(Boolean).join(' ¬∑ ');

            html += `
        <div class="admin-row ${ativo?'':'inativo'}" style="animation-delay:${Math.min(i,12)*0.02}s">
            <div class="admin-row-foto" style="background:var(--primary-faint);color:var(--primary-dark);font-weight:700">${(v.nome||'V')[0]}</div>
            <div class="admin-row-info">
                <div class="admin-row-nome">${v.nome||'‚Äî'}</div>
                <div class="admin-row-sub">${sub||'Sem dados'}</div>
                <div class="admin-row-badges">${badgeConv}</div>
            </div>
            <div class="admin-row-actions">
                <button class="btn-edit" onclick="abrirFormVisitante('${v.id}')">Editar</button>
                ${!convertido ? `<button class="btn-save" style="padding:6px 10px;font-size:11px" onclick="abrirConversaoMembro('${v.id}')">‚Üí Membro</button>` : ''}
                <button class="btn-toggle ${ativo?'ativo':'inativo'}" onclick="toggleAtivoVisitante('${v.id}',${ativo})">${ativo?'Inativar':'Ativar'}</button>
            </div>
        </div>`;
        });
        html += '</div>';
        document.getElementById('main-content').innerHTML = html;
    }

    // ‚îÄ‚îÄ CONVERS√ÉO VISITANTE ‚Üí MEMBRO (form completo) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function abrirConversaoMembro(visitanteId) {
        const v = visitantes.find(x => x.id === visitanteId);
        if (!v) return;
        // Carrega links para o select
        if (!links_cache.length)
            links_cache = await sb('links?select=id,nome&ativo=eq.true&order=nome') || [];

        document.getElementById('drawer-title').textContent = `Converter em Membro ‚Äî ${v.nome}`;
        document.getElementById('drawer-body').innerHTML = buildFormConversao(v);
        document.getElementById('overlay').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function buildFormConversao(v) {
        const fv = (k, d='') => v?.[k] ?? d;
        const linksOpts = links_cache.map(l=>`<option value="${l.id}">${l.nome}</option>`).join('');
        return `<div class="form-grid">
        <div class="msg-form" id="form-msg"></div>
        <div style="background:var(--primary-faint);border:1px solid var(--border);border-radius:10px;padding:10px 14px;margin-bottom:4px;font-size:12px;color:var(--primary-dark);line-height:1.6" class="form-full">
            <strong>Visitante:</strong> ${v.nome} ¬∑ ${v.email||'‚Äî'} ¬∑ ${v.telefone||'‚Äî'}<br>
            Preenche os dados adicionais e confirma para criar o membro.
        </div>

        <div class="form-section-title">Identifica√ß√£o</div>
        <div class="form-group form-full"><label class="form-label">Nome *</label>
            <input class="form-input" id="fc_nome" type="text" value="${v.nome||''}"></div>
        <div class="form-group"><label class="form-label">Email</label>
            <input class="form-input" id="fc_email" type="email" value="${v.email||''}"></div>
        <div class="form-group"><label class="form-label">Telefone</label>
            <input class="form-input" id="fc_telefone" type="tel" value="${v.telefone||''}"></div>
        <div class="form-group"><label class="form-label">G√©nero</label>
            <select class="form-select" id="fc_genero">
                <option value="">--</option>
                <option value="masculino">Masculino</option>
                <option value="feminino">Feminino</option>
                <option value="outro">Outro</option>
            </select></div>
        <div class="form-group"><label class="form-label">Data Nascimento</label>
            <input class="form-input" id="fc_data_nascimento" type="date"></div>
        <div class="form-group"><label class="form-label">Estado Civil</label>
            <select class="form-select" id="fc_estado_civil">
                <option value="">--</option>
                <option value="solteiro">Solteiro</option>
                <option value="casado">Casado</option>
                <option value="divorciado">Divorciado</option>
                <option value="viuvo">Vi√∫vo</option>
            </select></div>
        <div class="form-group"><label class="form-label">NIF</label>
            <input class="form-input" id="fc_nif" type="text" placeholder="000 000 000"></div>

        <div class="form-section-title">Morada</div>
        <div class="form-group form-full"><label class="form-label">Rua</label>
            <input class="form-input" id="fc_rua" type="text" placeholder="Nome da rua"></div>
        <div class="form-group"><label class="form-label">N√∫mero</label>
            <input class="form-input" id="fc_numero" type="text" placeholder="Nr"></div>
        <div class="form-group"><label class="form-label">Complemento</label>
            <input class="form-input" id="fc_complemento" type="text" placeholder="Andar, porta..."></div>
        <div class="form-group"><label class="form-label">Cidade</label>
            <input class="form-input" id="fc_cidade" type="text" placeholder="Lisboa"></div>
        <div class="form-group"><label class="form-label">C√≥digo Postal</label>
            <input class="form-input" id="fc_codigo_postal" type="text" placeholder="0000-000"></div>
        <div class="form-group"><label class="form-label">Pa√≠s</label>
            <input class="form-input" id="fc_pais" type="text" value="Portugal"></div>
        <div class="form-group"><label class="form-label">Zona (Link)</label>
            <input class="form-input" id="fc_zona" type="text" value="${v.zona||''}" placeholder="Ex: Montijo"></div>

        <div class="form-section-title">Igreja</div>
        <div class="form-group"><label class="form-label">Membro Desde</label>
            <input class="form-input" id="fc_data_entrada" type="date" value="${new Date().toISOString().split('T')[0]}"></div>
        <div class="form-group"><label class="form-label">Link</label>
            <select class="form-select" id="fc_link_id">
                <option value="">-- Sem Link --</option>
                ${linksOpts}
            </select></div>
        <div class="form-group form-full"><label class="form-label">Onde Conheceu</label>
            <input class="form-input" id="fc_onde_conheceu" type="text" value="${v.onde_conheceu||''}"></div>
        <div class="form-group"><label class="form-toggle"><input type="checkbox" id="fc_foi_batizado"><span>Foi Batizado</span></label></div>
        <div class="form-group"><label class="form-label">Data Batismo</label>
            <input class="form-input" id="fc_data_batismo" type="date"></div>

        <div class="form-section-title">Fun√ß√µes</div>
        <div class="form-group"><label class="form-toggle"><input type="checkbox" id="fc_e_voluntario"><span>Volunt√°rio</span></label></div>
        <div class="form-group"><label class="form-toggle"><input type="checkbox" id="fc_e_lider"><span>L√≠der</span></label></div>
        <div class="form-group"><label class="form-toggle"><input type="checkbox" id="fc_e_presbitero"><span>Presb√≠tero</span></label></div>

        <div class="form-section-title">Hist√≥ria</div>
        <div class="form-group form-full"><label class="form-label">Hist√≥ria / Notas</label>
            <textarea class="form-textarea" id="fc_historia" placeholder="Historia do membro..." style="height:80px"></textarea></div>

        <div class="form-actions">
            <button class="btn-cancel-form" onclick="closeDrawer()">Cancelar</button>
            <button class="btn-save" id="btn-save-conv" onclick="confirmarConversao('${v.id}')">‚úì Converter em Membro</button>
        </div>
    </div>`;
    }

    async function confirmarConversao(visitanteId) {
        const v   = visitantes.find(x => x.id === visitanteId);
        if (!v) return;
        const get = id => { const el = document.getElementById(id); return el ? el.value || null : null; };
        const chk = id => { const el = document.getElementById(id); return el ? el.checked : false; };
        const nome = get('fc_nome');
        if (!nome) { showFormMsg('Nome √© obrigat√≥rio.', 'error'); return; }

        const btn = document.getElementById('btn-save-conv');
        btn.disabled = true; btn.textContent = 'A converter...';

        try {
            // 1. Cria o membro
            const membroBody = {
                nome,
                email:          get('fc_email'),
                telefone:       get('fc_telefone'),
                genero:         get('fc_genero'),
                data_nascimento:get('fc_data_nascimento'),
                estado_civil:   get('fc_estado_civil'),
                nif:            get('fc_nif'),
                rua:            get('fc_rua'),
                numero:         get('fc_numero'),
                complemento:    get('fc_complemento'),
                cidade:         get('fc_cidade'),
                codigo_postal:  get('fc_codigo_postal'),
                pais:           get('fc_pais'),
                zona:           get('fc_zona'),
                data_entrada:   get('fc_data_entrada'),
                link_id:        get('fc_link_id'),
                onde_conheceu:  get('fc_onde_conheceu'),
                foi_batizado:   chk('fc_foi_batizado'),
                data_batismo:   get('fc_data_batismo'),
                e_voluntario:   chk('fc_e_voluntario'),
                e_lider:        chk('fc_e_lider'),
                e_presbitero:   chk('fc_e_presbitero'),
                historia:       get('fc_historia'),
                tipo:           'membro',
                ativo:          true,
                convertido_de_visitante_id: visitanteId,
            };
            // Remove campos nulos para n√£o sobrescrever defaults
            Object.keys(membroBody).forEach(k => { if (membroBody[k] === null) delete membroBody[k]; });

            const novoMembro = await sb('membros', { method:'POST', body:JSON.stringify(membroBody) });
            const membroId   = novoMembro?.[0]?.id;
            if (!membroId) throw new Error('Erro ao criar membro ‚Äî sem ID retornado.');

            // 2. Marca o visitante como convertido e vincula o membro
            await sb(`visitantes?id=eq.${visitanteId}`, {
                method: 'PATCH',
                body: JSON.stringify({ convertido: true, membro_id: membroId }),
            });

            // 3. Actualiza o utilizador (usuarios): tipo ‚Üí 'membro', membro_id ‚Üí membroId
            // Tenta encontrar o utilizador pelo email ou pelo visitante_id
            const userByEmail = await sb(`usuarios?email=eq.${encodeURIComponent(v.email || 'none@none')}&select=id`).catch(()=>[]);
            const userByVid   = await sb(`usuarios?visitante_id=eq.${visitanteId}&select=id`).catch(()=>[]);
            const userId      = userByEmail?.[0]?.id || userByVid?.[0]?.id;
            if (userId) {
                await sb(`usuarios?id=eq.${userId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ tipo: 'membro', membro_id: membroId }),
                }).catch(() => {}); // n√£o bloqueia se falhar
            }

            showFormMsg('Convertido com sucesso!', 'success');
            await carregarVisitantes();
            membros = await sb('membros?select=id,nome&ativo=eq.true&order=nome') || [];
            setTimeout(() => { closeDrawer(); renderSecao(); }, 800);

        } catch(e) {
            showFormMsg(`Erro: ${e?.message || e?.details || JSON.stringify(e)}`, 'error');
            btn.disabled = false; btn.textContent = '‚úì Converter em Membro';
        }
    }

    function buildSub(r) {
        const s = secaoAtiva;
        if (s==='membros')     return [r.tipo,r.zona,r.genero].filter(Boolean).join(' ¬∑ ');
        if (s==='pastores')    return [r.cargo,r.email].filter(Boolean).join(' ‚Äî ');
        if (s==='links')       return [r.tipo,r.zona,r.dia].filter(Boolean).join(' ¬∑ ');
        if (s==='cultos')      return [r.dia_semana,r.hora_inicio].filter(Boolean).join(' ‚Äî ');
        if (s==='ministerios') return [r.tipo?'['+r.tipo+']':null,r.descricao?.substring(0,50)].filter(Boolean).join(' ‚Äî ');
        if (s==='salas')       return [r.espaco,r.capacidade?r.capacidade+' pessoas':null].filter(Boolean).join(' ¬∑ ');
        if (s==='cursos')      return [r.carga_horaria,r.gratuito?'Gratuito':r.valor?'‚Ç¨'+r.valor:null].filter(Boolean).join(' ¬∑ ');
        if (s==='keola') {
            const TIPO_LABEL = {componente:'Componente', venda:'Venda', kit:'Kit', normal:'Normal'};
            const tipoStr = TIPO_LABEL[r.tipo_item] || r.tipo_item || '';
            const stockStr = r.stock != null ? `Stock: ${r.stock} ${r.unidade||'un'}` : '';
            const precoStr = r.tipo_item !== 'componente' && r.preco ? '‚Ç¨'+Number(r.preco).toFixed(2) : '';
            return [tipoStr, r.categoria, precoStr, stockStr].filter(Boolean).join(' ¬∑ ');
        }
        if (s==='loja')        return [r.categoria,r.preco?'‚Ç¨'+Number(r.preco).toFixed(2):null].filter(Boolean).join(' ¬∑ ');
        return '';
    }

    function buildBadges(r) {
        const b = [];
        if (r.e_lider)       b.push(`<span class="badge badge-primary">L√≠der</span>`);
        if (r.e_presbitero)  b.push(`<span class="badge badge-primary">Presb√≠tero</span>`);
        if (r.e_voluntario)  b.push(`<span class="badge badge-green">Volunt√°rio</span>`);
        if (r.e_admin)       b.push(`<span class="badge badge-red">Admin</span>`);
        if (r.online)        b.push(`<span class="badge badge-primary">Online</span>`);
        if (r.recorrente)    b.push(`<span class="badge badge-green">Recorrente</span>`);
        if (r.gratuito)      b.push(`<span class="badge badge-green">Gratuito</span>`);
        if (r.especial_hoje) b.push(`<span class="badge badge-primary">Especial hoje</span>`);
        if (r.destaque)      b.push(`<span class="badge badge-primary">Destaque</span>`);
        // Keola badges
        if (r.tipo_item === 'componente') b.push(`<span class="badge badge-gray">Componente</span>`);
        if (r.tipo_item === 'kit')        b.push(`<span class="badge badge-primary">Kit</span>`);
        if (r.tipo_item === 'venda')      b.push(`<span class="badge badge-green">Venda</span>`);
        if (r.mostrar_pdv === false)      b.push(`<span class="badge badge-gray">Oculto no PDV</span>`);
        if (r.stock != null && r.stock_minimo != null && r.stock <= r.stock_minimo && r.stock_minimo > 0)
            b.push(`<span class="badge badge-red">‚ö† Stock baixo</span>`);
        if (r.disponivel===false||r.ativo===false) b.push(`<span class="badge badge-gray">Inativo</span>`);
        return b.join('');
    }

    function toggleFiltroInativo() { filtroInativo = !filtroInativo; renderSecao(); }
    async function setSubTab(idx) {
        subTabAtiva = idx;
        renderSecao();
    }

    // ‚îÄ‚îÄ DASHBOARD MEMBROS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderDashboardMembros() {
        const cfg = SECOES['membros'];
        const totalMembros    = registos.filter(r => r.ativo !== false).length;
        const totalLideres    = registos.filter(r => r.e_lider && r.ativo !== false).length;
        const totalPresbiteros= registos.filter(r => r.e_presbitero && r.ativo !== false).length;
        const totalVoluntarios= registos.filter(r => r.e_voluntario && r.ativo !== false).length;
        const totalVisitantes = visitantes.filter(v => v.ativo !== false && !(v.convertido && v.membro_id)).length;
        const totalConvertidos= visitantes.filter(v => v.convertido && v.membro_id).length;

        // Anivers√°rios do m√™s
        const mesAtual = new Date().getMonth() + 1;
        const anivMes  = registos.filter(r => {
            if (!r.data_nascimento || r.ativo === false) return false;
            return parseInt(r.data_nascimento.split('-')[1]) === mesAtual;
        });

        const statCard = (num, label, cor, sub='') => `
            <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center">
                <div style="font-family:var(--font-title);font-size:28px;font-weight:700;color:${cor}">${num}</div>
                <div style="font-size:11px;color:var(--text-faint);margin-top:3px;text-transform:uppercase;letter-spacing:1px">${label}</div>
                ${sub ? `<div style="font-size:10px;color:var(--text-faint);margin-top:2px">${sub}</div>` : ''}
            </div>`;

        let html = `
    <div class="sub-tabs">
        ${cfg.subTabs.map((t,i)=>`<button class="sub-tab ${subTabAtiva===i?'active':''}" onclick="setSubTab(${i})">${t}</button>`).join('')}
    </div>
    <div style="padding:12px 16px">

        <div style="font-family:var(--font-title);font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--text-faint);margin-bottom:8px">Membros</div>
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:16px">
            ${statCard(totalMembros,    'Total Membros',    'var(--primary-dark)')}
            ${statCard(totalLideres,    'L√≠deres',          'var(--primary)')}
            ${statCard(totalPresbiteros,'Presb√≠teros',      'var(--primary)')}
            ${statCard(totalVoluntarios,'Volunt√°rios',      'var(--green)')}
        </div>

        <div style="font-family:var(--font-title);font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--text-faint);margin-bottom:8px">Visitantes</div>
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:16px">
            ${statCard(totalVisitantes, 'Visitantes Activos','var(--orange,#e65100)', 'Por converter')}
            ${statCard(totalConvertidos,'Convertidos',       'var(--green)',          'J√° s√£o membros')}
        </div>`;

        if (anivMes.length > 0) {
            html += `
        <div style="font-family:var(--font-title);font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--text-faint);margin-bottom:8px">
            üéÇ Anivers√°rios este m√™s (${anivMes.length})
        </div>
        <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:16px">`;
            anivMes.sort((a,b)=>{
                const da = parseInt(a.data_nascimento?.split('-')[2]||0);
                const db = parseInt(b.data_nascimento?.split('-')[2]||0);
                return da - db;
            }).forEach(m => {
                const dia  = m.data_nascimento?.split('-')[2];
                const foto = m.foto_url
                    ? `<img src="${m.foto_url}" style="width:32px;height:32px;border-radius:50%;object-fit:cover;flex-shrink:0" onerror="this.style.display='none'">`
                    : `<div style="width:32px;height:32px;border-radius:50%;background:var(--primary-faint);color:var(--primary-dark);display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0">${(m.nome||'?')[0]}</div>`;
                html += `<div style="display:flex;align-items:center;gap:10px;background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:8px 12px">
                    ${foto}
                    <div style="flex:1">
                        <div style="font-size:13px;font-weight:600;color:var(--text-main)">${m.nome}</div>
                        <div style="font-size:11px;color:var(--text-faint)">Dia ${dia}${m.e_lider?' ¬∑ L√≠der':''}${m.e_presbitero?' ¬∑ Presb√≠tero':''}</div>
                    </div>
                    <div style="font-size:20px">üéÇ</div>
                </div>`;
            });
            html += '</div>';
        }

        html += `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <button class="btn-save" style="margin:0" onclick="setSubTab(1)">Ver Membros ‚Üí</button>
            <button class="btn-save" style="margin:0;background:var(--primary-faint);color:var(--primary-dark);border:1px solid var(--border)" onclick="setSubTab(2)">Ver Visitantes ‚Üí</button>
        </div>
    </div>`;

        document.getElementById('main-content').innerHTML = html;
    }
    async function carregarVisitantes() {
        visitantes = await sb('visitantes?select=*&order=nome') || [];
    }
    function abrirFormVisitante(id) {
        const v = id ? visitantes.find(x=>x.id===id) : null;
        document.getElementById('drawer-title').textContent = v ? 'Editar Visitante' : 'Novo Visitante';
        document.getElementById('drawer-body').innerHTML = buildFormVisitante(v);
        document.getElementById('overlay').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }
    function buildFormVisitante(v) {
        const fv = (k, d='') => v?.[k] ?? d;
        return `<div class="form-grid">
        <div class="msg-form" id="form-msg"></div>
        <div class="form-group form-full"><label class="form-label">Nome</label><input class="form-input" id="fv_nome" type="text" value="${fv('nome')}"></div>
        <div class="form-group"><label class="form-label">Email</label><input class="form-input" id="fv_email" type="email" value="${fv('email')}"></div>
        <div class="form-group"><label class="form-label">Telefone</label><input class="form-input" id="fv_telefone" type="tel" value="${fv('telefone')}"></div>
        <div class="form-group"><label class="form-label">Zona</label><input class="form-input" id="fv_zona" value="${fv('zona')}"></div>
        <div class="form-group"><label class="form-label">Data da Visita</label><input class="form-input" id="fv_data_visita" type="date" value="${fv('data_visita')}"></div>
        <div class="form-group form-full"><label class="form-label">Onde Conheceu</label><input class="form-input" id="fv_onde_conheceu" value="${fv('onde_conheceu')}"></div>
        <div class="form-group form-full"><label class="form-label">Observa√ß√µes</label><textarea class="form-textarea" id="fv_observacoes">${fv('observacoes')}</textarea></div>
        <div class="form-group"><label class="form-toggle"><input type="checkbox" id="fv_convertido" ${fv('convertido')?'checked':''}><span>Convertido</span></label></div>
        <div class="form-group"><label class="form-toggle"><input type="checkbox" id="fv_ativo" ${fv('ativo')!==false?'checked':''}><span>Ativo</span></label></div>
        <div class="form-actions">
            <button class="btn-cancel-form" onclick="closeDrawer()">Cancelar</button>
            <button class="btn-save" id="btn-save" onclick="salvarVisitante('${v?.id||''}')">Guardar</button>
        </div>
    </div>`;
    }
    async function salvarVisitante(id) {
        const get = k => { const el=document.getElementById('fv_'+k); return el?el.value||null:null; };
        const chk = k => { const el=document.getElementById('fv_'+k); return el?el.checked:false; };
        const body = { nome:get('nome'), email:get('email'), telefone:get('telefone'), zona:get('zona'),
            data_visita:get('data_visita'), onde_conheceu:get('onde_conheceu'),
            observacoes:get('observacoes'), convertido:chk('convertido'), ativo:chk('ativo') };
        if (!body.nome) { showFormMsg('Nome obrigat√≥rio.','error'); return; }
        const btn = document.getElementById('btn-save');
        btn.disabled=true; btn.textContent='A guardar...';
        try {
            if (!id) await sb('visitantes',{method:'POST',body:JSON.stringify(body)});
            else     await sb(`visitantes?id=eq.${id}`,{method:'PATCH',body:JSON.stringify(body)});
            showFormMsg('Guardado!','success');
            await carregarVisitantes();
            setTimeout(closeDrawer, 700);
        } catch(e) {
            showFormMsg(`Erro: ${e?.message||JSON.stringify(e)}`,'error');
            btn.disabled=false; btn.textContent='Guardar';
        }
    }
    async function toggleAtivoVisitante(id, ativoAtual) {
        await sb(`visitantes?id=eq.${id}`,{method:'PATCH',body:JSON.stringify({ativo:!ativoAtual})});
        await carregarVisitantes(); renderSecao();
    }

    // ‚îÄ‚îÄ TOGGLE ATIVO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function toggleAtivo(id, key, ativoAtual) {
        try {
            await sb(`${SECOES[secaoAtiva].tabela}?id=eq.${id}`,
                {method:'PATCH', body:JSON.stringify({[key]:!ativoAtual})});
            await carregarSecao();
        } catch(e) { alert('Erro ao alterar estado.'); }
    }

    // ‚îÄ‚îÄ FORM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function abrirFormKeola_or_default(id) {
        if (secaoAtiva === 'keola') {
            await abrirKeolaComCustom(id);
        }
        await abrirForm(id);
    }

    async function abrirForm(id) {
        const cfg     = SECOES[secaoAtiva];
        const registo = id ? registos.find(r=>r.id===id) : null;
        const isNovo  = !registo;
        if (secaoAtiva==='ministerios'||secaoAtiva==='cursos') {
            try {
                const res = await sb('membros?select=id,nome&ativo=eq.true&order=nome');
                if (Array.isArray(res)&&res.length) membros = res;
            } catch(e){}
        }
        if (secaoAtiva==='membros') {
            try {
                const rm = await sb('membros?select=id,nome&ativo=eq.true&order=nome');
                if (Array.isArray(rm)&&rm.length) membros = rm;
                ministeriosCache = await sb('ministerios?select=id,nome,tipo&ativo=eq.true&order=tipo,nome')||[];
            } catch(e){}
        }
        document.getElementById('drawer-title').textContent =
            isNovo ? `Novo ‚Äî ${cfg.label||secaoAtiva}` : 'Editar';
        document.getElementById('drawer-body').innerHTML = buildForm(cfg, registo);
        // Para Keola: injectar painel de componentes de kit
        if (secaoAtiva === 'keola') {
            injectKitPanel(id || null);
        }
        // Aplicar guard de permiss√µes nos campos do form
        setTimeout(() => aplicarPermissoesSecao(secaoAtiva), 50);
        document.getElementById('overlay').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        if (!isNovo&&secaoAtiva==='membros') {
            await carregarFilhos(registo.id);
            await carregarMembroMinisterios(registo.id);
        } else if (!isNovo&&(secaoAtiva==='ministerios'||secaoAtiva==='cursos')) {
            await carregarSubList(registo.id);
        }
    }

    function buildForm(cfg, r) {
        const campos = typeof cfg.campos==='function' ? cfg.campos(r) : cfg.campos;
        let html = `<div class="form-grid"><div class="msg-form" id="form-msg"></div>`;
        campos.forEach(c => {
            if (c.key==='link_id'&&secaoAtiva==='membros') {
                const val2 = r?.[c.key]??'';
                const opts2 = links_cache.map(l=>`<option value="${l.id}" ${val2===l.id?'selected':''}>${l.nome}</option>`).join('');
                html += `<div class="form-group form-full"><label class="form-label">${c.label}</label>
                <select class="form-select" id="f_link_id"><option value="">-- Sem Link --</option>${opts2}</select></div>`;
                return;
            }
            if (c.type==='section') { html += `<div class="form-section-title">${c.label}</div>`; return; }
            const val = r?.[c.key]??c.default??'';
            const fc  = c.full?'form-full':'';
            if (c.type==='checkbox') {
                html += `<div class="form-group ${fc}"><label class="form-toggle">
                <input type="checkbox" id="f_${c.key}" ${val?'checked':''}><span>${c.label}</span></label></div>`;
            } else if (c.type==='select') {
                const opts = c.options.map(o=>`<option value="${o.v}" ${val==o.v?'selected':''}>${o.l}</option>`).join('');
                html += `<div class="form-group ${fc}"><label class="form-label">${c.label}</label>
                <select class="form-select" id="f_${c.key}"><option value="">-- Seleciona --</option>${opts}</select></div>`;
            } else if (c.type==='textarea') {
                html += `<div class="form-group ${fc}"><label class="form-label">${c.label}</label>
                <textarea class="form-textarea" id="f_${c.key}" placeholder="${c.ph||''}">${val}</textarea></div>`;
            } else if (c.type==='image') {
                html += buildImageUpload(c.key, c.label, val, c.bucket||'imagens');
            } else {
                html += `<div class="form-group ${fc}"><label class="form-label">${c.label}</label>
                <input class="form-input" id="f_${c.key}" type="${c.type||'text'}" placeholder="${c.ph||''}" value="${val}"></div>`;
            }
        });
        if (r&&secaoAtiva==='membros') {
            html += `
        <div class="form-section-title">Filhos</div>
        <div class="form-full"><div class="sub-list" id="sub-list"><div class="sub-list-empty">A carregar...</div></div></div>
        <div class="sub-add-row">
            <select class="form-select" id="sub-filho-id"><option value="">Seleciona filho</option>${membros.map(m=>`<option value="${m.id}">${m.nome}</option>`).join('')}</select>
            <button class="btn-sub-add" onclick="addFilho('${r.id}')">Adicionar</button>
        </div>
        <div class="form-section-title">Minist√©rios e √Åreas</div>
        <div class="form-full"><div class="sub-list" id="sub-list-mins"><div class="sub-list-empty">A carregar...</div></div></div>
        <div class="sub-add-row">
            <select class="form-select" id="sub-min-id"><option value="">Seleciona minist√©rio/√°rea</option>${ministeriosCache.map(m=>`<option value="${m.id}">[${m.tipo||'?'}] ${m.nome}</option>`).join('')}</select>
            <input class="form-input" id="sub-min-papel" placeholder="Papel" style="max-width:120px">
            <button class="btn-sub-add" onclick="addMembroMinisterio('${r.id}')">Adicionar</button>
        </div>`;
        }
        if (r&&(secaoAtiva==='ministerios'||secaoAtiva==='cursos')) {
            const sublabel = secaoAtiva==='ministerios'?'L√≠deres':'Instrutores';
            html += `
        <div class="form-section-title">${sublabel}</div>
        <div class="form-full"><div class="sub-list" id="sub-list"><div class="sub-list-empty">A carregar...</div></div></div>
        <div class="sub-add-row">
            <select class="form-select" id="sub-membro-id"><option value="">Seleciona membro</option>${membros.map(m=>`<option value="${m.id}">${m.nome}</option>`).join('')}</select>
            <input class="form-input" id="sub-cargo" placeholder="Cargo" style="max-width:110px">
            ${secaoAtiva==='cursos'?`<input class="form-input" id="sub-nome-instrutor" placeholder="Nome externo" style="max-width:110px">`:''}
            <button class="btn-sub-add" onclick="addSubItem('${r.id}')">Adicionar</button>
        </div>`;
        }
        html += `<div class="form-actions">
        <button class="btn-cancel-form" onclick="closeDrawer()">Cancelar</button>
        <button class="btn-save" id="btn-save" onclick="salvar('${r?.id||''}')">Guardar</button>
    </div></div>`;
        return html;
    }

    async function salvar(id) {
        const cfg    = SECOES[secaoAtiva];
        const isNovo = !id;
        const campos = typeof cfg.campos==='function' ? cfg.campos(null) : cfg.campos;
        const body   = {};
        campos.forEach(c => {
            if (c.type==='section') return;
            const el = document.getElementById(`f_${c.key}`);
            if (!el) return;
            if (c.type==='checkbox')  body[c.key] = el.checked;
            else if (c.type==='number') body[c.key] = el.value?Number(el.value):null;
            else body[c.key] = el.value||null;
        });
        if (cfg.ativoKey&&!(cfg.ativoKey in body)&&isNovo) body[cfg.ativoKey] = true;
        if (!('ativo' in body)&&isNovo&&cfg.tabela!=='keola_menu') body.ativo = true;
        const btn = document.getElementById('btn-save');
        btn.disabled=true; btn.textContent='A guardar...';
        try {
            if (isNovo) await sb(cfg.tabela,{method:'POST',body:JSON.stringify(body)});
            else        await sb(`${cfg.tabela}?id=eq.${id}`,{method:'PATCH',body:JSON.stringify(body)});
            showFormMsg('Guardado com sucesso!','success');
            // Se Keola kit ‚Äî guardar componentes
            if (secaoAtiva === 'keola') {
                const tipoSel = [...document.querySelectorAll('select')].find(s =>
                    s.closest('.form-group')?.querySelector('label')?.textContent?.includes('Tipo de Item')
                );
                if (tipoSel?.value === 'kit' || keolaKitItensTemp.length > 0) {
                    // Obter ID do item (novo ou existente)
                    const itemId = id || (await sb(`keola_menu?select=id&order=created_at.desc&limit=1`).catch(()=>[]))?.[0]?.id;
                    if (itemId) await salvarComponentesKit(itemId);
                }
                await carregarComponentesCache();
            }
            await carregarSecao();
            setTimeout(closeDrawer, 800);
        } catch(e) {
            showFormMsg(`Erro: ${e?.message||e?.details||JSON.stringify(e)}`,'error');
            btn.disabled=false; btn.textContent='Guardar';
        }
    }

    function showFormMsg(txt, tipo) {
        const el = document.getElementById('form-msg');
        if (!el) return;
        el.textContent = txt; el.className = `msg-form ${tipo}`;
        el.scrollIntoView({behavior:'smooth', block:'nearest'});
    }

    // ‚îÄ‚îÄ SUB-ITEMS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let membroMinisteriosData = [];

    async function carregarMembroMinisterios(membroId) {
        const items = await sb(`membro_ministerios?select=*,ministerios(id,nome,tipo)&membro_id=eq.${membroId}&ativo=eq.true&order=id`)||[];
        membroMinisteriosData = items;
        renderSubListMins(membroId);
    }
    function renderSubListMins(membroId) {
        const el = document.getElementById('sub-list-mins');
        if (!el) return;
        if (!membroMinisteriosData.length) {
            el.innerHTML = '<div class="sub-list-empty">Sem minist√©rios/√°reas.</div>'; return;
        }
        el.innerHTML = membroMinisteriosData.map(item => {
            const tipo = item.ministerios?.tipo||'?';
            const nome = item.ministerios?.nome||'‚Äî';
            return `<div class="sub-list-item">
            <span class="badge badge-gray" style="flex-shrink:0">${tipo==='ministerio'?'MIN':'AE'}</span>
            <div class="sub-list-nome">${nome}</div>
            <div class="sub-list-cargo">${item.papel||''}</div>
            <button class="sub-list-remove" onclick="removeMembroMinisterio('${item.id}','${membroId}')">Remover</button>
        </div>`;
        }).join('');
    }
    async function addMembroMinisterio(membroId) {
        const minId = document.getElementById('sub-min-id')?.value;
        const papel = document.getElementById('sub-min-papel')?.value?.trim();
        if (!minId) { alert('Seleciona um minist√©rio ou √°rea.'); return; }
        if (membroMinisteriosData.find(m=>m.ministerio_id===minId)) { alert('J√° associado.'); return; }
        try {
            await sb('membro_ministerios',{method:'POST',body:JSON.stringify({membro_id:membroId,ministerio_id:minId,papel:papel||null,ativo:true})});
            await carregarMembroMinisterios(membroId);
            document.getElementById('sub-min-id').value='';
            document.getElementById('sub-min-papel').value='';
        } catch(e) { alert('Erro: '+JSON.stringify(e)); }
    }
    async function removeMembroMinisterio(itemId, membroId) {
        if (!confirm('Remover desta √°rea/minist√©rio?')) return;
        await sb(`membro_ministerios?id=eq.${itemId}`,{method:'PATCH',body:JSON.stringify({ativo:false})});
        await carregarMembroMinisterios(membroId);
    }
    async function carregarFilhos(membroId) {
        const items = await sb(`membros_filhos?select=*&pai_id=eq.${membroId}&order=created_at`)||[];
        const el = document.getElementById('sub-list');
        if (!el) return;
        if (!items.length) { el.innerHTML='<div class="sub-list-empty">Sem filhos.</div>'; return; }
        el.innerHTML = items.map(item => {
            const filho = membros.find(m=>m.id===item.filho_id);
            return `<div class="sub-list-item">
            <div class="sub-list-nome">${filho?.nome||item.filho_id}</div>
            <div class="sub-list-cargo">Filho/a</div>
            <button class="sub-list-remove" onclick="removeFilho('${item.id}','${membroId}')">Remover</button>
        </div>`;
        }).join('');
    }
    async function addFilho(paiId) {
        const filhoId = document.getElementById('sub-filho-id')?.value;
        if (!filhoId) { alert('Seleciona um membro.'); return; }
        try {
            await sb('membros_filhos',{method:'POST',body:JSON.stringify({pai_id:paiId,filho_id:filhoId})});
            membros = await sb('membros?select=id,nome&ativo=eq.true&order=nome')||[];
            await carregarFilhos(paiId);
            document.getElementById('sub-filho-id').value='';
        } catch(e) { alert('Erro: '+JSON.stringify(e)); }
    }
    async function removeFilho(itemId, paiId) {
        if (!confirm('Remover este filho?')) return;
        await sb(`membros_filhos?id=eq.${itemId}`,{method:'DELETE'});
        await carregarFilhos(paiId);
    }
    async function carregarSubList(parentId) {
        const isMin  = secaoAtiva==='ministerios';
        const tabela = isMin?'ministerio_lideres':'zao_curso_instrutores';
        const fkKey  = isMin?'ministerio_id':'curso_id';
        const items  = await sb(`${tabela}?select=*&${fkKey}=eq.${parentId}&order=created_at`)||[];
        const el     = document.getElementById('sub-list');
        if (!el) return;
        if (!items.length) { el.innerHTML='<div class="sub-list-empty">Sem registos.</div>'; return; }
        el.innerHTML = items.map(item => {
            const membro = membros.find(m=>m.id===item.membro_id);
            const nome   = membro?.nome||item.nome_instrutor||'‚Äî';
            return `<div class="sub-list-item">
            <div class="sub-list-nome">${nome}</div>
            <div class="sub-list-cargo">${item.cargo||''}</div>
            <button class="sub-list-remove" onclick="removeSubItem('${item.id}','${tabela}','${parentId}')">Remover</button>
        </div>`;
        }).join('');
    }
    async function addSubItem(parentId) {
        const isMin  = secaoAtiva==='ministerios';
        const tabela = isMin?'ministerio_lideres':'zao_curso_instrutores';
        const fkKey  = isMin?'ministerio_id':'curso_id';
        const memId  = document.getElementById('sub-membro-id')?.value;
        const cargo  = document.getElementById('sub-cargo')?.value;
        const nomeExt= document.getElementById('sub-nome-instrutor')?.value;
        if (!memId&&!nomeExt) { alert('Seleciona um membro ou indica um nome.'); return; }
        const body = {[fkKey]:parentId, cargo:cargo||null};
        if (memId) body.membro_id = memId;
        if (!isMin&&nomeExt) body.nome_instrutor = nomeExt;
        try {
            await sb(tabela,{method:'POST',body:JSON.stringify(body)});
            await carregarSubList(parentId);
            ['sub-membro-id','sub-cargo','sub-nome-instrutor'].forEach(k=>{ const el=document.getElementById(k); if(el) el.value=''; });
        } catch(e) { alert('Erro ao adicionar.'); }
    }
    async function removeSubItem(itemId, tabela, parentId) {
        if (!confirm('Remover?')) return;
        await sb(`${tabela}?id=eq.${itemId}`,{method:'DELETE'});
        await carregarSubList(parentId);
    }

    // ‚îÄ‚îÄ IMAGE UPLOAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function buildImageUpload(key, label, currentUrl, bucket) {
        const hasImg = !!currentUrl;
        const imgHtml = hasImg
            ? `<img src="${currentUrl}" alt="${label}"
                 style="max-width:100%;max-height:100%;object-fit:contain;display:block;border-radius:6px"
                 onerror="this.parentElement.innerHTML='<div style=\'display:flex;align-items:center;justify-content:center;height:100%;flex-direction:column;gap:6px;color:var(--text-faint)\'><svg width=32 height=32 fill=none stroke=currentColor stroke-width=1.5 viewBox=\'0 0 24 24\'><rect x=3 y=3 width=18 height=18 rx=2/><circle cx=8.5 cy=8.5 r=1.5/><polyline points=\'21,15 16,10 5,21\'/></svg><div style=\'font-size:11px\'>Imagem inv√°lida ou em falta</div></div>'">`
            : `<div style="display:flex;align-items:center;justify-content:center;height:100%;flex-direction:column;gap:10px;color:var(--text-faint)">
                <svg width="36" height="36" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21,15 16,10 5,21"/></svg>
                <div style="font-size:12px;text-align:center;padding:0 12px;font-weight:600">Clica para escolher imagem</div>
                <div style="font-size:11px;color:var(--text-faint)">JPG, PNG, WEBP ¬∑ m√°x 5 MB</div>
               </div>`;
        return `<div class="form-group img-upload-wrap" style="grid-column:1/-1">
        <label class="form-label">${label}</label>
        <div id="img-box-${key}" onclick="triggerFileInput('${key}')"
             style="width:100%;height:240px;border:2px dashed var(--border);border-radius:12px;
                    background:var(--bg-input);cursor:pointer;overflow:hidden;position:relative;
                    transition:border-color 0.2s,background 0.2s;
                    display:flex;align-items:center;justify-content:center"
             onmouseover="this.style.borderColor='var(--primary)';this.style.background='var(--primary-faint)'"
             onmouseout="this.style.borderColor='var(--border)';this.style.background='var(--bg-input)'">
            ${imgHtml}
        </div>
        <div id="img-prog-${key}" style="height:3px;background:var(--border);border-radius:2px;margin-top:6px;overflow:hidden;display:none">
            <div id="img-prog-bar-${key}" style="height:100%;width:0%;background:var(--primary);transition:width 0.3s;border-radius:2px"></div>
        </div>
        <div id="img-status-${key}" style="font-size:11px;margin-top:4px;min-height:16px"></div>
        <div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap">
            <button type="button" class="img-upload-btn" onclick="event.stopPropagation();triggerFileInput('${key}')">Ficheiro</button>
            <button type="button" class="img-upload-btn" onclick="event.stopPropagation();triggerCamera('${key}')">C√¢mara</button>
            ${currentUrl ? `<button type="button" class="img-upload-btn danger" onclick="event.stopPropagation();removeImage('${key}','f_${key}')">Remover</button>` : ''}
        </div>
        <div style="display:flex;gap:6px;margin-top:6px">
            <input type="text" id="img-url-input-${key}" placeholder="Ou cola um URL aqui..."
                   value="${currentUrl||''}"
                   style="flex:1;background:var(--bg-input);border:1px solid var(--border);border-radius:7px;
                          padding:7px 10px;font-size:12px;font-family:var(--font-body);color:var(--text-main);outline:none"
                   onclick="event.stopPropagation()">
            <button type="button" class="img-upload-btn" onclick="event.stopPropagation();applyUrlInput('${key}')">Usar URL</button>
        </div>
        <input type="hidden" id="f_${key}" value="${currentUrl||''}">
        <input type="file" id="img-file-${key}" accept="image/*" style="display:none" onchange="handleFileSelect('${key}','${bucket}',this)">
        <input type="file" id="img-cam-${key}"  accept="image/*" capture="environment" style="display:none" onchange="handleFileSelect('${key}','${bucket}',this)">
    </div>`;
    }
    function triggerFileInput(key) { document.getElementById('img-file-'+key)?.click(); }
    function triggerCamera(key)    { document.getElementById('img-cam-'+key)?.click();  }
    function applyUrlInput(key) {
        const url = document.getElementById('img-url-input-'+key)?.value?.trim();
        if (!url) return;
        document.getElementById('f_'+key).value = url;
        updateImagePreview(key, url);
        setImgStatus(key,'URL aplicado.','ok');
    }
    function removeImage(key, hiddenId) {
        document.getElementById(hiddenId).value = '';
        const urlInput = document.getElementById('img-url-input-' + key);
        if (urlInput) urlInput.value = '';
        const box = document.getElementById('img-box-' + key);
        if (!box) return;
        box.style.borderColor = 'var(--border)';
        box.style.background  = 'var(--bg-input)';
        box.innerHTML = `<div style="display:flex;align-items:center;justify-content:center;height:100%;flex-direction:column;gap:10px;color:var(--text-faint)">
            <svg width="36" height="36" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21,15 16,10 5,21"/></svg>
            <div style="font-size:12px;text-align:center;padding:0 12px;font-weight:600">Clica para escolher imagem</div>
            <div style="font-size:11px;color:var(--text-faint)">JPG, PNG, WEBP ¬∑ m√°x 5 MB</div>
        </div>`;
        setImgStatus(key, 'Imagem removida.', '');
        setTimeout(() => setImgStatus(key, '', ''), 2000);
    }
    function updateImagePreview(key, url) {
        const box = document.getElementById('img-box-' + key);
        if (!box) return;
        box.style.background = 'var(--bg-input)';
        box.style.borderColor = 'var(--primary)';
        box.innerHTML = `<img src="${url}" alt="preview"
            style="max-width:100%;max-height:100%;object-fit:contain;display:block;border-radius:6px"
            onerror="this.parentElement.innerHTML='<div style=\'display:flex;align-items:center;justify-content:center;height:100%;flex-direction:column;gap:6px;color:var(--text-faint)\'><svg width=28 height=28 fill=none stroke=currentColor stroke-width=2 viewBox=\'0 0 24 24\'><circle cx=12 cy=12 r=10/><line x1=12 y1=8 x2=12 y2=12/><line x1=12 y1=16 x2=12.01 y2=16/></svg><div style=\'font-size:11px\'>Erro ao carregar imagem</div></div>'">`
    }
    function setImgStatus(key, msg, tipo) {
        const el = document.getElementById('img-status-' + key);
        if (!el) return;
        el.textContent = msg;
        el.style.fontWeight = tipo ? '600' : 'normal';
        el.style.color = tipo === 'ok' ? 'var(--green)' : tipo === 'err' ? 'var(--red)' : 'var(--text-faint)';
        // Mostrar/ocultar barra de progresso
        const prog = document.getElementById('img-prog-' + key);
        if (prog) prog.style.display = (msg && tipo !== 'ok' && tipo !== 'err') ? 'block' : 'none';
    }
    function resizeImage(file, maxW=800, maxH=800, quality=0.82) {
        return new Promise(resolve => {
            const img = new Image();
            const url = URL.createObjectURL(file);
            img.onload = () => {
                let {width:w, height:h} = img;
                if (w>maxW||h>maxH) { const r=Math.min(maxW/w,maxH/h); w=Math.round(w*r); h=Math.round(h*r); }
                const canvas=document.createElement('canvas');
                canvas.width=w; canvas.height=h;
                canvas.getContext('2d').drawImage(img,0,0,w,h);
                URL.revokeObjectURL(url);
                canvas.toBlob(blob=>resolve(blob),'image/jpeg',quality);
            };
            img.onerror=()=>{ URL.revokeObjectURL(url); resolve(file); };
            img.src=url;
        });
    }
    async function handleFileSelect(key, bucket, input) {
        const file = input.files?.[0];
        if (!file) return;
        // Preview local imediato
        updateImagePreview(key, URL.createObjectURL(file));
        setImgStatus(key, 'A comprimir...', '');
        const prog = document.getElementById('img-prog-' + key);
        const bar  = document.getElementById('img-prog-bar-' + key);
        if (prog) prog.classList.add('active');
        if (bar)  bar.style.width = '20%';
        try {
            // 1. Comprime
            const blob     = await resizeImage(file);
            const filename = `${secaoAtiva}/${Date.now()}-${Math.random().toString(36).slice(2)}.jpg`;
            setImgStatus(key, 'A fazer upload... aguarda', '');
            if (bar) bar.style.width = '50%';
            // Overlay de loading no box
            const boxEl = document.getElementById('img-box-' + key);
            if (boxEl) {
                boxEl.style.borderColor = 'var(--primary)';
                const overlay = document.createElement('div');
                overlay.id = 'upload-overlay-' + key;
                overlay.style.cssText = 'position:absolute;inset:0;background:rgba(0,144,152,0.12);display:flex;align-items:center;justify-content:center;border-radius:10px;z-index:2;backdrop-filter:blur(2px)';
                overlay.innerHTML = '<div style="font-family:var(--font-title);font-size:10px;letter-spacing:2px;color:var(--primary-dark);text-align:center">A FAZER UPLOAD...</div>';
                boxEl.style.position = 'relative';
                boxEl.appendChild(overlay);
            }

            // 2. Upload directo ao Supabase Storage (sem servidor interm√©dio)
            const uploadUrl = `${SUPA_URL}/storage/v1/object/${bucket}/${filename}`;
            const res = await fetch(uploadUrl, {
                method:  'POST',
                headers: {
                    'apikey':        SUPA_KEY,
                    'Authorization': `Bearer ${SUPA_KEY}`,
                    'Content-Type':  'image/jpeg',
                    'x-upsert':      'true',
                },
                body: blob,
            });
            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err?.error || err?.message || `Erro ${res.status}: verifique se o bucket "${bucket}" existe e √© p√∫blico no Supabase`);
            }
            if (bar) bar.style.width = '100%';
            // Remove overlay
            document.getElementById('upload-overlay-' + key)?.remove();

            // 3. URL p√∫blica
            const publicUrl = `${SUPA_URL}/storage/v1/object/public/${bucket}/${filename}`;
            document.getElementById('f_' + key).value             = publicUrl;
            document.getElementById('img-url-input-' + key).value = publicUrl;
            updateImagePreview(key, publicUrl);
            setImgStatus(key, `Upload conclu√≠do! (${Math.round(blob.size / 1024)} KB)`, 'ok');
        } catch(e) {
            document.getElementById('upload-overlay-' + key)?.remove();
            setImgStatus(key, 'Erro: ' + e.message, 'err');
            console.error('Upload error:', e);
        } finally {
            setTimeout(() => { if (prog) prog.classList.remove('active'); if (bar) bar.style.width = '0%'; }, 2500);
            input.value = '';
        }
    }

    // ‚îÄ‚îÄ DRAWER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function closeDrawer() {
        document.getElementById('overlay').classList.add('hidden');
        document.body.style.overflow='';
    }
    function closeDrawerOutside(e) {
        if (e.target===document.getElementById('overlay')) closeDrawer();
    }
    document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeDrawer(); });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CONFIGURA√á√ïES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let configData = [];
    async function carregarConfiguracoes() {
        configData = await sb('configuracoes?select=*&order=chave') || [];
        renderConfiguracoes();
    }
    function renderConfiguracoes() {
        const q = getQ();
        let lista = [...configData];
        if (q) lista = lista.filter(c =>
            c.chave.toLowerCase().includes(q) ||
            (c.valor||'').toLowerCase().includes(q) ||
            (c.descricao||'').toLowerCase().includes(q)
        );
        let html = `
    <div class="section-toolbar" style="position:sticky;top:0;z-index:10">
        <input class="toolbar-search" id="toolbar-search-input"
               placeholder="Pesquisar configura√ß√£o..." oninput="handleSearch()" value="">
        <button class="btn-new" onclick="abrirFormConfig(null)">+ Nova</button>
    </div>
    <div style="padding:8px 16px 4px">
        <div style="font-size:11px;color:var(--text-faint);line-height:1.6">
            Cada <strong>chave</strong> √© usada dinamicamente no c√≥digo.
        </div>
    </div>`;
        if (!lista.length) {
            html += '<div class="empty"><div class="empty-icon">‚öô</div><div class="empty-txt">Nenhuma configura√ß√£o encontrada.</div></div>';
            document.getElementById('main-content').innerHTML = html;
            restoreSearch(q); return;
        }
        html += `<div style="padding:0 16px 16px;overflow-x:auto">
    <table class="config-table"><thead><tr>
        <th>Chave</th><th>Valor</th><th>Descri√ß√£o</th><th>Atualizado</th><th></th>
    </tr></thead><tbody>`;
        lista.forEach(c => {
            const dt    = c.updated_at ? new Date(c.updated_at).toLocaleDateString('pt-PT',{day:'2-digit',month:'short',year:'numeric'}) : '‚Äî';
            const isUrl = (c.valor||'').startsWith('http');
            const valHtml = isUrl
                ? `<a href="${c.valor}" target="_blank" style="color:var(--primary);font-size:12px;word-break:break-all">${c.valor}</a>`
                : `<span style="word-break:break-all">${c.valor||'‚Äî'}</span>`;
            html += `<tr>
            <td><span class="config-chave">${c.chave}</span></td>
            <td>${valHtml}</td>
            <td><span class="config-desc">${c.descricao||'‚Äî'}</span></td>
            <td><span class="config-date">${dt}</span></td>
            <td><div class="config-actions">
                <button class="btn-edit" onclick="abrirFormConfig('${c.chave}')">Editar</button>
                <button class="btn-toggle ativo" onclick="eliminarConfig('${c.chave}')">Apagar</button>
            </div></td>
        </tr>`;
        });
        html += `</tbody></table></div>`;
        document.getElementById('main-content').innerHTML = html;
        restoreSearch(q);
    }
    function abrirFormConfig(chave) {
        const c = chave ? configData.find(x=>x.chave===chave) : null;
        document.getElementById('drawer-title').textContent = c ? 'Editar Configura√ß√£o' : 'Nova Configura√ß√£o';
        document.getElementById('drawer-body').innerHTML = `<div class="form-grid">
        <div class="msg-form" id="form-msg"></div>
        <div class="form-group form-full">
            <label class="form-label">Chave</label>
            <input class="form-input" id="fc_chave" type="text" placeholder="ex: endereco"
                   value="${c?.chave||''}" ${c?'readonly':''}>
        </div>
        <div class="form-group form-full">
            <label class="form-label">Valor</label>
            <textarea class="form-textarea" id="fc_valor" style="height:80px">${c?.valor||''}</textarea>
        </div>
        <div class="form-group form-full">
            <label class="form-label">Descri√ß√£o</label>
            <input class="form-input" id="fc_descricao" type="text" placeholder="Para que serve?" value="${c?.descricao||''}">
        </div>
        <div class="form-actions">
            <button class="btn-cancel-form" onclick="closeDrawer()">Cancelar</button>
            <button class="btn-save" id="btn-save" onclick="salvarConfig('${c?.chave||''}')">Guardar</button>
        </div>
    </div>`;
        document.getElementById('overlay').classList.remove('hidden');
        document.body.style.overflow='hidden';
    }
    async function salvarConfig(chaveOriginal) {
        const chave    = document.getElementById('fc_chave')?.value?.trim().toLowerCase().replace(/\s+/g,'_');
        const valor    = document.getElementById('fc_valor')?.value?.trim();
        const descricao= document.getElementById('fc_descricao')?.value?.trim();
        if (!chave) { showFormMsg('Chave obrigat√≥ria.','error'); return; }
        if (!valor) { showFormMsg('Valor obrigat√≥rio.','error'); return; }
        const btn = document.getElementById('btn-save');
        btn.disabled=true; btn.textContent='A guardar...';
        try {
            const body = {chave, valor, descricao:descricao||null, updated_at:new Date().toISOString()};
            if (!chaveOriginal) await sb('configuracoes',{method:'POST',body:JSON.stringify(body)});
            else await sb(`configuracoes?chave=eq.${chaveOriginal}`,{method:'PATCH',body:JSON.stringify(body)});
            showFormMsg('Guardado!','success');
            await carregarConfiguracoes();
            setTimeout(closeDrawer, 700);
        } catch(e) {
            showFormMsg(`Erro: ${e?.message||e?.details||JSON.stringify(e)}`,'error');
            btn.disabled=false; btn.textContent='Guardar';
        }
    }
    async function eliminarConfig(chave) {
        if (!confirm(`Apagar a configura√ß√£o "${chave}"?`)) return;
        try {
            await sb(`configuracoes?chave=eq.${chave}`,{method:'DELETE'});
            await carregarConfiguracoes();
        } catch(e) { alert('Erro ao apagar: '+JSON.stringify(e)); }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CAMPOS DAS SEC√á√ïES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function camposMembros() { return [
        {type:'section',label:'Identifica√ß√£o'},
        {key:'nome',            label:'Nome',              ph:'Nome completo',     full:true},
        {key:'email',           label:'Email',             type:'email',           ph:'email@exemplo.com'},
        {key:'telefone',        label:'Telefone',          ph:'+351 9XX XXX XXX'},
        {key:'genero',          label:'G√©nero',            type:'select', options:[{v:'masculino',l:'Masculino'},{v:'feminino',l:'Feminino'},{v:'outro',l:'Outro'}]},
        {key:'data_nascimento', label:'Data Nascimento',   type:'date'},
        {key:'estado_civil',    label:'Estado Civil',      type:'select', options:[{v:'solteiro',l:'Solteiro'},{v:'casado',l:'Casado'},{v:'divorciado',l:'Divorciado'},{v:'viuvo',l:'Vi√∫vo'}]},
        {key:'nif',             label:'NIF',               ph:'000 000 000'},
        {key:'foto_url',        label:'Foto',              type:'image', bucket:'imagens', full:true},
        {type:'section',label:'Morada'},
        {key:'rua',             label:'Rua',               ph:'Nome da rua',       full:true},
        {key:'numero',          label:'N√∫mero',            ph:'Nr'},
        {key:'complemento',     label:'Complemento',       ph:'Andar, porta...'},
        {key:'cidade',          label:'Cidade',            ph:'Lisboa'},
        {key:'codigo_postal',   label:'C√≥digo Postal',     ph:'0000-000'},
        {key:'pais',            label:'Pa√≠s',              ph:'Portugal',          default:'Portugal'},
        {key:'zona',            label:'Zona (Link)',        ph:'Ex: Montijo'},
        {type:'section',label:'Igreja'},
        {key:'tipo',            label:'Tipo',              type:'select', options:[{v:'membro',l:'Membro'},{v:'admin',l:'Administrador'}]},
        {key:'data_entrada',    label:'Membro Desde',      type:'date'},
        {key:'onde_conheceu',   label:'Onde Conheceu',     ph:'Como soube da Zion?', full:true},
        {key:'foi_batizado',    label:'Foi Batizado',      type:'checkbox'},
        {key:'data_batismo',    label:'Data Batismo',      type:'date'},
        {key:'tem_filhos',      label:'Tem Filhos',        type:'checkbox'},
        {key:'numero_filhos',   label:'Nr Filhos',         type:'number', ph:'0'},
        {type:'section',label:'Fun√ß√µes'},
        {key:'e_lider',         label:'L√≠der',             type:'checkbox'},
        {key:'e_presbitero',    label:'Presb√≠tero',        type:'checkbox'},
        {key:'e_voluntario',    label:'Volunt√°rio',        type:'checkbox'},
        {key:'e_admin',         label:'Administrador',     type:'checkbox'},
        {key:'professor',       label:'Professor',         type:'checkbox'},
        {type:'section',label:'Hist√≥ria'},
        {key:'historia',        label:'Hist√≥ria',          type:'textarea', ph:'Hist√≥ria do membro...', full:true},
        {key:'ativo',           label:'Ativo',             type:'checkbox', default:true},
    ];}
    function camposPastores() { return [
        {key:'nome',      label:'Nome',      ph:'Nome completo',     full:true},
        {key:'cargo',     label:'Cargo',     ph:'Ex: Pastor Principal'},
        {key:'email',     label:'Email',     type:'email',           ph:'email@exemplo.com'},
        {key:'telefone',  label:'Telefone',  ph:'+351 9XX XXX XXX'},
        {key:'instagram', label:'Instagram', ph:'@handle'},
        {key:'foto_url',  label:'Foto',      type:'image', bucket:'imagens', full:true},
        {key:'bio',       label:'Biografia', type:'textarea',        ph:'Breve biografia...', full:true},
        {key:'ativo',     label:'Ativo',     type:'checkbox',        default:true},
    ];}
    function camposLinks() { return [
        {type:'section',       label:'Identifica√ß√£o'},
        {key:'nome',           label:'Nome',              ph:'Ex: LINK Montijo',  full:true},
        {key:'tipo',           label:'Tipo',              type:'select', options:[
                {v:'Familias',l:'Fam√≠lias'},{v:'FLOW',l:'FLOW'},{v:'VOX',l:'VOX'},
                {v:'Diamantes',l:'Diamantes'},{v:'EKLECTOS',l:'EKLECTOS'}
            ]},
        {key:'faixa_etaria',   label:'Faixa Et√°ria',      ph:'Ex: 18-35 anos'},
        {key:'capacidade',     label:'Capacidade',        type:'number', ph:'20'},
        {type:'section',       label:'Lideran√ßa'},
        {key:'responsavel',    label:'Respons√°vel',       ph:'Nome do l√≠der',     full:true},
        {key:'co_responsavel', label:'Co-Respons√°vel',    ph:'Nome do co-l√≠der',  full:true},
        {key:'anfitrioes',     label:'Anfitri√µes',        ph:'Nomes...',          full:true},
        {type:'section',       label:'Hor√°rio'},
        {key:'dia',            label:'Dia',               type:'select', options:[
                {v:'Segunda-feira',l:'Segunda-feira'},{v:'Ter√ßa-feira',l:'Ter√ßa-feira'},
                {v:'Quarta-feira',l:'Quarta-feira'},{v:'Quinta-feira',l:'Quinta-feira'},
                {v:'Sexta-feira',l:'Sexta-feira'},{v:'S√°bado',l:'S√°bado'},{v:'Domingo',l:'Domingo'}
            ]},
        {key:'horario',        label:'Hor√°rio',           ph:'Ex: 20h00'},
        {key:'online',         label:'√â Online',          type:'checkbox'},
        {type:'section',       label:'Localiza√ß√£o'},
        {key:'zona',           label:'Zona',              ph:'Ex: Montijo'},
        {key:'distrito',       label:'Distrito',          ph:'Ex: Set√∫bal'},
        {key:'morada',         label:'Morada',            ph:'Rua...', full:true},
        {key:'codigo_postal',  label:'C√≥d. Postal',       ph:'Ex: 2870-001'},
        {type:'section',       label:'Contacto'},
        {key:'contato',        label:'Contacto (WhatsApp)',ph:'+351 9XX XXX XXX', full:true},
        {key:'ativo',          label:'Ativo',             type:'checkbox', default:true},
    ];}
    function camposCultos() { return [
        {key:'nome',            label:'Nome',           ph:'Ex: Culto de Domingo', full:true},
        {key:'dia_semana',      label:'Dia',            type:'select', options:[
                {v:'Domingo',l:'Domingo'},{v:'Segunda-feira',l:'Segunda-feira'},
                {v:'Ter√ßa-feira',l:'Ter√ßa-feira'},{v:'Quarta-feira',l:'Quarta-feira'},
                {v:'Quinta-feira',l:'Quinta-feira'},{v:'Sexta-feira',l:'Sexta-feira'},{v:'S√°bado',l:'S√°bado'}
            ]},
        {key:'hora_inicio',     label:'Hora In√≠cio',    type:'time'},
        {key:'hora_fim',        label:'Hora Fim',        type:'time'},
        {key:'recorrente',      label:'Recorrente',     type:'checkbox', default:true},
        {key:'data_especifica', label:'Data Espec√≠fica', type:'date', full:true},
        {key:'descricao',       label:'Descri√ß√£o',      type:'textarea', ph:'...', full:true},
        {key:'ativo',           label:'Ativo',           type:'checkbox', default:true},
    ];}
    function camposMinisterios() { return [
        {key:'nome',         label:'Nome',         ph:'Ex: Minist√©rio de Louvor', full:true},
        {key:'tipo',         label:'Tipo',         type:'select', options:[{v:'ministerio',l:'Minist√©rio'},{v:'area',l:'√Årea de Equipa'}]},
        {key:'slug',         label:'Slug',         ph:'Ex: louvor'},
        {key:'faixa_etaria', label:'Faixa Et√°ria', ph:'Ex: Todas as idades'},
        {key:'instagram',    label:'Instagram',    ph:'@handle'},
        {key:'descricao',    label:'Descri√ß√£o',    type:'textarea', ph:'...', full:true},
        {key:'ativo',        label:'Ativo',        type:'checkbox', default:true},
    ];}
    function camposSalas() { return [
        {key:'nome',               label:'Nome',          ph:'Ex: Sala Principal', full:true},
        {key:'espaco',             label:'Espa√ßo',        ph:'Ex: Piso 1'},
        {key:'capacidade',         label:'Capacidade',    type:'number', ph:'20'},
        {key:'hora_inicio',        label:'Hora Abertura', type:'time'},
        {key:'hora_fim',           label:'Hora Fecho',    type:'time'},
        {key:'descricao',          label:'Descri√ß√£o',     type:'textarea', ph:'...', full:true},
        {key:'aviso_entrega',      label:'Aviso Entrega', type:'textarea', ph:'...', full:true},
        {key:'foto_url',           label:'Foto',          type:'image', bucket:'imagens', full:true},
        {key:'google_calendar_id', label:'Google Calendar ID', ph:'calendar@...', full:true},
        {type:'section',label:'Equipamentos'},
        {key:'tem_som',            label:'Som',           type:'checkbox'},
        {key:'tem_iluminacao',     label:'Ilumina√ß√£o',    type:'checkbox'},
        {key:'tem_projecao',       label:'Proje√ß√£o',      type:'checkbox'},
        {key:'tem_mesas',          label:'Mesas',         type:'checkbox'},
        {key:'tem_cadeiras',       label:'Cadeiras',      type:'checkbox'},
        {key:'ativo',              label:'Ativo',         type:'checkbox', default:true},
    ];}
    function camposCursos() { return [
        {key:'nome',          label:'Nome',           ph:'Ex: Curso de Louvor', full:true},
        {key:'carga_horaria', label:'Carga Hor√°ria',  ph:'Ex: 40 horas'},
        {key:'valor',         label:'Valor (‚Ç¨)',       type:'number', ph:'0.00'},
        {key:'gratuito',      label:'Gratuito',        type:'checkbox'},
        {key:'descricao',     label:'Descri√ß√£o',       type:'textarea', ph:'...', full:true},
        {key:'ativo',         label:'Ativo',           type:'checkbox', default:true},
    ];}
    function camposKeola() { return [
        {key:'nome',          label:'Nome',            ph:'Ex: Caf√© Especial', full:true},
        {key:'categoria',     label:'Categoria',       type:'select', options:[
                {v:'almoco',l:'Almo√ßo'},{v:'bebidas',l:'Bebidas'},{v:'sumos',l:'Sumos'},
                {v:'snacks',l:'Snacks'},{v:'sobremesas',l:'Sobremesas'},{v:'outro',l:'Outros'}
            ]},
        {key:'descricao',     label:'Descri√ß√£o',       type:'textarea', ph:'Breve descri√ß√£o...', full:true},
        {key:'preco',         label:'Pre√ßo (‚Ç¨)',        type:'number', ph:'0.00'},
        {key:'ordem',         label:'Ordem',            type:'number', ph:'1'},
        {key:'imagem_url',    label:'Foto do Produto',  type:'image', bucket:'imagens', full:true},
        {key:'disponivel',    label:'Dispon√≠vel',       type:'checkbox', default:true},
        {key:'especial_hoje', label:'Especial Hoje',    type:'checkbox'},
    ];}
    function camposLoja() { return [
        // ‚îÄ‚îÄ IDENTIFICA√á√ÉO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        {type:'section', label:'Identifica√ß√£o'},
        {key:'nome',          label:'Nome *',        ph:'Ex: B√≠blia NVI Capa Dura', full:true},
        {key:'categoria',     label:'Categoria',     type:'select', options:[
            {v:'Livros',l:'Livros'},{v:'Biblia',l:'B√≠blias'},{v:'Vestuario',l:'Vestu√°rio'},
            {v:'Acessorios',l:'Acess√≥rios'},{v:'Musica',l:'M√∫sica'},{v:'Decoracao',l:'Decora√ß√£o'},
            {v:'Infantil',l:'Infantil'},{v:'Papelaria',l:'Papelaria'},{v:'Outros',l:'Outros'},
        ]},
        {key:'subcategoria',  label:'Subcategoria',  ph:'Ex: Devocionais'},
        {key:'descricao',     label:'Descri√ß√£o',     type:'textarea', ph:'Descri√ß√£o do produto...', full:true},
        {key:'sku',           label:'SKU',           ph:'Ex: BIB-NVI-001'},
        {key:'codigo_barras', label:'C√≥d. Barras',   ph:'Ex: 7891234567890'},
        {key:'marca',         label:'Marca',         ph:'Ex: Editora Vida'},
        {key:'fornecedor',    label:'Fornecedor',    ph:'Ex: Distribuidora X'},
        {key:'tags',          label:'Tags',          ph:'livro, b√≠blia, nvi (separado por v√≠rgula)', full:true},
        {key:'modelo',        label:'Modelo',        ph:'Ex: Standard'},

        // ‚îÄ‚îÄ PRE√áOS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        {type:'section', label:'Pre√ßos'},
        {key:'preco',              label:'Pre√ßo de Venda (‚Ç¨)',  type:'number', ph:'0.00'},
        {key:'preco_custo',        label:'Pre√ßo de Custo (‚Ç¨)',  type:'number', ph:'0.00'},
        {key:'preco_promocional',  label:'Pre√ßo Promo (‚Ç¨)',     type:'number', ph:'0.00'},
        {key:'desconto_pct',       label:'Desconto (%)',        type:'number', ph:'0'},
        {key:'margem_lucro',       label:'Margem Lucro (%)',    type:'number', ph:'0'},
        {key:'data_inicio_promo',  label:'In√≠cio Promo√ß√£o',     type:'date'},
        {key:'data_fim_promo',     label:'Fim Promo√ß√£o',        type:'date'},

        // ‚îÄ‚îÄ ESTOQUE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        {type:'section', label:'Estoque'},
        {key:'stock',           label:'Estoque Actual',    type:'number', ph:'0'},
        {key:'stock_minimo',    label:'Estoque M√≠nimo',   type:'number', ph:'0'},
        {key:'stock_maximo',    label:'Estoque M√°ximo',   type:'number', ph:'0'},
        {key:'localizacao',     label:'Localiza√ß√£o',       ph:'Ex: Prateleira A2'},
        {key:'controlar_estoque',   label:'Controlar Estoque',   type:'checkbox', default:true},
        {key:'venda_sem_estoque',   label:'Vender sem Estoque',  type:'checkbox'},

        // ‚îÄ‚îÄ VARIA√á√ïES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        {type:'section', label:'Varia√ß√µes (Roupa / Produto)'},
        {key:'cor',          label:'Cor',         ph:'Ex: Azul, Preto'},
        {key:'tamanho',      label:'Tamanho',     ph:'Ex: M, G, 42'},
        {key:'genero',       label:'G√©nero',      type:'select', options:[
            {v:'',l:'--'},{v:'masculino',l:'Masculino'},{v:'feminino',l:'Feminino'},
            {v:'unissex',l:'Unissex'},{v:'infantil',l:'Infantil'},
        ]},
        {key:'material',     label:'Material',    ph:'Ex: Algod√£o 100%'},
        {key:'tipo_tecido',  label:'Tipo Tecido', ph:'Ex: Jersey, Flanela'},
        {key:'estacao',      label:'Esta√ß√£o',     type:'select', options:[
            {v:'',l:'--'},{v:'verao',l:'Ver√£o'},{v:'inverno',l:'Inverno'},{v:'primavera',l:'Primavera'},{v:'outono',l:'Outono'},{v:'todas',l:'Todas'},
        ]},
        {key:'voltagem',     label:'Voltagem',    ph:'Ex: 110V / 220V'},
        {key:'edicao',       label:'Edi√ß√£o',      ph:'Ex: 1¬™ Edi√ß√£o'},
        {key:'sku_variacao',         label:'SKU Varia√ß√£o',      ph:'Ex: BIB-NVI-001-AZ-G'},
        {key:'preco_variacao',       label:'Pre√ßo Varia√ß√£o (‚Ç¨)', type:'number', ph:'0.00'},
        {key:'estoque_variacao',     label:'Estoque Varia√ß√£o',  type:'number', ph:'0'},

        // ‚îÄ‚îÄ LIVROS / B√çBLIAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        {type:'section', label:'Livros & B√≠blias'},
        {key:'autor',            label:'Autor',           ph:'Ex: Charles Spurgeon'},
        {key:'editora',          label:'Editora',         ph:'Ex: Editora Vida Nova'},
        {key:'isbn',             label:'ISBN',            ph:'Ex: 978-85-000-0000-0'},
        {key:'num_paginas',      label:'N¬∫ de P√°ginas',   type:'number', ph:'0'},
        {key:'ano_publicacao',   label:'Ano Publica√ß√£o',  type:'number', ph:'2024'},
        {key:'idioma',           label:'Idioma',          type:'select', options:[
            {v:'',l:'--'},{v:'portugues',l:'Portugu√™s'},{v:'ingles',l:'Ingl√™s'},
            {v:'espanhol',l:'Espanhol'},{v:'outro',l:'Outro'},
        ]},
        {key:'tipo_capa',        label:'Tipo de Capa',    type:'select', options:[
            {v:'',l:'--'},{v:'dura',l:'Capa Dura'},{v:'brochura',l:'Brochura'},{v:'flexivel',l:'Flex√≠vel'},
        ]},

        // ‚îÄ‚îÄ ENVIO / DIMENS√ïES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        {type:'section', label:'Dimens√µes & Envio'},
        {key:'peso',          label:'Peso (kg)',       type:'number', ph:'0.00'},
        {key:'altura',        label:'Altura (cm)',     type:'number', ph:'0'},
        {key:'largura',       label:'Largura (cm)',    type:'number', ph:'0'},
        {key:'comprimento',   label:'Comprimento (cm)',type:'number', ph:'0'},
        {key:'frete_gratis',  label:'Frete Gr√°tis',   type:'checkbox'},
        {key:'classe_envio',  label:'Classe Envio',   ph:'Ex: Standard, Expresso'},

        // ‚îÄ‚îÄ IMAGEM & DESTAQUE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        {type:'section', label:'Imagem & Visibilidade'},
        {key:'imagem_url',    label:'Imagem',          type:'image', bucket:'imagens', full:true},
        {key:'data_lancamento', label:'Data Lan√ßamento', type:'date'},
        {key:'ordem',         label:'Ordem Exibi√ß√£o',  type:'number', ph:'1'},
        {key:'disponivel',    label:'Dispon√≠vel',      type:'checkbox', default:true},
        {key:'ativo',         label:'Ativo',           type:'checkbox', default:true},
        {key:'destaque',      label:'Destaque',        type:'checkbox'},
        {key:'novo_lancamento',label:'Novo Lan√ßamento',type:'checkbox'},
        {key:'mais_vendido',  label:'Mais Vendido',    type:'checkbox'},
        {key:'frete_gratis',  label:'Frete Gr√°tis',   type:'checkbox'},
    ];}

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // EVENTOS ‚Äî COMPLETAMENTE REESCRITO
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const STATUS_EVENTO = {
        aberto:   {label:'Aberto',    cls:'badge-green'},
        em_curso: {label:'Em Curso',  cls:'badge-primary'},
        concluido:{label:'Conclu√≠do', cls:'badge-gray'},
        cancelado:{label:'Cancelado', cls:'badge-red'},
    };

    let eventosData        = [];
    let presencasData      = [];
    let lideresMinisterios = {};
    let presSearchQ        = '';
    let eventoAtivo        = null;
    let eventoSubTab       = 0;

    // Participantes seleccionados para novo evento (array de {id, nome})
    let eventoParticipantesSel = [];

    function renderEventos() {
        const q        = getQ();
        const filtroSt = document.getElementById('evt-filtro-status')?.value||'';
        let lista = [...eventosData].sort((a,b)=>new Date(a.data_inicio)-new Date(b.data_inicio));
        if (q)        lista = lista.filter(e=>(e.titulo||'').toLowerCase().includes(q)||(e.local||'').toLowerCase().includes(q));
        if (filtroSt) lista = lista.filter(e=>e.status===filtroSt);

        if (eventoAtivo && eventoSubTab===1) { renderPresencas(); return; }

        let html = `
    <div class="section-toolbar" style="position:sticky;top:0;z-index:10">
        <input class="toolbar-search" id="toolbar-search-input"
               placeholder="Pesquisar evento..." oninput="handleSearch()" value="${q}">
        <select class="toolbar-filter" id="evt-filtro-status" onchange="renderEventos()"
                style="border-radius:20px;padding:7px 12px;border:1px solid var(--border);background:var(--bg-input);font-family:var(--font-title);font-size:9px;color:var(--text-muted);cursor:pointer">
            <option value="">Todos</option>
            <option value="aberto">Abertos</option>
            <option value="em_curso">Em Curso</option>
            <option value="concluido">Conclu√≠dos</option>
            <option value="cancelado">Cancelados</option>
        </select>
        <button class="btn-new" onclick="abrirFormEvento(null)">+ Novo</button>
    </div>`;

        if (!lista.length) {
            html+='<div class="empty"><div class="empty-icon">‚Äî</div><div class="empty-txt">Nenhum evento.</div></div>';
            document.getElementById('main-content').innerHTML=html;
            restoreSearch(q); return;
        }

        html+='<div class="admin-list" style="padding:12px 16px">';
        lista.forEach((e,i)=>{
            const st   = STATUS_EVENTO[e.status]||STATUS_EVENTO.aberto;
            const dI   = e.data_inicio?new Date(e.data_inicio).toLocaleDateString('pt-PT',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}):'‚Äî';
            const dF   = e.data_fim?new Date(e.data_fim).toLocaleDateString('pt-PT',{day:'2-digit',month:'short'}):'';
            const btns = [];
            if(e.status==='aberto')    { btns.push(`<button class="btn-edit" onclick="abrirFormEvento('${e.id}')">Editar</button>`); btns.push(`<button class="btn-toggle ativo" onclick="iniciarEvento('${e.id}')">Iniciar</button>`); }
            if(e.status==='em_curso')  { btns.push(`<button class="btn-edit" onclick="abrirPresencas('${e.id}')">Presen√ßas</button>`); btns.push(`<button class="btn-toggle ativo" onclick="concluirEvento('${e.id}')">Concluir</button>`); }
            if(e.status!=='cancelado'&&e.status!=='concluido') btns.push(`<button class="btn-toggle ativo" onclick="cancelarEvento('${e.id}')">Cancelar</button>`);
            if(e.status==='concluido'||e.status==='cancelado') btns.push(`<button class="btn-edit" onclick="abrirPresencas('${e.id}')">Ver Resumo</button>`);
            if(e.status==='concluido') btns.push(`<button class="btn-edit" style="color:var(--red);border-color:var(--red-border)" onclick="gerarRelatorioEvento('${e.id}')">PDF</button>`);
            html+=`
        <div class="admin-row" style="animation-delay:${Math.min(i,12)*0.02}s;flex-direction:column;align-items:stretch;gap:8px">
            <div style="display:flex;align-items:center;gap:12px">
                <div class="admin-row-foto" style="background:var(--primary-faint)">${(e.titulo||'E')[0]}</div>
                <div class="admin-row-info">
                    <div class="admin-row-nome">${e.titulo||'‚Äî'}</div>
                    <div class="admin-row-sub">${dI}${dF?' ‚Äî '+dF:''} ${e.local?'¬∑ '+e.local:''}</div>
                    <div class="admin-row-badges">
                        <span class="badge ${st.cls}">${st.label}</span>
                        ${e.gratuito?'<span class="badge badge-green">Gratuito</span>':''}
                        ${e.destaque?'<span class="badge badge-primary">Destaque</span>':''}
                        ${e.tipo?`<span class="badge badge-gray">${e.tipo}</span>`:''}
                    </div>
                </div>
            </div>
            <div class="admin-row-actions" style="justify-content:flex-end">${btns.join('')}</div>
        </div>`;
        });
        html+='</div>';
        document.getElementById('main-content').innerHTML=html;
        restoreSearch(q);
    }

    // ‚îÄ‚îÄ INICIAR EVENTO (l√≥gica nova) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function iniciarEvento(id) {
        const evento = eventosData.find(e=>e.id===id);
        if (!evento) return;
        const isLideres = evento.tipo === 'Reuni√£o de L√≠deres';

        if (!confirm(`Iniciar "${evento.titulo}"?${isLideres?' Todos os l√≠deres ser√£o adicionados automaticamente. Poder√°s adicionar mais participantes na lista de presen√ßas.':' Ir√°s gerir os participantes na lista de presen√ßas.'}`)) return;

        await sb(`eventos?id=eq.${id}`,{method:'PATCH',body:JSON.stringify({status:'em_curso'})});

        if (isLideres) {
            // Adiciona todos os l√≠deres automaticamente
            const lideres = await sb('membros?select=id,nome&e_lider=eq.true&ativo=eq.true');
            if (lideres?.length) {
                const rows = lideres.map(l=>({evento_id:id, membro_id:l.id, status:'pendente'}));
                await sb('evento_presencas',{method:'POST',body:JSON.stringify(rows)});
            }
        }
        // Se n√£o for l√≠deres, come√ßa vazio ‚Äî gest√£o manual na lista de presen√ßas

        eventosData = await sb('eventos?select=*&order=data_inicio')||[];
        renderEventos();
    }

    async function cancelarEvento(id) {
        if(!confirm('Cancelar este evento?')) return;
        await sb(`eventos?id=eq.${id}`,{method:'PATCH',body:JSON.stringify({status:'cancelado'})});
        eventosData = await sb('eventos?select=*&order=data_inicio')||[];
        renderEventos();
    }

    async function concluirEvento(id) {
        if(!confirm('Concluir? Pendentes ser√£o marcados como faltaram.')) return;
        await sb(`evento_presencas?evento_id=eq.${id}&status=eq.pendente`,{method:'PATCH',body:JSON.stringify({status:'faltou'})});
        await sb(`eventos?id=eq.${id}`,{method:'PATCH',body:JSON.stringify({status:'concluido'})});
        eventosData = await sb('eventos?select=*&order=data_inicio')||[];
        eventoAtivo=null; eventoSubTab=0; renderEventos();
    }

    async function abrirPresencas(id) {
        eventoAtivo  = eventosData.find(e=>e.id===id);
        eventoSubTab = 1;
        presencasData= await sb(`evento_presencas?select=*,membros(id,nome,telefone,foto_url)&evento_id=eq.${id}&order=created_at`)||[];
        const membroIds = presencasData.map(p=>p.membro_id).filter(Boolean);
        lideresMinisterios={};
        if(membroIds.length) {
            const vincs = await sb(`membro_ministerios?select=membro_id,papel,ministerios(id,nome,tipo)&membro_id=in.(${membroIds.join(',')})&ativo=eq.true`)||[];
            vincs.forEach(v=>{
                if(!lideresMinisterios[v.membro_id]) lideresMinisterios[v.membro_id]=[];
                lideresMinisterios[v.membro_id].push({papel:v.papel,nome:v.ministerios?.nome||'‚Äî',tipo:v.ministerios?.tipo||'‚Äî'});
            });
        }
        renderPresencas();
    }

    // ‚îÄ‚îÄ ADD PARTICIPANTE MANUAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function addParticipanteManual() {
        const sel   = document.getElementById('add-membro-sel');
        const memId = sel?.value;
        if (!memId) return;
        if (presencasData.find(p=>p.membro_id===memId)) { alert('Este membro j√° est√° na lista.'); return; }
        try {
            const rows = [{evento_id: eventoAtivo.id, membro_id: memId, status:'pendente'}];
            await sb('evento_presencas',{method:'POST',body:JSON.stringify(rows)});
            await abrirPresencas(eventoAtivo.id);
        } catch(e) { alert('Erro ao adicionar: '+JSON.stringify(e)); }
    }

    function renderPresencas() {
        const evento  = eventoAtivo;
        const st      = STATUS_EVENTO[evento?.status]||STATUS_EVENTO.aberto;
        const emCurso = evento?.status==='em_curso';
        const q       = presSearchQ.toLowerCase();
        let lista     = [...presencasData];
        if(q) lista = lista.filter(p=>(p.membros?.nome||'').toLowerCase().includes(q));

        const presentes = presencasData.filter(p=>p.status==='presente').length;
        const faltaram  = presencasData.filter(p=>p.status==='faltou').length;
        const comMotivo = presencasData.filter(p=>p.status==='faltou_motivo').length;
        const pendentes = presencasData.filter(p=>p.status==='pendente').length;
        const total     = presencasData.length;

        // Membros n√£o adicionados ainda (para o select de adicionar)
        const jaAdicionados = new Set(presencasData.map(p=>p.membro_id));
        const membrosDisponiveis = membros.filter(m=>!jaAdicionados.has(m.id));

        let html=`
    <div class="section-toolbar" style="position:sticky;top:0;z-index:10;flex-wrap:wrap;gap:6px">
        <button class="btn-edit" onclick="voltarListaEventos()">‚Üê Voltar</button>
        ${eventoAtivo?.status==='concluido'?`<button class="btn-edit" style="color:var(--red);border-color:var(--red-border)" onclick="gerarRelatorioEvento('${eventoAtivo.id}')">PDF</button>`:''}
        <input class="toolbar-search" id="pres-search" placeholder="Pesquisar..."
               oninput="presSearchQ=this.value;renderPresencas()" style="flex:1;min-width:120px">
        ${emCurso?`<button class="btn-new" onclick="finalizarEntradas()">Finalizar Entradas</button>`:''}
    </div>

    <div style="padding:10px 16px 0">
        <div style="font-family:var(--font-title);font-size:14px;color:var(--primary-dark);margin-bottom:6px">${evento?.titulo||'‚Äî'}</div>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
            <span class="badge ${st.cls}">${st.label}</span>
            <span class="badge badge-green">‚úì Presentes: ${presentes}</span>
            <span class="badge badge-red">‚úó Faltaram: ${faltaram+comMotivo}</span>
            ${comMotivo?`<span class="badge badge-primary">! Com motivo: ${comMotivo}</span>`:''}
            ${pendentes?`<span class="badge badge-gray">¬∑ Pendentes: ${pendentes}</span>`:''}
            <span class="badge badge-gray">Total: ${total}</span>
        </div>
    </div>`;

        // ‚îÄ‚îÄ Painel adicionar participante ‚Äî sempre vis√≠vel em eventos em curso ‚îÄ‚îÄ
        if (emCurso) {
            html += `
    <div style="padding:10px 16px 4px">
        <div class="add-member-panel">
            <div class="add-member-panel-title">Adicionar participante</div>
            <div class="add-member-row">
                <select class="form-select" id="add-membro-sel" style="flex:1">
                    <option value="">Seleciona um membro...</option>
                    ${membrosDisponiveis.map(m=>`<option value="${m.id}">${m.nome}</option>`).join('')}
                </select>
                <button class="btn-sub-add" onclick="addParticipanteManual()">+ Adicionar</button>
            </div>
        </div>
    </div>`;
        }

        html += '<div class="gold-line" style="margin:8px 16px"></div>';

        // ‚îÄ‚îÄ Lista de participantes por grupo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        if(!lista.length) {
            html+='<div class="empty"><div class="empty-txt">Nenhum participante encontrado.</div></div>';
        } else {
            const grupos=[
                {key:'presente',      label:'Presentes',           items:lista.filter(p=>p.status==='presente')},
                {key:'pendente',      label:'Pendentes',            items:lista.filter(p=>p.status==='pendente')},
                {key:'faltou_motivo', label:'Faltaram c/ Motivo',  items:lista.filter(p=>p.status==='faltou_motivo')},
                {key:'faltou',        label:'Faltaram',             items:lista.filter(p=>p.status==='faltou')},
            ].filter(g=>g.items.length>0);

            grupos.forEach(grupo=>{
                html+=`<div style="padding:8px 16px 2px;font-family:var(--font-title);font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--text-faint)">${grupo.label} (${grupo.items.length})</div>`;
                html+='<div class="admin-list" style="padding:4px 16px 8px">';
                grupo.items.forEach((p,i)=>{
                    const nome   = p.membros?.nome||'‚Äî';
                    const stIcon = {presente:'‚úì',faltou:'‚úó',faltou_motivo:'!',pendente:'¬∑'}[p.status]||'¬∑';
                    const stColor= {presente:'var(--green)',faltou:'var(--red)',faltou_motivo:'var(--orange)',pendente:'var(--border)'}[p.status]||'var(--border)';
                    const mins   = lideresMinisterios[p.membro_id]||[];
                    const minsHtml=mins.map(m=>`<span class="badge badge-gray" style="font-size:8px">${m.tipo==='ministerio'?'MIN':'AE'} ¬∑ ${m.nome}${m.papel?' ¬∑ '+m.papel:''}</span>`).join('');
                    let btns='';
                    if(emCurso&&p.status!=='presente')      btns+=`<button class="btn-toggle inativo" onclick="marcarPresenca('${p.id}','presente')">Presente</button>`;
                    if(emCurso&&p.status!=='faltou')        btns+=`<button class="btn-toggle ativo" onclick="marcarPresenca('${p.id}','faltou')">Faltou</button>`;
                    if(emCurso&&p.status!=='faltou_motivo') btns+=`<button class="btn-edit" onclick="abrirMotivo('${p.id}','${nome.replace(/'/g,"\\'")}')">Com Motivo</button>`;
                    if(emCurso&&p.status!=='pendente')      btns+=`<button class="btn-edit" style="color:var(--text-faint)" onclick="marcarPresenca('${p.id}','pendente')" title="Desfazer">‚Ü©</button>`;
                    let zapBtn='';
                    if(p.membros?.telefone){
                        const tel=p.membros.telefone.replace(/\D/g,'');
                        const dEvt=eventoAtivo?.data_inicio?new Date(eventoAtivo.data_inicio).toLocaleDateString('pt-PT',{weekday:'long',day:'numeric',month:'long',hour:'2-digit',minute:'2-digit'}):'';
                        const msg=encodeURIComponent(`Ol√° ${p.membros.nome?.split(' ')[0]}! Gostar√≠amos de confirmar a tua presen√ßa na ${eventoAtivo?.titulo||'reuni√£o'} a realizar ${dEvt}. Podes confirmar?`);
                        zapBtn=`<a href="https://api.whatsapp.com/send?phone=${tel}&text=${msg}" target="_blank" rel="noopener"
                        style="display:inline-flex;align-items:center;gap:4px;font-size:11px;color:#25D366;text-decoration:none;padding:2px 6px;border-radius:6px;border:1px solid rgba(37,211,102,0.3);background:rgba(37,211,102,0.06)">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="#25D366"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>Zap</a>`;
                    }
                    const fotoSrc=p.membros?.foto_url;
                    const fotoHtml=fotoSrc
                        ?`<img src="${fotoSrc}" style="width:36px;height:36px;border-radius:50%;object-fit:cover;flex-shrink:0;border:2px solid ${stColor}" onerror="this.style.display='none'">`
                        :`<div class="admin-row-foto" style="font-size:13px;font-weight:bold;color:${stColor}">${stIcon}</div>`;
                    html+=`<div class="admin-row" style="animation-delay:${Math.min(i,20)*0.01}s;flex-wrap:wrap;gap:6px">
                    ${fotoHtml}
                    <div class="admin-row-info" style="min-width:0;flex:1">
                        <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
                            <span class="admin-row-nome">${nome}</span>${zapBtn}
                        </div>
                        <div class="admin-row-badges" style="margin-top:3px;flex-wrap:wrap;gap:3px">
                            ${minsHtml||'<span style="font-size:10px;color:var(--text-faint)">Sem √°reas</span>'}
                        </div>
                        ${p.motivo?`<div class="admin-row-sub" style="color:var(--orange);margin-top:3px">Motivo: ${p.motivo}</div>`:''}
                    </div>
                    <div class="admin-row-actions">${btns}</div>
                </div>`;
                });
                html+='</div>';
            });
        }

        // ‚îÄ‚îÄ Gr√°ficos e resumo ‚Äî DEPOIS da lista ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        if (evento?.status === 'concluido' || evento?.status === 'em_curso') {
            html += '<div class="gold-line" style="margin:12px 16px 4px"></div>';
            html += `<div style="padding:6px 16px 2px;font-family:var(--font-title);font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--text-faint)">Resumo e Gr√°ficos</div>`;
            html += renderGraficosResumo(presencasData, lideresMinisterios);
        }

        document.getElementById('main-content').innerHTML=html;
        const si=document.getElementById('pres-search');
        if(si){si.value=presSearchQ;si.focus();si.setSelectionRange(si.value.length,si.value.length);}
    }

    // ‚îÄ‚îÄ GR√ÅFICOS RESUMO (tela) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderGraficosResumo(pres, minsMap) {
        const presentes = pres.filter(p=>p.status==='presente').length;
        const faltaram  = pres.filter(p=>p.status==='faltou').length;
        const comMotivo = pres.filter(p=>p.status==='faltou_motivo').length;
        const total     = pres.length;
        const pct       = total > 0 ? Math.round(presentes/total*100) : 0;

        // Stats cards
        let html = `<div class="resumo-stats">
        <div class="resumo-stat">
            <div class="resumo-stat-num" style="color:var(--green)">${presentes}</div>
            <div class="resumo-stat-label">Presentes</div>
            <div class="resumo-stat-pct" style="color:var(--green)">${pct}%</div>
        </div>
        <div class="resumo-stat">
            <div class="resumo-stat-num" style="color:var(--red)">${faltaram}</div>
            <div class="resumo-stat-label">Faltaram</div>
            <div class="resumo-stat-pct" style="color:var(--red)">${total>0?Math.round(faltaram/total*100):0}%</div>
        </div>
        <div class="resumo-stat">
            <div class="resumo-stat-num" style="color:var(--orange,#e65100)">${comMotivo}</div>
            <div class="resumo-stat-label">Com Motivo</div>
            <div class="resumo-stat-pct" style="color:var(--orange,#e65100)">${total>0?Math.round(comMotivo/total*100):0}%</div>
        </div>
        <div class="resumo-stat">
            <div class="resumo-stat-num" style="color:var(--text-muted)">${total}</div>
            <div class="resumo-stat-label">Total</div>
            <div class="resumo-stat-pct" style="color:var(--text-faint)">100%</div>
        </div>
    </div>`;

        html += '<div class="resumo-graficos">';

        // Pizza geral presen√ßa
        html += buildGraficoPizza([
            {label:'Presentes',   val:presentes, cor:'#2e7d32'},
            {label:'Com Motivo',  val:comMotivo, cor:'#e65100'},
            {label:'Faltaram',    val:faltaram,  cor:'#c62828'},
        ], 'Presen√ßas Geral', total);

        // Por √°rea/minist√©rio
        const porArea = {};
        pres.forEach(p=>{
            const mins = minsMap[p.membro_id]||[{tipo:'Sem √°rea',nome:'Sem √°rea',papel:''}];
            mins.forEach(m=>{
                const k = `${m.tipo}||${m.nome}`;
                if (!porArea[k]) porArea[k]={tipo:m.tipo, nome:m.nome, presentes:0, faltaram:0, total:0};
                porArea[k].total++;
                if (p.status==='presente') porArea[k].presentes++;
                else if (p.status==='faltou'||p.status==='faltou_motivo') porArea[k].faltaram++;
            });
        });

        const areas = Object.values(porArea).sort((a,b)=>b.total-a.total);
        if (areas.length > 0) {
            html += buildGraficoBarras(areas, 'Presen√ßas por √Årea / Minist√©rio');
        }

        html += '</div>';
        return html;
    }

    function buildGraficoPizza(dados, titulo, total) {
        if (total === 0) return '';
        // SVG pizza simples
        const r   = 60;
        const cx  = 70;
        const cy  = 70;
        let paths = '';
        let startAngle = -Math.PI / 2;
        dados.forEach(d => {
            if (d.val === 0) return;
            const angle = (d.val / total) * Math.PI * 2;
            const endAngle = startAngle + angle;
            const x1 = cx + r * Math.cos(startAngle);
            const y1 = cy + r * Math.sin(startAngle);
            const x2 = cx + r * Math.cos(endAngle);
            const y2 = cy + r * Math.sin(endAngle);
            const largeArc = angle > Math.PI ? 1 : 0;
            paths += `<path d="M${cx},${cy} L${x1.toFixed(1)},${y1.toFixed(1)} A${r},${r} 0 ${largeArc},1 ${x2.toFixed(1)},${y2.toFixed(1)} Z" fill="${d.cor}" opacity="0.9"/>`;
            startAngle = endAngle;
        });
        // C√≠rculo central (donut)
        paths += `<circle cx="${cx}" cy="${cy}" r="30" fill="var(--bg-card)"/>`;
        paths += `<text x="${cx}" y="${cy-5}" text-anchor="middle" font-size="14" font-weight="bold" fill="var(--text-main)">${total}</text>`;
        paths += `<text x="${cx}" y="${cy+12}" text-anchor="middle" font-size="9" fill="var(--text-faint)">TOTAL</text>`;

        const legend = dados.map(d=>`
        <div class="pizza-legend-item">
            <div class="pizza-legend-dot" style="background:${d.cor}"></div>
            <span>${d.label}: <strong>${d.val}</strong> (${total>0?Math.round(d.val/total*100):0}%)</span>
        </div>`).join('');

        return `<div class="grafico-wrap">
        <div class="grafico-titulo">${titulo}</div>
        <div class="pizza-wrap">
            <svg class="pizza-svg" width="140" height="140" viewBox="0 0 140 140">${paths}</svg>
            <div class="pizza-legend">${legend}</div>
        </div>
    </div>`;
    }

    function buildGraficoBarras(areas, titulo) {
        const max = Math.max(...areas.map(a=>a.total), 1);
        const barras = areas.map(a=>{
            const pct = Math.round(a.presentes / (a.total||1) * 100);
            const wP  = Math.round(a.presentes / max * 100);
            const wF  = Math.round(a.faltaram  / max * 100);
            const tipoLabel = a.tipo==='ministerio' ? 'MIN' : a.tipo==='Sem √°rea' ? '‚Äî' : 'AE';
            return `
        <div style="margin-bottom:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:3px">
                <span style="font-size:11px;color:var(--text-main);max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
                    <span style="font-size:9px;background:var(--bg-input);padding:1px 5px;border-radius:4px;color:var(--text-faint);margin-right:5px">${tipoLabel}</span>${a.nome}
                </span>
                <span style="font-size:10px;font-weight:bold;color:${pct>=80?'var(--green)':pct>=50?'var(--orange,#e65100)':'var(--red)'}">${pct}%</span>
            </div>
            <div style="display:flex;gap:4px;height:12px">
                <div style="flex:${a.presentes||0};background:#2e7d32;border-radius:4px 0 0 4px;opacity:0.8;min-width:${a.presentes?'4px':'0'}"></div>
                <div style="flex:${a.faltaram||0};background:#c62828;border-radius:0 4px 4px 0;opacity:0.8;min-width:${a.faltaram?'4px':'0'}"></div>
            </div>
            <div style="font-size:10px;color:var(--text-faint);margin-top:2px">${a.presentes} presentes ¬∑ ${a.faltaram} faltaram ¬∑ ${a.total} total</div>
        </div>`;
        }).join('');

        return `<div class="grafico-wrap">
        <div class="grafico-titulo">${titulo}</div>
        <div style="display:flex;gap:12px;margin-bottom:10px">
            <div style="display:flex;align-items:center;gap:5px;font-size:11px"><div style="width:12px;height:12px;background:#2e7d32;border-radius:2px;opacity:0.8"></div>Presentes</div>
            <div style="display:flex;align-items:center;gap:5px;font-size:11px"><div style="width:12px;height:12px;background:#c62828;border-radius:2px;opacity:0.8"></div>Faltaram</div>
        </div>
        ${barras}
    </div>`;
    }

    function voltarListaEventos() { eventoAtivo=null; eventoSubTab=0; presSearchQ=''; renderEventos(); }

    async function marcarPresenca(presencaId, novoStatus) {
        const patch={status:novoStatus,registado_em:new Date().toISOString()};
        if(novoStatus==='pendente') patch.motivo='';
        await sb(`evento_presencas?id=eq.${presencaId}`,{method:'PATCH',body:JSON.stringify(patch)});
        const idx=presencasData.findIndex(p=>p.id===presencaId);
        if(idx>=0){presencasData[idx].status=novoStatus;if(novoStatus==='pendente') presencasData[idx].motivo='';}
        renderPresencas();
    }

    async function finalizarEntradas() {
        if(!eventoAtivo) return;
        if(!confirm('Pendentes ser√£o marcados como faltaram.')) return;
        await sb(`evento_presencas?evento_id=eq.${eventoAtivo.id}&status=eq.pendente`,{method:'PATCH',body:JSON.stringify({status:'faltou'})});
        presencasData.forEach(p=>{if(p.status==='pendente') p.status='faltou';});
        renderPresencas();
    }

    let motivoPresencaId=null;
    function abrirMotivo(presencaId, nome) {
        motivoPresencaId=presencaId;
        document.getElementById('drawer-title').textContent=`Motivo ‚Äî ${nome}`;
        document.getElementById('drawer-body').innerHTML=`<div class="form-grid">
        <div class="form-group form-full">
            <label class="form-label">Motivo da Falta</label>
            <textarea class="form-textarea" id="motivo-txt" placeholder="Descreve o motivo..." style="height:100px"></textarea>
        </div>
        <div class="form-actions">
            <button class="btn-cancel-form" onclick="closeDrawer()">Cancelar</button>
            <button class="btn-save" onclick="guardarMotivo()">Guardar</button>
        </div>
    </div>`;
        document.getElementById('overlay').classList.remove('hidden');
        document.body.style.overflow='hidden';
    }
    async function guardarMotivo() {
        const motivo=document.getElementById('motivo-txt')?.value?.trim();
        if(!motivo){alert('Escreve o motivo.');return;}
        await sb(`evento_presencas?id=eq.${motivoPresencaId}`,{method:'PATCH',body:JSON.stringify({status:'faltou_motivo',motivo,registado_em:new Date().toISOString()})});
        const idx=presencasData.findIndex(p=>p.id===motivoPresencaId);
        if(idx>=0){presencasData[idx].status='faltou_motivo';presencasData[idx].motivo=motivo;}
        closeDrawer(); renderPresencas();
    }

    // ‚îÄ‚îÄ FORM EVENTO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function abrirFormEvento(id) {
        const e=id?eventosData.find(x=>x.id===id):null;
        document.getElementById('drawer-title').textContent=e?'Editar Evento':'Novo Evento';
        document.getElementById('drawer-body').innerHTML=buildFormEvento(e);
        document.getElementById('overlay').classList.remove('hidden');
        document.body.style.overflow='hidden';
    }

    function buildFormEvento(e) {
        const fv =(k,d='')=>e?.[k]??d;
        const fdt=k=>{const v=e?.[k];if(!v)return'';return new Date(v).toISOString().slice(0,16);};
        const tipoOpts = TIPOS_EVENTO.map(t=>`<option value="${t}" ${fv('tipo')===t?'selected':''}>${t}</option>`).join('');
        return `<div class="form-grid">
        <div class="msg-form" id="form-msg"></div>
        <div class="form-section-title">Identifica√ß√£o</div>
        <div class="form-group form-full"><label class="form-label">T√≠tulo</label><input class="form-input" id="fe_titulo" type="text" placeholder="Nome do evento" value="${fv('titulo')}"></div>
        <div class="form-group">
            <label class="form-label">Tipo</label>
            <select class="form-select" id="fe_tipo">
                <option value="">-- Seleciona --</option>
                ${tipoOpts}
            </select>
        </div>
        <div class="form-group"><label class="form-label">Local</label><input class="form-input" id="fe_local" type="text" placeholder="Ex: Sede Lisboa" value="${fv('local')}"></div>
        <div class="form-group form-full"><label class="form-label">Descri√ß√£o</label><textarea class="form-textarea" id="fe_descricao">${fv('descricao')}</textarea></div>
        <div class="form-section-title">Data e Hora</div>
        <div class="form-group"><label class="form-label">Data In√≠cio</label><input class="form-input" id="fe_data_inicio" type="datetime-local" value="${fdt('data_inicio')}"></div>
        <div class="form-group"><label class="form-label">Data Fim</label><input class="form-input" id="fe_data_fim" type="datetime-local" value="${fdt('data_fim')}"></div>
        <div class="form-section-title">Inscri√ß√£o</div>
        <div class="form-group"><label class="form-label">Valor (‚Ç¨)</label><input class="form-input" id="fe_valor" type="number" placeholder="0.00" value="${fv('valor')}"></div>
        <div class="form-group"><label class="form-label">Link Inscri√ß√£o</label><input class="form-input" id="fe_link_inscricao" type="url" placeholder="https://..." value="${fv('link_inscricao')}"></div>
        <div class="form-group"><label class="form-toggle"><input type="checkbox" id="fe_gratuito" ${fv('gratuito')?'checked':''}><span>Gratuito</span></label></div>
        <div class="form-group"><label class="form-toggle"><input type="checkbox" id="fe_destaque" ${fv('destaque')?'checked':''}><span>Destaque</span></label></div>
        <div class="form-group"><label class="form-toggle"><input type="checkbox" id="fe_ativo" ${fv('ativo')!==false?'checked':''}><span>Ativo</span></label></div>
        <div class="form-actions">
            <button class="btn-cancel-form" onclick="closeDrawer()">Cancelar</button>
            <button class="btn-save" id="btn-save" onclick="salvarEvento('${e?.id||''}')">Guardar</button>
        </div>
    </div>`;
    }

    async function salvarEvento(id) {
        const get=k=>{const el=document.getElementById('fe_'+k);return el?el.value||null:null;};
        const chk=k=>{const el=document.getElementById('fe_'+k);return el?el.checked:false;};
        const body={titulo:get('titulo'),tipo:get('tipo'),local:get('local'),descricao:get('descricao'),
            data_inicio:get('data_inicio'),data_fim:get('data_fim'),
            valor:get('valor')?Number(get('valor')):null,link_inscricao:get('link_inscricao'),
            gratuito:chk('gratuito'),destaque:chk('destaque'),ativo:chk('ativo')};
        if(!body.titulo){showFormMsg('T√≠tulo obrigat√≥rio.','error');return;}
        const btn=document.getElementById('btn-save');
        btn.disabled=true;btn.textContent='A guardar...';
        try {
            if(!id){body.status='aberto';await sb('eventos',{method:'POST',body:JSON.stringify(body)});}
            else await sb(`eventos?id=eq.${id}`,{method:'PATCH',body:JSON.stringify(body)});
            showFormMsg('Guardado!','success');
            eventosData=await sb('eventos?select=*&order=data_inicio')||[];
            setTimeout(()=>{closeDrawer();renderEventos();},700);
        } catch(err) {
            showFormMsg('Erro: '+(err?.message||JSON.stringify(err)),'error');
            btn.disabled=false;btn.textContent='Guardar';
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // TIPOS DE EVENTO ‚Äî gest√£o na tela
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const TIPOS_EVENTO_DEFAULT = [
        'Reuni√£o de L√≠deres','Culto Especial','Confer√™ncia','Retiro',
        'Treinamento','Workshop','Confer√™ncia de Jovens','Encontro de Casais',
        'Culto de Ora√ß√£o','Semin√°rio','Outro',
    ];

    function getTiposEvento() {
        try {
            const saved = localStorage.getItem('zion_tipos_evento');
            return saved ? JSON.parse(saved) : [...TIPOS_EVENTO_DEFAULT];
        } catch { return [...TIPOS_EVENTO_DEFAULT]; }
    }
    function saveTiposEvento(lista) {
        localStorage.setItem('zion_tipos_evento', JSON.stringify(lista));
        syncTiposEvento(); // actualiza o array TIPOS_EVENTO em mem√≥ria
    }

    function renderTiposEvento() {
        const lista = getTiposEvento();
        let html = `
    <div class="section-toolbar" style="position:sticky;top:0;z-index:10">
        <span style="font-family:var(--font-title);font-size:10px;letter-spacing:1px;color:var(--text-muted);flex:1">Tipos de Evento</span>
        <button class="btn-new" onclick="abrirFormTipoEvento(null)">+ Novo Tipo</button>
    </div>
    <div style="padding:8px 16px 4px">
        <div style="font-size:11px;color:var(--text-faint);line-height:1.6">
            Quando o tipo √© <strong>Reuni√£o de L√≠deres</strong>, todos os l√≠deres s√£o adicionados automaticamente ao iniciar.
            Os outros tipos come√ßam com lista vazia.
        </div>
    </div>
    <div class="admin-list" style="padding:8px 16px">`;

        lista.forEach((tipo, i) => {
            const isLideres = tipo === 'Reuni√£o de L√≠deres';
            html += `
        <div class="admin-row" style="animation-delay:${i*0.02}s">
            <div class="admin-row-foto" style="font-size:11px">${(i+1)}</div>
            <div class="admin-row-info">
                <div class="admin-row-nome">${tipo}</div>
                ${isLideres ? '<div class="admin-row-sub" style="color:var(--primary-dark)">Auto-adiciona todos os l√≠deres</div>' : ''}
            </div>
            <div class="admin-row-actions">
                <button class="btn-edit" onclick="abrirFormTipoEvento(${i})">Editar</button>
                ${!isLideres ? `<button class="btn-toggle ativo" onclick="removerTipoEvento(${i})">Remover</button>` : ''}
                ${i > 0 ? `<button class="btn-edit" onclick="moverTipo(${i},-1)" title="Subir">‚Üë</button>` : ''}
                ${i < lista.length-1 ? `<button class="btn-edit" onclick="moverTipo(${i},1)" title="Descer">‚Üì</button>` : ''}
            </div>
        </div>`;
        });

        html += '</div>';
        document.getElementById('main-content').innerHTML = html;
    }

    function abrirFormTipoEvento(idx) {
        const lista  = getTiposEvento();
        const isNovo = idx === null;
        const valor  = isNovo ? '' : lista[idx];
        document.getElementById('drawer-title').textContent = isNovo ? 'Novo Tipo de Evento' : 'Editar Tipo';
        document.getElementById('drawer-body').innerHTML = `<div class="form-grid">
        <div class="msg-form" id="form-msg"></div>
        <div class="form-group form-full">
            <label class="form-label">Nome do Tipo</label>
            <input class="form-input" id="ft_nome" type="text" placeholder="Ex: Encontro de Jovens" value="${valor}">
        </div>
        <div class="form-actions">
            <button class="btn-cancel-form" onclick="closeDrawer()">Cancelar</button>
            <button class="btn-save" onclick="salvarTipoEvento(${idx})">Guardar</button>
        </div>
    </div>`;
        document.getElementById('overlay').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function salvarTipoEvento(idx) {
        const nome = document.getElementById('ft_nome')?.value?.trim();
        if (!nome) { showFormMsg('Nome obrigat√≥rio.','error'); return; }
        const lista = getTiposEvento();
        if (idx === null) {
            // Adiciona antes de "Outro" (√∫ltimo)
            lista.splice(lista.length - 1, 0, nome);
        } else {
            lista[idx] = nome;
        }
        saveTiposEvento(lista);
        closeDrawer();
        renderTiposEvento();
    }

    function removerTipoEvento(idx) {
        const lista = getTiposEvento();
        if (!confirm(`Remover o tipo "${lista[idx]}"?`)) return;
        lista.splice(idx, 1);
        saveTiposEvento(lista);
        renderTiposEvento();
    }

    function moverTipo(idx, dir) {
        const lista = getTiposEvento();
        const novo  = idx + dir;
        if (novo < 0 || novo >= lista.length) return;
        [lista[idx], lista[novo]] = [lista[novo], lista[idx]];
        saveTiposEvento(lista);
        renderTiposEvento();
    }

    function camposEventos(){return[];}

    // ‚îÄ‚îÄ RELAT√ìRIO PDF (com gr√°ficos) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function gerarRelatorioEvento(eventoId) {
        const evento=eventosData.find(e=>e.id===eventoId);
        if(!evento) return;
        const pres=await sb(`evento_presencas?select=*,membros(id,nome,foto_url,telefone)&evento_id=eq.${eventoId}&order=created_at`)||[];
        const membroIds=pres.map(p=>p.membro_id).filter(Boolean);
        let minsMap={};
        if(membroIds.length){
            const vincs=await sb(`membro_ministerios?select=membro_id,papel,ministerios(nome,tipo)&membro_id=in.(${membroIds.join(',')})&ativo=eq.true`)||[];
            vincs.forEach(v=>{
                if(!minsMap[v.membro_id]) minsMap[v.membro_id]=[];
                minsMap[v.membro_id].push({tipo:v.ministerios?.tipo||'?',nome:v.ministerios?.nome||'‚Äî',papel:v.papel||''});
            });
        }
        const presentes=pres.filter(p=>p.status==='presente');
        const faltaram =pres.filter(p=>p.status==='faltou');
        const comMotivo=pres.filter(p=>p.status==='faltou_motivo');
        const total    =pres.length;
        const dEvt=evento.data_inicio?new Date(evento.data_inicio).toLocaleDateString('pt-PT',{weekday:'long',day:'numeric',month:'long',year:'numeric',hour:'2-digit',minute:'2-digit'}):'‚Äî';

        // Por √°rea
        const porArea={};
        pres.forEach(p=>{
            const mins=minsMap[p.membro_id]||[{tipo:'Sem √°rea',nome:'Sem √°rea',papel:''}];
            mins.forEach(m=>{
                const k=`${m.tipo}||${m.nome}`;
                if(!porArea[k]) porArea[k]={tipo:m.tipo,nome:m.nome,presentes:0,faltaram:0,total:0};
                porArea[k].total++;
                if(p.status==='presente') porArea[k].presentes++;
                else if(p.status==='faltou'||p.status==='faltou_motivo') porArea[k].faltaram++;
            });
        });
        const areasSort=Object.values(porArea).sort((a,b)=>a.nome.localeCompare(b.nome));

        const rowM=p=>{
            const mins=minsMap[p.membro_id]||[];
            const as=mins.map(m=>`[${m.tipo==='ministerio'?'MIN':'AE'}] ${m.nome}${m.papel?' ¬∑ '+m.papel:''}`).join(' | ');
            return `<tr><td>${p.membros?.nome||'‚Äî'}</td><td style="font-size:11px;color:#666">${as||'‚Äî'}</td><td style="font-size:11px;color:#c07000">${p.motivo||'‚Äî'}</td></tr>`;
        };
        const rowA=a=>`<tr>
        <td>${a.tipo==='ministerio'?'Minist√©rio':'√Årea de Equipa'}</td>
        <td style="font-weight:600">${a.nome}</td>
        <td style="color:green;text-align:center">${a.presentes}</td>
        <td style="color:red;text-align:center">${a.faltaram}</td>
        <td style="text-align:center">${Math.round(a.presentes/(a.total||1)*100)}%</td>
    </tr>`;

        // Gr√°fico de barras SVG para PDF
        function buildSvgBarras(areas) {
            const maxVal = Math.max(...areas.map(a=>a.total), 1);
            const barH   = 22;
            const gap    = 6;
            const leftW  = 180;
            const barMaxW= 300;
            const svgH   = areas.length * (barH + gap) + 40;
            let svgContent = `<svg width="560" height="${svgH}" xmlns="http://www.w3.org/2000/svg" font-family="Arial,sans-serif">`;
            svgContent += `<text x="0" y="18" font-size="11" fill="#888">√Årea</text>`;
            svgContent += `<text x="${leftW+5}" y="18" font-size="11" fill="#2e7d32">Presentes</text>`;
            svgContent += `<text x="${leftW+barMaxW/2}" y="18" font-size="11" fill="#c62828">Faltaram</text>`;
            areas.forEach((a, i) => {
                const y    = 30 + i * (barH + gap);
                const wP   = Math.round(a.presentes / maxVal * barMaxW);
                const wF   = Math.round(a.faltaram  / maxVal * barMaxW);
                const pct  = Math.round(a.presentes / (a.total||1) * 100);
                const nome = a.nome.length > 22 ? a.nome.substring(0,22)+'‚Ä¶' : a.nome;
                svgContent += `<text x="${leftW-5}" y="${y+15}" font-size="11" fill="#333" text-anchor="end">${nome}</text>`;
                svgContent += `<rect x="${leftW}" y="${y}" width="${wP}" height="${barH}" fill="#2e7d32" opacity="0.8" rx="3"/>`;
                svgContent += `<rect x="${leftW+wP}" y="${y}" width="${wF}" height="${barH}" fill="#c62828" opacity="0.8" rx="3"/>`;
                svgContent += `<text x="${leftW+wP+wF+8}" y="${y+15}" font-size="11" fill="${pct>=80?'#2e7d32':pct>=50?'#e65100':'#c62828'}" font-weight="bold">${pct}%</text>`;
            });
            svgContent += '</svg>';
            return svgContent;
        }

        // Pizza SVG para PDF
        function buildSvgPizza() {
            const r=80; const cx=100; const cy=100;
            const dados=[
                {val:presentes.length,cor:'#2e7d32',label:'Presentes'},
                {val:comMotivo.length,cor:'#e65100',label:'Com Motivo'},
                {val:faltaram.length, cor:'#c62828',label:'Faltaram'},
            ];
            let paths=''; let start=-Math.PI/2;
            dados.forEach(d=>{
                if(!d.val) return;
                const a=d.val/total*Math.PI*2;
                const end=start+a;
                const x1=cx+r*Math.cos(start); const y1=cy+r*Math.sin(start);
                const x2=cx+r*Math.cos(end);   const y2=cy+r*Math.sin(end);
                const la=a>Math.PI?1:0;
                paths+=`<path d="M${cx},${cy} L${x1.toFixed(1)},${y1.toFixed(1)} A${r},${r} 0 ${la},1 ${x2.toFixed(1)},${y2.toFixed(1)} Z" fill="${d.cor}" opacity="0.85"/>`;
                start=end;
            });
            paths+=`<circle cx="${cx}" cy="${cy}" r="40" fill="white"/>`;
            paths+=`<text x="${cx}" y="${cy-4}" text-anchor="middle" font-size="18" font-weight="bold" fill="#333">${total}</text>`;
            paths+=`<text x="${cx}" y="${cy+14}" text-anchor="middle" font-size="10" fill="#888">TOTAL</text>`;
            const legend=dados.map((d,i)=>`<text x="210" y="${40+i*22}" font-size="12" fill="${d.cor}">‚ñ† ${d.label}: ${d.val} (${total>0?Math.round(d.val/total*100):0}%)</text>`).join('');
            return `<svg width="420" height="200" xmlns="http://www.w3.org/2000/svg" font-family="Arial,sans-serif">${paths}${legend}</svg>`;
        }

        const htm=`<!DOCTYPE html><html lang="pt"><head><meta charset="UTF-8"><title>Relat√≥rio ‚Äî ${evento.titulo}</title>
    <style>
        body{font-family:Arial,sans-serif;color:#222;padding:32px;max-width:900px;margin:0 auto}
        h1{font-size:22px;margin-bottom:4px;color:#006b70}
        h2{font-size:15px;margin:28px 0 10px;color:#006b70;border-bottom:2px solid #009098;padding-bottom:4px}
        .meta{font-size:13px;color:#555;margin-bottom:24px}
        .badges{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap}
        .badge{padding:6px 14px;border-radius:20px;font-size:12px;font-weight:bold}
        .g{background:#e8f5e9;color:#2e7d32}.r{background:#ffebee;color:#c62828}
        .o{background:#fff8e1;color:#e65100}.gr{background:#f5f5f5;color:#555}
        table{width:100%;border-collapse:collapse;font-size:13px}
        th{background:#f0f7f8;padding:8px;text-align:left;font-size:11px;letter-spacing:1px;text-transform:uppercase;color:#888}
        td{padding:6px 8px;border-bottom:1px solid #eee}
        .grafico-section{background:#f9f9f9;border:1px solid #e0e0e0;border-radius:8px;padding:16px;margin-bottom:20px}
        .grafico-section h3{font-size:12px;letter-spacing:2px;text-transform:uppercase;color:#888;margin:0 0 12px}
        @media print{body{padding:16px}}
    </style></head><body>
    <h1>${evento.titulo}</h1>
    <div class="meta">${dEvt}${evento.local?' ¬∑ '+evento.local:''}${evento.tipo?' ¬∑ '+evento.tipo:''}</div>
    <div class="badges">
        <span class="badge g">‚úì Presentes: ${presentes.length}</span>
        <span class="badge r">‚úó Faltaram: ${faltaram.length}</span>
        <span class="badge o">! Com motivo: ${comMotivo.length}</span>
        <span class="badge gr">Total: ${total}</span>
        <span class="badge gr">Taxa presen√ßa: ${total>0?Math.round(presentes.length/total*100):0}%</span>
    </div>

    <h2>Gr√°fico de Presen√ßas</h2>
    <div class="grafico-section">
        <h3>Distribui√ß√£o Geral</h3>
        ${buildSvgPizza()}
    </div>

    ${areasSort.length>0?`
    <div class="grafico-section">
        <h3>Presen√ßas por √Årea / Minist√©rio</h3>
        ${buildSvgBarras(areasSort)}
    </div>`:''}

    <h2>Presentes (${presentes.length})</h2>
    <table><thead><tr><th>Nome</th><th>√Åreas / Minist√©rios</th><th>‚Äî</th></tr></thead>
    <tbody>${presentes.map(rowM).join('')}</tbody></table>

    ${comMotivo.length?`<h2>Faltaram c/ Motivo (${comMotivo.length})</h2>
    <table><thead><tr><th>Nome</th><th>√Åreas</th><th>Motivo</th></tr></thead>
    <tbody>${comMotivo.map(rowM).join('')}</tbody></table>`:''}

    ${faltaram.length?`<h2>Faltaram (${faltaram.length})</h2>
    <table><thead><tr><th>Nome</th><th>√Åreas</th><th>‚Äî</th></tr></thead>
    <tbody>${faltaram.map(rowM).join('')}</tbody></table>`:''}

    <h2>Resumo por √Årea / Minist√©rio</h2>
    <table><thead><tr><th>Tipo</th><th>Nome</th><th style="text-align:center">Presentes</th><th style="text-align:center">Faltaram</th><th style="text-align:center">%</th></tr></thead>
    <tbody>${areasSort.map(rowA).join('')}</tbody></table>

    <div style="margin-top:40px;font-size:11px;color:#aaa;text-align:center">
        Gerado em ${new Date().toLocaleDateString('pt-PT',{day:'2-digit',month:'long',year:'numeric',hour:'2-digit',minute:'2-digit'})} ¬∑ Zion Lisboa
    </div>
    <script>window.onload=()=>window.print();<\/script>
    </body></html>`;

        const win=window.open('','_blank');
        win.document.write(htm);
        win.document.close();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // DASHBOARD GERAL
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderDashboardGeral() {
        document.getElementById('main-content').innerHTML = `
        <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 24px;text-align:center;gap:16px">
            <div style="font-size:48px">üèóÔ∏è</div>
            <div style="font-family:var(--font-title);font-size:16px;letter-spacing:2px;color:var(--primary-dark)">EM CONSTRU√á√ÉO</div>
            <div style="font-size:13px;color:var(--text-faint);max-width:280px;line-height:1.7">
                O Dashboard geral est√° a ser preparado.<br>Em breve ter√°s aqui uma vis√£o completa da Zion Lisboa.
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:8px">
                <span class="badge badge-gray">Membros</span>
                <span class="badge badge-gray">Visitantes</span>
                <span class="badge badge-gray">Eventos</span>
                <span class="badge badge-gray">D√≠zimos</span>
                <span class="badge badge-gray">Minist√©rios</span>
            </div>
        </div>`;
    }


    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // M√ìDULO FINANCEIRO ‚Äî FORNECEDORES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let fornecedoresData = [];

    async function carregarFornecedores() {
        fornecedoresData = await sb('fornecedores?select=*&order=nome') || [];
        renderFornecedores();
    }

    function renderFornecedores() {
        const q = getQ();
        let lista = [...fornecedoresData].filter(f => f.ativo !== false);
        if (filtroInativo) lista = fornecedoresData.filter(f => f.ativo === false);
        if (q) lista = lista.filter(f => (f.nome||'').toLowerCase().includes(q) || (f.categoria||'').toLowerCase().includes(q));

        let html = `
        <div class="section-toolbar" style="position:sticky;top:0;z-index:10">
            <input class="toolbar-search" id="toolbar-search-input" placeholder="Pesquisar fornecedor..." oninput="handleSearch()" value="${q}">
            <button class="toolbar-filter ${filtroInativo?'active':''}" onclick="toggleFiltroInativo()">Inativos</button>
            <button class="btn-new" onclick="abrirFormFornecedor(null)">+ Novo</button>
        </div>`;

        if (!lista.length) {
            html += `<div class="empty"><div class="empty-icon">‚Äî</div><div class="empty-txt">Nenhum fornecedor. Clica em + Novo.</div></div>`;
            document.getElementById('main-content').innerHTML = html;
            return;
        }

        html += '<div class="admin-list">';
        lista.forEach((f, i) => {
            const sub = [f.categoria, f.cidade, f.telefone].filter(Boolean).join(' ¬∑ ');
            const badges = [];
            if (f.tipo === 'prestador') badges.push('<span class="badge badge-primary">Prestador</span>');
            if (f.tipo === 'outro') badges.push('<span class="badge badge-gray">Outro</span>');
            if (f.prazo_pagamento) badges.push(`<span class="badge badge-gray">${f.prazo_pagamento}d</span>`);
            html += `
            <div class="admin-row" style="animation-delay:${Math.min(i,12)*0.02}s">
                <div class="admin-row-foto" style="background:var(--primary-faint);color:var(--primary-dark);font-size:13px;font-weight:700">${(f.nome||'F')[0]}</div>
                <div class="admin-row-info">
                    <div class="admin-row-nome">${f.nome}</div>
                    ${sub ? `<div class="admin-row-sub">${sub}</div>` : ''}
                    ${badges.length ? `<div class="admin-row-badges">${badges.join('')}</div>` : ''}
                </div>
                <div class="admin-row-actions">
                    <button class="btn-edit" onclick="abrirFormFornecedor('${f.id}')">Editar</button>
                    <button class="btn-toggle ${f.ativo!==false?'ativo':'inativo'}" onclick="toggleAtivoFornecedor('${f.id}',${f.ativo!==false})">${f.ativo!==false?'Inativar':'Ativar'}</button>
                </div>
            </div>`;
        });
        html += '</div>';
        document.getElementById('main-content').innerHTML = html;
        restoreSearch(q);
    }

    function abrirFormFornecedor(id) {
        const f = id ? fornecedoresData.find(x => x.id === id) : null;
        document.getElementById('drawer-title').textContent = f ? 'Editar Fornecedor' : 'Novo Fornecedor';
        document.getElementById('drawer-body').innerHTML = buildFormFornecedor(f);
        document.getElementById('overlay').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function buildFormFornecedor(f) {
        const fv = (k, d='') => f?.[k] ?? d;
        return `<div class="form-grid">
        <div class="msg-form" id="form-msg"></div>

        <div class="form-section-title">Identifica√ß√£o</div>
        <div class="form-group form-full"><label class="form-label">Nome *</label>
            <input class="form-input" id="ff_nome" type="text" value="${fv('nome')}" placeholder="Nome do fornecedor"></div>
        <div class="form-group"><label class="form-label">Tipo</label>
            <select class="form-select" id="ff_tipo">
                <option value="fornecedor" ${fv('tipo','fornecedor')==='fornecedor'?'selected':''}>Fornecedor</option>
                <option value="prestador"  ${fv('tipo')==='prestador'?'selected':''}>Prestador de Servi√ßos</option>
                <option value="outro"      ${fv('tipo')==='outro'?'selected':''}>Outro</option>
            </select></div>
        <div class="form-group"><label class="form-label">Categoria</label>
            <input class="form-input" id="ff_categoria" type="text" value="${fv('categoria')}" placeholder="Ex: Alimenta√ß√£o, Vestu√°rio..."></div>
        <div class="form-group"><label class="form-label">NIF</label>
            <input class="form-input" id="ff_nif" type="text" value="${fv('nif')}" placeholder="PT000000000"></div>
        <div class="form-group"><label class="form-label">Email</label>
            <input class="form-input" id="ff_email" type="email" value="${fv('email')}"></div>
        <div class="form-group"><label class="form-label">Telefone</label>
            <input class="form-input" id="ff_telefone" type="tel" value="${fv('telefone')}"></div>
        <div class="form-group"><label class="form-label">Website</label>
            <input class="form-input" id="ff_website" type="url" value="${fv('website')}" placeholder="https://..."></div>

        <div class="form-section-title">Morada</div>
        <div class="form-group form-full"><label class="form-label">Rua</label>
            <input class="form-input" id="ff_rua" type="text" value="${fv('rua')}"></div>
        <div class="form-group"><label class="form-label">N√∫mero</label>
            <input class="form-input" id="ff_numero" type="text" value="${fv('numero')}"></div>
        <div class="form-group"><label class="form-label">C√≥d. Postal</label>
            <input class="form-input" id="ff_codigo_postal" type="text" value="${fv('codigo_postal')}" placeholder="0000-000"></div>
        <div class="form-group"><label class="form-label">Cidade</label>
            <input class="form-input" id="ff_cidade" type="text" value="${fv('cidade')}" placeholder="Lisboa"></div>
        <div class="form-group"><label class="form-label">Pa√≠s</label>
            <input class="form-input" id="ff_pais" type="text" value="${fv('pais','Portugal')}"></div>

        <div class="form-section-title">Dados Banc√°rios</div>
        <div class="form-group form-full"><label class="form-label">IBAN</label>
            <input class="form-input" id="ff_iban" type="text" value="${fv('iban')}" placeholder="PT50 0000 0000 0000 0000 0000 0"></div>
        <div class="form-group"><label class="form-label">Banco</label>
            <input class="form-input" id="ff_banco" type="text" value="${fv('banco')}"></div>
        <div class="form-group"><label class="form-label">SWIFT/BIC</label>
            <input class="form-input" id="ff_swift" type="text" value="${fv('swift')}"></div>

        <div class="form-section-title">Condi√ß√µes Comerciais</div>
        <div class="form-group"><label class="form-label">Prazo Pagamento (dias)</label>
            <input class="form-input" id="ff_prazo_pagamento" type="number" value="${fv('prazo_pagamento',30)}" placeholder="30"></div>
        <div class="form-group"><label class="form-label">Contacto Principal</label>
            <input class="form-input" id="ff_contacto_nome" type="text" value="${fv('contacto_nome')}"></div>
        <div class="form-group form-full"><label class="form-label">Condi√ß√µes / Notas</label>
            <textarea class="form-textarea" id="ff_condicoes" placeholder="Condi√ß√µes especiais, descontos...">${fv('condicoes')}</textarea></div>
        <div class="form-group"><label class="form-toggle"><input type="checkbox" id="ff_ativo" ${fv('ativo',true)!==false?'checked':''}><span>Ativo</span></label></div>

        <div class="form-actions">
            <button class="btn-cancel-form" onclick="closeDrawer()">Cancelar</button>
            <button class="btn-save" id="btn-save" onclick="salvarFornecedor('${f?.id||''}')">Guardar</button>
        </div></div>`;
    }

    async function salvarFornecedor(id) {
        const get = k => { const el = document.getElementById('ff_'+k); return el ? el.value||null : null; };
        const chk = k => { const el = document.getElementById('ff_'+k); return el ? el.checked : false; };
        const nome = get('nome');
        if (!nome) { showFormMsg('Nome obrigat√≥rio.','error'); return; }
        const body = {
            nome, tipo:get('tipo'), categoria:get('categoria'), nif:get('nif'),
            email:get('email'), telefone:get('telefone'), website:get('website'),
            rua:get('rua'), numero:get('numero'), codigo_postal:get('codigo_postal'),
            cidade:get('cidade'), pais:get('pais'),
            iban:get('iban'), banco:get('banco'), swift:get('swift'),
            prazo_pagamento:get('prazo_pagamento')?Number(get('prazo_pagamento')):30,
            contacto_nome:get('contacto_nome'), condicoes:get('condicoes'),
            ativo:chk('ativo'), updated_at:new Date().toISOString(),
        };
        const btn = document.getElementById('btn-save');
        btn.disabled = true; btn.textContent = 'A guardar...';
        try {
            if (!id) await sb('fornecedores', {method:'POST', body:JSON.stringify(body)});
            else     await sb(`fornecedores?id=eq.${id}`, {method:'PATCH', body:JSON.stringify(body)});
            showFormMsg('Guardado!', 'success');
            fornecedoresData = await sb('fornecedores?select=*&order=nome') || [];
            setTimeout(closeDrawer, 700);
        } catch(e) {
            showFormMsg('Erro: '+(e?.message||JSON.stringify(e)), 'error');
            btn.disabled = false; btn.textContent = 'Guardar';
        }
    }

    async function toggleAtivoFornecedor(id, ativo) {
        await sb(`fornecedores?id=eq.${id}`, {method:'PATCH', body:JSON.stringify({ativo:!ativo})});
        await carregarFornecedores();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // M√ìDULO FINANCEIRO ‚Äî ECR√É PRINCIPAL (3 abas)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let finTab        = 0; // 0=Faturas 1=Contas a Pagar 2=Contas a Receber
    let comprasData   = [];
    let contasPagarData = [];
    let contasReceberData = [];
    let produtosCache = []; // loja + keola combinados

    // Filtros
    let finFiltros = {
        fornecedor_id: '', status: '', mes: '', categoria: '',
    };

    async function carregarFinanceiro() {
        finTab = finTab || 0;
        await Promise.all([
            carregarDadosFinanceiros(),
        ]);
        renderFinanceiro();
    }

    async function carregarDadosFinanceiros() {
        [comprasData, contasPagarData, contasReceberData, fornecedoresData] = await Promise.all([
            sb('compras?select=*,fornecedores(id,nome)&order=data_fatura.desc').catch(()=>[]),
            sb('contas_pagar?select=*,fornecedores(id,nome)&order=data_vencimento').catch(()=>[]),
            sb('contas_receber?select=*&order=data_vencimento').catch(()=>[]),
            fornecedoresData.length ? Promise.resolve(fornecedoresData) : sb('fornecedores?select=*&order=nome').catch(()=>[]),
        ]);
        // Marcar atrasados automaticamente (client-side)
        const hoje = new Date().toISOString().split('T')[0];
        contasPagarData.forEach(c => {
            if (c.status === 'pendente' && c.data_vencimento && c.data_vencimento < hoje) c.status = 'atrasado';
        });
    }

    function renderFinanceiro() {
        const tabs = ['Entrada de Faturas','Contas a Pagar','Contas a Receber'];
        let html = `<div class="sub-tabs">
            ${tabs.map((t,i)=>`<button class="sub-tab ${finTab===i?'active':''}" onclick="setFinTab(${i})">${t}</button>`).join('')}
        </div>`;
        document.getElementById('main-content').innerHTML = html + '<div id="fin-content"><div class="loading"><div class="spin"></div></div></div>';
        renderFinTab();
    }

    async function setFinTab(i) {
        finTab = i;
        await carregarDadosFinanceiros();
        renderFinanceiro();
    }

    function renderFinTab() {
        const el = document.getElementById('fin-content');
        if (!el) return;
        if (finTab === 0) el.innerHTML = renderFaturas();
        if (finTab === 1) el.innerHTML = renderContasPagar();
        if (finTab === 2) el.innerHTML = renderContasReceber();
    }

    // ‚îÄ‚îÄ RESUMO STATS BAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function statBox(label, valor, cor, sub='') {
        return `<div style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center;flex:1;min-width:120px">
            <div style="font-family:var(--font-title);font-size:20px;font-weight:700;color:${cor}">‚Ç¨${Number(valor||0).toFixed(2)}</div>
            <div style="font-size:10px;color:var(--text-faint);text-transform:uppercase;letter-spacing:1px;margin-top:3px">${label}</div>
            ${sub?`<div style="font-size:10px;color:var(--text-faint);margin-top:2px">${sub}</div>`:''}
        </div>`;
    }

    // ‚îÄ‚îÄ ABA 0: ENTRADA DE FATURAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderFaturas() {
        const q = '';
        const totalFaturas = comprasData.length;
        const totalValor   = comprasData.reduce((a,c) => a + Number(c.total||0), 0);
        const pendentes    = comprasData.filter(c => c.status === 'pendente').length;

        let html = `
        <div style="display:flex;gap:8px;padding:12px 16px 8px;flex-wrap:wrap">
            ${statBox('Total Faturas', totalValor, 'var(--primary-dark)', totalFaturas+' registos')}
            ${statBox('Pendentes', comprasData.filter(c=>c.status==='pendente').reduce((a,c)=>a+Number(c.total||0),0), 'var(--orange,#e65100)', pendentes+' faturas')}
            ${statBox('Pagas', comprasData.filter(c=>c.status==='pago').reduce((a,c)=>a+Number(c.total||0),0), 'var(--green)', comprasData.filter(c=>c.status==='pago').length+' faturas')}
        </div>
        <div class="section-toolbar" style="position:sticky;top:0;z-index:10">
            <input class="toolbar-search" id="toolbar-search-input" placeholder="Pesquisar fatura..." oninput="handleSearch()" value="">
            <button class="btn-new" onclick="abrirFormCompra(null)">+ Nova Fatura</button>
        </div>`;

        if (!comprasData.length) {
            return html + `<div class="empty"><div class="empty-icon">‚Äî</div><div class="empty-txt">Nenhuma fatura registada. Clica em + Nova Fatura.</div></div>`;
        }

        const STATUS_COR = {pendente:'var(--orange,#e65100)',pago:'var(--green)',parcial:'var(--primary)',cancelado:'var(--text-faint)',atrasado:'var(--red)'};
        const STATUS_LABEL = {pendente:'Pendente',pago:'Pago',parcial:'Parcial',cancelado:'Cancelado',atrasado:'Atrasado'};

        html += '<div class="admin-list" style="padding:0 16px 16px">';
        comprasData.forEach((c, i) => {
            const forn  = c.fornecedores?.nome || c.fornecedor_nome || '‚Äî';
            const data  = c.data_fatura ? new Date(c.data_fatura).toLocaleDateString('pt-PT') : '‚Äî';
            const venc  = c.data_vencimento ? new Date(c.data_vencimento).toLocaleDateString('pt-PT') : '‚Äî';
            const cor   = STATUS_COR[c.status]  || 'var(--text-faint)';
            const label = STATUS_LABEL[c.status] || c.status;
            html += `
            <div class="admin-row" style="animation-delay:${Math.min(i,12)*0.02}s;flex-wrap:wrap;gap:6px">
                <div class="admin-row-foto" style="background:var(--primary-faint);color:var(--primary-dark);font-size:11px;font-weight:700">${(forn[0]||'F')}</div>
                <div class="admin-row-info" style="flex:1;min-width:0">
                    <div class="admin-row-nome">${forn}${c.numero_fatura?` <span style="font-size:11px;color:var(--text-faint)">¬∑ N¬∫ ${c.numero_fatura}</span>`:''}</div>
                    <div class="admin-row-sub">Emiss√£o: ${data} ¬∑ Vence: ${venc} ¬∑ ${c.forma_pagamento||'‚Äî'}</div>
                    <div class="admin-row-badges">
                        <span class="badge" style="background:${cor}22;color:${cor};border:1px solid ${cor}44">${label}</span>
                        ${c.categoria?`<span class="badge badge-gray">${c.categoria}</span>`:''}
                    </div>
                </div>
                <div style="text-align:right;flex-shrink:0">
                    <div style="font-family:var(--font-title);font-size:16px;font-weight:700;color:var(--primary-dark)">‚Ç¨${Number(c.total||0).toFixed(2)}</div>
                    <div style="font-size:10px;color:var(--text-faint)">IVA: ‚Ç¨${Number(c.iva||0).toFixed(2)}</div>
                </div>
                <div class="admin-row-actions" style="width:100%;justify-content:flex-end">
                    <button class="btn-edit" onclick="abrirFormCompra('${c.id}')">Ver / Editar</button>
                    ${c.status!=='pago'?`<button class="btn-toggle ativo" onclick="marcarCompraPaga('${c.id}')">Marcar Pago</button>`:''}
                    <button class="btn-edit" style="color:var(--red);border-color:rgba(192,57,43,0.3)" onclick="abrirContaPagarDeCompra('${c.id}')">Ver Conta</button>
                </div>
            </div>`;
        });
        html += '</div>';
        return html;
    }

    // ‚îÄ‚îÄ FORM COMPRA (entrada de fatura) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let compraItensTemp = []; // itens em edi√ß√£o

    async function abrirFormCompra(id) {
        const compra = id ? comprasData.find(x => x.id === id) : null;
        // Carregar produtos (loja + keola)
        if (!produtosCache.length) {
            const [loja, keola] = await Promise.all([
                sb('loja_produtos?select=id,nome,categoria,sku,preco_custo,stock&ativo=eq.true&order=categoria,nome').catch(()=>[]),
                sb('keola_menu?select=id,nome,categoria&disponivel=eq.true&order=categoria,nome').catch(()=>[]),
            ]);
            produtosCache = [
                ...(loja||[]).map(p => ({...p, origem:'loja', label:`[Loja] ${p.categoria ? p.categoria+' ‚Äî ' : ''}${p.nome}`})),
                ...(keola||[]).map(p => ({...p, origem:'keola', label:`[Keola] ${p.categoria ? p.categoria+' ‚Äî ' : ''}${p.nome}`})),
            ];
        }
        // Carregar itens existentes se edi√ß√£o
        compraItensTemp = [];
        if (id) {
            const itens = await sb(`compra_itens?select=*&compra_id=eq.${id}&order=created_at`).catch(()=>[]);
            compraItensTemp = itens || [];
        }
        document.getElementById('drawer-title').textContent = compra ? `Fatura ‚Äî ${compra.numero_fatura||compra.id.slice(0,8)}` : 'Nova Entrada de Fatura';
        document.getElementById('drawer-body').innerHTML = buildFormCompra(compra);
        document.getElementById('overlay').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        renderItensCompra();
        calcularTotaisCompra();
    }

    function buildFormCompra(c) {
        const fv = (k,d='') => c?.[k] ?? d;
        const fornOpts = fornecedoresData.map(f =>
            `<option value="${f.id}" ${fv('fornecedor_id')===f.id?'selected':''}>${f.nome}</option>`
        ).join('');
        const prodOpts = produtosCache.map(p =>
            `<option value="${p.id}" data-origem="${p.origem}" data-nome="${p.nome.replace(/"/g,'&quot;')}" data-custo="${p.preco_custo||0}">${p.label}</option>`
        ).join('');

        return `<div class="form-grid">
        <div class="msg-form" id="form-msg"></div>

        <div class="form-section-title">Fornecedor & Fatura</div>
        <div class="form-group form-full"><label class="form-label">Fornecedor</label>
            <select class="form-select" id="fc_fornecedor_id">
                <option value="">-- Sem fornecedor cadastrado --</option>${fornOpts}
            </select></div>
        <div class="form-group form-full"><label class="form-label">Nome Fornecedor (manual)</label>
            <input class="form-input" id="fc_fornecedor_nome" type="text" value="${fv('fornecedor_nome')}" placeholder="Se n√£o estiver na lista acima"></div>
        <div class="form-group"><label class="form-label">N¬∫ Fatura</label>
            <input class="form-input" id="fc_numero_fatura" type="text" value="${fv('numero_fatura')}" placeholder="FT 2026/001"></div>
        <div class="form-group"><label class="form-label">Data Fatura *</label>
            <input class="form-input" id="fc_data_fatura" type="date" value="${fv('data_fatura', new Date().toISOString().split('T')[0])}"></div>
        <div class="form-group"><label class="form-label">Data Vencimento</label>
            <input class="form-input" id="fc_data_vencimento" type="date" value="${fv('data_vencimento')}"></div>
        <div class="form-group"><label class="form-label">Categoria</label>
            <select class="form-select" id="fc_categoria">
                <option value="stock"        ${fv('categoria')==='stock'?'selected':''}>Stock / Mercadoria</option>
                <option value="servicos"     ${fv('categoria')==='servicos'?'selected':''}>Servi√ßos</option>
                <option value="manutencao"   ${fv('categoria')==='manutencao'?'selected':''}>Manuten√ß√£o</option>
                <option value="utilities"    ${fv('categoria')==='utilities'?'selected':''}>√Ågua / Luz / G√°s</option>
                <option value="renda"        ${fv('categoria')==='renda'?'selected':''}>Renda</option>
                <option value="outros"       ${fv('categoria')==='outros'?'selected':''}>Outros</option>
            </select></div>

        <div class="form-section-title">Pagamento</div>
        <div class="form-group"><label class="form-label">Forma de Pagamento</label>
            <select class="form-select" id="fc_forma_pagamento">
                <option value="transferencia" ${fv('forma_pagamento','transferencia')==='transferencia'?'selected':''}>Transfer√™ncia Banc√°ria</option>
                <option value="mbway"         ${fv('forma_pagamento')==='mbway'?'selected':''}>MBWay</option>
                <option value="multibanco"    ${fv('forma_pagamento')==='multibanco'?'selected':''}>Multibanco / Refer√™ncia</option>
                <option value="dinheiro"      ${fv('forma_pagamento')==='dinheiro'?'selected':''}>Dinheiro</option>
                <option value="cheque"        ${fv('forma_pagamento')==='cheque'?'selected':''}>Cheque</option>
                <option value="credito"       ${fv('forma_pagamento')==='credito'?'selected':''}>Cr√©dito</option>
            </select></div>
        <div class="form-group"><label class="form-label">Condi√ß√£o de Pagamento</label>
            <select class="form-select" id="fc_condicao_pagamento">
                <option value="a_vista"   ${fv('condicao_pagamento')==='a_vista'?'selected':''}>A Vista</option>
                <option value="30_dias"   ${fv('condicao_pagamento','30_dias')==='30_dias'?'selected':''}>30 dias</option>
                <option value="60_dias"   ${fv('condicao_pagamento')==='60_dias'?'selected':''}>60 dias</option>
                <option value="90_dias"   ${fv('condicao_pagamento')==='90_dias'?'selected':''}>90 dias</option>
                <option value="parcelado" ${fv('condicao_pagamento')==='parcelado'?'selected':''}>Parcelado</option>
            </select></div>

        <div class="form-section-title">Itens da Fatura</div>
        <div class="form-full" style="background:var(--bg-input);border:1px solid var(--border);border-radius:10px;padding:12px">
            <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px">
                <select class="form-select" id="item-produto-sel" style="flex:2;min-width:180px">
                    <option value="">Seleciona produto (Loja ou Keola)...</option>${prodOpts}
                </select>
                <input class="form-input" id="item-desc-manual" type="text" placeholder="Ou descri√ß√£o manual" style="flex:1;min-width:120px">
                <input class="form-input" id="item-qty" type="number" value="1" min="0.001" step="0.001" placeholder="Qtd" style="width:70px">
                <input class="form-input" id="item-preco" type="number" value="0" min="0" step="0.01" placeholder="‚Ç¨ unit." style="width:90px">
                <input class="form-input" id="item-iva" type="number" value="23" min="0" step="1" placeholder="IVA%" style="width:65px">
                <button class="btn-sub-add" onclick="adicionarItemCompra()">+ Adicionar</button>
            </div>
            <div id="itens-compra-lista"></div>
            <div id="itens-compra-totais" style="margin-top:8px;padding-top:8px;border-top:1px dashed var(--border)"></div>
        </div>

        <div class="form-section-title">Notas</div>
        <div class="form-group form-full"><label class="form-label">Observa√ß√µes</label>
            <textarea class="form-textarea" id="fc_observacoes" placeholder="Notas adicionais...">${fv('observacoes')}</textarea></div>

        <div class="form-actions">
            <button class="btn-cancel-form" onclick="closeDrawer()">Cancelar</button>
            <button class="btn-save" id="btn-save" onclick="salvarCompra('${c?.id||''}')">Guardar e Criar Conta a Pagar</button>
        </div></div>`;
    }

    function adicionarItemCompra() {
        const sel    = document.getElementById('item-produto-sel');
        const opt    = sel?.options[sel.selectedIndex];
        const descManual = document.getElementById('item-desc-manual')?.value?.trim();
        const qty    = parseFloat(document.getElementById('item-qty')?.value || 1);
        const preco  = parseFloat(document.getElementById('item-preco')?.value || 0);
        const iva    = parseFloat(document.getElementById('item-iva')?.value || 23);

        const prodId = sel?.value;
        const desc   = descManual || opt?.dataset?.nome || '';
        const origem = opt?.dataset?.origem || 'outro';

        if (!desc && !prodId) { alert('Seleciona um produto ou escreve uma descri√ß√£o.'); return; }
        if (qty <= 0)  { alert('Quantidade deve ser maior que 0.'); return; }

        compraItensTemp.push({
            _tmp: Date.now(),
            produto_id: prodId || null,
            origem,
            descricao: desc || opt?.text || '‚Äî',
            quantidade: qty,
            preco_unitario: preco,
            iva_pct: iva,
            atualizar_stock: origem !== 'outro',
        });

        // Limpar campos
        if (sel) sel.value = '';
        document.getElementById('item-desc-manual').value = '';
        document.getElementById('item-qty').value = '1';
        document.getElementById('item-preco').value = '0';

        renderItensCompra();
        calcularTotaisCompra();
    }

    function removerItemCompra(idx) {
        compraItensTemp.splice(idx, 1);
        renderItensCompra();
        calcularTotaisCompra();
    }

    function renderItensCompra() {
        const el = document.getElementById('itens-compra-lista');
        if (!el) return;
        if (!compraItensTemp.length) {
            el.innerHTML = '<div style="font-size:12px;color:var(--text-faint);padding:6px 0">Nenhum item adicionado.</div>';
            return;
        }
        el.innerHTML = `
        <div style="display:grid;grid-template-columns:1fr auto auto auto auto;gap:4px;font-size:10px;font-family:var(--font-title);letter-spacing:1px;color:var(--text-faint);margin-bottom:4px;padding:0 4px">
            <div>DESCRI√á√ÉO</div><div style="text-align:center">QTD</div><div style="text-align:right">‚Ç¨ UNIT.</div><div style="text-align:right">IVA%</div><div style="text-align:right">TOTAL</div>
        </div>` +
        compraItensTemp.map((item, i) => {
            const sub = (item.quantidade * item.preco_unitario * (1 + item.iva_pct/100)).toFixed(2);
            return `<div style="display:grid;grid-template-columns:1fr auto auto auto auto;gap:4px;align-items:center;padding:6px 4px;border-radius:6px;background:var(--bg-card);margin-bottom:3px;font-size:12px">
                <div style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
                    ${item.atualizar_stock?'<span title="Vai actualizar stock" style="color:var(--green);font-size:10px">üì¶ </span>':''}${item.descricao}
                </div>
                <div style="text-align:center;color:var(--text-faint)">${item.quantidade}</div>
                <div style="text-align:right">‚Ç¨${Number(item.preco_unitario).toFixed(2)}</div>
                <div style="text-align:right;color:var(--text-faint)">${item.iva_pct}%</div>
                <div style="text-align:right;font-weight:700;color:var(--primary-dark)">‚Ç¨${sub}</div>
                <div style="grid-column:1/-1;display:flex;justify-content:flex-end;gap:4px">
                    <label style="font-size:10px;color:var(--text-faint);display:flex;align-items:center;gap:4px;cursor:pointer">
                        <input type="checkbox" ${item.atualizar_stock?'checked':''} onchange="compraItensTemp[${i}].atualizar_stock=this.checked"> Actualizar stock
                    </label>
                    <button onclick="removerItemCompra(${i})" style="font-size:10px;color:var(--red);background:none;border:none;cursor:pointer;padding:2px 6px">Remover</button>
                </div>
            </div>`;
        }).join('');
    }

    function calcularTotaisCompra() {
        const el = document.getElementById('itens-compra-totais');
        if (!el) return;
        let subtotal = 0, ivaTotal = 0;
        compraItensTemp.forEach(item => {
            const base = item.quantidade * item.preco_unitario;
            subtotal += base;
            ivaTotal += base * (item.iva_pct / 100);
        });
        const total = subtotal + ivaTotal;
        el.innerHTML = `
        <div style="display:flex;justify-content:flex-end;gap:20px;font-size:13px">
            <div style="color:var(--text-faint)">Subtotal: <strong>‚Ç¨${subtotal.toFixed(2)}</strong></div>
            <div style="color:var(--text-faint)">IVA: <strong>‚Ç¨${ivaTotal.toFixed(2)}</strong></div>
            <div style="color:var(--primary-dark);font-weight:700;font-size:15px">Total: ‚Ç¨${total.toFixed(2)}</div>
        </div>`;
    }

    async function salvarCompra(id) {
        const get = k => { const el = document.getElementById('fc_'+k); return el ? el.value||null : null; };
        const fornId   = get('fornecedor_id');
        const fornNome = fornId ? (fornecedoresData.find(f=>f.id===fornId)?.nome||null) : get('fornecedor_nome');
        const dataFatura = get('data_fatura');
        if (!dataFatura) { showFormMsg('Data da fatura obrigat√≥ria.','error'); return; }
        if (!compraItensTemp.length) { showFormMsg('Adiciona pelo menos um item.','error'); return; }

        let subtotal = 0, ivaTotal = 0;
        compraItensTemp.forEach(item => {
            const base = item.quantidade * item.preco_unitario;
            subtotal += base;
            ivaTotal += base * (item.iva_pct/100);
        });
        const total = subtotal + ivaTotal;

        // Calcular vencimento
        let dataVenc = get('data_vencimento');
        if (!dataVenc) {
            const cond = get('condicao_pagamento') || '30_dias';
            const dias = {a_vista:0, '30_dias':30, '60_dias':60, '90_dias':90, parcelado:30}[cond] || 30;
            const d = new Date(dataFatura);
            d.setDate(d.getDate() + dias);
            dataVenc = d.toISOString().split('T')[0];
        }

        const body = {
            fornecedor_id: fornId || null,
            fornecedor_nome: fornNome,
            numero_fatura: get('numero_fatura'),
            data_fatura: dataFatura,
            data_vencimento: dataVenc,
            categoria: get('categoria'),
            forma_pagamento: get('forma_pagamento'),
            condicao_pagamento: get('condicao_pagamento'),
            observacoes: get('observacoes'),
            subtotal: parseFloat(subtotal.toFixed(2)),
            iva: parseFloat(ivaTotal.toFixed(2)),
            total: parseFloat(total.toFixed(2)),
            status: 'pendente',
            operador: currentUser?.nome || null,
            updated_at: new Date().toISOString(),
        };

        const btn = document.getElementById('btn-save');
        btn.disabled = true; btn.textContent = 'A guardar...';

        try {
            let compraId = id;
            if (!id) {
                const res = await sb('compras', {method:'POST', body:JSON.stringify(body)});
                compraId = res?.[0]?.id;
            } else {
                await sb(`compras?id=eq.${id}`, {method:'PATCH', body:JSON.stringify(body)});
                // Apagar itens antigos
                await sb(`compra_itens?compra_id=eq.${id}`, {method:'DELETE'});
            }

            if (!compraId) throw new Error('Erro ao obter ID da compra.');

            // Inserir itens + actualizar stock
            for (const item of compraItensTemp) {
                // Guardar stock antes
                let stockAntes = null;
                if (item.produto_id && item.atualizar_stock) {
                    const tabela = item.origem === 'loja' ? 'loja_produtos' : 'keola_menu';
                    const campo  = item.origem === 'loja' ? 'stock' : null;
                    if (campo) {
                        const prod = await sb(`${tabela}?id=eq.${item.produto_id}&select=${campo}`).catch(()=>[]);
                        stockAntes = prod?.[0]?.[campo] ?? null;
                    }
                }

                const itemBody = {
                    compra_id: compraId,
                    produto_id: item.produto_id || null,
                    origem: item.origem,
                    descricao: item.descricao,
                    quantidade: item.quantidade,
                    preco_unitario: item.preco_unitario,
                    iva_pct: item.iva_pct,
                    atualizar_stock: item.atualizar_stock,
                    stock_antes: stockAntes,
                };

                if (item.produto_id && item.atualizar_stock && item.origem === 'loja') {
                    const novoStock = (stockAntes || 0) + Math.round(item.quantidade);
                    itemBody.stock_depois = novoStock;
                    await sb(`loja_produtos?id=eq.${item.produto_id}`, {
                        method: 'PATCH',
                        body: JSON.stringify({stock: novoStock}),
                    });
                }

                await sb('compra_itens', {method:'POST', body:JSON.stringify(itemBody)});
            }

            // Criar / actualizar Conta a Pagar automaticamente
            const contaExistente = contasPagarData.find(cp => cp.compra_id === compraId);
            const contaBody = {
                compra_id: compraId,
                fornecedor_id: fornId || null,
                fornecedor_nome: fornNome,
                descricao: `Fatura ${body.numero_fatura||compraId.slice(0,8)} ‚Äî ${fornNome||'Fornecedor'}`,
                numero_documento: body.numero_fatura,
                categoria: body.categoria || 'fornecedor',
                valor_total: body.total,
                valor_pago: 0,
                data_emissao: body.data_fatura,
                data_vencimento: dataVenc,
                forma_pagamento: body.forma_pagamento,
                status: 'pendente',
                updated_at: new Date().toISOString(),
            };

            if (!contaExistente) {
                await sb('contas_pagar', {method:'POST', body:JSON.stringify(contaBody)});
            } else {
                await sb(`contas_pagar?id=eq.${contaExistente.id}`, {method:'PATCH', body:JSON.stringify(contaBody)});
            }

            showFormMsg('Fatura guardada! Stock e conta a pagar atualizados.', 'success');
            await carregarDadosFinanceiros();
            setTimeout(() => { closeDrawer(); renderFinanceiro(); }, 900);

        } catch(e) {
            showFormMsg('Erro: '+(e?.message||JSON.stringify(e)), 'error');
            btn.disabled = false; btn.textContent = 'Guardar e Criar Conta a Pagar';
        }
    }

    async function marcarCompraPaga(id) {
        await sb(`compras?id=eq.${id}`, {method:'PATCH', body:JSON.stringify({status:'pago', updated_at:new Date().toISOString()})});
        await sb(`contas_pagar?compra_id=eq.${id}`, {method:'PATCH', body:JSON.stringify({status:'pago', data_pagamento:new Date().toISOString().split('T')[0], valor_pago:(contasPagarData.find(c=>c.compra_id===id)?.valor_total||0), updated_at:new Date().toISOString()})});
        await carregarDadosFinanceiros();
        renderFinanceiro();
    }

    function abrirContaPagarDeCompra(compraId) {
        finTab = 1;
        renderFinanceiro();
        // Scroll / highlight da conta correspondente
        setTimeout(() => {
            const el = document.querySelector(`[data-compra-id="${compraId}"]`);
            if (el) el.scrollIntoView({behavior:'smooth'});
        }, 200);
    }

    // ‚îÄ‚îÄ ABA 1: CONTAS A PAGAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderContasPagar() {
        const hoje = new Date().toISOString().split('T')[0];
        // Filtros
        const filtForn  = finFiltros.fornecedor_id;
        const filtSt    = finFiltros.status;
        const filtMes   = finFiltros.mes;
        const filtCat   = finFiltros.categoria;

        let lista = [...contasPagarData];
        if (filtForn) lista = lista.filter(c => c.fornecedor_id === filtForn);
        if (filtSt)   lista = lista.filter(c => c.status === filtSt);
        if (filtCat)  lista = lista.filter(c => c.categoria === filtCat);
        if (filtMes)  lista = lista.filter(c => c.data_vencimento?.startsWith(filtMes));

        const totalPendente = lista.filter(c => c.status==='pendente'||c.status==='atrasado').reduce((a,c) => a+Number(c.valor_pendente||c.valor_total||0),0);
        const totalAtrasado = lista.filter(c => c.status==='atrasado').reduce((a,c) => a+Number(c.valor_pendente||c.valor_total||0),0);
        const totalPago     = lista.filter(c => c.status==='pago').reduce((a,c) => a+Number(c.valor_total||0),0);

        // Meses dispon√≠veis
        const meses = [...new Set(contasPagarData.map(c => c.data_vencimento?.slice(0,7)).filter(Boolean))].sort().reverse();
        const fornDisponiveis = [...new Set(contasPagarData.map(c => c.fornecedor_id).filter(Boolean))];
        const mesOpts = meses.map(m => {
            const [ano,mes] = m.split('-');
            const label = new Date(ano, mes-1).toLocaleDateString('pt-PT',{month:'long',year:'numeric'});
            return `<option value="${m}" ${filtMes===m?'selected':''}>${label}</option>`;
        }).join('');
        const fornOpts = fornecedoresData.filter(f => fornDisponiveis.includes(f.id))
            .map(f => `<option value="${f.id}" ${filtForn===f.id?'selected':''}>${f.nome}</option>`).join('');

        const STATUS_STYLE = {
            pendente:  'background:rgba(230,81,0,0.1);color:#e65100;border:1px solid rgba(230,81,0,0.3)',
            pago:      'background:rgba(46,125,50,0.1);color:#2e7d32;border:1px solid rgba(46,125,50,0.3)',
            atrasado:  'background:rgba(198,40,40,0.1);color:#c62828;border:1px solid rgba(198,40,40,0.3)',
            parcial:   'background:rgba(0,144,152,0.1);color:var(--primary-dark);border:1px solid rgba(0,144,152,0.3)',
            cancelado: 'background:var(--bg-input);color:var(--text-faint);border:1px solid var(--border)',
        };

        let html = `
        <div style="display:flex;gap:8px;padding:12px 16px 8px;flex-wrap:wrap">
            ${statBox('A Pagar', totalPendente, 'var(--orange,#e65100)', lista.filter(c=>c.status==='pendente'||c.status==='atrasado').length+' contas')}
            ${statBox('Em Atraso', totalAtrasado, 'var(--red)', lista.filter(c=>c.status==='atrasado').length+' contas')}
            ${statBox('Pago (filtro)', totalPago, 'var(--green)', lista.filter(c=>c.status==='pago').length+' contas')}
        </div>

        <div style="padding:0 16px 8px;display:flex;gap:6px;flex-wrap:wrap;align-items:center">
            <select class="toolbar-filter" onchange="finFiltros.mes=this.value;setFinTab(1)" style="border-radius:20px;padding:7px 12px;border:1px solid var(--border);background:var(--bg-input);font-size:12px;cursor:pointer">
                <option value="">Todos os meses</option>${mesOpts}
            </select>
            <select class="toolbar-filter" onchange="finFiltros.fornecedor_id=this.value;setFinTab(1)" style="border-radius:20px;padding:7px 12px;border:1px solid var(--border);background:var(--bg-input);font-size:12px;cursor:pointer">
                <option value="">Todos os fornecedores</option>${fornOpts}
            </select>
            <select class="toolbar-filter" onchange="finFiltros.status=this.value;setFinTab(1)" style="border-radius:20px;padding:7px 12px;border:1px solid var(--border);background:var(--bg-input);font-size:12px;cursor:pointer">
                <option value="">Todos os estados</option>
                <option value="pendente"  ${filtSt==='pendente'?'selected':''}>Pendente</option>
                <option value="atrasado"  ${filtSt==='atrasado'?'selected':''}>Atrasado</option>
                <option value="pago"      ${filtSt==='pago'?'selected':''}>Pago</option>
                <option value="parcial"   ${filtSt==='parcial'?'selected':''}>Parcial</option>
                <option value="cancelado" ${filtSt==='cancelado'?'selected':''}>Cancelado</option>
            </select>
            <select class="toolbar-filter" onchange="finFiltros.categoria=this.value;setFinTab(1)" style="border-radius:20px;padding:7px 12px;border:1px solid var(--border);background:var(--bg-input);font-size:12px;cursor:pointer">
                <option value="">Todas as categorias</option>
                <option value="fornecedor">Fornecedor</option>
                <option value="renda">Renda</option>
                <option value="servicos">Servi√ßos</option>
                <option value="utilities">Utilities</option>
                <option value="salarios">Sal√°rios</option>
                <option value="impostos">Impostos</option>
                <option value="outros">Outros</option>
            </select>
            <button class="btn-new" onclick="abrirFormContaPagar(null)">+ Manual</button>
        </div>`;

        if (!lista.length) {
            return html + `<div class="empty"><div class="empty-icon">‚Äî</div><div class="empty-txt">Nenhuma conta a pagar com este filtro.</div></div>`;
        }

        // Agrupar por m√™s de vencimento
        const grupos = {};
        lista.forEach(c => {
            const mes = c.data_vencimento?.slice(0,7) || 'sem-data';
            if (!grupos[mes]) grupos[mes] = [];
            grupos[mes].push(c);
        });

        html += '<div style="padding:0 16px 16px">';
        Object.keys(grupos).sort().reverse().forEach(mes => {
            const label = mes === 'sem-data' ? 'Sem Data' : (() => {
                const [ano,m] = mes.split('-');
                return new Date(ano,m-1).toLocaleDateString('pt-PT',{month:'long',year:'numeric'});
            })();
            const totalMes = grupos[mes].reduce((a,c) => a+Number(c.valor_pendente||0),0);
            html += `<div style="font-family:var(--font-title);font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--text-faint);padding:12px 0 6px;display:flex;justify-content:space-between;align-items:center">
                <span>${label}</span>
                <span style="color:var(--primary-dark)">‚Ç¨${totalMes.toFixed(2)} pendente</span>
            </div>`;
            grupos[mes].forEach((c, i) => {
                const venc = c.data_vencimento ? new Date(c.data_vencimento).toLocaleDateString('pt-PT') : '‚Äî';
                const isAtrasado = c.status === 'atrasado';
                const st = STATUS_STYLE[c.status] || STATUS_STYLE.pendente;
                html += `
                <div class="admin-row" data-compra-id="${c.compra_id||''}" style="margin-bottom:6px;flex-wrap:wrap;gap:6px;${isAtrasado?'border-color:rgba(198,40,40,0.3)':''}">
                    <div class="admin-row-info" style="flex:1;min-width:0">
                        <div class="admin-row-nome" style="font-size:13px">${c.descricao||'‚Äî'}</div>
                        <div class="admin-row-sub">
                            ${c.fornecedor_nome||c.fornecedores?.nome||'Sem fornecedor'} ¬∑ Vence: ${venc}
                            ${c.forma_pagamento?'¬∑ '+c.forma_pagamento:''}
                        </div>
                        <div class="admin-row-badges">
                            <span class="badge" style="${st}">${c.status?.toUpperCase()}</span>
                            ${c.categoria?`<span class="badge badge-gray">${c.categoria}</span>`:''}
                            ${c.compra_id?'<span class="badge badge-primary">Fatura</span>':''}
                        </div>
                    </div>
                    <div style="text-align:right;flex-shrink:0">
                        <div style="font-family:var(--font-title);font-size:16px;font-weight:700;color:${isAtrasado?'var(--red)':'var(--primary-dark)'}">‚Ç¨${Number(c.valor_total||0).toFixed(2)}</div>
                        ${c.valor_pago>0?`<div style="font-size:10px;color:var(--green)">Pago: ‚Ç¨${Number(c.valor_pago).toFixed(2)}</div>`:''}
                    </div>
                    <div class="admin-row-actions" style="width:100%;justify-content:flex-end">
                        ${c.status!=='pago'&&c.status!=='cancelado'?`
                            <button class="btn-toggle ativo" onclick="marcarContaPaga('${c.id}',${c.valor_total})">Marcar Pago</button>
                            <button class="btn-edit" onclick="abrirPagamentoParcial('${c.id}','${c.descricao?.replace(/'/g,"\\'")}',${ c.valor_total},${c.valor_pago||0})">Parcial</button>
                        `:''}
                        <button class="btn-edit" onclick="abrirFormContaPagar('${c.id}')">Editar</button>
                        ${c.status!=='cancelado'?`<button class="btn-toggle ativo" style="color:var(--text-faint)" onclick="cancelarConta('${c.id}')">Cancelar</button>`:''}
                    </div>
                </div>`;
            });
        });
        html += '</div>';
        return html;
    }

    async function marcarContaPaga(id, valorTotal) {
        await sb(`contas_pagar?id=eq.${id}`, {
            method:'PATCH',
            body:JSON.stringify({
                status:'pago', valor_pago:valorTotal,
                data_pagamento:new Date().toISOString().split('T')[0],
                updated_at:new Date().toISOString(),
            })
        });
        await carregarDadosFinanceiros();
        renderFinanceiro();
    }

    async function cancelarConta(id) {
        if (!confirm('Cancelar esta conta a pagar?')) return;
        await sb(`contas_pagar?id=eq.${id}`, {method:'PATCH', body:JSON.stringify({status:'cancelado', updated_at:new Date().toISOString()})});
        await carregarDadosFinanceiros();
        renderFinanceiro();
    }

    function abrirPagamentoParcial(id, descricao, valorTotal, valorJaPago) {
        document.getElementById('drawer-title').textContent = 'Pagamento Parcial';
        const pendente = (valorTotal - valorJaPago).toFixed(2);
        document.getElementById('drawer-body').innerHTML = `<div class="form-grid">
        <div class="msg-form" id="form-msg"></div>
        <div style="background:var(--primary-faint);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:4px;font-size:13px;line-height:1.8" class="form-full">
            <strong>${descricao}</strong><br>
            Total: ‚Ç¨${Number(valorTotal).toFixed(2)} ¬∑ J√° pago: ‚Ç¨${Number(valorJaPago).toFixed(2)} ¬∑ <strong>Pendente: ‚Ç¨${pendente}</strong>
        </div>
        <div class="form-group form-full"><label class="form-label">Valor a pagar agora (‚Ç¨)</label>
            <input class="form-input" id="pp_valor" type="number" step="0.01" min="0.01" max="${pendente}" value="${pendente}"></div>
        <div class="form-group form-full"><label class="form-label">Forma de Pagamento</label>
            <select class="form-select" id="pp_forma">
                <option value="transferencia">Transfer√™ncia</option>
                <option value="mbway">MBWay</option>
                <option value="multibanco">Multibanco</option>
                <option value="dinheiro">Dinheiro</option>
            </select></div>
        <div class="form-group form-full"><label class="form-label">Refer√™ncia (opcional)</label>
            <input class="form-input" id="pp_ref" type="text" placeholder="N¬∫ transfer√™ncia, comprovativo..."></div>
        <div class="form-actions">
            <button class="btn-cancel-form" onclick="closeDrawer()">Cancelar</button>
            <button class="btn-save" onclick="registarPagamentoParcial('${id}',${valorTotal},${valorJaPago})">Registar Pagamento</button>
        </div></div>`;
        document.getElementById('overlay').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    async function registarPagamentoParcial(id, valorTotal, valorJaPago) {
        const valor = parseFloat(document.getElementById('pp_valor')?.value || 0);
        const forma = document.getElementById('pp_forma')?.value;
        const ref   = document.getElementById('pp_ref')?.value;
        if (!valor || valor <= 0) { showFormMsg('Valor inv√°lido.','error'); return; }
        const novoPago = valorJaPago + valor;
        const novoStatus = novoPago >= valorTotal ? 'pago' : 'parcial';
        await sb(`contas_pagar?id=eq.${id}`, {
            method:'PATCH',
            body:JSON.stringify({
                valor_pago: parseFloat(novoPago.toFixed(2)),
                status: novoStatus,
                forma_pagamento: forma,
                referencia_pagamento: ref || null,
                data_pagamento: novoStatus==='pago' ? new Date().toISOString().split('T')[0] : null,
                updated_at: new Date().toISOString(),
            })
        });
        showFormMsg('Pagamento registado!','success');
        await carregarDadosFinanceiros();
        setTimeout(() => { closeDrawer(); renderFinanceiro(); }, 700);
    }

    function abrirFormContaPagar(id) {
        const c = id ? contasPagarData.find(x => x.id === id) : null;
        const fv = (k,d='') => c?.[k] ?? d;
        const fornOpts = fornecedoresData.map(f =>
            `<option value="${f.id}" ${fv('fornecedor_id')===f.id?'selected':''}>${f.nome}</option>`
        ).join('');
        document.getElementById('drawer-title').textContent = c ? 'Editar Conta a Pagar' : 'Nova Conta a Pagar';
        document.getElementById('drawer-body').innerHTML = `<div class="form-grid">
        <div class="msg-form" id="form-msg"></div>
        <div class="form-group form-full"><label class="form-label">Descri√ß√£o *</label>
            <input class="form-input" id="cp_descricao" type="text" value="${fv('descricao')}" placeholder="Ex: Fatura energia setembro"></div>
        <div class="form-group form-full"><label class="form-label">Fornecedor</label>
            <select class="form-select" id="cp_fornecedor_id">
                <option value="">-- Nenhum --</option>${fornOpts}
            </select></div>
        <div class="form-group form-full"><label class="form-label">Fornecedor (nome manual)</label>
            <input class="form-input" id="cp_fornecedor_nome" type="text" value="${fv('fornecedor_nome')}" placeholder="Se n√£o estiver na lista"></div>
        <div class="form-group"><label class="form-label">Valor Total (‚Ç¨) *</label>
            <input class="form-input" id="cp_valor_total" type="number" step="0.01" value="${fv('valor_total',0)}"></div>
        <div class="form-group"><label class="form-label">N¬∫ Documento</label>
            <input class="form-input" id="cp_numero_documento" type="text" value="${fv('numero_documento')}"></div>
        <div class="form-group"><label class="form-label">Data Emiss√£o</label>
            <input class="form-input" id="cp_data_emissao" type="date" value="${fv('data_emissao', new Date().toISOString().split('T')[0])}"></div>
        <div class="form-group"><label class="form-label">Data Vencimento *</label>
            <input class="form-input" id="cp_data_vencimento" type="date" value="${fv('data_vencimento')}"></div>
        <div class="form-group"><label class="form-label">Categoria</label>
            <select class="form-select" id="cp_categoria">
                <option value="fornecedor" ${fv('categoria')==='fornecedor'?'selected':''}>Fornecedor</option>
                <option value="renda"      ${fv('categoria')==='renda'?'selected':''}>Renda</option>
                <option value="servicos"   ${fv('categoria')==='servicos'?'selected':''}>Servi√ßos</option>
                <option value="utilities"  ${fv('categoria')==='utilities'?'selected':''}>Utilities</option>
                <option value="salarios"   ${fv('categoria')==='salarios'?'selected':''}>Sal√°rios</option>
                <option value="impostos"   ${fv('categoria')==='impostos'?'selected':''}>Impostos / AT</option>
                <option value="outros"     ${fv('categoria')==='outros'?'selected':''}>Outros</option>
            </select></div>
        <div class="form-group"><label class="form-label">Forma Pagamento</label>
            <select class="form-select" id="cp_forma_pagamento">
                <option value="transferencia">Transfer√™ncia</option>
                <option value="mbway">MBWay</option>
                <option value="multibanco">Multibanco</option>
                <option value="dinheiro">Dinheiro</option>
                <option value="cheque">Cheque</option>
            </select></div>
        <div class="form-group"><label class="form-toggle"><input type="checkbox" id="cp_recorrente" ${fv('recorrente')?'checked':''}><span>Recorrente</span></label></div>
        <div class="form-group form-full"><label class="form-label">Observa√ß√µes</label>
            <textarea class="form-textarea" id="cp_observacoes">${fv('observacoes')}</textarea></div>
        <div class="form-actions">
            <button class="btn-cancel-form" onclick="closeDrawer()">Cancelar</button>
            <button class="btn-save" id="btn-save" onclick="salvarContaPagar('${c?.id||''}')">Guardar</button>
        </div></div>`;
        document.getElementById('overlay').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    async function salvarContaPagar(id) {
        const get = k => { const el = document.getElementById('cp_'+k); return el ? el.value||null : null; };
        const chk = k => { const el = document.getElementById('cp_'+k); return el ? el.checked : false; };
        const descricao = get('descricao');
        const valorTotal = parseFloat(get('valor_total')||0);
        const dataVenc   = get('data_vencimento');
        if (!descricao)  { showFormMsg('Descri√ß√£o obrigat√≥ria.','error'); return; }
        if (!valorTotal) { showFormMsg('Valor obrigat√≥rio.','error'); return; }
        if (!dataVenc)   { showFormMsg('Data de vencimento obrigat√≥ria.','error'); return; }
        const fornId = get('fornecedor_id');
        const body = {
            descricao, valor_total:valorTotal,
            fornecedor_id: fornId || null,
            fornecedor_nome: fornId ? null : get('fornecedor_nome'),
            numero_documento: get('numero_documento'),
            data_emissao: get('data_emissao'),
            data_vencimento: dataVenc,
            categoria: get('categoria'),
            forma_pagamento: get('forma_pagamento'),
            recorrente: chk('recorrente'),
            observacoes: get('observacoes'),
            status: 'pendente',
            updated_at: new Date().toISOString(),
        };
        const btn = document.getElementById('btn-save');
        btn.disabled = true; btn.textContent = 'A guardar...';
        try {
            if (!id) await sb('contas_pagar', {method:'POST', body:JSON.stringify(body)});
            else     await sb(`contas_pagar?id=eq.${id}`, {method:'PATCH', body:JSON.stringify(body)});
            showFormMsg('Guardado!','success');
            await carregarDadosFinanceiros();
            setTimeout(() => { closeDrawer(); renderFinanceiro(); }, 700);
        } catch(e) {
            showFormMsg('Erro: '+(e?.message||JSON.stringify(e)),'error');
            btn.disabled = false; btn.textContent = 'Guardar';
        }
    }

    // ‚îÄ‚îÄ ABA 2: CONTAS A RECEBER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderContasReceber() {
        const hoje = new Date().toISOString().split('T')[0];
        const totalPendente = contasReceberData.filter(c=>c.status==='pendente'||c.status==='atrasado').reduce((a,c)=>a+Number(c.valor_pendente||0),0);
        const totalRecebido = contasReceberData.filter(c=>c.status==='recebido').reduce((a,c)=>a+Number(c.valor_total||0),0);

        const STATUS_STYLE = {
            pendente:  'background:rgba(230,81,0,0.1);color:#e65100;border:1px solid rgba(230,81,0,0.3)',
            recebido:  'background:rgba(46,125,50,0.1);color:#2e7d32;border:1px solid rgba(46,125,50,0.3)',
            atrasado:  'background:rgba(198,40,40,0.1);color:#c62828;border:1px solid rgba(198,40,40,0.3)',
            parcial:   'background:rgba(0,144,152,0.1);color:var(--primary-dark);border:1px solid rgba(0,144,152,0.3)',
            cancelado: 'background:var(--bg-input);color:var(--text-faint);border:1px solid var(--border)',
        };
        const TIPO_LABEL = {dizimo:'D√≠zimo',oferta:'Oferta',venda:'Venda',evento:'Evento',curso:'Curso',outro:'Outro'};

        let html = `
        <div style="display:flex;gap:8px;padding:12px 16px 8px;flex-wrap:wrap">
            ${statBox('A Receber', totalPendente, 'var(--primary-dark)', contasReceberData.filter(c=>c.status==='pendente'||c.status==='atrasado').length+' contas')}
            ${statBox('Recebido', totalRecebido, 'var(--green)', contasReceberData.filter(c=>c.status==='recebido').length+' contas')}
        </div>
        <div style="padding:0 16px 8px;display:flex;justify-content:flex-end">
            <button class="btn-new" onclick="abrirFormContaReceber(null)">+ Nova</button>
        </div>`;

        if (!contasReceberData.length) {
            return html + `<div class="empty"><div class="empty-icon">‚Äî</div>
            <div class="empty-txt">Em constru√ß√£o. Aqui aparecer√£o os d√≠zimos, ofertas e outras entradas.<br>Podes j√° lan√ßar entradas manualmente.</div></div>`;
        }

        html += '<div class="admin-list" style="padding:0 16px 16px">';
        contasReceberData.forEach((c, i) => {
            const venc = c.data_vencimento ? new Date(c.data_vencimento).toLocaleDateString('pt-PT') : '‚Äî';
            const st   = STATUS_STYLE[c.status] || STATUS_STYLE.pendente;
            html += `
            <div class="admin-row" style="flex-wrap:wrap;gap:6px;animation-delay:${Math.min(i,12)*0.02}s">
                <div class="admin-row-foto" style="background:var(--primary-faint);color:var(--primary-dark);font-size:10px;font-weight:700">${TIPO_LABEL[c.tipo]?.slice(0,3)||'OUT'}</div>
                <div class="admin-row-info" style="flex:1;min-width:0">
                    <div class="admin-row-nome">${c.descricao}</div>
                    <div class="admin-row-sub">${c.membro_nome||'Sem membro'} ¬∑ Vence: ${venc}</div>
                    <div class="admin-row-badges">
                        <span class="badge" style="${st}">${c.status?.toUpperCase()}</span>
                        <span class="badge badge-gray">${TIPO_LABEL[c.tipo]||c.tipo}</span>
                    </div>
                </div>
                <div style="text-align:right;flex-shrink:0">
                    <div style="font-family:var(--font-title);font-size:16px;font-weight:700;color:var(--primary-dark)">‚Ç¨${Number(c.valor_total||0).toFixed(2)}</div>
                    ${c.valor_recebido>0?`<div style="font-size:10px;color:var(--green)">Recebido: ‚Ç¨${Number(c.valor_recebido).toFixed(2)}</div>`:''}
                </div>
                <div class="admin-row-actions" style="width:100%;justify-content:flex-end">
                    ${c.status!=='recebido'&&c.status!=='cancelado'?`<button class="btn-toggle ativo" onclick="marcarContaRecebida('${c.id}',${c.valor_total})">Marcar Recebido</button>`:''}
                    <button class="btn-edit" onclick="abrirFormContaReceber('${c.id}')">Editar</button>
                </div>
            </div>`;
        });
        html += '</div>';
        return html;
    }

    async function marcarContaRecebida(id, valor) {
        await sb(`contas_receber?id=eq.${id}`, {
            method:'PATCH',
            body:JSON.stringify({status:'recebido', valor_recebido:valor, data_recebimento:new Date().toISOString().split('T')[0], updated_at:new Date().toISOString()})
        });
        await carregarDadosFinanceiros();
        renderFinanceiro();
    }

    function abrirFormContaReceber(id) {
        const c = id ? contasReceberData.find(x=>x.id===id) : null;
        const fv = (k,d='') => c?.[k] ?? d;
        const membOpts = membros.map(m => `<option value="${m.id}" ${fv('membro_id')===m.id?'selected':''}>${m.nome}</option>`).join('');
        document.getElementById('drawer-title').textContent = c ? 'Editar Conta a Receber' : 'Nova Conta a Receber';
        document.getElementById('drawer-body').innerHTML = `<div class="form-grid">
        <div class="msg-form" id="form-msg"></div>
        <div class="form-group form-full"><label class="form-label">Descri√ß√£o *</label>
            <input class="form-input" id="cr_descricao" type="text" value="${fv('descricao')}" placeholder="Ex: D√≠zimo Jo√£o ‚Äî Mar√ßo 2026"></div>
        <div class="form-group"><label class="form-label">Tipo</label>
            <select class="form-select" id="cr_tipo">
                <option value="dizimo"   ${fv('tipo','dizimo')==='dizimo'?'selected':''}>D√≠zimo</option>
                <option value="oferta"   ${fv('tipo')==='oferta'?'selected':''}>Oferta</option>
                <option value="venda"    ${fv('tipo')==='venda'?'selected':''}>Venda (Loja/Keola)</option>
                <option value="evento"   ${fv('tipo')==='evento'?'selected':''}>Evento</option>
                <option value="curso"    ${fv('tipo')==='curso'?'selected':''}>Curso ZAO</option>
                <option value="outro"    ${fv('tipo')==='outro'?'selected':''}>Outro</option>
            </select></div>
        <div class="form-group form-full"><label class="form-label">Membro</label>
            <select class="form-select" id="cr_membro_id">
                <option value="">-- Sem membro --</option>${membOpts}
            </select></div>
        <div class="form-group"><label class="form-label">Valor Total (‚Ç¨) *</label>
            <input class="form-input" id="cr_valor_total" type="number" step="0.01" value="${fv('valor_total',0)}"></div>
        <div class="form-group"><label class="form-label">Data Vencimento</label>
            <input class="form-input" id="cr_data_vencimento" type="date" value="${fv('data_vencimento')}"></div>
        <div class="form-group form-full"><label class="form-label">Observa√ß√µes</label>
            <textarea class="form-textarea" id="cr_observacoes">${fv('observacoes')}</textarea></div>
        <div class="form-actions">
            <button class="btn-cancel-form" onclick="closeDrawer()">Cancelar</button>
            <button class="btn-save" id="btn-save" onclick="salvarContaReceber('${c?.id||''}')">Guardar</button>
        </div></div>`;
        document.getElementById('overlay').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    async function salvarContaReceber(id) {
        const get = k => { const el = document.getElementById('cr_'+k); return el ? el.value||null : null; };
        const desc = get('descricao');
        const val  = parseFloat(get('valor_total')||0);
        if (!desc) { showFormMsg('Descri√ß√£o obrigat√≥ria.','error'); return; }
        if (!val)  { showFormMsg('Valor obrigat√≥rio.','error'); return; }
        const memId = get('membro_id');
        const body = {
            descricao:desc, tipo:get('tipo'), valor_total:val,
            membro_id: memId||null,
            membro_nome: memId ? (membros.find(m=>m.id===memId)?.nome||null) : null,
            data_vencimento:get('data_vencimento'),
            observacoes:get('observacoes'),
            status:'pendente', updated_at:new Date().toISOString(),
        };
        const btn = document.getElementById('btn-save');
        btn.disabled=true; btn.textContent='A guardar...';
        try {
            if (!id) await sb('contas_receber',{method:'POST',body:JSON.stringify(body)});
            else     await sb(`contas_receber?id=eq.${id}`,{method:'PATCH',body:JSON.stringify(body)});
            showFormMsg('Guardado!','success');
            await carregarDadosFinanceiros();
            setTimeout(()=>{closeDrawer();renderFinanceiro();},700);
        } catch(e) {
            showFormMsg('Erro: '+(e?.message||JSON.stringify(e)),'error');
            btn.disabled=false; btn.textContent='Guardar';
        }
    }


    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // PERMISS√ïES ‚Äî NAV HIDE + GUARD
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function aplicarPermissoesNav() {
        document.querySelectorAll('.nav-item[data-secao]').forEach(el => {
            const secao = el.dataset.secao;
            if (secao && !perm(secao, 'ver')) {
                el.style.display = 'none';
            } else {
                el.style.display = '';
            }
        });
    }

    // Aplica guard nos bot√µes de ac√ß√£o da sec√ß√£o activa
    function aplicarPermissoesSecao(secao) {
        // Bot√£o Novo
        document.querySelectorAll('.btn-new').forEach(btn => {
            if (!perm(secao, 'criar')) {
                btn.style.display = 'none';
            }
        });
        // Bot√µes Editar
        document.querySelectorAll('.btn-edit').forEach(btn => {
            if (!perm(secao, 'editar')) {
                btn.disabled = true;
                btn.style.opacity = '0.35';
                btn.title = 'Sem permiss√£o para editar';
            }
        });
        // Bot√µes Toggle/Delete/Inativar
        document.querySelectorAll('.btn-toggle').forEach(btn => {
            if (!perm(secao, 'eliminar')) {
                btn.disabled = true;
                btn.style.opacity = '0.35';
                btn.title = 'Sem permiss√£o';
            }
        });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // GEST√ÉO DE UTILIZADORES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let utilizadoresData = [];

    const TODAS_SECOES = [
        { key: 'dashboard',    label: 'Dashboard' },
        { key: 'membros',      label: 'Membros' },
        { key: 'pastores',     label: 'Pastores' },
        { key: 'links',        label: 'Links' },
        { key: 'cultos',       label: 'Cultos' },
        { key: 'ministerios',  label: 'Minist√©rios' },
        { key: 'salas',        label: 'Salas' },
        { key: 'cursos',       label: 'Cursos ZAO' },
        { key: 'keola',        label: 'Keola' },
        { key: 'loja',         label: 'Loja' },
        { key: 'eventos',      label: 'Eventos' },
        { key: 'fornecedores', label: 'Fornecedores' },
        { key: 'financeiro',   label: 'Financeiro' },
        { key: 'configuracoes',label: 'Configura√ß√µes' },
    ];

    async function carregarUtilizadores() {
        utilizadoresData = await sb('usuarios?select=*&order=nome') || [];
        renderUtilizadores();
    }

    function renderUtilizadores() {
        const q = getQ();
        let lista = utilizadoresData;
        if (!filtroInativo) lista = lista.filter(u => u.ativo !== false);
        else lista = lista.filter(u => u.ativo === false);
        if (q) lista = lista.filter(u =>
            (u.nome||'').toLowerCase().includes(q) ||
            (u.email||'').toLowerCase().includes(q)
        );

        const TIPO_LABEL = { admin:'Admin', membro:'Membro', visitante:'Visitante', outro:'Outro' };
        const TIPO_COR   = { admin:'badge-red', membro:'badge-primary', visitante:'badge-gray', outro:'badge-gray' };

        let html = `
        <div class="section-toolbar" style="position:sticky;top:0;z-index:10">
            <input class="toolbar-search" id="toolbar-search-input" placeholder="Pesquisar utilizador..." oninput="handleSearch()" value="${q}">
            <button class="toolbar-filter ${filtroInativo?'active':''}" onclick="toggleFiltroInativo()">Inativos</button>
            <button class="btn-new" onclick="abrirFormUtilizador(null)" ${btnGuard('utilizadores','criar')}>+ Novo</button>
        </div>
        <div style="padding:8px 16px 0;font-size:11px;color:var(--text-faint)">${lista.length} utilizador(es)</div>
        <div class="admin-list">`;

        lista.forEach((u, i) => {
            const tipo  = TIPO_LABEL[u.tipo] || u.tipo || '‚Äî';
            const badge = TIPO_COR[u.tipo]   || 'badge-gray';
            // Contar quantas sec√ß√µes tem acesso
            const numAcessos = TODAS_SECOES.filter(s => u[`ver_${s.key}`] || u.e_admin).length;
            html += `
            <div class="admin-row" style="animation-delay:${Math.min(i,12)*0.02}s">
                <div class="admin-row-foto" style="background:var(--primary-faint);color:var(--primary-dark);font-size:13px;font-weight:700">${(u.nome||u.email||'U')[0].toUpperCase()}</div>
                <div class="admin-row-info">
                    <div class="admin-row-nome">${u.nome || u.email || '‚Äî'}</div>
                    <div class="admin-row-sub">${u.email || ''}</div>
                    <div class="admin-row-badges">
                        <span class="badge ${badge}">${tipo}</span>
                        ${u.e_admin ? '<span class="badge badge-red">Admin Total</span>' : `<span class="badge badge-gray">${numAcessos} sec√ß√µes</span>`}
                        ${u.ativo===false ? '<span class="badge badge-gray">Inativo</span>' : ''}
                    </div>
                </div>
                <div class="admin-row-actions">
                    <button class="btn-edit" onclick="abrirFormUtilizador('${u.id}')" ${btnGuard('utilizadores','editar')}>Editar</button>
                    <button class="btn-toggle ${u.ativo!==false?'ativo':'inativo'}" onclick="toggleAtivoUtilizador('${u.id}',${u.ativo!==false})" ${btnGuard('utilizadores','eliminar')}>${u.ativo!==false?'Inativar':'Ativar'}</button>
                </div>
            </div>`;
        });

        html += '</div>';
        document.getElementById('main-content').innerHTML = html;
        restoreSearch(q);
    }

    async function toggleAtivoUtilizador(id, ativo) {
        await sb(`usuarios?id=eq.${id}`, {method:'PATCH', body:JSON.stringify({ativo:!ativo})});
        await carregarUtilizadores();
    }

    function abrirFormUtilizador(id) {
        const u = id ? utilizadoresData.find(x => x.id === id) : null;
        document.getElementById('drawer-title').textContent = u ? 'Editar Utilizador' : 'Novo Utilizador';
        document.getElementById('drawer-body').innerHTML = buildFormUtilizador(u);
        document.getElementById('overlay').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        // Listener para "Admin Total" toggle
        document.getElementById('uf_admin')?.addEventListener('change', function() {
            const bloco = document.getElementById('bloco-perms');
            if (bloco) bloco.style.opacity = this.checked ? '0.35' : '1';
            if (bloco) bloco.style.pointerEvents = this.checked ? 'none' : '';
        });
    }

    function buildFormUtilizador(u) {
        const fv  = (k, d='') => u?.[k] ?? d;
        const chk = (k, d=false) => (u?.[k] ?? d) ? 'checked' : '';

        // Construir a tabela de permiss√µes por sec√ß√£o
        const headerPerms = `
        <div style="display:grid;grid-template-columns:1fr repeat(4,56px);gap:4px;font-size:9px;font-family:var(--font-title);letter-spacing:1px;color:var(--text-faint);text-transform:uppercase;padding:4px 8px;border-bottom:1px solid var(--border);margin-bottom:4px">
            <div>Sec√ß√£o</div><div style="text-align:center">Ver</div><div style="text-align:center">Criar</div><div style="text-align:center">Editar</div><div style="text-align:center">Eliminar</div>
        </div>`;

        const linhasPerms = TODAS_SECOES.map(s => `
        <div style="display:grid;grid-template-columns:1fr repeat(4,56px);gap:4px;align-items:center;padding:5px 8px;border-radius:6px;background:var(--bg-card);margin-bottom:3px">
            <div style="font-size:12px">${s.label}</div>
            <div style="text-align:center"><input type="checkbox" id="pv_ver_${s.key}"      ${chk('ver_'+s.key)}      onchange="sincronizarPerms('${s.key}','ver',this.checked)"></div>
            <div style="text-align:center"><input type="checkbox" id="pv_criar_${s.key}"    ${chk('criar_'+s.key)}    onchange="sincronizarPerms('${s.key}','criar',this.checked)"></div>
            <div style="text-align:center"><input type="checkbox" id="pv_editar_${s.key}"   ${chk('editar_'+s.key)}   onchange="sincronizarPerms('${s.key}','editar',this.checked)"></div>
            <div style="text-align:center"><input type="checkbox" id="pv_eliminar_${s.key}" ${chk('eliminar_'+s.key)} onchange="sincronizarPerms('${s.key}','eliminar',this.checked)"></div>
        </div>`).join('');

        return `<div class="form-grid">
        <div class="msg-form" id="form-msg"></div>

        <div class="form-section-title">Dados do Utilizador</div>
        <div class="form-group form-full"><label class="form-label">Nome</label>
            <input class="form-input" id="uf_nome" type="text" value="${fv('nome')}" placeholder="Nome completo"></div>
        <div class="form-group form-full"><label class="form-label">Email *</label>
            <input class="form-input" id="uf_email" type="email" value="${fv('email')}" placeholder="email@exemplo.com" ${u?'readonly':''}></div>
        ${!u ? `<div class="form-group form-full"><label class="form-label">Password (inicial)</label>
            <input class="form-input" id="uf_password" type="password" placeholder="M√≠nimo 6 caracteres"></div>` : ''}
        <div class="form-group"><label class="form-label">Tipo</label>
            <select class="form-select" id="uf_tipo">
                <option value="membro"    ${fv('tipo','membro')==='membro'?'selected':''}>Membro</option>
                <option value="visitante" ${fv('tipo')==='visitante'?'selected':''}>Visitante</option>
                <option value="admin"     ${fv('tipo')==='admin'?'selected':''}>Admin</option>
                <option value="outro"     ${fv('tipo')==='outro'?'selected':''}>Outro</option>
            </select></div>
        <div class="form-group" style="display:flex;align-items:center;gap:10px;padding-top:20px">
            <label class="form-toggle">
                <input type="checkbox" id="uf_admin" ${chk('e_admin')}>
                <span>Admin Total (acesso a tudo)</span>
            </label>
        </div>
        <div class="form-group">
            <label class="form-toggle">
                <input type="checkbox" id="uf_ativo" ${u?.ativo===false?'':'checked'}><span>Ativo</span>
            </label>
        </div>

        <div class="form-section-title" style="display:flex;justify-content:space-between;align-items:center;grid-column:1/-1">
            <span>Permiss√µes por Sec√ß√£o</span>
            <div style="display:flex;gap:6px">
                <button type="button" onclick="definirTodasPerms(true)"  style="font-size:10px;padding:3px 10px;border-radius:20px;border:1px solid var(--primary);background:var(--primary-faint);color:var(--primary-dark);cursor:pointer">Selecionar Tudo</button>
                <button type="button" onclick="definirTodasPerms(false)" style="font-size:10px;padding:3px 10px;border-radius:20px;border:1px solid var(--border);background:var(--bg-input);color:var(--text-faint);cursor:pointer">Limpar Tudo</button>
            </div>
        </div>

        <div class="form-full" id="bloco-perms" style="${chk('e_admin')?'opacity:0.35;pointer-events:none':''}">
            <div style="font-size:11px;color:var(--text-faint);margin-bottom:8px">
                üí° <strong>Ver</strong> = acesso √† aba ¬∑ <strong>Criar</strong> = pode adicionar ¬∑ <strong>Editar</strong> = pode modificar ¬∑ <strong>Eliminar</strong> = pode desativar/apagar
            </div>
            ${headerPerms}
            ${linhasPerms}
        </div>

        <div class="form-actions">
            <button class="btn-cancel-form" onclick="closeDrawer()">Cancelar</button>
            <button class="btn-save" id="btn-save" onclick="salvarUtilizador('${u?.id||''}')">Guardar</button>
        </div></div>`;
    }

    // Quando marca Criar/Editar/Eliminar ‚Äî garante que Ver tamb√©m fica marcado
    function sincronizarPerms(secao, accao, checked) {
        if (checked && accao !== 'ver') {
            const verEl = document.getElementById(`pv_ver_${secao}`);
            if (verEl) verEl.checked = true;
        }
        // Se desmarcar Ver ‚Äî desmarca tudo
        if (!checked && accao === 'ver') {
            ['criar','editar','eliminar'].forEach(a => {
                const el = document.getElementById(`pv_${a}_${secao}`);
                if (el) el.checked = false;
            });
        }
    }

    function definirTodasPerms(valor) {
        TODAS_SECOES.forEach(s => {
            ['ver','criar','editar','eliminar'].forEach(a => {
                const el = document.getElementById(`pv_${a}_${s.key}`);
                if (el) el.checked = valor;
            });
        });
    }

    async function salvarUtilizador(id) {
        const get = k => { const el = document.getElementById('uf_'+k); return el ? el.value?.trim()||null : null; };
        const chk = k => { const el = document.getElementById('uf_'+k); return el ? el.checked : false; };

        const email = get('email');
        if (!email) { showFormMsg('Email obrigat√≥rio.','error'); return; }

        // Colunas de permiss√£o que existem na tabela usuarios
        // (excluir 'utilizadores' e 'dashboard' que n√£o t√™m colunas CRUD na BD)
        const SECOES_BD = ['membros','pastores','links','cultos','ministerios',
            'salas','cursos','keola','loja','eventos','fornecedores','financeiro','configuracoes'];
        const ACCOES_BD = ['ver','criar','editar','eliminar'];
        // ver_dashboard existe mas n√£o tem criar/editar/eliminar
        const perms = { ver_dashboard: document.getElementById('pv_ver_dashboard')?.checked || false };

        SECOES_BD.forEach(s => {
            ACCOES_BD.forEach(a => {
                const el = document.getElementById(`pv_${a}_${s}`);
                perms[`${a}_${s}`] = el ? el.checked : false;
            });
        });

        const isAdmin = chk('admin');
        if (isAdmin) {
            perms.ver_dashboard = true;
            SECOES_BD.forEach(s => {
                ACCOES_BD.forEach(a => { perms[`${a}_${s}`] = true; });
            });
        }

        // Um √∫nico body com tudo junto
        const bodyCompleto = {
            nome:    get('nome'),
            tipo:    get('tipo'),
            e_admin: isAdmin,
            ativo:   chk('ativo'),
            updated_at: new Date().toISOString(),
            ...perms,
        };

        const btn = document.getElementById('btn-save');
        btn.disabled = true; btn.textContent = 'A guardar...';

        try {
            if (!id) {
                const existente = await sb(`usuarios?email=eq.${encodeURIComponent(email)}&select=id`).catch(()=>[]);
                if (existente?.length) { showFormMsg('J√° existe um utilizador com este email.','error'); btn.disabled=false; btn.textContent='Guardar'; return; }
                const password = get('password');
                if (!password || password.length < 6) { showFormMsg('Password m√≠nima de 6 caracteres.','error'); btn.disabled=false; btn.textContent='Guardar'; return; }
                bodyCompleto.email         = email;
                bodyCompleto.password_hash = btoa(password);
                await sb('usuarios', {method:'POST', body:JSON.stringify(bodyCompleto)});
            } else {
                await sb(`usuarios?id=eq.${id}`, {method:'PATCH', body:JSON.stringify(bodyCompleto)});
            }

            showFormMsg('Guardado!','success');
            utilizadoresData = await sb('usuarios?select=*&order=nome') || [];
            setTimeout(closeDrawer, 700);
        } catch(e) {
            showFormMsg('Erro: '+(e?.message||JSON.stringify(e)),'error');
            btn.disabled = false; btn.textContent = 'Guardar';
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // KEOLA MELHORADO ‚Äî CAMPOS + KIT SYSTEM
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    // Override da fun√ß√£o camposKeola com campos completos
    // (a fun√ß√£o original ser√° sobreposta por esta)
    function camposKeola() { return [
        {type:'section', label:'Identifica√ß√£o'},
        {key:'nome',      label:'Nome *', ph:'Ex: Bitoque, Caf√©, Sumo', full:true},
        {key:'tipo_item', label:'Tipo de Item', type:'select', options:[
            {v:'componente', l:'Componente (ingrediente / mat√©ria-prima)'},
            {v:'venda',      l:'Item de Venda (produto final)'},
            {v:'kit',        l:'Kit / Prato (montado com componentes)'},
        ]},
        {key:'categoria', label:'Categoria', type:'select', options:[
            {v:'almoco',l:'Almo√ßo'},{v:'bebidas',l:'Bebidas'},{v:'sumos',l:'Sumos'},
            {v:'snacks',l:'Snacks'},{v:'sobremesas',l:'Sobremesas'},{v:'outro',l:'Outros'}
        ]},
        {key:'tipo_comida', label:'Tipo de Comida', type:'select', options:[
            {v:'',l:'‚Äî Nenhum ‚Äî'},{v:'carne',l:'Carne'},{v:'peixe',l:'Peixe'},
            {v:'vegetariano',l:'Vegetariano'},{v:'vegan',l:'Vegan'},
            {v:'sem_gluten',l:'Sem Gl√∫ten'},{v:'sobremesa',l:'Sobremesa'},
            {v:'bebida',l:'Bebida'},{v:'outro',l:'Outro'},
        ]},
        {key:'descricao', label:'Descri√ß√£o', type:'textarea', ph:'Breve descri√ß√£o...', full:true},

        {type:'section', label:'Pre√ßos'},
        {key:'preco',       label:'Pre√ßo de Venda (‚Ç¨)', type:'number', ph:'0.00'},
        // Nota: componentes n√£o t√™m pre√ßo de venda ‚Äî ocultado via JS no injectKitPanel
        {key:'preco_custo', label:'Custo Unit√°rio (‚Ç¨/un ¬∑ ‚Ç¨/g ¬∑ ‚Ç¨/kg ¬∑ ‚Ç¨/l)', type:'number', ph:'0.0000'},
        {key:'iva_pct',     label:'IVA (%)', type:'number', ph:'13'},

        {type:'section', label:'Stock'},
        {key:'unidade',     label:'Unidade de Stock', type:'select', options:[
            {v:'un',l:'Unidade (un)'},{v:'g',l:'Gramas (g)'},{v:'kg',l:'Quilograma (kg)'},
            {v:'ml',l:'Mililitro (ml)'},{v:'l',l:'Litro (l)'},
        ]},
        {key:'stock',         label:'Stock Actual', type:'number', ph:'0'},
        {key:'stock_minimo',  label:'Stock M√≠nimo (alerta)', type:'number', ph:'0'},

        {key:'alergenos',  label:'Al√©rgenos', ph:'Gl√∫ten, Lactose, Soja...', full:true},
        {key:'ordem',      label:'Ordem no Menu', type:'number', ph:'1'},
        {key:'imagem_url', label:'Foto', type:'image', bucket:'imagens', full:true},
        {key:'mostrar_pdv',   label:'Mostrar no PDV', type:'checkbox', default:true},
        {key:'disponivel',    label:'Dispon√≠vel',      type:'checkbox', default:true},
        {key:'especial_hoje', label:'Especial Hoje',   type:'checkbox'},
    ];}

    // Override do renderSecao para Keola ‚Äî adicionar bot√£o Kit e painel de componentes
    const _renderSecaoOriginal = typeof renderSecao === 'function' ? renderSecao : null;

    // Hook: ap√≥s abrir drawer para keola, mostrar/esconder sec√ß√£o kit
    const _buildFormOriginal = typeof buildForm === 'function' ? buildForm : null;

    // ‚îÄ‚îÄ Keola custom render ap√≥s guard padr√£o ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Adiciona o bot√£o "Montar Pratos" aos kits na listagem
    function patchKeolaRow(r) {
        if (r.tipo_item !== 'kit') return '';
        const maxKits = calcularMaxKits(r.id);
        return `<button class="btn-sub-add" style="font-size:11px" onclick="abrirModalMontarKit('${r.id}','${r.nome?.replace(/'/g,"\\'")}')">üçΩ Montar (${maxKits} poss√≠veis)</button>`;
    }

    // Cache de componentes para calcular max kits
    let keolaComponentesCache = {}; // kit_id -> [{componente_id, quantidade, unidade, stock, nome}]

    async function carregarComponentesCache() {
        const comps = await sb('keola_kit_componentes?select=*,keola_menu!keola_kit_componentes_componente_id_fkey(id,nome,stock,unidade)').catch(()=>[]);
        keolaComponentesCache = {};
        (comps||[]).forEach(c => {
            if (!keolaComponentesCache[c.kit_id]) keolaComponentesCache[c.kit_id] = [];
            keolaComponentesCache[c.kit_id].push({
                ...c,
                stock:  c.keola_menu?.stock  || 0,
                nome:   c.keola_menu?.nome   || '‚Äî',
                unidade:c.keola_menu?.unidade|| 'un',
            });
        });
    }

    function calcularMaxKits(kitId) {
        const comps = keolaComponentesCache[kitId];
        if (!comps || !comps.length) return '?';
        let max = Infinity;
        comps.forEach(c => {
            if (c.quantidade > 0) {
                const possivel = Math.floor(c.stock / c.quantidade);
                max = Math.min(max, possivel);
            }
        });
        return max === Infinity ? 0 : max;
    }

    // ‚îÄ‚îÄ Modal: Montar Kit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function abrirModalMontarKit(kitId, kitNome) {
        const comps = keolaComponentesCache[kitId] || [];
        const maxKits = calcularMaxKits(kitId);

        const linhasComps = comps.map(c => {
            const possivel = c.quantidade > 0 ? Math.floor(c.stock / c.quantidade) : '‚àû';
            return `<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 10px;background:var(--bg-card);border-radius:6px;margin-bottom:3px;font-size:12px">
                <span>${c.nome}</span>
                <span style="color:var(--text-faint)">${c.quantidade} ${c.unidade} √ó prato ¬∑ Stock: <strong>${c.stock}</strong> ¬∑ Poss√≠vel: <strong style="color:${possivel<5?'var(--red)':'var(--green)'}">${possivel}</strong></span>
            </div>`;
        }).join('');

        document.getElementById('drawer-title').textContent = `Montar: ${kitNome}`;
        document.getElementById('drawer-body').innerHTML = `<div class="form-grid">
        <div class="msg-form" id="form-msg"></div>

        <div class="form-section-title">Componentes necess√°rios por prato</div>
        <div class="form-full">${linhasComps || '<div style="color:var(--text-faint);font-size:12px">Nenhum componente configurado. Edita o item e define os componentes.</div>'}</div>

        <div class="form-section-title" style="grid-column:1/-1;display:flex;justify-content:space-between;align-items:center">
            <span>Quantos pratos montar?</span>
            <span style="font-size:11px;color:var(--${maxKits>0?'green':'red'})">M√°ximo poss√≠vel: <strong>${maxKits}</strong></span>
        </div>

        <div class="form-group form-full">
            <input class="form-input" id="mk_quantidade" type="number" min="1" max="${maxKits}" value="${Math.min(1, maxKits)}" style="font-size:20px;text-align:center;height:60px;font-family:var(--font-title)">
        </div>

        <div class="form-actions">
            <button class="btn-cancel-form" onclick="closeDrawer()">Cancelar</button>
            <button class="btn-save" id="btn-save" onclick="executarMontagem('${kitId}','${kitNome?.replace(/'/g,"\\'")}',${maxKits})" ${maxKits<=0?'disabled':''}>
                üçΩ Confirmar Montagem
            </button>
        </div></div>`;
        document.getElementById('overlay').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    async function executarMontagem(kitId, kitNome, maxKits) {
        const qty = parseInt(document.getElementById('mk_quantidade')?.value || 0);
        if (!qty || qty <= 0) { showFormMsg('Quantidade inv√°lida.','error'); return; }
        if (qty > maxKits) { showFormMsg(`M√°ximo poss√≠vel: ${maxKits} pratos.`,'error'); return; }

        const btn = document.getElementById('btn-save');
        btn.disabled = true; btn.textContent = 'A montar...';

        const comps = keolaComponentesCache[kitId] || [];
        const consumidos = [];

        try {
            // 1. Reduzir stock de cada componente
            for (const c of comps) {
                const consumo    = c.quantidade * qty;
                const novoStock  = Math.max(0, c.stock - consumo);
                await sb(`keola_menu?id=eq.${c.componente_id}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ stock: novoStock, updated_at: new Date().toISOString() }),
                });
                // Log de movimento
                await sb('keola_stock_movimentos', {
                    method: 'POST',
                    body: JSON.stringify({
                        item_id: c.componente_id, item_nome: c.nome,
                        tipo: 'montagem', quantidade: -consumo,
                        stock_antes: c.stock, stock_depois: novoStock,
                        referencia: `montagem_kit_${kitId}`,
                        notas: `Montagem de ${qty}√ó ${kitNome}`,
                        operador: currentUser?.nome || null,
                    }),
                });
                consumidos.push({ id: c.componente_id, nome: c.nome, consumido: consumo, stock_depois: novoStock });
                // Actualizar cache local
                c.stock = novoStock;
            }

            // 2. Aumentar stock do kit
            const kitActual = registos.find(r => r.id === kitId);
            const stockKitAntes  = kitActual?.stock_kits || 0;
            const stockKitDepois = stockKitAntes + qty;
            await sb(`keola_menu?id=eq.${kitId}`, {
                method: 'PATCH',
                body: JSON.stringify({ stock_kits: stockKitDepois, updated_at: new Date().toISOString() }),
            });

            // 3. Registar montagem no hist√≥rico
            await sb('keola_montagens', {
                method: 'POST',
                body: JSON.stringify({
                    kit_id: kitId, kit_nome: kitNome,
                    quantidade: qty,
                    stock_antes: stockKitAntes, stock_depois: stockKitDepois,
                    componentes_consumidos: consumidos,
                    operador: currentUser?.nome || null,
                }),
            });

            showFormMsg(`‚úì ${qty} prato(s) montado(s)! Stock actualizado.`, 'success');
            // Recarregar
            registos = await sb(`keola_menu?select=*&order=categoria,nome`) || [];
            await carregarComponentesCache();
            setTimeout(() => { closeDrawer(); renderSecao(); }, 1000);

        } catch(e) {
            showFormMsg('Erro: '+(e?.message||JSON.stringify(e)),'error');
            btn.disabled = false; btn.textContent = 'üçΩ Confirmar Montagem';
        }
    }

    // ‚îÄ‚îÄ Painel de componentes no drawer de edi√ß√£o Keola ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let keolaKitItensTemp = []; // componentes em edi√ß√£o no formul√°rio

    async function abrirKeolaComCustom(id) {
        // Carregar componentes do kit se for edi√ß√£o
        keolaKitItensTemp = [];
        if (id) {
            const comps = await sb(`keola_kit_componentes?select=*,keola_menu!keola_kit_componentes_componente_id_fkey(id,nome,unidade)&kit_id=eq.${id}`).catch(()=>[]);
            keolaKitItensTemp = (comps||[]).map(c => ({
                componente_id: c.componente_id,
                nome: c.keola_menu?.nome || '‚Äî',
                quantidade: c.quantidade,
                unidade: c.unidade || c.keola_menu?.unidade || 'un',
            }));
        }
    }

    // Injectar painel Kit ap√≥s o formul√°rio standard ser renderizado
    function injectKitPanel(kitId) {
        const drawer = document.getElementById('drawer-body');
        if (!drawer) return;

        document.getElementById('kit-panel')?.remove();

        const selTipo = drawer.querySelector('select[id*="tipo_item"]') ||
                        [...drawer.querySelectorAll('select')].find(s =>
                            s.closest('.form-group')?.querySelector('label')?.textContent?.includes('Tipo de Item')
                        );

        if (selTipo) {
            ajustarCamposKeolaPorTipo(selTipo.value);
            selTipo.addEventListener('change', () => {
                ajustarCamposKeolaPorTipo(selTipo.value);
                toggleKitPanel(selTipo.value, kitId);
            });
            if (selTipo.value === 'kit') toggleKitPanel('kit', kitId);
        }
    }

    function ajustarCamposKeolaPorTipo(tipo) {
        // Campo pre√ßo de venda ‚Äî ocultar para componentes
        const camposPreco = [...document.querySelectorAll('#drawer-body .form-group')].filter(g =>
            g.querySelector('label')?.textContent?.includes('Pre√ßo de Venda')
        );
        camposPreco.forEach(g => {
            g.style.display = tipo === 'componente' ? 'none' : '';
        });
        // Campo mostrar_pdv ‚Äî ocultar para componentes (nunca aparecem no PDV)
        const camposPdv = [...document.querySelectorAll('#drawer-body .form-group')].filter(g =>
            g.querySelector('label')?.textContent?.includes('Mostrar no PDV')
        );
        camposPdv.forEach(g => {
            g.style.display = tipo === 'componente' ? 'none' : '';
        });
    }

    function toggleKitPanel(tipoItem, kitId) {
        document.getElementById('kit-panel')?.remove();
        if (tipoItem !== 'kit') return;

        // Buscar itens do tipo componente dispon√≠veis
        const componentes = registos.filter(r => r.tipo_item === 'componente');
        const compOpts = componentes.map(c =>
            `<option value="${c.id}" data-nome="${c.nome?.replace(/"/g,'&quot;')}" data-unidade="${c.unidade||'un'}">${c.nome} (${c.unidade||'un'} ¬∑ Stock: ${c.stock||0})</option>`
        ).join('');

        const panel = document.createElement('div');
        panel.id = 'kit-panel';
        panel.style.cssText = 'grid-column:1/-1;background:var(--bg-input);border:1px solid var(--primary);border-radius:10px;padding:14px;margin-top:4px';
        panel.innerHTML = `
        <div style="font-family:var(--font-title);font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--primary-dark);margin-bottom:10px">üß© Componentes do Kit</div>
        <div style="font-size:11px;color:var(--text-faint);margin-bottom:8px">Define quais os ingredientes/componentes e a quantidade necess√°ria para montar 1 unidade deste prato.</div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px">
            <select class="form-select" id="kc-sel" style="flex:2;min-width:150px">
                <option value="">Seleciona componente...</option>${compOpts}
            </select>
            <input class="form-input" id="kc-qty" type="number" value="1" step="0.001" min="0.001" placeholder="Qtd" style="width:80px">
            <input class="form-input" id="kc-unit" type="text" value="" placeholder="Un." style="width:60px" readonly>
            <button class="btn-sub-add" onclick="adicionarComponenteKit()">+ Add</button>
        </div>
        <div id="kit-comp-lista"></div>`;

        // Inserir antes dos form-actions
        const actions = document.querySelector('.form-actions');
        if (actions) actions.parentNode.insertBefore(panel, actions);
        else document.getElementById('drawer-body').appendChild(panel);

        // Auto-preencher unidade ao selecionar componente
        document.getElementById('kc-sel')?.addEventListener('change', function() {
            const opt = this.options[this.selectedIndex];
            const unit = document.getElementById('kc-unit');
            if (unit) unit.value = opt?.dataset?.unidade || 'un';
        });

        renderComponentesKitTemp();
    }

    function adicionarComponenteKit() {
        const sel   = document.getElementById('kc-sel');
        const opt   = sel?.options[sel.selectedIndex];
        const qty   = parseFloat(document.getElementById('kc-qty')?.value || 0);
        const unit  = document.getElementById('kc-unit')?.value || 'un';
        const compId = sel?.value;
        if (!compId) { alert('Seleciona um componente.'); return; }
        if (qty <= 0) { alert('Quantidade deve ser > 0.'); return; }
        if (keolaKitItensTemp.find(c => c.componente_id === compId)) {
            alert('Componente j√° adicionado. Remove e adiciona novamente se precisares de alterar a quantidade.'); return;
        }
        keolaKitItensTemp.push({ componente_id: compId, nome: opt?.dataset?.nome || opt?.text || '‚Äî', quantidade: qty, unidade: unit });
        sel.value = ''; document.getElementById('kc-qty').value = '1'; document.getElementById('kc-unit').value = '';
        renderComponentesKitTemp();
    }

    function removerComponenteKit(idx) {
        keolaKitItensTemp.splice(idx, 1);
        renderComponentesKitTemp();
    }

    function renderComponentesKitTemp() {
        const el = document.getElementById('kit-comp-lista');
        if (!el) return;
        if (!keolaKitItensTemp.length) {
            el.innerHTML = '<div style="font-size:11px;color:var(--text-faint);padding:4px 0">Nenhum componente definido.</div>';
            return;
        }
        el.innerHTML = keolaKitItensTemp.map((c, i) => `
        <div style="display:flex;align-items:center;gap:8px;background:var(--bg-card);border-radius:6px;padding:7px 10px;margin-bottom:3px;font-size:12px">
            <span style="flex:1">${c.nome}</span>
            <span style="color:var(--primary-dark);font-weight:700">${c.quantidade} ${c.unidade}</span>
            <button onclick="removerComponenteKit(${i})" style="color:var(--red);background:none;border:none;cursor:pointer;font-size:12px;padding:2px 6px">‚úï</button>
        </div>`).join('');
    }

    // Guardar componentes do kit ap√≥s guardar o item keola
    async function salvarComponentesKit(kitId) {
        // Apagar existentes
        await sb(`keola_kit_componentes?kit_id=eq.${kitId}`, {method:'DELETE'}).catch(()=>{});
        // Inserir novos
        for (const c of keolaKitItensTemp) {
            await sb('keola_kit_componentes', {
                method: 'POST',
                body: JSON.stringify({
                    kit_id: kitId,
                    componente_id: c.componente_id,
                    quantidade: c.quantidade,
                    unidade: c.unidade,
                }),
            });
        }
        // Actualizar cache
        await carregarComponentesCache();
    }

    // Patch: interceptar o btn-save do keola para guardar tamb√©m os componentes
    function patchKeolaSave(itemId) {
        const btn = document.getElementById('btn-save');
        if (!btn) return;
        const originalOnclick = btn.getAttribute('onclick');
        btn.setAttribute('onclick', '');
        btn.onclick = async function() {
            // Executar o save original
            btn.setAttribute('onclick', originalOnclick);
            btn.click();
            // Aguardar o registo ser criado/atualizado
            // O save original fecha o drawer ‚Äî interceptamos antes disso
        };
    }


    init();
</script>
</body>
</html>
