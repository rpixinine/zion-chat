<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Painel Admin ‚Äî Zion Lisboa</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/tokens.css">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/components.css">
    <script src="config.js"></script>
    <script src="auth.js"></script>
    <style>
        .welcome-card {
            display: flex;
            align-items: center;
            justify-content: center;   /* centralizado */
            gap: 10px;
            padding: 6px 16px;
            background: var(--primary-faint);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            text-align: center;
        }
        .welcome-card img {
            height: 28px;
            width: auto;
            object-fit: contain;
        }
        .welcome-card p {
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.4;
        }
        .welcome-card strong {
            color: var(--primary-dark);
            font-family: var(--font-title);
            font-size: 10px;
            letter-spacing: 1px;
        }
        /* Banner fixo em 70px */
        .banner { min-height: 70px !important; max-height: 70px !important; }
        .banner img { height: 70px !important; }
        .banner-fallback { height: 70px !important; }

        /* Tabela de configura√ß√µes */
        .config-table { width:100%; border-collapse:collapse; font-size:13px; }
        .config-table th {
            background:var(--bg-input); padding:8px 12px; text-align:left;
            font-family:var(--font-title); font-size:9px; letter-spacing:2px;
            text-transform:uppercase; color:var(--text-faint); border-bottom:1px solid var(--border);
        }
        .config-table td { padding:10px 12px; border-bottom:1px solid var(--border); vertical-align:top; }
        .config-table tr:last-child td { border-bottom:none; }
        .config-table tr:hover td { background:var(--primary-faint); }
        .config-chave { font-family:var(--font-title); font-size:10px; letter-spacing:1px; color:var(--primary-dark); white-space:nowrap; }
        .config-desc  { font-size:11px; color:var(--text-faint); }
        .config-date  { font-size:10px; color:var(--text-faint); white-space:nowrap; }
        .config-actions { display:flex; gap:6px; white-space:nowrap; }

        /* Painel adicionar membros ao evento */
        .add-member-panel {
            background: var(--bg-input); border: 1px solid var(--border);
            border-radius: 10px; padding: 12px; margin-top: 8px;
        }
        .add-member-panel-title {
            font-family: var(--font-title); font-size: 9px; letter-spacing: 2px;
            text-transform: uppercase; color: var(--text-faint); margin-bottom: 8px;
        }
        .add-member-row { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
        .add-member-list { display: flex; flex-direction: column; gap: 4px; margin-top: 8px; max-height: 200px; overflow-y: auto; }
        .add-member-item {
            display: flex; align-items: center; gap: 8px; padding: 6px 10px;
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px;
        }
        .add-member-item-nome { flex: 1; font-size: 12px; color: var(--text-main); }
        .add-member-item-remove {
            width: 20px; height: 20px; border-radius: 50%; border: none;
            background: rgba(220,80,60,0.1); color: var(--red); font-size: 12px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        /* Gr√°ficos resumo na tela */
        .resumo-graficos {
            padding: 0 16px 16px;
        }
        .grafico-wrap {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 12px; padding: 16px; margin-bottom: 12px;
        }
        .grafico-titulo {
            font-family: var(--font-title); font-size: 10px; letter-spacing: 2px;
            text-transform: uppercase; color: var(--text-faint); margin-bottom: 12px;
        }
        .grafico-barras { display: flex; flex-direction: column; gap: 8px; }
        .grafico-barra-row { display: flex; align-items: center; gap: 8px; }
        .grafico-barra-label { font-size: 11px; color: var(--text-main); width: 140px; flex-shrink: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .grafico-barra-track { flex: 1; background: var(--bg-input); border-radius: 20px; height: 18px; overflow: hidden; }
        .grafico-barra-fill { height: 100%; border-radius: 20px; display: flex; align-items: center; justify-content: flex-end; padding-right: 6px; font-size: 10px; font-weight: bold; color: #fff; transition: width 0.4s ease; min-width: 20px; }
        .grafico-barra-val { font-size: 11px; color: var(--text-faint); width: 50px; text-align: right; flex-shrink: 0; }

        /* Pizza mini */
        .pizza-wrap { display: flex; align-items: center; gap: 20px; flex-wrap: wrap; }
        .pizza-svg { flex-shrink: 0; }
        .pizza-legend { display: flex; flex-direction: column; gap: 6px; }
        .pizza-legend-item { display: flex; align-items: center; gap: 6px; font-size: 12px; }
        .pizza-legend-dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }

        /* Stats summary cards */
        .resumo-stats {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;
            padding: 12px 16px 8px;
        }
        .resumo-stat {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 10px; padding: 12px; text-align: center;
        }
        .resumo-stat-num { font-family: var(--font-title); font-size: 22px; font-weight: 700; }
        .resumo-stat-label { font-size: 10px; color: var(--text-faint); margin-top: 2px; }
        .resumo-stat-pct { font-size: 11px; font-weight: bold; margin-top: 2px; }
    </style>
</head>
<body>
<div class="page-wrapper">

    <div class="banner">
        <img src="assets/banner_zion.jpg" alt="Zion Lisboa"
             onerror="this.onerror=null;this.style.display='none';document.querySelector('.banner-fallback').classList.add('show');">
        <div class="banner-fallback">
            <div class="banner-title">ZION</div>
            <div class="banner-sub">Lisboa ¬∑ Portugal</div>
        </div>
    </div>

    <div class="gold-line"></div>

    <div class="welcome-card">
        <img src="assets/logo_zion.jpg" alt="Logo Zion"
             onerror="this.onerror=null;this.style.display='none';">
        <p><strong>Bem-vindo √† Zion Lisboa</strong><br>Painel de Administra√ß√£o</p>
    </div>

    <div class="user-bar">
        <a href="index.html" class="user-bar-back">&#8592; In√≠cio</a>
        <div class="user-bar-center">
            <div class="user-bar-section" id="secao-label">Cadastros</div>
            <div class="user-bar-date" id="data-hoje"></div>
        </div>
        <div class="user-bar-right">
            <div class="user-bar-nome" id="top-user"></div>
            <button class="logout-btn" onclick="ZionAuth.logout()">Sair</button>
        </div>
    </div>

    <div class="nav-bar" id="nav-bar">
        <div class="nav-item"         onclick="setSecao('dashboard')">Dashboard</div>
        <div class="nav-item active"  onclick="setSecao('membros')">Membros</div>
        <div class="nav-item"         onclick="setSecao('pastores')">Pastores</div>
        <div class="nav-item"         onclick="setSecao('links')">Links</div>
        <div class="nav-item"         onclick="setSecao('cultos')">Cultos</div>
        <div class="nav-item"         onclick="setSecao('ministerios')">Minist√©rios</div>
        <div class="nav-item"         onclick="setSecao('salas')">Salas</div>
        <div class="nav-item"         onclick="setSecao('cursos')">Cursos ZAO</div>
        <div class="nav-item"         onclick="setSecao('keola')">Keola</div>
        <div class="nav-item"         onclick="setSecao('loja')">Loja</div>
        <div class="nav-item"         onclick="setSecao('eventos')">Eventos</div>
        <div class="nav-item"         onclick="setSecao('tipos_evento')">Tipos Evento</div>
        <div class="nav-item"         onclick="setSecao('configuracoes')">‚öô Config</div>
    </div>

    <div class="content" id="main-content">
        <div class="loading"><div class="spin"></div>A verificar acesso...</div>
    </div>

    <div class="footer">
        <div class="footer-links">
            <a class="footer-link" href="https://zionchurch.org.br/" target="_blank">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="12" height="12"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                Site Oficial
            </a>
            <a class="footer-link" href="https://www.instagram.com/zionlisboa/" target="_blank">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="12" height="12"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"/></svg>
                @ZionLisboa
            </a>
        </div>
        <div class="footer-div"></div>
        <div class="footer-copy">¬© 2026 Zion Lisboa ‚Äî Todos os direitos reservados</div>
        <div class="footer-addr">Rua do Centro Cultural, 11 ¬∑ 1700-036 Alvalade ¬∑ Lisboa, Portugal</div>
    </div>
</div>

<div class="overlay hidden" id="overlay" onclick="closeDrawerOutside(event)">
    <div class="drawer" id="drawer">
        <div class="drawer-head">
            <div class="drawer-title" id="drawer-title">Novo Registo</div>
            <button class="drawer-x" onclick="closeDrawer()">‚úï</button>
        </div>
        <div class="drawer-body" id="drawer-body"></div>
    </div>
</div>

<script>
    ZionAuth.protect();
    const currentUser = ZionAuth.getUser();
    const SUPA_URL    = window.SUPABASE_URL      || '';
    const SUPA_KEY    = window.SUPABASE_ANON_KEY || '';

    let secaoAtiva       = 'membros';
    let subTabAtiva      = 0;
    let registos         = [];
    let filtroInativo    = false;
    let membros          = [];
    let links_cache      = [];
    let ministeriosCache = [];

    // ‚îÄ‚îÄ TIPOS DE EVENTO (carregados dinamicamente do localStorage) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Definido mais abaixo em TIPOS DE EVENTO ‚Äî gest√£o na tela,
    // mas precisamos do array dispon√≠vel para buildFormEvento.
    // Usamos uma proxy: getTiposEvento() √© definida mais abaixo;
    // buildFormEvento chama getTiposEvento() directamente em vez deste array.
    const TIPOS_EVENTO = []; // preenchido no init via syncTiposEvento

    function syncTiposEvento() {
        try {
            const saved = localStorage.getItem('zion_tipos_evento');
            const lista = saved ? JSON.parse(saved) : [
                'Reuni√£o de L√≠deres','Culto Especial','Confer√™ncia','Retiro',
                'Treinamento','Workshop','Confer√™ncia de Jovens','Encontro de Casais',
                'Culto de Ora√ß√£o','Semin√°rio','Outro',
            ];
            TIPOS_EVENTO.length = 0;
            lista.forEach(t => TIPOS_EVENTO.push(t));
        } catch { /* usa os existentes */ }
    }

    // ‚îÄ‚îÄ SUPABASE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function sb(path, opts = {}) {
        const r = await fetch(`${SUPA_URL}/rest/v1/${path}`, {
            ...opts,
            headers: {
                'apikey': SUPA_KEY, 'Authorization': `Bearer ${SUPA_KEY}`,
                'Content-Type': 'application/json', 'Prefer': 'return=representation',
                ...opts.headers,
            },
        });
        if (!r.ok) { const e = await r.json().catch(() => {}); throw e; }
        const txt = await r.text();
        return txt ? JSON.parse(txt) : [];
    }

    // ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function init() {
        document.getElementById('top-user').textContent =
            currentUser.nome?.split(' ')[0] || '';
        const hoje = new Date().toLocaleDateString('pt-PT',
            { weekday:'long', day:'numeric', month:'long' });
        document.getElementById('data-hoje').textContent =
            hoje.charAt(0).toUpperCase() + hoje.slice(1);

        const check = await sb(
            `membros?select=e_admin,e_presbitero&email=eq.${encodeURIComponent(currentUser.email)}&ativo=eq.true`
        );
        const m = check?.[0];
        if (!m || (!m.e_admin && !m.e_presbitero)) {
            document.getElementById('nav-bar').style.display = 'none';
            document.getElementById('main-content').innerHTML = `
            <div class="acesso-negado">
                <div class="acesso-negado-icon">‚úï</div>
                <div class="acesso-negado-title">Acesso Restrito</div>
                <div class="acesso-negado-txt">Esta √°rea √© exclusiva para Administradores e Presb√≠teros.</div>
            </div>`;
            return;
        }
        membros = await sb('membros?select=id,nome&ativo=eq.true&order=nome') || [];
        syncTiposEvento();
        await setSecao('membros');
    }

    // ‚îÄ‚îÄ SEC√á√ïES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function setSecao(secao) {
        secaoAtiva = secao; filtroInativo = false; subTabAtiva = 0;
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        const nomes = {
            dashboard:'Dashboard',
            membros:'Membros', pastores:'Pastores', links:'Links', cultos:'Cultos',
            ministerios:'Minist√©rios', salas:'Salas', cursos:'Cursos ZAO',
            keola:'Keola ‚Äî Menu', loja:'Loja', eventos:'Eventos',
            tipos_evento:'Tipos de Evento', configuracoes:'Configura√ß√µes',
        };
        const sl = document.getElementById('secao-label');
        if (sl) sl.textContent = nomes[secao] || 'Cadastros';
        const idx = ['dashboard','membros','pastores','links','cultos','ministerios','salas',
            'cursos','keola','loja','eventos','tipos_evento','configuracoes'];
        const ni = document.querySelectorAll('.nav-item')[idx.indexOf(secao)];
        if (ni) ni.classList.add('active');
        await carregarSecao();
    }

    async function carregarSecao() {
        document.getElementById('main-content').innerHTML =
            '<div class="loading"><div class="spin"></div>A carregar...</div>';
        if (secaoAtiva === 'dashboard') {
            renderDashboardGeral(); return;
        }
        if (secaoAtiva === 'tipos_evento') {
            renderTiposEvento(); return;
        }
        if (secaoAtiva === 'eventos') {
            eventosData = await sb('eventos?select=*&order=data_inicio') || [];
            eventoAtivo = null; eventoSubTab = 0;
            renderEventos(); return;
        }
        if (secaoAtiva === 'configuracoes') {
            await carregarConfiguracoes(); return;
        }
        const cfg = SECOES[secaoAtiva];
        registos = await sb(`${cfg.tabela}?select=*&order=${cfg.orderBy||'nome'}`) || [];
        if (secaoAtiva === 'membros') {
            if (!links_cache.length)
                links_cache = await sb('links?select=id,nome&ativo=eq.true&order=nome') || [];
            await carregarVisitantes();
        }
        renderSecao();
    }

    // ‚îÄ‚îÄ CONFIG DAS SEC√á√ïES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const SECOES = {
        membros:     { tabela:'membros',       orderBy:'nome',          campos:camposMembros,    subTabs:['Dashboard','Membros','Visitantes'] },
        pastores:    { tabela:'pastores',      orderBy:'nome',          campos:camposPastores },
        links:       { tabela:'links',         orderBy:'nome',          campos:camposLinks },
        cultos:      { tabela:'cultos',        orderBy:'nome',          campos:camposCultos },
        ministerios: { tabela:'ministerios',   orderBy:'nome',          campos:camposMinisterios, subTabs:['Minist√©rio','L√≠deres'] },
        salas:       { tabela:'salas',         orderBy:'nome',          campos:camposSalas },
        cursos:      { tabela:'zao_cursos',    orderBy:'nome',          campos:camposCursos,      subTabs:['Curso','Instrutores'] },
        keola:       { tabela:'keola_menu',    orderBy:'categoria,nome',campos:camposKeola,       ativoKey:'disponivel' },
        loja:        { tabela:'loja_produtos', orderBy:'categoria,nome',campos:camposLoja },
        eventos:     { tabela:'eventos',       orderBy:'data_inicio',   campos:camposEventos,     customRender:true },
    };

    // ‚îÄ‚îÄ RENDER SEC√á√ÉO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function getQ() {
        const el = document.getElementById('toolbar-search-input');
        return el ? el.value.toLowerCase() : '';
    }
    function restoreSearch(q) {
        const el = document.getElementById('toolbar-search-input');
        if (el && q) { el.value = q; el.focus(); el.setSelectionRange(q.length, q.length); }
    }
    function handleSearch() {
        if (secaoAtiva === 'eventos')       { renderEventos();        return; }
        if (secaoAtiva === 'configuracoes') { renderConfiguracoes();   return; }
        renderSecao();
    }

    async function renderSecao() {
        const cfg      = SECOES[secaoAtiva];
        if (!cfg) return;
        const ativoKey = cfg.ativoKey || 'ativo';
        const q        = getQ();
        const temSubTabs = !!cfg.subTabs;
        if (temSubTabs && secaoAtiva === 'membros') {
            if (subTabAtiva === 0) { renderDashboardMembros(); return; }
            if (subTabAtiva === 1) { /* cai para renderSecao normal abaixo */ }
            if (subTabAtiva === 2) { await renderVisitantesTab(); return; }
        } else if (temSubTabs && subTabAtiva >= 1) {
            if (secaoAtiva !== 'membros' && subTabAtiva === 1) { renderInfoSubTab(); return; }
        }
        let lista = [...registos];
        if (!filtroInativo) lista = lista.filter(r => r[ativoKey] !== false);
        else                lista = lista.filter(r => r[ativoKey] === false);
        if (q) lista = lista.filter(r =>
            (r.nome||r.categoria||r.titulo||'').toLowerCase().includes(q)
        );
        let html = `
    <div class="section-toolbar" style="position:sticky;top:0;z-index:10">
        <input class="toolbar-search" id="toolbar-search-input"
               placeholder="Pesquisar..." oninput="handleSearch()" value="">
        <button class="toolbar-filter ${filtroInativo?'active':''}" onclick="toggleFiltroInativo()">Inativos</button>
        <button class="btn-new" onclick="abrirForm(null)">+ Novo</button>
    </div>`;
        if (temSubTabs) {
            html += `<div class="sub-tabs">
            ${cfg.subTabs.map((t,i)=>`<button class="sub-tab ${subTabAtiva===i?'active':''}" onclick="setSubTab(${i})">${t}</button>`).join('')}
        </div>`;
        }
        if (!lista.length) {
            html += `<div class="empty"><div class="empty-icon">‚Äî</div>
            <div class="empty-txt">${filtroInativo?'Nenhum registo inativo.':'Nenhum registo. Clica em + Novo.'}</div></div>`;
            document.getElementById('main-content').innerHTML = html;
            restoreSearch(q); return;
        }
        html += '<div class="admin-list">';
        lista.forEach((r, i) => {
            const ativo   = r[ativoKey] !== false;
            const imgUrl  = r.foto_url || r.imagem_url;
            let fotoHtml;
            if (imgUrl) {
                const ini = (r.nome||r.categoria||'-')[0];
                fotoHtml = `<div class="admin-row-foto" style="overflow:hidden;padding:0">
                <img src="${imgUrl}" alt="${r.nome||''}"
                     style="width:100%;height:100%;object-fit:cover"
                     onerror="this.parentElement.style.padding='';this.parentElement.innerHTML='${ini}'">
            </div>`;
            } else {
                fotoHtml = `<div class="admin-row-foto">${(r.nome||r.categoria||'-')[0]}</div>`;
            }
            const sub    = buildSub(r);
            const badges = buildBadges(r);
            html += `
        <div class="admin-row ${ativo?'':'inativo'}" style="animation-delay:${Math.min(i,12)*0.02}s">
            ${fotoHtml}
            <div class="admin-row-info">
                <div class="admin-row-nome">${r.nome||r.categoria||'‚Äî'}</div>
                ${sub    ? `<div class="admin-row-sub">${sub}</div>`       : ''}
                ${badges ? `<div class="admin-row-badges">${badges}</div>` : ''}
            </div>
            <div class="admin-row-actions">
                <button class="btn-edit" onclick="abrirForm('${r.id}')">Editar</button>
                <button class="btn-toggle ${ativo?'ativo':'inativo'}"
                        onclick="toggleAtivo('${r.id}','${ativoKey}',${ativo})">
                    ${ativo?'Inativar':'Ativar'}
                </button>
            </div>
        </div>`;
        });
        html += '</div>';
        document.getElementById('main-content').innerHTML = html;
        restoreSearch(q);
    }

    function renderInfoSubTab() {
        const cfg    = SECOES[secaoAtiva];
        const labels = {ministerios:'l√≠deres', cursos:'instrutores', membros:'filhos'};
        const parent = {ministerios:'minist√©rio', cursos:'curso', membros:'membro'};
        let html = `<div class="sub-tabs">
        ${cfg.subTabs.map((t,i)=>`<button class="sub-tab ${subTabAtiva===i?'active':''}" onclick="setSubTab(${i})">${t}</button>`).join('')}
    </div>
    <div class="admin-list">
        <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:20px;text-align:center;color:var(--text-faint);font-size:13px;line-height:1.8">
            Para gerir ${labels[secaoAtiva]||'itens'}, abre o registo do ${parent[secaoAtiva]||'item'} e edita a partir da√≠.
        </div>
    </div>`;
        document.getElementById('main-content').innerHTML = html;
    }

    async function renderVisitantesTab() {
        const mc = document.getElementById('main-content');
        if (!mc) { console.error('main-content n√£o existe'); return; }

        const cfg = SECOES['membros'];
        if (!cfg) { mc.innerHTML = '<div style="padding:20px;color:red">ERRO: SECOES[membros] n√£o definido</div>'; return; }

        // Loading
        mc.innerHTML = `
    <div class="sub-tabs">
        ${cfg.subTabs.map((t,i)=>`<button class="sub-tab ${subTabAtiva===i?'active':''}" onclick="setSubTab(${i})">${t}</button>`).join('')}
    </div>
    <div style="padding:20px;color:var(--text-faint)">‚è≥ A carregar visitantes do Supabase...</div>`;

        // Carrega SEMPRE directamente do Supabase
        let rawData = [];
        try {
            rawData = await sb('visitantes?select=*&order=nome') || [];
            visitantes = rawData;
            console.log('Visitantes carregados:', visitantes.length, visitantes);
        } catch(e) {
            console.error('Erro visitantes:', e);
            mc.innerHTML += `<div style="padding:16px;color:red;font-size:12px">Erro: ${e?.message||e?.code||JSON.stringify(e)}</div>`;
            return;
        }

        const q   = getQ();
        let lista = [...visitantes];

        const jaConvertido = v => v.convertido === true && v.membro_id;
        if (!filtroInativo) lista = lista.filter(r => r.ativo !== false && !jaConvertido(r));
        else                lista = lista.filter(r => jaConvertido(r) || r.ativo === false);
        if (q) lista = lista.filter(r => (r.nome||'').toLowerCase().includes(q));

        let html = `
    <div class="sub-tabs">
        ${cfg.subTabs.map((t,i)=>`<button class="sub-tab ${subTabAtiva===i?'active':''}" onclick="setSubTab(${i})">${t}</button>`).join('')}
    </div>
    <div class="section-toolbar" style="position:sticky;top:0;z-index:10">
        <input class="toolbar-search" id="toolbar-search-input"
               placeholder="Pesquisar visitante..." oninput="handleSearch()" value="${q}">
        <button class="toolbar-filter ${filtroInativo?'active':''}" onclick="toggleFiltroInativo()">
            ${filtroInativo?'Ver Ativos':'Ver Convertidos'}
        </button>
        <button class="btn-new" onclick="abrirFormVisitante(null)">+ Novo</button>
    </div>
    <div style="padding:6px 16px 2px;font-size:11px;color:var(--text-faint)">
        ${visitantes.length} visitante(s) total ¬∑ ${lista.length} a mostrar
    </div>`;

        if (!lista.length) {
            html += `<div class="empty"><div class="empty-icon">‚Äî</div>
            <div class="empty-txt">${filtroInativo ? 'Nenhum visitante convertido.' : 'Nenhum visitante por converter.'}</div></div>`;
            document.getElementById('main-content').innerHTML = html;
            return;
        }

        html += '<div class="admin-list">';
        lista.forEach((v, i) => {
            const ativo      = v.ativo !== false;
            const convertido = jaConvertido(v);
            const badgeConv  = convertido
                ? '<span class="badge badge-green">‚úì Membro</span>'
                : v.membro_id ? '<span class="badge badge-primary">Vinculado</span>' : '<span class="badge badge-gray">Visitante</span>';
            const sub = [
                v.telefone,
                v.data_visita ? new Date(v.data_visita).toLocaleDateString('pt-PT') : null,
                v.onde_conheceu ? `"${v.onde_conheceu}"` : null,
            ].filter(Boolean).join(' ¬∑ ');

            html += `
        <div class="admin-row ${ativo?'':'inativo'}" style="animation-delay:${Math.min(i,12)*0.02}s">
            <div class="admin-row-foto" style="background:var(--primary-faint);color:var(--primary-dark);font-weight:700">${(v.nome||'V')[0]}</div>
            <div class="admin-row-info">
                <div class="admin-row-nome">${v.nome||'‚Äî'}</div>
                <div class="admin-row-sub">${sub||'Sem dados'}</div>
                <div class="admin-row-badges">${badgeConv}</div>
            </div>
            <div class="admin-row-actions">
                <button class="btn-edit" onclick="abrirFormVisitante('${v.id}')">Editar</button>
                ${!convertido ? `<button class="btn-save" style="padding:6px 10px;font-size:11px" onclick="abrirConversaoMembro('${v.id}')">‚Üí Membro</button>` : ''}
                <button class="btn-toggle ${ativo?'ativo':'inativo'}" onclick="toggleAtivoVisitante('${v.id}',${ativo})">${ativo?'Inativar':'Ativar'}</button>
            </div>
        </div>`;
        });
        html += '</div>';
        document.getElementById('main-content').innerHTML = html;
    }

    // ‚îÄ‚îÄ CONVERS√ÉO VISITANTE ‚Üí MEMBRO (form completo) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function abrirConversaoMembro(visitanteId) {
        const v = visitantes.find(x => x.id === visitanteId);
        if (!v) return;
        // Carrega links para o select
        if (!links_cache.length)
            links_cache = await sb('links?select=id,nome&ativo=eq.true&order=nome') || [];

        document.getElementById('drawer-title').textContent = `Converter em Membro ‚Äî ${v.nome}`;
        document.getElementById('drawer-body').innerHTML = buildFormConversao(v);
        document.getElementById('overlay').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function buildFormConversao(v) {
        const fv = (k, d='') => v?.[k] ?? d;
        const linksOpts = links_cache.map(l=>`<option value="${l.id}">${l.nome}</option>`).join('');
        return `<div class="form-grid">
        <div class="msg-form" id="form-msg"></div>
        <div style="background:var(--primary-faint);border:1px solid var(--border);border-radius:10px;padding:10px 14px;margin-bottom:4px;font-size:12px;color:var(--primary-dark);line-height:1.6" class="form-full">
            <strong>Visitante:</strong> ${v.nome} ¬∑ ${v.email||'‚Äî'} ¬∑ ${v.telefone||'‚Äî'}<br>
            Preenche os dados adicionais e confirma para criar o membro.
        </div>

        <div class="form-section-title">Identifica√ß√£o</div>
        <div class="form-group form-full"><label class="form-label">Nome *</label>
            <input class="form-input" id="fc_nome" type="text" value="${v.nome||''}"></div>
        <div class="form-group"><label class="form-label">Email</label>
            <input class="form-input" id="fc_email" type="email" value="${v.email||''}"></div>
        <div class="form-group"><label class="form-label">Telefone</label>
            <input class="form-input" id="fc_telefone" type="tel" value="${v.telefone||''}"></div>
        <div class="form-group"><label class="form-label">G√©nero</label>
            <select class="form-select" id="fc_genero">
                <option value="">--</option>
                <option value="masculino">Masculino</option>
                <option value="feminino">Feminino</option>
                <option value="outro">Outro</option>
            </select></div>
        <div class="form-group"><label class="form-label">Data Nascimento</label>
            <input class="form-input" id="fc_data_nascimento" type="date"></div>
        <div class="form-group"><label class="form-label">Estado Civil</label>
            <select class="form-select" id="fc_estado_civil">
                <option value="">--</option>
                <option value="solteiro">Solteiro</option>
                <option value="casado">Casado</option>
                <option value="divorciado">Divorciado</option>
                <option value="viuvo">Vi√∫vo</option>
            </select></div>
        <div class="form-group"><label class="form-label">NIF</label>
            <input class="form-input" id="fc_nif" type="text" placeholder="000 000 000"></div>

        <div class="form-section-title">Morada</div>
        <div class="form-group form-full"><label class="form-label">Rua</label>
            <input class="form-input" id="fc_rua" type="text" placeholder="Nome da rua"></div>
        <div class="form-group"><label class="form-label">N√∫mero</label>
            <input class="form-input" id="fc_numero" type="text" placeholder="Nr"></div>
        <div class="form-group"><label class="form-label">Complemento</label>
            <input class="form-input" id="fc_complemento" type="text" placeholder="Andar, porta..."></div>
        <div class="form-group"><label class="form-label">Cidade</label>
            <input class="form-input" id="fc_cidade" type="text" placeholder="Lisboa"></div>
        <div class="form-group"><label class="form-label">C√≥digo Postal</label>
            <input class="form-input" id="fc_codigo_postal" type="text" placeholder="0000-000"></div>
        <div class="form-group"><label class="form-label">Pa√≠s</label>
            <input class="form-input" id="fc_pais" type="text" value="Portugal"></div>
        <div class="form-group"><label class="form-label">Zona (Link)</label>
            <input class="form-input" id="fc_zona" type="text" value="${v.zona||''}" placeholder="Ex: Montijo"></div>

        <div class="form-section-title">Igreja</div>
        <div class="form-group"><label class="form-label">Membro Desde</label>
            <input class="form-input" id="fc_data_entrada" type="date" value="${new Date().toISOString().split('T')[0]}"></div>
        <div class="form-group"><label class="form-label">Link</label>
            <select class="form-select" id="fc_link_id">
                <option value="">-- Sem Link --</option>
                ${linksOpts}
            </select></div>
        <div class="form-group form-full"><label class="form-label">Onde Conheceu</label>
            <input class="form-input" id="fc_onde_conheceu" type="text" value="${v.onde_conheceu||''}"></div>
        <div class="form-group"><label class="form-toggle"><input type="checkbox" id="fc_foi_batizado"><span>Foi Batizado</span></label></div>
        <div class="form-group"><label class="form-label">Data Batismo</label>
            <input class="form-input" id="fc_data_batismo" type="date"></div>

        <div class="form-section-title">Fun√ß√µes</div>
        <div class="form-group"><label class="form-toggle"><input type="checkbox" id="fc_e_voluntario"><span>Volunt√°rio</span></label></div>
        <div class="form-group"><label class="form-toggle"><input type="checkbox" id="fc_e_lider"><span>L√≠der</span></label></div>
        <div class="form-group"><label class="form-toggle"><input type="checkbox" id="fc_e_presbitero"><span>Presb√≠tero</span></label></div>

        <div class="form-section-title">Hist√≥ria</div>
        <div class="form-group form-full"><label class="form-label">Hist√≥ria / Notas</label>
            <textarea class="form-textarea" id="fc_historia" placeholder="Historia do membro..." style="height:80px"></textarea></div>

        <div class="form-actions">
            <button class="btn-cancel-form" onclick="closeDrawer()">Cancelar</button>
            <button class="btn-save" id="btn-save-conv" onclick="confirmarConversao('${v.id}')">‚úì Converter em Membro</button>
        </div>
    </div>`;
    }

    async function confirmarConversao(visitanteId) {
        const v   = visitantes.find(x => x.id === visitanteId);
        if (!v) return;
        const get = id => { const el = document.getElementById(id); return el ? el.value || null : null; };
        const chk = id => { const el = document.getElementById(id); return el ? el.checked : false; };
        const nome = get('fc_nome');
        if (!nome) { showFormMsg('Nome √© obrigat√≥rio.', 'error'); return; }

        const btn = document.getElementById('btn-save-conv');
        btn.disabled = true; btn.textContent = 'A converter...';

        try {
            // 1. Cria o membro
            const membroBody = {
                nome,
                email:          get('fc_email'),
                telefone:       get('fc_telefone'),
                genero:         get('fc_genero'),
                data_nascimento:get('fc_data_nascimento'),
                estado_civil:   get('fc_estado_civil'),
                nif:            get('fc_nif'),
                rua:            get('fc_rua'),
                numero:         get('fc_numero'),
                complemento:    get('fc_complemento'),
                cidade:         get('fc_cidade'),
                codigo_postal:  get('fc_codigo_postal'),
                pais:           get('fc_pais'),
                zona:           get('fc_zona'),
                data_entrada:   get('fc_data_entrada'),
                link_id:        get('fc_link_id'),
                onde_conheceu:  get('fc_onde_conheceu'),
                foi_batizado:   chk('fc_foi_batizado'),
                data_batismo:   get('fc_data_batismo'),
                e_voluntario:   chk('fc_e_voluntario'),
                e_lider:        chk('fc_e_lider'),
                e_presbitero:   chk('fc_e_presbitero'),
                historia:       get('fc_historia'),
                tipo:           'membro',
                ativo:          true,
                convertido_de_visitante_id: visitanteId,
            };
            // Remove campos nulos para n√£o sobrescrever defaults
            Object.keys(membroBody).forEach(k => { if (membroBody[k] === null) delete membroBody[k]; });

            const novoMembro = await sb('membros', { method:'POST', body:JSON.stringify(membroBody) });
            const membroId   = novoMembro?.[0]?.id;
            if (!membroId) throw new Error('Erro ao criar membro ‚Äî sem ID retornado.');

            // 2. Marca o visitante como convertido e vincula o membro
            await sb(`visitantes?id=eq.${visitanteId}`, {
                method: 'PATCH',
                body: JSON.stringify({ convertido: true, membro_id: membroId }),
            });

            // 3. Actualiza o utilizador (usuarios): tipo ‚Üí 'membro', membro_id ‚Üí membroId
            // Tenta encontrar o utilizador pelo email ou pelo visitante_id
            const userByEmail = await sb(`usuarios?email=eq.${encodeURIComponent(v.email || 'none@none')}&select=id`).catch(()=>[]);
            const userByVid   = await sb(`usuarios?visitante_id=eq.${visitanteId}&select=id`).catch(()=>[]);
            const userId      = userByEmail?.[0]?.id || userByVid?.[0]?.id;
            if (userId) {
                await sb(`usuarios?id=eq.${userId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ tipo: 'membro', membro_id: membroId }),
                }).catch(() => {}); // n√£o bloqueia se falhar
            }

            showFormMsg('Convertido com sucesso!', 'success');
            await carregarVisitantes();
            membros = await sb('membros?select=id,nome&ativo=eq.true&order=nome') || [];
            setTimeout(() => { closeDrawer(); renderSecao(); }, 800);

        } catch(e) {
            showFormMsg(`Erro: ${e?.message || e?.details || JSON.stringify(e)}`, 'error');
            btn.disabled = false; btn.textContent = '‚úì Converter em Membro';
        }
    }

    function buildSub(r) {
        const s = secaoAtiva;
        if (s==='membros')     return [r.tipo,r.zona,r.genero].filter(Boolean).join(' ¬∑ ');
        if (s==='pastores')    return [r.cargo,r.email].filter(Boolean).join(' ‚Äî ');
        if (s==='links')       return [r.tipo,r.zona,r.dia].filter(Boolean).join(' ¬∑ ');
        if (s==='cultos')      return [r.dia_semana,r.hora_inicio].filter(Boolean).join(' ‚Äî ');
        if (s==='ministerios') return [r.tipo?'['+r.tipo+']':null,r.descricao?.substring(0,50)].filter(Boolean).join(' ‚Äî ');
        if (s==='salas')       return [r.espaco,r.capacidade?r.capacidade+' pessoas':null].filter(Boolean).join(' ¬∑ ');
        if (s==='cursos')      return [r.carga_horaria,r.gratuito?'Gratuito':r.valor?'‚Ç¨'+r.valor:null].filter(Boolean).join(' ¬∑ ');
        if (s==='keola')       return [r.categoria,r.preco?'‚Ç¨'+Number(r.preco).toFixed(2):null].filter(Boolean).join(' ¬∑ ');
        if (s==='loja')        return [r.categoria,r.preco?'‚Ç¨'+Number(r.preco).toFixed(2):null].filter(Boolean).join(' ¬∑ ');
        return '';
    }

    function buildBadges(r) {
        const b = [];
        if (r.e_lider)       b.push(`<span class="badge badge-primary">L√≠der</span>`);
        if (r.e_presbitero)  b.push(`<span class="badge badge-primary">Presb√≠tero</span>`);
        if (r.e_voluntario)  b.push(`<span class="badge badge-green">Volunt√°rio</span>`);
        if (r.e_admin)       b.push(`<span class="badge badge-red">Admin</span>`);
        if (r.online)        b.push(`<span class="badge badge-primary">Online</span>`);
        if (r.recorrente)    b.push(`<span class="badge badge-green">Recorrente</span>`);
        if (r.gratuito)      b.push(`<span class="badge badge-green">Gratuito</span>`);
        if (r.especial_hoje) b.push(`<span class="badge badge-primary">Especial hoje</span>`);
        if (r.destaque)      b.push(`<span class="badge badge-primary">Destaque</span>`);
        if (r.disponivel===false||r.ativo===false) b.push(`<span class="badge badge-gray">Inativo</span>`);
        return b.join('');
    }

    function toggleFiltroInativo() { filtroInativo = !filtroInativo; renderSecao(); }
    async function setSubTab(idx) {
        subTabAtiva = idx;
        renderSecao();
    }

    // ‚îÄ‚îÄ DASHBOARD MEMBROS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderDashboardMembros() {
        const cfg = SECOES['membros'];
        const totalMembros    = registos.filter(r => r.ativo !== false).length;
        const totalLideres    = registos.filter(r => r.e_lider && r.ativo !== false).length;
        const totalPresbiteros= registos.filter(r => r.e_presbitero && r.ativo !== false).length;
        const totalVoluntarios= registos.filter(r => r.e_voluntario && r.ativo !== false).length;
        const totalVisitantes = visitantes.filter(v => v.ativo !== false && !(v.convertido && v.membro_id)).length;
        const totalConvertidos= visitantes.filter(v => v.convertido && v.membro_id).length;

        // Anivers√°rios do m√™s
        const mesAtual = new Date().getMonth() + 1;
        const anivMes  = registos.filter(r => {
            if (!r.data_nascimento || r.ativo === false) return false;
            return parseInt(r.data_nascimento.split('-')[1]) === mesAtual;
        });

        const statCard = (num, label, cor, sub='') => `
            <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center">
                <div style="font-family:var(--font-title);font-size:28px;font-weight:700;color:${cor}">${num}</div>
                <div style="font-size:11px;color:var(--text-faint);margin-top:3px;text-transform:uppercase;letter-spacing:1px">${label}</div>
                ${sub ? `<div style="font-size:10px;color:var(--text-faint);margin-top:2px">${sub}</div>` : ''}
            </div>`;

        let html = `
    <div class="sub-tabs">
        ${cfg.subTabs.map((t,i)=>`<button class="sub-tab ${subTabAtiva===i?'active':''}" onclick="setSubTab(${i})">${t}</button>`).join('')}
    </div>
    <div style="padding:12px 16px">

        <div style="font-family:var(--font-title);font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--text-faint);margin-bottom:8px">Membros</div>
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:16px">
            ${statCard(totalMembros,    'Total Membros',    'var(--primary-dark)')}
            ${statCard(totalLideres,    'L√≠deres',          'var(--primary)')}
            ${statCard(totalPresbiteros,'Presb√≠teros',      'var(--primary)')}
            ${statCard(totalVoluntarios,'Volunt√°rios',      'var(--green)')}
        </div>

        <div style="font-family:var(--font-title);font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--text-faint);margin-bottom:8px">Visitantes</div>
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:16px">
            ${statCard(totalVisitantes, 'Visitantes Activos','var(--orange,#e65100)', 'Por converter')}
            ${statCard(totalConvertidos,'Convertidos',       'var(--green)',          'J√° s√£o membros')}
        </div>`;

        if (anivMes.length > 0) {
            html += `
        <div style="font-family:var(--font-title);font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--text-faint);margin-bottom:8px">
            üéÇ Anivers√°rios este m√™s (${anivMes.length})
        </div>
        <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:16px">`;
            anivMes.sort((a,b)=>{
                const da = parseInt(a.data_nascimento?.split('-')[2]||0);
                const db = parseInt(b.data_nascimento?.split('-')[2]||0);
                return da - db;
            }).forEach(m => {
                const dia  = m.data_nascimento?.split('-')[2];
                const foto = m.foto_url
                    ? `<img src="${m.foto_url}" style="width:32px;height:32px;border-radius:50%;object-fit:cover;flex-shrink:0" onerror="this.style.display='none'">`
                    : `<div style="width:32px;height:32px;border-radius:50%;background:var(--primary-faint);color:var(--primary-dark);display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0">${(m.nome||'?')[0]}</div>`;
                html += `<div style="display:flex;align-items:center;gap:10px;background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:8px 12px">
                    ${foto}
                    <div style="flex:1">
                        <div style="font-size:13px;font-weight:600;color:var(--text-main)">${m.nome}</div>
                        <div style="font-size:11px;color:var(--text-faint)">Dia ${dia}${m.e_lider?' ¬∑ L√≠der':''}${m.e_presbitero?' ¬∑ Presb√≠tero':''}</div>
                    </div>
                    <div style="font-size:20px">üéÇ</div>
                </div>`;
            });
            html += '</div>';
        }

        html += `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <button class="btn-save" style="margin:0" onclick="setSubTab(1)">Ver Membros ‚Üí</button>
            <button class="btn-save" style="margin:0;background:var(--primary-faint);color:var(--primary-dark);border:1px solid var(--border)" onclick="setSubTab(2)">Ver Visitantes ‚Üí</button>
        </div>
    </div>`;

        document.getElementById('main-content').innerHTML = html;
    }
    async function carregarVisitantes() {
        visitantes = await sb('visitantes?select=*&order=nome') || [];
    }
    function abrirFormVisitante(id) {
        const v = id ? visitantes.find(x=>x.id===id) : null;
        document.getElementById('drawer-title').textContent = v ? 'Editar Visitante' : 'Novo Visitante';
        document.getElementById('drawer-body').innerHTML = buildFormVisitante(v);
        document.getElementById('overlay').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }
    function buildFormVisitante(v) {
        const fv = (k, d='') => v?.[k] ?? d;
        return `<div class="form-grid">
        <div class="msg-form" id="form-msg"></div>
        <div class="form-group form-full"><label class="form-label">Nome</label><input class="form-input" id="fv_nome" type="text" value="${fv('nome')}"></div>
        <div class="form-group"><label class="form-label">Email</label><input class="form-input" id="fv_email" type="email" value="${fv('email')}"></div>
        <div class="form-group"><label class="form-label">Telefone</label><input class="form-input" id="fv_telefone" type="tel" value="${fv('telefone')}"></div>
        <div class="form-group"><label class="form-label">Zona</label><input class="form-input" id="fv_zona" value="${fv('zona')}"></div>
        <div class="form-group"><label class="form-label">Data da Visita</label><input class="form-input" id="fv_data_visita" type="date" value="${fv('data_visita')}"></div>
        <div class="form-group form-full"><label class="form-label">Onde Conheceu</label><input class="form-input" id="fv_onde_conheceu" value="${fv('onde_conheceu')}"></div>
        <div class="form-group form-full"><label class="form-label">Observa√ß√µes</label><textarea class="form-textarea" id="fv_observacoes">${fv('observacoes')}</textarea></div>
        <div class="form-group"><label class="form-toggle"><input type="checkbox" id="fv_convertido" ${fv('convertido')?'checked':''}><span>Convertido</span></label></div>
        <div class="form-group"><label class="form-toggle"><input type="checkbox" id="fv_ativo" ${fv('ativo')!==false?'checked':''}><span>Ativo</span></label></div>
        <div class="form-actions">
            <button class="btn-cancel-form" onclick="closeDrawer()">Cancelar</button>
            <button class="btn-save" id="btn-save" onclick="salvarVisitante('${v?.id||''}')">Guardar</button>
        </div>
    </div>`;
    }
    async function salvarVisitante(id) {
        const get = k => { const el=document.getElementById('fv_'+k); return el?el.value||null:null; };
        const chk = k => { const el=document.getElementById('fv_'+k); return el?el.checked:false; };
        const body = { nome:get('nome'), email:get('email'), telefone:get('telefone'), zona:get('zona'),
            data_visita:get('data_visita'), onde_conheceu:get('onde_conheceu'),
            observacoes:get('observacoes'), convertido:chk('convertido'), ativo:chk('ativo') };
        if (!body.nome) { showFormMsg('Nome obrigat√≥rio.','error'); return; }
        const btn = document.getElementById('btn-save');
        btn.disabled=true; btn.textContent='A guardar...';
        try {
            if (!id) await sb('visitantes',{method:'POST',body:JSON.stringify(body)});
            else     await sb(`visitantes?id=eq.${id}`,{method:'PATCH',body:JSON.stringify(body)});
            showFormMsg('Guardado!','success');
            await carregarVisitantes();
            setTimeout(closeDrawer, 700);
        } catch(e) {
            showFormMsg(`Erro: ${e?.message||JSON.stringify(e)}`,'error');
            btn.disabled=false; btn.textContent='Guardar';
        }
    }
    async function toggleAtivoVisitante(id, ativoAtual) {
        await sb(`visitantes?id=eq.${id}`,{method:'PATCH',body:JSON.stringify({ativo:!ativoAtual})});
        await carregarVisitantes(); renderSecao();
    }

    // ‚îÄ‚îÄ TOGGLE ATIVO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function toggleAtivo(id, key, ativoAtual) {
        try {
            await sb(`${SECOES[secaoAtiva].tabela}?id=eq.${id}`,
                {method:'PATCH', body:JSON.stringify({[key]:!ativoAtual})});
            await carregarSecao();
        } catch(e) { alert('Erro ao alterar estado.'); }
    }

    // ‚îÄ‚îÄ FORM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function abrirForm(id) {
        const cfg     = SECOES[secaoAtiva];
        const registo = id ? registos.find(r=>r.id===id) : null;
        const isNovo  = !registo;
        if (secaoAtiva==='ministerios'||secaoAtiva==='cursos') {
            try {
                const res = await sb('membros?select=id,nome&ativo=eq.true&order=nome');
                if (Array.isArray(res)&&res.length) membros = res;
            } catch(e){}
        }
        if (secaoAtiva==='membros') {
            try {
                const rm = await sb('membros?select=id,nome&ativo=eq.true&order=nome');
                if (Array.isArray(rm)&&rm.length) membros = rm;
                ministeriosCache = await sb('ministerios?select=id,nome,tipo&ativo=eq.true&order=tipo,nome')||[];
            } catch(e){}
        }
        document.getElementById('drawer-title').textContent =
            isNovo ? `Novo ‚Äî ${cfg.label||secaoAtiva}` : 'Editar';
        document.getElementById('drawer-body').innerHTML = buildForm(cfg, registo);
        document.getElementById('overlay').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        if (!isNovo&&secaoAtiva==='membros') {
            await carregarFilhos(registo.id);
            await carregarMembroMinisterios(registo.id);
        } else if (!isNovo&&(secaoAtiva==='ministerios'||secaoAtiva==='cursos')) {
            await carregarSubList(registo.id);
        }
    }

    function buildForm(cfg, r) {
        const campos = typeof cfg.campos==='function' ? cfg.campos(r) : cfg.campos;
        let html = `<div class="form-grid"><div class="msg-form" id="form-msg"></div>`;
        campos.forEach(c => {
            if (c.key==='link_id'&&secaoAtiva==='membros') {
                const val2 = r?.[c.key]??'';
                const opts2 = links_cache.map(l=>`<option value="${l.id}" ${val2===l.id?'selected':''}>${l.nome}</option>`).join('');
                html += `<div class="form-group form-full"><label class="form-label">${c.label}</label>
                <select class="form-select" id="f_link_id"><option value="">-- Sem Link --</option>${opts2}</select></div>`;
                return;
            }
            if (c.type==='section') { html += `<div class="form-section-title">${c.label}</div>`; return; }
            const val = r?.[c.key]??c.default??'';
            const fc  = c.full?'form-full':'';
            if (c.type==='checkbox') {
                html += `<div class="form-group ${fc}"><label class="form-toggle">
                <input type="checkbox" id="f_${c.key}" ${val?'checked':''}><span>${c.label}</span></label></div>`;
            } else if (c.type==='select') {
                const opts = c.options.map(o=>`<option value="${o.v}" ${val==o.v?'selected':''}>${o.l}</option>`).join('');
                html += `<div class="form-group ${fc}"><label class="form-label">${c.label}</label>
                <select class="form-select" id="f_${c.key}"><option value="">-- Seleciona --</option>${opts}</select></div>`;
            } else if (c.type==='textarea') {
                html += `<div class="form-group ${fc}"><label class="form-label">${c.label}</label>
                <textarea class="form-textarea" id="f_${c.key}" placeholder="${c.ph||''}">${val}</textarea></div>`;
            } else if (c.type==='image') {
                html += buildImageUpload(c.key, c.label, val, c.bucket||'imagens');
            } else {
                html += `<div class="form-group ${fc}"><label class="form-label">${c.label}</label>
                <input class="form-input" id="f_${c.key}" type="${c.type||'text'}" placeholder="${c.ph||''}" value="${val}"></div>`;
            }
        });
        if (r&&secaoAtiva==='membros') {
            html += `
        <div class="form-section-title">Filhos</div>
        <div class="form-full"><div class="sub-list" id="sub-list"><div class="sub-list-empty">A carregar...</div></div></div>
        <div class="sub-add-row">
            <select class="form-select" id="sub-filho-id"><option value="">Seleciona filho</option>${membros.map(m=>`<option value="${m.id}">${m.nome}</option>`).join('')}</select>
            <button class="btn-sub-add" onclick="addFilho('${r.id}')">Adicionar</button>
        </div>
        <div class="form-section-title">Minist√©rios e √Åreas</div>
        <div class="form-full"><div class="sub-list" id="sub-list-mins"><div class="sub-list-empty">A carregar...</div></div></div>
        <div class="sub-add-row">
            <select class="form-select" id="sub-min-id"><option value="">Seleciona minist√©rio/√°rea</option>${ministeriosCache.map(m=>`<option value="${m.id}">[${m.tipo||'?'}] ${m.nome}</option>`).join('')}</select>
            <input class="form-input" id="sub-min-papel" placeholder="Papel" style="max-width:120px">
            <button class="btn-sub-add" onclick="addMembroMinisterio('${r.id}')">Adicionar</button>
        </div>`;
        }
        if (r&&(secaoAtiva==='ministerios'||secaoAtiva==='cursos')) {
            const sublabel = secaoAtiva==='ministerios'?'L√≠deres':'Instrutores';
            html += `
        <div class="form-section-title">${sublabel}</div>
        <div class="form-full"><div class="sub-list" id="sub-list"><div class="sub-list-empty">A carregar...</div></div></div>
        <div class="sub-add-row">
            <select class="form-select" id="sub-membro-id"><option value="">Seleciona membro</option>${membros.map(m=>`<option value="${m.id}">${m.nome}</option>`).join('')}</select>
            <input class="form-input" id="sub-cargo" placeholder="Cargo" style="max-width:110px">
            ${secaoAtiva==='cursos'?`<input class="form-input" id="sub-nome-instrutor" placeholder="Nome externo" style="max-width:110px">`:''}
            <button class="btn-sub-add" onclick="addSubItem('${r.id}')">Adicionar</button>
        </div>`;
        }
        html += `<div class="form-actions">
        <button class="btn-cancel-form" onclick="closeDrawer()">Cancelar</button>
        <button class="btn-save" id="btn-save" onclick="salvar('${r?.id||''}')">Guardar</button>
    </div></div>`;
        return html;
    }

    async function salvar(id) {
        const cfg    = SECOES[secaoAtiva];
        const isNovo = !id;
        const campos = typeof cfg.campos==='function' ? cfg.campos(null) : cfg.campos;
        const body   = {};
        campos.forEach(c => {
            if (c.type==='section') return;
            const el = document.getElementById(`f_${c.key}`);
            if (!el) return;
            if (c.type==='checkbox')  body[c.key] = el.checked;
            else if (c.type==='number') body[c.key] = el.value?Number(el.value):null;
            else body[c.key] = el.value||null;
        });
        if (cfg.ativoKey&&!(cfg.ativoKey in body)&&isNovo) body[cfg.ativoKey] = true;
        if (!('ativo' in body)&&isNovo&&cfg.tabela!=='keola_menu') body.ativo = true;
        const btn = document.getElementById('btn-save');
        btn.disabled=true; btn.textContent='A guardar...';
        try {
            if (isNovo) await sb(cfg.tabela,{method:'POST',body:JSON.stringify(body)});
            else        await sb(`${cfg.tabela}?id=eq.${id}`,{method:'PATCH',body:JSON.stringify(body)});
            showFormMsg('Guardado com sucesso!','success');
            await carregarSecao();
            setTimeout(closeDrawer, 800);
        } catch(e) {
            showFormMsg(`Erro: ${e?.message||e?.details||JSON.stringify(e)}`,'error');
            btn.disabled=false; btn.textContent='Guardar';
        }
    }

    function showFormMsg(txt, tipo) {
        const el = document.getElementById('form-msg');
        if (!el) return;
        el.textContent = txt; el.className = `msg-form ${tipo}`;
        el.scrollIntoView({behavior:'smooth', block:'nearest'});
    }

    // ‚îÄ‚îÄ SUB-ITEMS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let membroMinisteriosData = [];

    async function carregarMembroMinisterios(membroId) {
        const items = await sb(`membro_ministerios?select=*,ministerios(id,nome,tipo)&membro_id=eq.${membroId}&ativo=eq.true&order=id`)||[];
        membroMinisteriosData = items;
        renderSubListMins(membroId);
    }
    function renderSubListMins(membroId) {
        const el = document.getElementById('sub-list-mins');
        if (!el) return;
        if (!membroMinisteriosData.length) {
            el.innerHTML = '<div class="sub-list-empty">Sem minist√©rios/√°reas.</div>'; return;
        }
        el.innerHTML = membroMinisteriosData.map(item => {
            const tipo = item.ministerios?.tipo||'?';
            const nome = item.ministerios?.nome||'‚Äî';
            return `<div class="sub-list-item">
            <span class="badge badge-gray" style="flex-shrink:0">${tipo==='ministerio'?'MIN':'AE'}</span>
            <div class="sub-list-nome">${nome}</div>
            <div class="sub-list-cargo">${item.papel||''}</div>
            <button class="sub-list-remove" onclick="removeMembroMinisterio('${item.id}','${membroId}')">Remover</button>
        </div>`;
        }).join('');
    }
    async function addMembroMinisterio(membroId) {
        const minId = document.getElementById('sub-min-id')?.value;
        const papel = document.getElementById('sub-min-papel')?.value?.trim();
        if (!minId) { alert('Seleciona um minist√©rio ou √°rea.'); return; }
        if (membroMinisteriosData.find(m=>m.ministerio_id===minId)) { alert('J√° associado.'); return; }
        try {
            await sb('membro_ministerios',{method:'POST',body:JSON.stringify({membro_id:membroId,ministerio_id:minId,papel:papel||null,ativo:true})});
            await carregarMembroMinisterios(membroId);
            document.getElementById('sub-min-id').value='';
            document.getElementById('sub-min-papel').value='';
        } catch(e) { alert('Erro: '+JSON.stringify(e)); }
    }
    async function removeMembroMinisterio(itemId, membroId) {
        if (!confirm('Remover desta √°rea/minist√©rio?')) return;
        await sb(`membro_ministerios?id=eq.${itemId}`,{method:'PATCH',body:JSON.stringify({ativo:false})});
        await carregarMembroMinisterios(membroId);
    }
    async function carregarFilhos(membroId) {
        const items = await sb(`membros_filhos?select=*&pai_id=eq.${membroId}&order=created_at`)||[];
        const el = document.getElementById('sub-list');
        if (!el) return;
        if (!items.length) { el.innerHTML='<div class="sub-list-empty">Sem filhos.</div>'; return; }
        el.innerHTML = items.map(item => {
            const filho = membros.find(m=>m.id===item.filho_id);
            return `<div class="sub-list-item">
            <div class="sub-list-nome">${filho?.nome||item.filho_id}</div>
            <div class="sub-list-cargo">Filho/a</div>
            <button class="sub-list-remove" onclick="removeFilho('${item.id}','${membroId}')">Remover</button>
        </div>`;
        }).join('');
    }
    async function addFilho(paiId) {
        const filhoId = document.getElementById('sub-filho-id')?.value;
        if (!filhoId) { alert('Seleciona um membro.'); return; }
        try {
            await sb('membros_filhos',{method:'POST',body:JSON.stringify({pai_id:paiId,filho_id:filhoId})});
            membros = await sb('membros?select=id,nome&ativo=eq.true&order=nome')||[];
            await carregarFilhos(paiId);
            document.getElementById('sub-filho-id').value='';
        } catch(e) { alert('Erro: '+JSON.stringify(e)); }
    }
    async function removeFilho(itemId, paiId) {
        if (!confirm('Remover este filho?')) return;
        await sb(`membros_filhos?id=eq.${itemId}`,{method:'DELETE'});
        await carregarFilhos(paiId);
    }
    async function carregarSubList(parentId) {
        const isMin  = secaoAtiva==='ministerios';
        const tabela = isMin?'ministerio_lideres':'zao_curso_instrutores';
        const fkKey  = isMin?'ministerio_id':'curso_id';
        const items  = await sb(`${tabela}?select=*&${fkKey}=eq.${parentId}&order=created_at`)||[];
        const el     = document.getElementById('sub-list');
        if (!el) return;
        if (!items.length) { el.innerHTML='<div class="sub-list-empty">Sem registos.</div>'; return; }
        el.innerHTML = items.map(item => {
            const membro = membros.find(m=>m.id===item.membro_id);
            const nome   = membro?.nome||item.nome_instrutor||'‚Äî';
            return `<div class="sub-list-item">
            <div class="sub-list-nome">${nome}</div>
            <div class="sub-list-cargo">${item.cargo||''}</div>
            <button class="sub-list-remove" onclick="removeSubItem('${item.id}','${tabela}','${parentId}')">Remover</button>
        </div>`;
        }).join('');
    }
    async function addSubItem(parentId) {
        const isMin  = secaoAtiva==='ministerios';
        const tabela = isMin?'ministerio_lideres':'zao_curso_instrutores';
        const fkKey  = isMin?'ministerio_id':'curso_id';
        const memId  = document.getElementById('sub-membro-id')?.value;
        const cargo  = document.getElementById('sub-cargo')?.value;
        const nomeExt= document.getElementById('sub-nome-instrutor')?.value;
        if (!memId&&!nomeExt) { alert('Seleciona um membro ou indica um nome.'); return; }
        const body = {[fkKey]:parentId, cargo:cargo||null};
        if (memId) body.membro_id = memId;
        if (!isMin&&nomeExt) body.nome_instrutor = nomeExt;
        try {
            await sb(tabela,{method:'POST',body:JSON.stringify(body)});
            await carregarSubList(parentId);
            ['sub-membro-id','sub-cargo','sub-nome-instrutor'].forEach(k=>{ const el=document.getElementById(k); if(el) el.value=''; });
        } catch(e) { alert('Erro ao adicionar.'); }
    }
    async function removeSubItem(itemId, tabela, parentId) {
        if (!confirm('Remover?')) return;
        await sb(`${tabela}?id=eq.${itemId}`,{method:'DELETE'});
        await carregarSubList(parentId);
    }

    // ‚îÄ‚îÄ IMAGE UPLOAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function buildImageUpload(key, label, currentUrl, bucket) {
        const hasImg = !!currentUrl;
        const imgHtml = hasImg
            ? `<img src="${currentUrl}" alt="${label}"
                 style="max-width:100%;max-height:100%;object-fit:contain;display:block;border-radius:6px"
                 onerror="this.parentElement.innerHTML='<div style=\'display:flex;align-items:center;justify-content:center;height:100%;flex-direction:column;gap:6px;color:var(--text-faint)\'><svg width=32 height=32 fill=none stroke=currentColor stroke-width=1.5 viewBox=\'0 0 24 24\'><rect x=3 y=3 width=18 height=18 rx=2/><circle cx=8.5 cy=8.5 r=1.5/><polyline points=\'21,15 16,10 5,21\'/></svg><div style=\'font-size:11px\'>Imagem inv√°lida ou em falta</div></div>'">`
            : `<div style="display:flex;align-items:center;justify-content:center;height:100%;flex-direction:column;gap:10px;color:var(--text-faint)">
                <svg width="36" height="36" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21,15 16,10 5,21"/></svg>
                <div style="font-size:12px;text-align:center;padding:0 12px;font-weight:600">Clica para escolher imagem</div>
                <div style="font-size:11px;color:var(--text-faint)">JPG, PNG, WEBP ¬∑ m√°x 5 MB</div>
               </div>`;
        return `<div class="form-group img-upload-wrap" style="grid-column:1/-1">
        <label class="form-label">${label}</label>
        <div id="img-box-${key}" onclick="triggerFileInput('${key}')"
             style="width:100%;height:240px;border:2px dashed var(--border);border-radius:12px;
                    background:var(--bg-input);cursor:pointer;overflow:hidden;position:relative;
                    transition:border-color 0.2s,background 0.2s;
                    display:flex;align-items:center;justify-content:center"
             onmouseover="this.style.borderColor='var(--primary)';this.style.background='var(--primary-faint)'"
             onmouseout="this.style.borderColor='var(--border)';this.style.background='var(--bg-input)'">
            ${imgHtml}
        </div>
        <div id="img-prog-${key}" style="height:3px;background:var(--border);border-radius:2px;margin-top:6px;overflow:hidden;display:none">
            <div id="img-prog-bar-${key}" style="height:100%;width:0%;background:var(--primary);transition:width 0.3s;border-radius:2px"></div>
        </div>
        <div id="img-status-${key}" style="font-size:11px;margin-top:4px;min-height:16px"></div>
        <div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap">
            <button type="button" class="img-upload-btn" onclick="event.stopPropagation();triggerFileInput('${key}')">Ficheiro</button>
            <button type="button" class="img-upload-btn" onclick="event.stopPropagation();triggerCamera('${key}')">C√¢mara</button>
            ${currentUrl ? `<button type="button" class="img-upload-btn danger" onclick="event.stopPropagation();removeImage('${key}','f_${key}')">Remover</button>` : ''}
        </div>
        <div style="display:flex;gap:6px;margin-top:6px">
            <input type="text" id="img-url-input-${key}" placeholder="Ou cola um URL aqui..."
                   value="${currentUrl||''}"
                   style="flex:1;background:var(--bg-input);border:1px solid var(--border);border-radius:7px;
                          padding:7px 10px;font-size:12px;font-family:var(--font-body);color:var(--text-main);outline:none"
                   onclick="event.stopPropagation()">
            <button type="button" class="img-upload-btn" onclick="event.stopPropagation();applyUrlInput('${key}')">Usar URL</button>
        </div>
        <input type="hidden" id="f_${key}" value="${currentUrl||''}">
        <input type="file" id="img-file-${key}" accept="image/*" style="display:none" onchange="handleFileSelect('${key}','${bucket}',this)">
        <input type="file" id="img-cam-${key}"  accept="image/*" capture="environment" style="display:none" onchange="handleFileSelect('${key}','${bucket}',this)">
    </div>`;
    }
    function triggerFileInput(key) { document.getElementById('img-file-'+key)?.click(); }
    function triggerCamera(key)    { document.getElementById('img-cam-'+key)?.click();  }
    function applyUrlInput(key) {
        const url = document.getElementById('img-url-input-'+key)?.value?.trim();
        if (!url) return;
        document.getElementById('f_'+key).value = url;
        updateImagePreview(key, url);
        setImgStatus(key,'URL aplicado.','ok');
    }
    function removeImage(key, hiddenId) {
        document.getElementById(hiddenId).value = '';
        const urlInput = document.getElementById('img-url-input-' + key);
        if (urlInput) urlInput.value = '';
        const box = document.getElementById('img-box-' + key);
        if (!box) return;
        box.style.borderColor = 'var(--border)';
        box.style.background  = 'var(--bg-input)';
        box.innerHTML = `<div style="display:flex;align-items:center;justify-content:center;height:100%;flex-direction:column;gap:10px;color:var(--text-faint)">
            <svg width="36" height="36" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21,15 16,10 5,21"/></svg>
            <div style="font-size:12px;text-align:center;padding:0 12px;font-weight:600">Clica para escolher imagem</div>
            <div style="font-size:11px;color:var(--text-faint)">JPG, PNG, WEBP ¬∑ m√°x 5 MB</div>
        </div>`;
        setImgStatus(key, 'Imagem removida.', '');
        setTimeout(() => setImgStatus(key, '', ''), 2000);
    }
    function updateImagePreview(key, url) {
        const box = document.getElementById('img-box-' + key);
        if (!box) return;
        box.style.background = 'var(--bg-input)';
        box.style.borderColor = 'var(--primary)';
        box.innerHTML = `<img src="${url}" alt="preview"
            style="max-width:100%;max-height:100%;object-fit:contain;display:block;border-radius:6px"
            onerror="this.parentElement.innerHTML='<div style=\'display:flex;align-items:center;justify-content:center;height:100%;flex-direction:column;gap:6px;color:var(--text-faint)\'><svg width=28 height=28 fill=none stroke=currentColor stroke-width=2 viewBox=\'0 0 24 24\'><circle cx=12 cy=12 r=10/><line x1=12 y1=8 x2=12 y2=12/><line x1=12 y1=16 x2=12.01 y2=16/></svg><div style=\'font-size:11px\'>Erro ao carregar imagem</div></div>'">`
    }
    function setImgStatus(key, msg, tipo) {
        const el = document.getElementById('img-status-' + key);
        if (!el) return;
        el.textContent = msg;
        el.style.fontWeight = tipo ? '600' : 'normal';
        el.style.color = tipo === 'ok' ? 'var(--green)' : tipo === 'err' ? 'var(--red)' : 'var(--text-faint)';
        // Mostrar/ocultar barra de progresso
        const prog = document.getElementById('img-prog-' + key);
        if (prog) prog.style.display = (msg && tipo !== 'ok' && tipo !== 'err') ? 'block' : 'none';
    }
    function resizeImage(file, maxW=800, maxH=800, quality=0.82) {
        return new Promise(resolve => {
            const img = new Image();
            const url = URL.createObjectURL(file);
            img.onload = () => {
                let {width:w, height:h} = img;
                if (w>maxW||h>maxH) { const r=Math.min(maxW/w,maxH/h); w=Math.round(w*r); h=Math.round(h*r); }
                const canvas=document.createElement('canvas');
                canvas.width=w; canvas.height=h;
                canvas.getContext('2d').drawImage(img,0,0,w,h);
                URL.revokeObjectURL(url);
                canvas.toBlob(blob=>resolve(blob),'image/jpeg',quality);
            };
            img.onerror=()=>{ URL.revokeObjectURL(url); resolve(file); };
            img.src=url;
        });
    }
    async function handleFileSelect(key, bucket, input) {
        const file = input.files?.[0];
        if (!file) return;
        // Preview local imediato
        updateImagePreview(key, URL.createObjectURL(file));
        setImgStatus(key, 'A comprimir...', '');
        const prog = document.getElementById('img-prog-' + key);
        const bar  = document.getElementById('img-prog-bar-' + key);
        if (prog) prog.classList.add('active');
        if (bar)  bar.style.width = '20%';
        try {
            // 1. Comprime
            const blob     = await resizeImage(file);
            const filename = `${secaoAtiva}/${Date.now()}-${Math.random().toString(36).slice(2)}.jpg`;
            setImgStatus(key, 'A fazer upload... aguarda', '');
            if (bar) bar.style.width = '50%';
            // Overlay de loading no box
            const boxEl = document.getElementById('img-box-' + key);
            if (boxEl) {
                boxEl.style.borderColor = 'var(--primary)';
                const overlay = document.createElement('div');
                overlay.id = 'upload-overlay-' + key;
                overlay.style.cssText = 'position:absolute;inset:0;background:rgba(0,144,152,0.12);display:flex;align-items:center;justify-content:center;border-radius:10px;z-index:2;backdrop-filter:blur(2px)';
                overlay.innerHTML = '<div style="font-family:var(--font-title);font-size:10px;letter-spacing:2px;color:var(--primary-dark);text-align:center">A FAZER UPLOAD...</div>';
                boxEl.style.position = 'relative';
                boxEl.appendChild(overlay);
            }

            // 2. Upload directo ao Supabase Storage (sem servidor interm√©dio)
            const uploadUrl = `${SUPA_URL}/storage/v1/object/${bucket}/${filename}`;
            const res = await fetch(uploadUrl, {
                method:  'POST',
                headers: {
                    'apikey':        SUPA_KEY,
                    'Authorization': `Bearer ${SUPA_KEY}`,
                    'Content-Type':  'image/jpeg',
                    'x-upsert':      'true',
                },
                body: blob,
            });
            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err?.error || err?.message || `Erro ${res.status}: verifique se o bucket "${bucket}" existe e √© p√∫blico no Supabase`);
            }
            if (bar) bar.style.width = '100%';
            // Remove overlay
            document.getElementById('upload-overlay-' + key)?.remove();

            // 3. URL p√∫blica
            const publicUrl = `${SUPA_URL}/storage/v1/object/public/${bucket}/${filename}`;
            document.getElementById('f_' + key).value             = publicUrl;
            document.getElementById('img-url-input-' + key).value = publicUrl;
            updateImagePreview(key, publicUrl);
            setImgStatus(key, `Upload conclu√≠do! (${Math.round(blob.size / 1024)} KB)`, 'ok');
        } catch(e) {
            document.getElementById('upload-overlay-' + key)?.remove();
            setImgStatus(key, 'Erro: ' + e.message, 'err');
            console.error('Upload error:', e);
        } finally {
            setTimeout(() => { if (prog) prog.classList.remove('active'); if (bar) bar.style.width = '0%'; }, 2500);
            input.value = '';
        }
    }

    // ‚îÄ‚îÄ DRAWER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function closeDrawer() {
        document.getElementById('overlay').classList.add('hidden');
        document.body.style.overflow='';
    }
    function closeDrawerOutside(e) {
        if (e.target===document.getElementById('overlay')) closeDrawer();
    }
    document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeDrawer(); });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CONFIGURA√á√ïES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let configData = [];
    async function carregarConfiguracoes() {
        configData = await sb('configuracoes?select=*&order=chave') || [];
        renderConfiguracoes();
    }
    function renderConfiguracoes() {
        const q = getQ();
        let lista = [...configData];
        if (q) lista = lista.filter(c =>
            c.chave.toLowerCase().includes(q) ||
            (c.valor||'').toLowerCase().includes(q) ||
            (c.descricao||'').toLowerCase().includes(q)
        );
        let html = `
    <div class="section-toolbar" style="position:sticky;top:0;z-index:10">
        <input class="toolbar-search" id="toolbar-search-input"
               placeholder="Pesquisar configura√ß√£o..." oninput="handleSearch()" value="">
        <button class="btn-new" onclick="abrirFormConfig(null)">+ Nova</button>
    </div>
    <div style="padding:8px 16px 4px">
        <div style="font-size:11px;color:var(--text-faint);line-height:1.6">
            Cada <strong>chave</strong> √© usada dinamicamente no c√≥digo.
        </div>
    </div>`;
        if (!lista.length) {
            html += '<div class="empty"><div class="empty-icon">‚öô</div><div class="empty-txt">Nenhuma configura√ß√£o encontrada.</div></div>';
            document.getElementById('main-content').innerHTML = html;
            restoreSearch(q); return;
        }
        html += `<div style="padding:0 16px 16px;overflow-x:auto">
    <table class="config-table"><thead><tr>
        <th>Chave</th><th>Valor</th><th>Descri√ß√£o</th><th>Atualizado</th><th></th>
    </tr></thead><tbody>`;
        lista.forEach(c => {
            const dt    = c.updated_at ? new Date(c.updated_at).toLocaleDateString('pt-PT',{day:'2-digit',month:'short',year:'numeric'}) : '‚Äî';
            const isUrl = (c.valor||'').startsWith('http');
            const valHtml = isUrl
                ? `<a href="${c.valor}" target="_blank" style="color:var(--primary);font-size:12px;word-break:break-all">${c.valor}</a>`
                : `<span style="word-break:break-all">${c.valor||'‚Äî'}</span>`;
            html += `<tr>
            <td><span class="config-chave">${c.chave}</span></td>
            <td>${valHtml}</td>
            <td><span class="config-desc">${c.descricao||'‚Äî'}</span></td>
            <td><span class="config-date">${dt}</span></td>
            <td><div class="config-actions">
                <button class="btn-edit" onclick="abrirFormConfig('${c.chave}')">Editar</button>
                <button class="btn-toggle ativo" onclick="eliminarConfig('${c.chave}')">Apagar</button>
            </div></td>
        </tr>`;
        });
        html += `</tbody></table></div>`;
        document.getElementById('main-content').innerHTML = html;
        restoreSearch(q);
    }
    function abrirFormConfig(chave) {
        const c = chave ? configData.find(x=>x.chave===chave) : null;
        document.getElementById('drawer-title').textContent = c ? 'Editar Configura√ß√£o' : 'Nova Configura√ß√£o';
        document.getElementById('drawer-body').innerHTML = `<div class="form-grid">
        <div class="msg-form" id="form-msg"></div>
        <div class="form-group form-full">
            <label class="form-label">Chave</label>
            <input class="form-input" id="fc_chave" type="text" placeholder="ex: endereco"
                   value="${c?.chave||''}" ${c?'readonly':''}>
        </div>
        <div class="form-group form-full">
            <label class="form-label">Valor</label>
            <textarea class="form-textarea" id="fc_valor" style="height:80px">${c?.valor||''}</textarea>
        </div>
        <div class="form-group form-full">
            <label class="form-label">Descri√ß√£o</label>
            <input class="form-input" id="fc_descricao" type="text" placeholder="Para que serve?" value="${c?.descricao||''}">
        </div>
        <div class="form-actions">
            <button class="btn-cancel-form" onclick="closeDrawer()">Cancelar</button>
            <button class="btn-save" id="btn-save" onclick="salvarConfig('${c?.chave||''}')">Guardar</button>
        </div>
    </div>`;
        document.getElementById('overlay').classList.remove('hidden');
        document.body.style.overflow='hidden';
    }
    async function salvarConfig(chaveOriginal) {
        const chave    = document.getElementById('fc_chave')?.value?.trim().toLowerCase().replace(/\s+/g,'_');
        const valor    = document.getElementById('fc_valor')?.value?.trim();
        const descricao= document.getElementById('fc_descricao')?.value?.trim();
        if (!chave) { showFormMsg('Chave obrigat√≥ria.','error'); return; }
        if (!valor) { showFormMsg('Valor obrigat√≥rio.','error'); return; }
        const btn = document.getElementById('btn-save');
        btn.disabled=true; btn.textContent='A guardar...';
        try {
            const body = {chave, valor, descricao:descricao||null, updated_at:new Date().toISOString()};
            if (!chaveOriginal) await sb('configuracoes',{method:'POST',body:JSON.stringify(body)});
            else await sb(`configuracoes?chave=eq.${chaveOriginal}`,{method:'PATCH',body:JSON.stringify(body)});
            showFormMsg('Guardado!','success');
            await carregarConfiguracoes();
            setTimeout(closeDrawer, 700);
        } catch(e) {
            showFormMsg(`Erro: ${e?.message||e?.details||JSON.stringify(e)}`,'error');
            btn.disabled=false; btn.textContent='Guardar';
        }
    }
    async function eliminarConfig(chave) {
        if (!confirm(`Apagar a configura√ß√£o "${chave}"?`)) return;
        try {
            await sb(`configuracoes?chave=eq.${chave}`,{method:'DELETE'});
            await carregarConfiguracoes();
        } catch(e) { alert('Erro ao apagar: '+JSON.stringify(e)); }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CAMPOS DAS SEC√á√ïES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function camposMembros() { return [
        {type:'section',label:'Identifica√ß√£o'},
        {key:'nome',            label:'Nome',              ph:'Nome completo',     full:true},
        {key:'email',           label:'Email',             type:'email',           ph:'email@exemplo.com'},
        {key:'telefone',        label:'Telefone',          ph:'+351 9XX XXX XXX'},
        {key:'genero',          label:'G√©nero',            type:'select', options:[{v:'masculino',l:'Masculino'},{v:'feminino',l:'Feminino'},{v:'outro',l:'Outro'}]},
        {key:'data_nascimento', label:'Data Nascimento',   type:'date'},
        {key:'estado_civil',    label:'Estado Civil',      type:'select', options:[{v:'solteiro',l:'Solteiro'},{v:'casado',l:'Casado'},{v:'divorciado',l:'Divorciado'},{v:'viuvo',l:'Vi√∫vo'}]},
        {key:'nif',             label:'NIF',               ph:'000 000 000'},
        {key:'foto_url',        label:'Foto',              type:'image', bucket:'imagens', full:true},
        {type:'section',label:'Morada'},
        {key:'rua',             label:'Rua',               ph:'Nome da rua',       full:true},
        {key:'numero',          label:'N√∫mero',            ph:'Nr'},
        {key:'complemento',     label:'Complemento',       ph:'Andar, porta...'},
        {key:'cidade',          label:'Cidade',            ph:'Lisboa'},
        {key:'codigo_postal',   label:'C√≥digo Postal',     ph:'0000-000'},
        {key:'pais',            label:'Pa√≠s',              ph:'Portugal',          default:'Portugal'},
        {key:'zona',            label:'Zona (Link)',        ph:'Ex: Montijo'},
        {type:'section',label:'Igreja'},
        {key:'tipo',            label:'Tipo',              type:'select', options:[{v:'membro',l:'Membro'},{v:'admin',l:'Administrador'}]},
        {key:'data_entrada',    label:'Membro Desde',      type:'date'},
        {key:'onde_conheceu',   label:'Onde Conheceu',     ph:'Como soube da Zion?', full:true},
        {key:'foi_batizado',    label:'Foi Batizado',      type:'checkbox'},
        {key:'data_batismo',    label:'Data Batismo',      type:'date'},
        {key:'tem_filhos',      label:'Tem Filhos',        type:'checkbox'},
        {key:'numero_filhos',   label:'Nr Filhos',         type:'number', ph:'0'},
        {type:'section',label:'Fun√ß√µes'},
        {key:'e_lider',         label:'L√≠der',             type:'checkbox'},
        {key:'e_presbitero',    label:'Presb√≠tero',        type:'checkbox'},
        {key:'e_voluntario',    label:'Volunt√°rio',        type:'checkbox'},
        {key:'e_admin',         label:'Administrador',     type:'checkbox'},
        {key:'professor',       label:'Professor',         type:'checkbox'},
        {type:'section',label:'Hist√≥ria'},
        {key:'historia',        label:'Hist√≥ria',          type:'textarea', ph:'Hist√≥ria do membro...', full:true},
        {key:'ativo',           label:'Ativo',             type:'checkbox', default:true},
    ];}
    function camposPastores() { return [
        {key:'nome',      label:'Nome',      ph:'Nome completo',     full:true},
        {key:'cargo',     label:'Cargo',     ph:'Ex: Pastor Principal'},
        {key:'email',     label:'Email',     type:'email',           ph:'email@exemplo.com'},
        {key:'telefone',  label:'Telefone',  ph:'+351 9XX XXX XXX'},
        {key:'instagram', label:'Instagram', ph:'@handle'},
        {key:'foto_url',  label:'Foto',      type:'image', bucket:'imagens', full:true},
        {key:'bio',       label:'Biografia', type:'textarea',        ph:'Breve biografia...', full:true},
        {key:'ativo',     label:'Ativo',     type:'checkbox',        default:true},
    ];}
    function camposLinks() { return [
        {type:'section',       label:'Identifica√ß√£o'},
        {key:'nome',           label:'Nome',              ph:'Ex: LINK Montijo',  full:true},
        {key:'tipo',           label:'Tipo',              type:'select', options:[
                {v:'Familias',l:'Fam√≠lias'},{v:'FLOW',l:'FLOW'},{v:'VOX',l:'VOX'},
                {v:'Diamantes',l:'Diamantes'},{v:'EKLECTOS',l:'EKLECTOS'}
            ]},
        {key:'faixa_etaria',   label:'Faixa Et√°ria',      ph:'Ex: 18-35 anos'},
        {key:'capacidade',     label:'Capacidade',        type:'number', ph:'20'},
        {type:'section',       label:'Lideran√ßa'},
        {key:'responsavel',    label:'Respons√°vel',       ph:'Nome do l√≠der',     full:true},
        {key:'co_responsavel', label:'Co-Respons√°vel',    ph:'Nome do co-l√≠der',  full:true},
        {key:'anfitrioes',     label:'Anfitri√µes',        ph:'Nomes...',          full:true},
        {type:'section',       label:'Hor√°rio'},
        {key:'dia',            label:'Dia',               type:'select', options:[
                {v:'Segunda-feira',l:'Segunda-feira'},{v:'Ter√ßa-feira',l:'Ter√ßa-feira'},
                {v:'Quarta-feira',l:'Quarta-feira'},{v:'Quinta-feira',l:'Quinta-feira'},
                {v:'Sexta-feira',l:'Sexta-feira'},{v:'S√°bado',l:'S√°bado'},{v:'Domingo',l:'Domingo'}
            ]},
        {key:'horario',        label:'Hor√°rio',           ph:'Ex: 20h00'},
        {key:'online',         label:'√â Online',          type:'checkbox'},
        {type:'section',       label:'Localiza√ß√£o'},
        {key:'zona',           label:'Zona',              ph:'Ex: Montijo'},
        {key:'distrito',       label:'Distrito',          ph:'Ex: Set√∫bal'},
        {key:'morada',         label:'Morada',            ph:'Rua...', full:true},
        {key:'codigo_postal',  label:'C√≥d. Postal',       ph:'Ex: 2870-001'},
        {type:'section',       label:'Contacto'},
        {key:'contato',        label:'Contacto (WhatsApp)',ph:'+351 9XX XXX XXX', full:true},
        {key:'ativo',          label:'Ativo',             type:'checkbox', default:true},
    ];}
    function camposCultos() { return [
        {key:'nome',            label:'Nome',           ph:'Ex: Culto de Domingo', full:true},
        {key:'dia_semana',      label:'Dia',            type:'select', options:[
                {v:'Domingo',l:'Domingo'},{v:'Segunda-feira',l:'Segunda-feira'},
                {v:'Ter√ßa-feira',l:'Ter√ßa-feira'},{v:'Quarta-feira',l:'Quarta-feira'},
                {v:'Quinta-feira',l:'Quinta-feira'},{v:'Sexta-feira',l:'Sexta-feira'},{v:'S√°bado',l:'S√°bado'}
            ]},
        {key:'hora_inicio',     label:'Hora In√≠cio',    type:'time'},
        {key:'hora_fim',        label:'Hora Fim',        type:'time'},
        {key:'recorrente',      label:'Recorrente',     type:'checkbox', default:true},
        {key:'data_especifica', label:'Data Espec√≠fica', type:'date', full:true},
        {key:'descricao',       label:'Descri√ß√£o',      type:'textarea', ph:'...', full:true},
        {key:'ativo',           label:'Ativo',           type:'checkbox', default:true},
    ];}
    function camposMinisterios() { return [
        {key:'nome',         label:'Nome',         ph:'Ex: Minist√©rio de Louvor', full:true},
        {key:'tipo',         label:'Tipo',         type:'select', options:[{v:'ministerio',l:'Minist√©rio'},{v:'area',l:'√Årea de Equipa'}]},
        {key:'slug',         label:'Slug',         ph:'Ex: louvor'},
        {key:'faixa_etaria', label:'Faixa Et√°ria', ph:'Ex: Todas as idades'},
        {key:'instagram',    label:'Instagram',    ph:'@handle'},
        {key:'descricao',    label:'Descri√ß√£o',    type:'textarea', ph:'...', full:true},
        {key:'ativo',        label:'Ativo',        type:'checkbox', default:true},
    ];}
    function camposSalas() { return [
        {key:'nome',               label:'Nome',          ph:'Ex: Sala Principal', full:true},
        {key:'espaco',             label:'Espa√ßo',        ph:'Ex: Piso 1'},
        {key:'capacidade',         label:'Capacidade',    type:'number', ph:'20'},
        {key:'hora_inicio',        label:'Hora Abertura', type:'time'},
        {key:'hora_fim',           label:'Hora Fecho',    type:'time'},
        {key:'descricao',          label:'Descri√ß√£o',     type:'textarea', ph:'...', full:true},
        {key:'aviso_entrega',      label:'Aviso Entrega', type:'textarea', ph:'...', full:true},
        {key:'foto_url',           label:'Foto',          type:'image', bucket:'imagens', full:true},
        {key:'google_calendar_id', label:'Google Calendar ID', ph:'calendar@...', full:true},
        {type:'section',label:'Equipamentos'},
        {key:'tem_som',            label:'Som',           type:'checkbox'},
        {key:'tem_iluminacao',     label:'Ilumina√ß√£o',    type:'checkbox'},
        {key:'tem_projecao',       label:'Proje√ß√£o',      type:'checkbox'},
        {key:'tem_mesas',          label:'Mesas',         type:'checkbox'},
        {key:'tem_cadeiras',       label:'Cadeiras',      type:'checkbox'},
        {key:'ativo',              label:'Ativo',         type:'checkbox', default:true},
    ];}
    function camposCursos() { return [
        {key:'nome',          label:'Nome',           ph:'Ex: Curso de Louvor', full:true},
        {key:'carga_horaria', label:'Carga Hor√°ria',  ph:'Ex: 40 horas'},
        {key:'valor',         label:'Valor (‚Ç¨)',       type:'number', ph:'0.00'},
        {key:'gratuito',      label:'Gratuito',        type:'checkbox'},
        {key:'descricao',     label:'Descri√ß√£o',       type:'textarea', ph:'...', full:true},
        {key:'ativo',         label:'Ativo',           type:'checkbox', default:true},
    ];}
    function camposKeola() { return [
        {key:'nome',          label:'Nome',            ph:'Ex: Caf√© Especial', full:true},
        {key:'categoria',     label:'Categoria',       type:'select', options:[
                {v:'almoco',l:'Almo√ßo'},{v:'bebidas',l:'Bebidas'},{v:'sumos',l:'Sumos'},
                {v:'snacks',l:'Snacks'},{v:'sobremesas',l:'Sobremesas'},{v:'outro',l:'Outros'}
            ]},
        {key:'descricao',     label:'Descri√ß√£o',       type:'textarea', ph:'Breve descri√ß√£o...', full:true},
        {key:'preco',         label:'Pre√ßo (‚Ç¨)',        type:'number', ph:'0.00'},
        {key:'ordem',         label:'Ordem',            type:'number', ph:'1'},
        {key:'imagem_url',    label:'Foto do Produto',  type:'image', bucket:'imagens', full:true},
        {key:'disponivel',    label:'Dispon√≠vel',       type:'checkbox', default:true},
        {key:'especial_hoje', label:'Especial Hoje',    type:'checkbox'},
    ];}
    function camposLoja() { return [
        // ‚îÄ‚îÄ IDENTIFICA√á√ÉO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        {type:'section', label:'Identifica√ß√£o'},
        {key:'nome',          label:'Nome *',        ph:'Ex: B√≠blia NVI Capa Dura', full:true},
        {key:'categoria',     label:'Categoria',     type:'select', options:[
            {v:'Livros',l:'Livros'},{v:'Biblia',l:'B√≠blias'},{v:'Vestuario',l:'Vestu√°rio'},
            {v:'Acessorios',l:'Acess√≥rios'},{v:'Musica',l:'M√∫sica'},{v:'Decoracao',l:'Decora√ß√£o'},
            {v:'Infantil',l:'Infantil'},{v:'Papelaria',l:'Papelaria'},{v:'Outros',l:'Outros'},
        ]},
        {key:'subcategoria',  label:'Subcategoria',  ph:'Ex: Devocionais'},
        {key:'descricao',     label:'Descri√ß√£o',     type:'textarea', ph:'Descri√ß√£o do produto...', full:true},
        {key:'sku',           label:'SKU',           ph:'Ex: BIB-NVI-001'},
        {key:'codigo_barras', label:'C√≥d. Barras',   ph:'Ex: 7891234567890'},
        {key:'marca',         label:'Marca',         ph:'Ex: Editora Vida'},
        {key:'fornecedor',    label:'Fornecedor',    ph:'Ex: Distribuidora X'},
        {key:'tags',          label:'Tags',          ph:'livro, b√≠blia, nvi (separado por v√≠rgula)', full:true},
        {key:'modelo',        label:'Modelo',        ph:'Ex: Standard'},

        // ‚îÄ‚îÄ PRE√áOS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        {type:'section', label:'Pre√ßos'},
        {key:'preco',              label:'Pre√ßo de Venda (‚Ç¨)',  type:'number', ph:'0.00'},
        {key:'preco_custo',        label:'Pre√ßo de Custo (‚Ç¨)',  type:'number', ph:'0.00'},
        {key:'preco_promocional',  label:'Pre√ßo Promo (‚Ç¨)',     type:'number', ph:'0.00'},
        {key:'desconto_pct',       label:'Desconto (%)',        type:'number', ph:'0'},
        {key:'margem_lucro',       label:'Margem Lucro (%)',    type:'number', ph:'0'},
        {key:'data_inicio_promo',  label:'In√≠cio Promo√ß√£o',     type:'date'},
        {key:'data_fim_promo',     label:'Fim Promo√ß√£o',        type:'date'},

        // ‚îÄ‚îÄ ESTOQUE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        {type:'section', label:'Estoque'},
        {key:'stock',           label:'Estoque Actual',    type:'number', ph:'0'},
        {key:'stock_minimo',    label:'Estoque M√≠nimo',   type:'number', ph:'0'},
        {key:'stock_maximo',    label:'Estoque M√°ximo',   type:'number', ph:'0'},
        {key:'localizacao',     label:'Localiza√ß√£o',       ph:'Ex: Prateleira A2'},
        {key:'controlar_estoque',   label:'Controlar Estoque',   type:'checkbox', default:true},
        {key:'venda_sem_estoque',   label:'Vender sem Estoque',  type:'checkbox'},

        // ‚îÄ‚îÄ VARIA√á√ïES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        {type:'section', label:'Varia√ß√µes (Roupa / Produto)'},
        {key:'cor',          label:'Cor',         ph:'Ex: Azul, Preto'},
        {key:'tamanho',      label:'Tamanho',     ph:'Ex: M, G, 42'},
        {key:'genero',       label:'G√©nero',      type:'select', options:[
            {v:'',l:'--'},{v:'masculino',l:'Masculino'},{v:'feminino',l:'Feminino'},
            {v:'unissex',l:'Unissex'},{v:'infantil',l:'Infantil'},
        ]},
        {key:'material',     label:'Material',    ph:'Ex: Algod√£o 100%'},
        {key:'tipo_tecido',  label:'Tipo Tecido', ph:'Ex: Jersey, Flanela'},
        {key:'estacao',      label:'Esta√ß√£o',     type:'select', options:[
            {v:'',l:'--'},{v:'verao',l:'Ver√£o'},{v:'inverno',l:'Inverno'},{v:'primavera',l:'Primavera'},{v:'outono',l:'Outono'},{v:'todas',l:'Todas'},
        ]},
        {key:'voltagem',     label:'Voltagem',    ph:'Ex: 110V / 220V'},
        {key:'edicao',       label:'Edi√ß√£o',      ph:'Ex: 1¬™ Edi√ß√£o'},
        {key:'sku_variacao',         label:'SKU Varia√ß√£o',      ph:'Ex: BIB-NVI-001-AZ-G'},
        {key:'preco_variacao',       label:'Pre√ßo Varia√ß√£o (‚Ç¨)', type:'number', ph:'0.00'},
        {key:'estoque_variacao',     label:'Estoque Varia√ß√£o',  type:'number', ph:'0'},

        // ‚îÄ‚îÄ LIVROS / B√çBLIAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        {type:'section', label:'Livros & B√≠blias'},
        {key:'autor',            label:'Autor',           ph:'Ex: Charles Spurgeon'},
        {key:'editora',          label:'Editora',         ph:'Ex: Editora Vida Nova'},
        {key:'isbn',             label:'ISBN',            ph:'Ex: 978-85-000-0000-0'},
        {key:'num_paginas',      label:'N¬∫ de P√°ginas',   type:'number', ph:'0'},
        {key:'ano_publicacao',   label:'Ano Publica√ß√£o',  type:'number', ph:'2024'},
        {key:'idioma',           label:'Idioma',          type:'select', options:[
            {v:'',l:'--'},{v:'portugues',l:'Portugu√™s'},{v:'ingles',l:'Ingl√™s'},
            {v:'espanhol',l:'Espanhol'},{v:'outro',l:'Outro'},
        ]},
        {key:'tipo_capa',        label:'Tipo de Capa',    type:'select', options:[
            {v:'',l:'--'},{v:'dura',l:'Capa Dura'},{v:'brochura',l:'Brochura'},{v:'flexivel',l:'Flex√≠vel'},
        ]},

        // ‚îÄ‚îÄ ENVIO / DIMENS√ïES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        {type:'section', label:'Dimens√µes & Envio'},
        {key:'peso',          label:'Peso (kg)',       type:'number', ph:'0.00'},
        {key:'altura',        label:'Altura (cm)',     type:'number', ph:'0'},
        {key:'largura',       label:'Largura (cm)',    type:'number', ph:'0'},
        {key:'comprimento',   label:'Comprimento (cm)',type:'number', ph:'0'},
        {key:'frete_gratis',  label:'Frete Gr√°tis',   type:'checkbox'},
        {key:'classe_envio',  label:'Classe Envio',   ph:'Ex: Standard, Expresso'},

        // ‚îÄ‚îÄ IMAGEM & DESTAQUE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        {type:'section', label:'Imagem & Visibilidade'},
        {key:'imagem_url',    label:'Imagem',          type:'image', bucket:'imagens', full:true},
        {key:'data_lancamento', label:'Data Lan√ßamento', type:'date'},
        {key:'ordem',         label:'Ordem Exibi√ß√£o',  type:'number', ph:'1'},
        {key:'disponivel',    label:'Dispon√≠vel',      type:'checkbox', default:true},
        {key:'ativo',         label:'Ativo',           type:'checkbox', default:true},
        {key:'destaque',      label:'Destaque',        type:'checkbox'},
        {key:'novo_lancamento',label:'Novo Lan√ßamento',type:'checkbox'},
        {key:'mais_vendido',  label:'Mais Vendido',    type:'checkbox'},
        {key:'frete_gratis',  label:'Frete Gr√°tis',   type:'checkbox'},
    ];}

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // EVENTOS ‚Äî COMPLETAMENTE REESCRITO
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const STATUS_EVENTO = {
        aberto:   {label:'Aberto',    cls:'badge-green'},
        em_curso: {label:'Em Curso',  cls:'badge-primary'},
        concluido:{label:'Conclu√≠do', cls:'badge-gray'},
        cancelado:{label:'Cancelado', cls:'badge-red'},
    };

    let eventosData        = [];
    let presencasData      = [];
    let lideresMinisterios = {};
    let presSearchQ        = '';
    let eventoAtivo        = null;
    let eventoSubTab       = 0;

    // Participantes seleccionados para novo evento (array de {id, nome})
    let eventoParticipantesSel = [];

    function renderEventos() {
        const q        = getQ();
        const filtroSt = document.getElementById('evt-filtro-status')?.value||'';
        let lista = [...eventosData].sort((a,b)=>new Date(a.data_inicio)-new Date(b.data_inicio));
        if (q)        lista = lista.filter(e=>(e.titulo||'').toLowerCase().includes(q)||(e.local||'').toLowerCase().includes(q));
        if (filtroSt) lista = lista.filter(e=>e.status===filtroSt);

        if (eventoAtivo && eventoSubTab===1) { renderPresencas(); return; }

        let html = `
    <div class="section-toolbar" style="position:sticky;top:0;z-index:10">
        <input class="toolbar-search" id="toolbar-search-input"
               placeholder="Pesquisar evento..." oninput="handleSearch()" value="${q}">
        <select class="toolbar-filter" id="evt-filtro-status" onchange="renderEventos()"
                style="border-radius:20px;padding:7px 12px;border:1px solid var(--border);background:var(--bg-input);font-family:var(--font-title);font-size:9px;color:var(--text-muted);cursor:pointer">
            <option value="">Todos</option>
            <option value="aberto">Abertos</option>
            <option value="em_curso">Em Curso</option>
            <option value="concluido">Conclu√≠dos</option>
            <option value="cancelado">Cancelados</option>
        </select>
        <button class="btn-new" onclick="abrirFormEvento(null)">+ Novo</button>
    </div>`;

        if (!lista.length) {
            html+='<div class="empty"><div class="empty-icon">‚Äî</div><div class="empty-txt">Nenhum evento.</div></div>';
            document.getElementById('main-content').innerHTML=html;
            restoreSearch(q); return;
        }

        html+='<div class="admin-list" style="padding:12px 16px">';
        lista.forEach((e,i)=>{
            const st   = STATUS_EVENTO[e.status]||STATUS_EVENTO.aberto;
            const dI   = e.data_inicio?new Date(e.data_inicio).toLocaleDateString('pt-PT',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}):'‚Äî';
            const dF   = e.data_fim?new Date(e.data_fim).toLocaleDateString('pt-PT',{day:'2-digit',month:'short'}):'';
            const btns = [];
            if(e.status==='aberto')    { btns.push(`<button class="btn-edit" onclick="abrirFormEvento('${e.id}')">Editar</button>`); btns.push(`<button class="btn-toggle ativo" onclick="iniciarEvento('${e.id}')">Iniciar</button>`); }
            if(e.status==='em_curso')  { btns.push(`<button class="btn-edit" onclick="abrirPresencas('${e.id}')">Presen√ßas</button>`); btns.push(`<button class="btn-toggle ativo" onclick="concluirEvento('${e.id}')">Concluir</button>`); }
            if(e.status!=='cancelado'&&e.status!=='concluido') btns.push(`<button class="btn-toggle ativo" onclick="cancelarEvento('${e.id}')">Cancelar</button>`);
            if(e.status==='concluido'||e.status==='cancelado') btns.push(`<button class="btn-edit" onclick="abrirPresencas('${e.id}')">Ver Resumo</button>`);
            if(e.status==='concluido') btns.push(`<button class="btn-edit" style="color:var(--red);border-color:var(--red-border)" onclick="gerarRelatorioEvento('${e.id}')">PDF</button>`);
            html+=`
        <div class="admin-row" style="animation-delay:${Math.min(i,12)*0.02}s;flex-direction:column;align-items:stretch;gap:8px">
            <div style="display:flex;align-items:center;gap:12px">
                <div class="admin-row-foto" style="background:var(--primary-faint)">${(e.titulo||'E')[0]}</div>
                <div class="admin-row-info">
                    <div class="admin-row-nome">${e.titulo||'‚Äî'}</div>
                    <div class="admin-row-sub">${dI}${dF?' ‚Äî '+dF:''} ${e.local?'¬∑ '+e.local:''}</div>
                    <div class="admin-row-badges">
                        <span class="badge ${st.cls}">${st.label}</span>
                        ${e.gratuito?'<span class="badge badge-green">Gratuito</span>':''}
                        ${e.destaque?'<span class="badge badge-primary">Destaque</span>':''}
                        ${e.tipo?`<span class="badge badge-gray">${e.tipo}</span>`:''}
                    </div>
                </div>
            </div>
            <div class="admin-row-actions" style="justify-content:flex-end">${btns.join('')}</div>
        </div>`;
        });
        html+='</div>';
        document.getElementById('main-content').innerHTML=html;
        restoreSearch(q);
    }

    // ‚îÄ‚îÄ INICIAR EVENTO (l√≥gica nova) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function iniciarEvento(id) {
        const evento = eventosData.find(e=>e.id===id);
        if (!evento) return;
        const isLideres = evento.tipo === 'Reuni√£o de L√≠deres';

        if (!confirm(`Iniciar "${evento.titulo}"?${isLideres?' Todos os l√≠deres ser√£o adicionados automaticamente. Poder√°s adicionar mais participantes na lista de presen√ßas.':' Ir√°s gerir os participantes na lista de presen√ßas.'}`)) return;

        await sb(`eventos?id=eq.${id}`,{method:'PATCH',body:JSON.stringify({status:'em_curso'})});

        if (isLideres) {
            // Adiciona todos os l√≠deres automaticamente
            const lideres = await sb('membros?select=id,nome&e_lider=eq.true&ativo=eq.true');
            if (lideres?.length) {
                const rows = lideres.map(l=>({evento_id:id, membro_id:l.id, status:'pendente'}));
                await sb('evento_presencas',{method:'POST',body:JSON.stringify(rows)});
            }
        }
        // Se n√£o for l√≠deres, come√ßa vazio ‚Äî gest√£o manual na lista de presen√ßas

        eventosData = await sb('eventos?select=*&order=data_inicio')||[];
        renderEventos();
    }

    async function cancelarEvento(id) {
        if(!confirm('Cancelar este evento?')) return;
        await sb(`eventos?id=eq.${id}`,{method:'PATCH',body:JSON.stringify({status:'cancelado'})});
        eventosData = await sb('eventos?select=*&order=data_inicio')||[];
        renderEventos();
    }

    async function concluirEvento(id) {
        if(!confirm('Concluir? Pendentes ser√£o marcados como faltaram.')) return;
        await sb(`evento_presencas?evento_id=eq.${id}&status=eq.pendente`,{method:'PATCH',body:JSON.stringify({status:'faltou'})});
        await sb(`eventos?id=eq.${id}`,{method:'PATCH',body:JSON.stringify({status:'concluido'})});
        eventosData = await sb('eventos?select=*&order=data_inicio')||[];
        eventoAtivo=null; eventoSubTab=0; renderEventos();
    }

    async function abrirPresencas(id) {
        eventoAtivo  = eventosData.find(e=>e.id===id);
        eventoSubTab = 1;
        presencasData= await sb(`evento_presencas?select=*,membros(id,nome,telefone,foto_url)&evento_id=eq.${id}&order=created_at`)||[];
        const membroIds = presencasData.map(p=>p.membro_id).filter(Boolean);
        lideresMinisterios={};
        if(membroIds.length) {
            const vincs = await sb(`membro_ministerios?select=membro_id,papel,ministerios(id,nome,tipo)&membro_id=in.(${membroIds.join(',')})&ativo=eq.true`)||[];
            vincs.forEach(v=>{
                if(!lideresMinisterios[v.membro_id]) lideresMinisterios[v.membro_id]=[];
                lideresMinisterios[v.membro_id].push({papel:v.papel,nome:v.ministerios?.nome||'‚Äî',tipo:v.ministerios?.tipo||'‚Äî'});
            });
        }
        renderPresencas();
    }

    // ‚îÄ‚îÄ ADD PARTICIPANTE MANUAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function addParticipanteManual() {
        const sel   = document.getElementById('add-membro-sel');
        const memId = sel?.value;
        if (!memId) return;
        if (presencasData.find(p=>p.membro_id===memId)) { alert('Este membro j√° est√° na lista.'); return; }
        try {
            const rows = [{evento_id: eventoAtivo.id, membro_id: memId, status:'pendente'}];
            await sb('evento_presencas',{method:'POST',body:JSON.stringify(rows)});
            await abrirPresencas(eventoAtivo.id);
        } catch(e) { alert('Erro ao adicionar: '+JSON.stringify(e)); }
    }

    function renderPresencas() {
        const evento  = eventoAtivo;
        const st      = STATUS_EVENTO[evento?.status]||STATUS_EVENTO.aberto;
        const emCurso = evento?.status==='em_curso';
        const q       = presSearchQ.toLowerCase();
        let lista     = [...presencasData];
        if(q) lista = lista.filter(p=>(p.membros?.nome||'').toLowerCase().includes(q));

        const presentes = presencasData.filter(p=>p.status==='presente').length;
        const faltaram  = presencasData.filter(p=>p.status==='faltou').length;
        const comMotivo = presencasData.filter(p=>p.status==='faltou_motivo').length;
        const pendentes = presencasData.filter(p=>p.status==='pendente').length;
        const total     = presencasData.length;

        // Membros n√£o adicionados ainda (para o select de adicionar)
        const jaAdicionados = new Set(presencasData.map(p=>p.membro_id));
        const membrosDisponiveis = membros.filter(m=>!jaAdicionados.has(m.id));

        let html=`
    <div class="section-toolbar" style="position:sticky;top:0;z-index:10;flex-wrap:wrap;gap:6px">
        <button class="btn-edit" onclick="voltarListaEventos()">‚Üê Voltar</button>
        ${eventoAtivo?.status==='concluido'?`<button class="btn-edit" style="color:var(--red);border-color:var(--red-border)" onclick="gerarRelatorioEvento('${eventoAtivo.id}')">PDF</button>`:''}
        <input class="toolbar-search" id="pres-search" placeholder="Pesquisar..."
               oninput="presSearchQ=this.value;renderPresencas()" style="flex:1;min-width:120px">
        ${emCurso?`<button class="btn-new" onclick="finalizarEntradas()">Finalizar Entradas</button>`:''}
    </div>

    <div style="padding:10px 16px 0">
        <div style="font-family:var(--font-title);font-size:14px;color:var(--primary-dark);margin-bottom:6px">${evento?.titulo||'‚Äî'}</div>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
            <span class="badge ${st.cls}">${st.label}</span>
            <span class="badge badge-green">‚úì Presentes: ${presentes}</span>
            <span class="badge badge-red">‚úó Faltaram: ${faltaram+comMotivo}</span>
            ${comMotivo?`<span class="badge badge-primary">! Com motivo: ${comMotivo}</span>`:''}
            ${pendentes?`<span class="badge badge-gray">¬∑ Pendentes: ${pendentes}</span>`:''}
            <span class="badge badge-gray">Total: ${total}</span>
        </div>
    </div>`;

        // ‚îÄ‚îÄ Painel adicionar participante ‚Äî sempre vis√≠vel em eventos em curso ‚îÄ‚îÄ
        if (emCurso) {
            html += `
    <div style="padding:10px 16px 4px">
        <div class="add-member-panel">
            <div class="add-member-panel-title">Adicionar participante</div>
            <div class="add-member-row">
                <select class="form-select" id="add-membro-sel" style="flex:1">
                    <option value="">Seleciona um membro...</option>
                    ${membrosDisponiveis.map(m=>`<option value="${m.id}">${m.nome}</option>`).join('')}
                </select>
                <button class="btn-sub-add" onclick="addParticipanteManual()">+ Adicionar</button>
            </div>
        </div>
    </div>`;
        }

        html += '<div class="gold-line" style="margin:8px 16px"></div>';

        // ‚îÄ‚îÄ Lista de participantes por grupo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        if(!lista.length) {
            html+='<div class="empty"><div class="empty-txt">Nenhum participante encontrado.</div></div>';
        } else {
            const grupos=[
                {key:'presente',      label:'Presentes',           items:lista.filter(p=>p.status==='presente')},
                {key:'pendente',      label:'Pendentes',            items:lista.filter(p=>p.status==='pendente')},
                {key:'faltou_motivo', label:'Faltaram c/ Motivo',  items:lista.filter(p=>p.status==='faltou_motivo')},
                {key:'faltou',        label:'Faltaram',             items:lista.filter(p=>p.status==='faltou')},
            ].filter(g=>g.items.length>0);

            grupos.forEach(grupo=>{
                html+=`<div style="padding:8px 16px 2px;font-family:var(--font-title);font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--text-faint)">${grupo.label} (${grupo.items.length})</div>`;
                html+='<div class="admin-list" style="padding:4px 16px 8px">';
                grupo.items.forEach((p,i)=>{
                    const nome   = p.membros?.nome||'‚Äî';
                    const stIcon = {presente:'‚úì',faltou:'‚úó',faltou_motivo:'!',pendente:'¬∑'}[p.status]||'¬∑';
                    const stColor= {presente:'var(--green)',faltou:'var(--red)',faltou_motivo:'var(--orange)',pendente:'var(--border)'}[p.status]||'var(--border)';
                    const mins   = lideresMinisterios[p.membro_id]||[];
                    const minsHtml=mins.map(m=>`<span class="badge badge-gray" style="font-size:8px">${m.tipo==='ministerio'?'MIN':'AE'} ¬∑ ${m.nome}${m.papel?' ¬∑ '+m.papel:''}</span>`).join('');
                    let btns='';
                    if(emCurso&&p.status!=='presente')      btns+=`<button class="btn-toggle inativo" onclick="marcarPresenca('${p.id}','presente')">Presente</button>`;
                    if(emCurso&&p.status!=='faltou')        btns+=`<button class="btn-toggle ativo" onclick="marcarPresenca('${p.id}','faltou')">Faltou</button>`;
                    if(emCurso&&p.status!=='faltou_motivo') btns+=`<button class="btn-edit" onclick="abrirMotivo('${p.id}','${nome.replace(/'/g,"\\'")}')">Com Motivo</button>`;
                    if(emCurso&&p.status!=='pendente')      btns+=`<button class="btn-edit" style="color:var(--text-faint)" onclick="marcarPresenca('${p.id}','pendente')" title="Desfazer">‚Ü©</button>`;
                    let zapBtn='';
                    if(p.membros?.telefone){
                        const tel=p.membros.telefone.replace(/\D/g,'');
                        const dEvt=eventoAtivo?.data_inicio?new Date(eventoAtivo.data_inicio).toLocaleDateString('pt-PT',{weekday:'long',day:'numeric',month:'long',hour:'2-digit',minute:'2-digit'}):'';
                        const msg=encodeURIComponent(`Ol√° ${p.membros.nome?.split(' ')[0]}! Gostar√≠amos de confirmar a tua presen√ßa na ${eventoAtivo?.titulo||'reuni√£o'} a realizar ${dEvt}. Podes confirmar?`);
                        zapBtn=`<a href="https://api.whatsapp.com/send?phone=${tel}&text=${msg}" target="_blank" rel="noopener"
                        style="display:inline-flex;align-items:center;gap:4px;font-size:11px;color:#25D366;text-decoration:none;padding:2px 6px;border-radius:6px;border:1px solid rgba(37,211,102,0.3);background:rgba(37,211,102,0.06)">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="#25D366"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>Zap</a>`;
                    }
                    const fotoSrc=p.membros?.foto_url;
                    const fotoHtml=fotoSrc
                        ?`<img src="${fotoSrc}" style="width:36px;height:36px;border-radius:50%;object-fit:cover;flex-shrink:0;border:2px solid ${stColor}" onerror="this.style.display='none'">`
                        :`<div class="admin-row-foto" style="font-size:13px;font-weight:bold;color:${stColor}">${stIcon}</div>`;
                    html+=`<div class="admin-row" style="animation-delay:${Math.min(i,20)*0.01}s;flex-wrap:wrap;gap:6px">
                    ${fotoHtml}
                    <div class="admin-row-info" style="min-width:0;flex:1">
                        <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
                            <span class="admin-row-nome">${nome}</span>${zapBtn}
                        </div>
                        <div class="admin-row-badges" style="margin-top:3px;flex-wrap:wrap;gap:3px">
                            ${minsHtml||'<span style="font-size:10px;color:var(--text-faint)">Sem √°reas</span>'}
                        </div>
                        ${p.motivo?`<div class="admin-row-sub" style="color:var(--orange);margin-top:3px">Motivo: ${p.motivo}</div>`:''}
                    </div>
                    <div class="admin-row-actions">${btns}</div>
                </div>`;
                });
                html+='</div>';
            });
        }

        // ‚îÄ‚îÄ Gr√°ficos e resumo ‚Äî DEPOIS da lista ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        if (evento?.status === 'concluido' || evento?.status === 'em_curso') {
            html += '<div class="gold-line" style="margin:12px 16px 4px"></div>';
            html += `<div style="padding:6px 16px 2px;font-family:var(--font-title);font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--text-faint)">Resumo e Gr√°ficos</div>`;
            html += renderGraficosResumo(presencasData, lideresMinisterios);
        }

        document.getElementById('main-content').innerHTML=html;
        const si=document.getElementById('pres-search');
        if(si){si.value=presSearchQ;si.focus();si.setSelectionRange(si.value.length,si.value.length);}
    }

    // ‚îÄ‚îÄ GR√ÅFICOS RESUMO (tela) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderGraficosResumo(pres, minsMap) {
        const presentes = pres.filter(p=>p.status==='presente').length;
        const faltaram  = pres.filter(p=>p.status==='faltou').length;
        const comMotivo = pres.filter(p=>p.status==='faltou_motivo').length;
        const total     = pres.length;
        const pct       = total > 0 ? Math.round(presentes/total*100) : 0;

        // Stats cards
        let html = `<div class="resumo-stats">
        <div class="resumo-stat">
            <div class="resumo-stat-num" style="color:var(--green)">${presentes}</div>
            <div class="resumo-stat-label">Presentes</div>
            <div class="resumo-stat-pct" style="color:var(--green)">${pct}%</div>
        </div>
        <div class="resumo-stat">
            <div class="resumo-stat-num" style="color:var(--red)">${faltaram}</div>
            <div class="resumo-stat-label">Faltaram</div>
            <div class="resumo-stat-pct" style="color:var(--red)">${total>0?Math.round(faltaram/total*100):0}%</div>
        </div>
        <div class="resumo-stat">
            <div class="resumo-stat-num" style="color:var(--orange,#e65100)">${comMotivo}</div>
            <div class="resumo-stat-label">Com Motivo</div>
            <div class="resumo-stat-pct" style="color:var(--orange,#e65100)">${total>0?Math.round(comMotivo/total*100):0}%</div>
        </div>
        <div class="resumo-stat">
            <div class="resumo-stat-num" style="color:var(--text-muted)">${total}</div>
            <div class="resumo-stat-label">Total</div>
            <div class="resumo-stat-pct" style="color:var(--text-faint)">100%</div>
        </div>
    </div>`;

        html += '<div class="resumo-graficos">';

        // Pizza geral presen√ßa
        html += buildGraficoPizza([
            {label:'Presentes',   val:presentes, cor:'#2e7d32'},
            {label:'Com Motivo',  val:comMotivo, cor:'#e65100'},
            {label:'Faltaram',    val:faltaram,  cor:'#c62828'},
        ], 'Presen√ßas Geral', total);

        // Por √°rea/minist√©rio
        const porArea = {};
        pres.forEach(p=>{
            const mins = minsMap[p.membro_id]||[{tipo:'Sem √°rea',nome:'Sem √°rea',papel:''}];
            mins.forEach(m=>{
                const k = `${m.tipo}||${m.nome}`;
                if (!porArea[k]) porArea[k]={tipo:m.tipo, nome:m.nome, presentes:0, faltaram:0, total:0};
                porArea[k].total++;
                if (p.status==='presente') porArea[k].presentes++;
                else if (p.status==='faltou'||p.status==='faltou_motivo') porArea[k].faltaram++;
            });
        });

        const areas = Object.values(porArea).sort((a,b)=>b.total-a.total);
        if (areas.length > 0) {
            html += buildGraficoBarras(areas, 'Presen√ßas por √Årea / Minist√©rio');
        }

        html += '</div>';
        return html;
    }

    function buildGraficoPizza(dados, titulo, total) {
        if (total === 0) return '';
        // SVG pizza simples
        const r   = 60;
        const cx  = 70;
        const cy  = 70;
        let paths = '';
        let startAngle = -Math.PI / 2;
        dados.forEach(d => {
            if (d.val === 0) return;
            const angle = (d.val / total) * Math.PI * 2;
            const endAngle = startAngle + angle;
            const x1 = cx + r * Math.cos(startAngle);
            const y1 = cy + r * Math.sin(startAngle);
            const x2 = cx + r * Math.cos(endAngle);
            const y2 = cy + r * Math.sin(endAngle);
            const largeArc = angle > Math.PI ? 1 : 0;
            paths += `<path d="M${cx},${cy} L${x1.toFixed(1)},${y1.toFixed(1)} A${r},${r} 0 ${largeArc},1 ${x2.toFixed(1)},${y2.toFixed(1)} Z" fill="${d.cor}" opacity="0.9"/>`;
            startAngle = endAngle;
        });
        // C√≠rculo central (donut)
        paths += `<circle cx="${cx}" cy="${cy}" r="30" fill="var(--bg-card)"/>`;
        paths += `<text x="${cx}" y="${cy-5}" text-anchor="middle" font-size="14" font-weight="bold" fill="var(--text-main)">${total}</text>`;
        paths += `<text x="${cx}" y="${cy+12}" text-anchor="middle" font-size="9" fill="var(--text-faint)">TOTAL</text>`;

        const legend = dados.map(d=>`
        <div class="pizza-legend-item">
            <div class="pizza-legend-dot" style="background:${d.cor}"></div>
            <span>${d.label}: <strong>${d.val}</strong> (${total>0?Math.round(d.val/total*100):0}%)</span>
        </div>`).join('');

        return `<div class="grafico-wrap">
        <div class="grafico-titulo">${titulo}</div>
        <div class="pizza-wrap">
            <svg class="pizza-svg" width="140" height="140" viewBox="0 0 140 140">${paths}</svg>
            <div class="pizza-legend">${legend}</div>
        </div>
    </div>`;
    }

    function buildGraficoBarras(areas, titulo) {
        const max = Math.max(...areas.map(a=>a.total), 1);
        const barras = areas.map(a=>{
            const pct = Math.round(a.presentes / (a.total||1) * 100);
            const wP  = Math.round(a.presentes / max * 100);
            const wF  = Math.round(a.faltaram  / max * 100);
            const tipoLabel = a.tipo==='ministerio' ? 'MIN' : a.tipo==='Sem √°rea' ? '‚Äî' : 'AE';
            return `
        <div style="margin-bottom:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:3px">
                <span style="font-size:11px;color:var(--text-main);max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
                    <span style="font-size:9px;background:var(--bg-input);padding:1px 5px;border-radius:4px;color:var(--text-faint);margin-right:5px">${tipoLabel}</span>${a.nome}
                </span>
                <span style="font-size:10px;font-weight:bold;color:${pct>=80?'var(--green)':pct>=50?'var(--orange,#e65100)':'var(--red)'}">${pct}%</span>
            </div>
            <div style="display:flex;gap:4px;height:12px">
                <div style="flex:${a.presentes||0};background:#2e7d32;border-radius:4px 0 0 4px;opacity:0.8;min-width:${a.presentes?'4px':'0'}"></div>
                <div style="flex:${a.faltaram||0};background:#c62828;border-radius:0 4px 4px 0;opacity:0.8;min-width:${a.faltaram?'4px':'0'}"></div>
            </div>
            <div style="font-size:10px;color:var(--text-faint);margin-top:2px">${a.presentes} presentes ¬∑ ${a.faltaram} faltaram ¬∑ ${a.total} total</div>
        </div>`;
        }).join('');

        return `<div class="grafico-wrap">
        <div class="grafico-titulo">${titulo}</div>
        <div style="display:flex;gap:12px;margin-bottom:10px">
            <div style="display:flex;align-items:center;gap:5px;font-size:11px"><div style="width:12px;height:12px;background:#2e7d32;border-radius:2px;opacity:0.8"></div>Presentes</div>
            <div style="display:flex;align-items:center;gap:5px;font-size:11px"><div style="width:12px;height:12px;background:#c62828;border-radius:2px;opacity:0.8"></div>Faltaram</div>
        </div>
        ${barras}
    </div>`;
    }

    function voltarListaEventos() { eventoAtivo=null; eventoSubTab=0; presSearchQ=''; renderEventos(); }

    async function marcarPresenca(presencaId, novoStatus) {
        const patch={status:novoStatus,registado_em:new Date().toISOString()};
        if(novoStatus==='pendente') patch.motivo='';
        await sb(`evento_presencas?id=eq.${presencaId}`,{method:'PATCH',body:JSON.stringify(patch)});
        const idx=presencasData.findIndex(p=>p.id===presencaId);
        if(idx>=0){presencasData[idx].status=novoStatus;if(novoStatus==='pendente') presencasData[idx].motivo='';}
        renderPresencas();
    }

    async function finalizarEntradas() {
        if(!eventoAtivo) return;
        if(!confirm('Pendentes ser√£o marcados como faltaram.')) return;
        await sb(`evento_presencas?evento_id=eq.${eventoAtivo.id}&status=eq.pendente`,{method:'PATCH',body:JSON.stringify({status:'faltou'})});
        presencasData.forEach(p=>{if(p.status==='pendente') p.status='faltou';});
        renderPresencas();
    }

    let motivoPresencaId=null;
    function abrirMotivo(presencaId, nome) {
        motivoPresencaId=presencaId;
        document.getElementById('drawer-title').textContent=`Motivo ‚Äî ${nome}`;
        document.getElementById('drawer-body').innerHTML=`<div class="form-grid">
        <div class="form-group form-full">
            <label class="form-label">Motivo da Falta</label>
            <textarea class="form-textarea" id="motivo-txt" placeholder="Descreve o motivo..." style="height:100px"></textarea>
        </div>
        <div class="form-actions">
            <button class="btn-cancel-form" onclick="closeDrawer()">Cancelar</button>
            <button class="btn-save" onclick="guardarMotivo()">Guardar</button>
        </div>
    </div>`;
        document.getElementById('overlay').classList.remove('hidden');
        document.body.style.overflow='hidden';
    }
    async function guardarMotivo() {
        const motivo=document.getElementById('motivo-txt')?.value?.trim();
        if(!motivo){alert('Escreve o motivo.');return;}
        await sb(`evento_presencas?id=eq.${motivoPresencaId}`,{method:'PATCH',body:JSON.stringify({status:'faltou_motivo',motivo,registado_em:new Date().toISOString()})});
        const idx=presencasData.findIndex(p=>p.id===motivoPresencaId);
        if(idx>=0){presencasData[idx].status='faltou_motivo';presencasData[idx].motivo=motivo;}
        closeDrawer(); renderPresencas();
    }

    // ‚îÄ‚îÄ FORM EVENTO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function abrirFormEvento(id) {
        const e=id?eventosData.find(x=>x.id===id):null;
        document.getElementById('drawer-title').textContent=e?'Editar Evento':'Novo Evento';
        document.getElementById('drawer-body').innerHTML=buildFormEvento(e);
        document.getElementById('overlay').classList.remove('hidden');
        document.body.style.overflow='hidden';
    }

    function buildFormEvento(e) {
        const fv =(k,d='')=>e?.[k]??d;
        const fdt=k=>{const v=e?.[k];if(!v)return'';return new Date(v).toISOString().slice(0,16);};
        const tipoOpts = TIPOS_EVENTO.map(t=>`<option value="${t}" ${fv('tipo')===t?'selected':''}>${t}</option>`).join('');
        return `<div class="form-grid">
        <div class="msg-form" id="form-msg"></div>
        <div class="form-section-title">Identifica√ß√£o</div>
        <div class="form-group form-full"><label class="form-label">T√≠tulo</label><input class="form-input" id="fe_titulo" type="text" placeholder="Nome do evento" value="${fv('titulo')}"></div>
        <div class="form-group">
            <label class="form-label">Tipo</label>
            <select class="form-select" id="fe_tipo">
                <option value="">-- Seleciona --</option>
                ${tipoOpts}
            </select>
        </div>
        <div class="form-group"><label class="form-label">Local</label><input class="form-input" id="fe_local" type="text" placeholder="Ex: Sede Lisboa" value="${fv('local')}"></div>
        <div class="form-group form-full"><label class="form-label">Descri√ß√£o</label><textarea class="form-textarea" id="fe_descricao">${fv('descricao')}</textarea></div>
        <div class="form-section-title">Data e Hora</div>
        <div class="form-group"><label class="form-label">Data In√≠cio</label><input class="form-input" id="fe_data_inicio" type="datetime-local" value="${fdt('data_inicio')}"></div>
        <div class="form-group"><label class="form-label">Data Fim</label><input class="form-input" id="fe_data_fim" type="datetime-local" value="${fdt('data_fim')}"></div>
        <div class="form-section-title">Inscri√ß√£o</div>
        <div class="form-group"><label class="form-label">Valor (‚Ç¨)</label><input class="form-input" id="fe_valor" type="number" placeholder="0.00" value="${fv('valor')}"></div>
        <div class="form-group"><label class="form-label">Link Inscri√ß√£o</label><input class="form-input" id="fe_link_inscricao" type="url" placeholder="https://..." value="${fv('link_inscricao')}"></div>
        <div class="form-group"><label class="form-toggle"><input type="checkbox" id="fe_gratuito" ${fv('gratuito')?'checked':''}><span>Gratuito</span></label></div>
        <div class="form-group"><label class="form-toggle"><input type="checkbox" id="fe_destaque" ${fv('destaque')?'checked':''}><span>Destaque</span></label></div>
        <div class="form-group"><label class="form-toggle"><input type="checkbox" id="fe_ativo" ${fv('ativo')!==false?'checked':''}><span>Ativo</span></label></div>
        <div class="form-actions">
            <button class="btn-cancel-form" onclick="closeDrawer()">Cancelar</button>
            <button class="btn-save" id="btn-save" onclick="salvarEvento('${e?.id||''}')">Guardar</button>
        </div>
    </div>`;
    }

    async function salvarEvento(id) {
        const get=k=>{const el=document.getElementById('fe_'+k);return el?el.value||null:null;};
        const chk=k=>{const el=document.getElementById('fe_'+k);return el?el.checked:false;};
        const body={titulo:get('titulo'),tipo:get('tipo'),local:get('local'),descricao:get('descricao'),
            data_inicio:get('data_inicio'),data_fim:get('data_fim'),
            valor:get('valor')?Number(get('valor')):null,link_inscricao:get('link_inscricao'),
            gratuito:chk('gratuito'),destaque:chk('destaque'),ativo:chk('ativo')};
        if(!body.titulo){showFormMsg('T√≠tulo obrigat√≥rio.','error');return;}
        const btn=document.getElementById('btn-save');
        btn.disabled=true;btn.textContent='A guardar...';
        try {
            if(!id){body.status='aberto';await sb('eventos',{method:'POST',body:JSON.stringify(body)});}
            else await sb(`eventos?id=eq.${id}`,{method:'PATCH',body:JSON.stringify(body)});
            showFormMsg('Guardado!','success');
            eventosData=await sb('eventos?select=*&order=data_inicio')||[];
            setTimeout(()=>{closeDrawer();renderEventos();},700);
        } catch(err) {
            showFormMsg('Erro: '+(err?.message||JSON.stringify(err)),'error');
            btn.disabled=false;btn.textContent='Guardar';
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // TIPOS DE EVENTO ‚Äî gest√£o na tela
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const TIPOS_EVENTO_DEFAULT = [
        'Reuni√£o de L√≠deres','Culto Especial','Confer√™ncia','Retiro',
        'Treinamento','Workshop','Confer√™ncia de Jovens','Encontro de Casais',
        'Culto de Ora√ß√£o','Semin√°rio','Outro',
    ];

    function getTiposEvento() {
        try {
            const saved = localStorage.getItem('zion_tipos_evento');
            return saved ? JSON.parse(saved) : [...TIPOS_EVENTO_DEFAULT];
        } catch { return [...TIPOS_EVENTO_DEFAULT]; }
    }
    function saveTiposEvento(lista) {
        localStorage.setItem('zion_tipos_evento', JSON.stringify(lista));
        syncTiposEvento(); // actualiza o array TIPOS_EVENTO em mem√≥ria
    }

    function renderTiposEvento() {
        const lista = getTiposEvento();
        let html = `
    <div class="section-toolbar" style="position:sticky;top:0;z-index:10">
        <span style="font-family:var(--font-title);font-size:10px;letter-spacing:1px;color:var(--text-muted);flex:1">Tipos de Evento</span>
        <button class="btn-new" onclick="abrirFormTipoEvento(null)">+ Novo Tipo</button>
    </div>
    <div style="padding:8px 16px 4px">
        <div style="font-size:11px;color:var(--text-faint);line-height:1.6">
            Quando o tipo √© <strong>Reuni√£o de L√≠deres</strong>, todos os l√≠deres s√£o adicionados automaticamente ao iniciar.
            Os outros tipos come√ßam com lista vazia.
        </div>
    </div>
    <div class="admin-list" style="padding:8px 16px">`;

        lista.forEach((tipo, i) => {
            const isLideres = tipo === 'Reuni√£o de L√≠deres';
            html += `
        <div class="admin-row" style="animation-delay:${i*0.02}s">
            <div class="admin-row-foto" style="font-size:11px">${(i+1)}</div>
            <div class="admin-row-info">
                <div class="admin-row-nome">${tipo}</div>
                ${isLideres ? '<div class="admin-row-sub" style="color:var(--primary-dark)">Auto-adiciona todos os l√≠deres</div>' : ''}
            </div>
            <div class="admin-row-actions">
                <button class="btn-edit" onclick="abrirFormTipoEvento(${i})">Editar</button>
                ${!isLideres ? `<button class="btn-toggle ativo" onclick="removerTipoEvento(${i})">Remover</button>` : ''}
                ${i > 0 ? `<button class="btn-edit" onclick="moverTipo(${i},-1)" title="Subir">‚Üë</button>` : ''}
                ${i < lista.length-1 ? `<button class="btn-edit" onclick="moverTipo(${i},1)" title="Descer">‚Üì</button>` : ''}
            </div>
        </div>`;
        });

        html += '</div>';
        document.getElementById('main-content').innerHTML = html;
    }

    function abrirFormTipoEvento(idx) {
        const lista  = getTiposEvento();
        const isNovo = idx === null;
        const valor  = isNovo ? '' : lista[idx];
        document.getElementById('drawer-title').textContent = isNovo ? 'Novo Tipo de Evento' : 'Editar Tipo';
        document.getElementById('drawer-body').innerHTML = `<div class="form-grid">
        <div class="msg-form" id="form-msg"></div>
        <div class="form-group form-full">
            <label class="form-label">Nome do Tipo</label>
            <input class="form-input" id="ft_nome" type="text" placeholder="Ex: Encontro de Jovens" value="${valor}">
        </div>
        <div class="form-actions">
            <button class="btn-cancel-form" onclick="closeDrawer()">Cancelar</button>
            <button class="btn-save" onclick="salvarTipoEvento(${idx})">Guardar</button>
        </div>
    </div>`;
        document.getElementById('overlay').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function salvarTipoEvento(idx) {
        const nome = document.getElementById('ft_nome')?.value?.trim();
        if (!nome) { showFormMsg('Nome obrigat√≥rio.','error'); return; }
        const lista = getTiposEvento();
        if (idx === null) {
            // Adiciona antes de "Outro" (√∫ltimo)
            lista.splice(lista.length - 1, 0, nome);
        } else {
            lista[idx] = nome;
        }
        saveTiposEvento(lista);
        closeDrawer();
        renderTiposEvento();
    }

    function removerTipoEvento(idx) {
        const lista = getTiposEvento();
        if (!confirm(`Remover o tipo "${lista[idx]}"?`)) return;
        lista.splice(idx, 1);
        saveTiposEvento(lista);
        renderTiposEvento();
    }

    function moverTipo(idx, dir) {
        const lista = getTiposEvento();
        const novo  = idx + dir;
        if (novo < 0 || novo >= lista.length) return;
        [lista[idx], lista[novo]] = [lista[novo], lista[idx]];
        saveTiposEvento(lista);
        renderTiposEvento();
    }

    function camposEventos(){return[];}

    // ‚îÄ‚îÄ RELAT√ìRIO PDF (com gr√°ficos) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function gerarRelatorioEvento(eventoId) {
        const evento=eventosData.find(e=>e.id===eventoId);
        if(!evento) return;
        const pres=await sb(`evento_presencas?select=*,membros(id,nome,foto_url,telefone)&evento_id=eq.${eventoId}&order=created_at`)||[];
        const membroIds=pres.map(p=>p.membro_id).filter(Boolean);
        let minsMap={};
        if(membroIds.length){
            const vincs=await sb(`membro_ministerios?select=membro_id,papel,ministerios(nome,tipo)&membro_id=in.(${membroIds.join(',')})&ativo=eq.true`)||[];
            vincs.forEach(v=>{
                if(!minsMap[v.membro_id]) minsMap[v.membro_id]=[];
                minsMap[v.membro_id].push({tipo:v.ministerios?.tipo||'?',nome:v.ministerios?.nome||'‚Äî',papel:v.papel||''});
            });
        }
        const presentes=pres.filter(p=>p.status==='presente');
        const faltaram =pres.filter(p=>p.status==='faltou');
        const comMotivo=pres.filter(p=>p.status==='faltou_motivo');
        const total    =pres.length;
        const dEvt=evento.data_inicio?new Date(evento.data_inicio).toLocaleDateString('pt-PT',{weekday:'long',day:'numeric',month:'long',year:'numeric',hour:'2-digit',minute:'2-digit'}):'‚Äî';

        // Por √°rea
        const porArea={};
        pres.forEach(p=>{
            const mins=minsMap[p.membro_id]||[{tipo:'Sem √°rea',nome:'Sem √°rea',papel:''}];
            mins.forEach(m=>{
                const k=`${m.tipo}||${m.nome}`;
                if(!porArea[k]) porArea[k]={tipo:m.tipo,nome:m.nome,presentes:0,faltaram:0,total:0};
                porArea[k].total++;
                if(p.status==='presente') porArea[k].presentes++;
                else if(p.status==='faltou'||p.status==='faltou_motivo') porArea[k].faltaram++;
            });
        });
        const areasSort=Object.values(porArea).sort((a,b)=>a.nome.localeCompare(b.nome));

        const rowM=p=>{
            const mins=minsMap[p.membro_id]||[];
            const as=mins.map(m=>`[${m.tipo==='ministerio'?'MIN':'AE'}] ${m.nome}${m.papel?' ¬∑ '+m.papel:''}`).join(' | ');
            return `<tr><td>${p.membros?.nome||'‚Äî'}</td><td style="font-size:11px;color:#666">${as||'‚Äî'}</td><td style="font-size:11px;color:#c07000">${p.motivo||'‚Äî'}</td></tr>`;
        };
        const rowA=a=>`<tr>
        <td>${a.tipo==='ministerio'?'Minist√©rio':'√Årea de Equipa'}</td>
        <td style="font-weight:600">${a.nome}</td>
        <td style="color:green;text-align:center">${a.presentes}</td>
        <td style="color:red;text-align:center">${a.faltaram}</td>
        <td style="text-align:center">${Math.round(a.presentes/(a.total||1)*100)}%</td>
    </tr>`;

        // Gr√°fico de barras SVG para PDF
        function buildSvgBarras(areas) {
            const maxVal = Math.max(...areas.map(a=>a.total), 1);
            const barH   = 22;
            const gap    = 6;
            const leftW  = 180;
            const barMaxW= 300;
            const svgH   = areas.length * (barH + gap) + 40;
            let svgContent = `<svg width="560" height="${svgH}" xmlns="http://www.w3.org/2000/svg" font-family="Arial,sans-serif">`;
            svgContent += `<text x="0" y="18" font-size="11" fill="#888">√Årea</text>`;
            svgContent += `<text x="${leftW+5}" y="18" font-size="11" fill="#2e7d32">Presentes</text>`;
            svgContent += `<text x="${leftW+barMaxW/2}" y="18" font-size="11" fill="#c62828">Faltaram</text>`;
            areas.forEach((a, i) => {
                const y    = 30 + i * (barH + gap);
                const wP   = Math.round(a.presentes / maxVal * barMaxW);
                const wF   = Math.round(a.faltaram  / maxVal * barMaxW);
                const pct  = Math.round(a.presentes / (a.total||1) * 100);
                const nome = a.nome.length > 22 ? a.nome.substring(0,22)+'‚Ä¶' : a.nome;
                svgContent += `<text x="${leftW-5}" y="${y+15}" font-size="11" fill="#333" text-anchor="end">${nome}</text>`;
                svgContent += `<rect x="${leftW}" y="${y}" width="${wP}" height="${barH}" fill="#2e7d32" opacity="0.8" rx="3"/>`;
                svgContent += `<rect x="${leftW+wP}" y="${y}" width="${wF}" height="${barH}" fill="#c62828" opacity="0.8" rx="3"/>`;
                svgContent += `<text x="${leftW+wP+wF+8}" y="${y+15}" font-size="11" fill="${pct>=80?'#2e7d32':pct>=50?'#e65100':'#c62828'}" font-weight="bold">${pct}%</text>`;
            });
            svgContent += '</svg>';
            return svgContent;
        }

        // Pizza SVG para PDF
        function buildSvgPizza() {
            const r=80; const cx=100; const cy=100;
            const dados=[
                {val:presentes.length,cor:'#2e7d32',label:'Presentes'},
                {val:comMotivo.length,cor:'#e65100',label:'Com Motivo'},
                {val:faltaram.length, cor:'#c62828',label:'Faltaram'},
            ];
            let paths=''; let start=-Math.PI/2;
            dados.forEach(d=>{
                if(!d.val) return;
                const a=d.val/total*Math.PI*2;
                const end=start+a;
                const x1=cx+r*Math.cos(start); const y1=cy+r*Math.sin(start);
                const x2=cx+r*Math.cos(end);   const y2=cy+r*Math.sin(end);
                const la=a>Math.PI?1:0;
                paths+=`<path d="M${cx},${cy} L${x1.toFixed(1)},${y1.toFixed(1)} A${r},${r} 0 ${la},1 ${x2.toFixed(1)},${y2.toFixed(1)} Z" fill="${d.cor}" opacity="0.85"/>`;
                start=end;
            });
            paths+=`<circle cx="${cx}" cy="${cy}" r="40" fill="white"/>`;
            paths+=`<text x="${cx}" y="${cy-4}" text-anchor="middle" font-size="18" font-weight="bold" fill="#333">${total}</text>`;
            paths+=`<text x="${cx}" y="${cy+14}" text-anchor="middle" font-size="10" fill="#888">TOTAL</text>`;
            const legend=dados.map((d,i)=>`<text x="210" y="${40+i*22}" font-size="12" fill="${d.cor}">‚ñ† ${d.label}: ${d.val} (${total>0?Math.round(d.val/total*100):0}%)</text>`).join('');
            return `<svg width="420" height="200" xmlns="http://www.w3.org/2000/svg" font-family="Arial,sans-serif">${paths}${legend}</svg>`;
        }

        const htm=`<!DOCTYPE html><html lang="pt"><head><meta charset="UTF-8"><title>Relat√≥rio ‚Äî ${evento.titulo}</title>
    <style>
        body{font-family:Arial,sans-serif;color:#222;padding:32px;max-width:900px;margin:0 auto}
        h1{font-size:22px;margin-bottom:4px;color:#006b70}
        h2{font-size:15px;margin:28px 0 10px;color:#006b70;border-bottom:2px solid #009098;padding-bottom:4px}
        .meta{font-size:13px;color:#555;margin-bottom:24px}
        .badges{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap}
        .badge{padding:6px 14px;border-radius:20px;font-size:12px;font-weight:bold}
        .g{background:#e8f5e9;color:#2e7d32}.r{background:#ffebee;color:#c62828}
        .o{background:#fff8e1;color:#e65100}.gr{background:#f5f5f5;color:#555}
        table{width:100%;border-collapse:collapse;font-size:13px}
        th{background:#f0f7f8;padding:8px;text-align:left;font-size:11px;letter-spacing:1px;text-transform:uppercase;color:#888}
        td{padding:6px 8px;border-bottom:1px solid #eee}
        .grafico-section{background:#f9f9f9;border:1px solid #e0e0e0;border-radius:8px;padding:16px;margin-bottom:20px}
        .grafico-section h3{font-size:12px;letter-spacing:2px;text-transform:uppercase;color:#888;margin:0 0 12px}
        @media print{body{padding:16px}}
    </style></head><body>
    <h1>${evento.titulo}</h1>
    <div class="meta">${dEvt}${evento.local?' ¬∑ '+evento.local:''}${evento.tipo?' ¬∑ '+evento.tipo:''}</div>
    <div class="badges">
        <span class="badge g">‚úì Presentes: ${presentes.length}</span>
        <span class="badge r">‚úó Faltaram: ${faltaram.length}</span>
        <span class="badge o">! Com motivo: ${comMotivo.length}</span>
        <span class="badge gr">Total: ${total}</span>
        <span class="badge gr">Taxa presen√ßa: ${total>0?Math.round(presentes.length/total*100):0}%</span>
    </div>

    <h2>Gr√°fico de Presen√ßas</h2>
    <div class="grafico-section">
        <h3>Distribui√ß√£o Geral</h3>
        ${buildSvgPizza()}
    </div>

    ${areasSort.length>0?`
    <div class="grafico-section">
        <h3>Presen√ßas por √Årea / Minist√©rio</h3>
        ${buildSvgBarras(areasSort)}
    </div>`:''}

    <h2>Presentes (${presentes.length})</h2>
    <table><thead><tr><th>Nome</th><th>√Åreas / Minist√©rios</th><th>‚Äî</th></tr></thead>
    <tbody>${presentes.map(rowM).join('')}</tbody></table>

    ${comMotivo.length?`<h2>Faltaram c/ Motivo (${comMotivo.length})</h2>
    <table><thead><tr><th>Nome</th><th>√Åreas</th><th>Motivo</th></tr></thead>
    <tbody>${comMotivo.map(rowM).join('')}</tbody></table>`:''}

    ${faltaram.length?`<h2>Faltaram (${faltaram.length})</h2>
    <table><thead><tr><th>Nome</th><th>√Åreas</th><th>‚Äî</th></tr></thead>
    <tbody>${faltaram.map(rowM).join('')}</tbody></table>`:''}

    <h2>Resumo por √Årea / Minist√©rio</h2>
    <table><thead><tr><th>Tipo</th><th>Nome</th><th style="text-align:center">Presentes</th><th style="text-align:center">Faltaram</th><th style="text-align:center">%</th></tr></thead>
    <tbody>${areasSort.map(rowA).join('')}</tbody></table>

    <div style="margin-top:40px;font-size:11px;color:#aaa;text-align:center">
        Gerado em ${new Date().toLocaleDateString('pt-PT',{day:'2-digit',month:'long',year:'numeric',hour:'2-digit',minute:'2-digit'})} ¬∑ Zion Lisboa
    </div>
    <script>window.onload=()=>window.print();<\/script>
    </body></html>`;

        const win=window.open('','_blank');
        win.document.write(htm);
        win.document.close();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // DASHBOARD GERAL
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderDashboardGeral() {
        document.getElementById('main-content').innerHTML = `
        <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 24px;text-align:center;gap:16px">
            <div style="font-size:48px">üèóÔ∏è</div>
            <div style="font-family:var(--font-title);font-size:16px;letter-spacing:2px;color:var(--primary-dark)">EM CONSTRU√á√ÉO</div>
            <div style="font-size:13px;color:var(--text-faint);max-width:280px;line-height:1.7">
                O Dashboard geral est√° a ser preparado.<br>Em breve ter√°s aqui uma vis√£o completa da Zion Lisboa.
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:8px">
                <span class="badge badge-gray">Membros</span>
                <span class="badge badge-gray">Visitantes</span>
                <span class="badge badge-gray">Eventos</span>
                <span class="badge badge-gray">D√≠zimos</span>
                <span class="badge badge-gray">Minist√©rios</span>
            </div>
        </div>`;
    }

    init();
</script>
</body>
</html>
