<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Painel Admin — Zion Lisboa</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/tokens.css">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/components.css">
    <script src="config.js"></script>
    <script src="auth.js"></script>
    <style>
        .welcome-card {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 16px;
            background: var(--primary-faint);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }
        .welcome-card img {
            height: 28px;
            width: auto;
            object-fit: contain;
        }
        .welcome-card p {
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.4;
        }
        .welcome-card strong {
            color: var(--primary-dark);
            font-family: var(--font-title);
            font-size: 10px;
            letter-spacing: 1px;
        }
        /* Banner fixo em 70px em qualquer ecrã */
        .banner { min-height: 70px !important; max-height: 70px !important; }
        .banner img { height: 70px !important; }
        .banner-fallback { height: 70px !important; }

        /* Tabela de configurações */
        .config-table { width:100%; border-collapse:collapse; font-size:13px; }
        .config-table th {
            background:var(--bg-input); padding:8px 12px; text-align:left;
            font-family:var(--font-title); font-size:9px; letter-spacing:2px;
            text-transform:uppercase; color:var(--text-faint); border-bottom:1px solid var(--border);
        }
        .config-table td { padding:10px 12px; border-bottom:1px solid var(--border); vertical-align:top; }
        .config-table tr:last-child td { border-bottom:none; }
        .config-table tr:hover td { background:var(--primary-faint); }
        .config-chave { font-family:var(--font-title); font-size:10px; letter-spacing:1px; color:var(--primary-dark); white-space:nowrap; }
        .config-desc  { font-size:11px; color:var(--text-faint); }
        .config-date  { font-size:10px; color:var(--text-faint); white-space:nowrap; }
        .config-actions { display:flex; gap:6px; white-space:nowrap; }
    </style>
</head>
<body>
<div class="page-wrapper">

    <div class="banner">
        <img src="assets/banner_zion.jpg" alt="Zion Lisboa"
             onerror="this.onerror=null;this.style.display='none';document.querySelector('.banner-fallback').classList.add('show');">
        <div class="banner-fallback">
            <div class="banner-title">ZION</div>
            <div class="banner-sub">Lisboa · Portugal</div>
        </div>
    </div>

    <div class="gold-line"></div>

    <div class="welcome-card">
        <img src="assets/logo_zion.jpg" alt="Logo Zion"
             onerror="this.onerror=null;this.style.display='none';">
        <p><strong>Bem-vindo à Zion Lisboa</strong><br>Painel de Administração</p>
    </div>

    <div class="user-bar">
        <a href="index.html" class="user-bar-back">&#8592; Início</a>
        <div class="user-bar-center">
            <div class="user-bar-section" id="secao-label">Cadastros</div>
            <div class="user-bar-date" id="data-hoje"></div>
        </div>
        <div class="user-bar-right">
            <div class="user-bar-nome" id="top-user"></div>
            <button class="logout-btn" onclick="ZionAuth.logout()">Sair</button>
        </div>
    </div>

    <div class="nav-bar" id="nav-bar">
        <div class="nav-item active"  onclick="setSecao('membros')">Membros</div>
        <div class="nav-item"         onclick="setSecao('pastores')">Pastores</div>
        <div class="nav-item"         onclick="setSecao('links')">Links</div>
        <div class="nav-item"         onclick="setSecao('cultos')">Cultos</div>
        <div class="nav-item"         onclick="setSecao('ministerios')">Ministérios</div>
        <div class="nav-item"         onclick="setSecao('salas')">Salas</div>
        <div class="nav-item"         onclick="setSecao('cursos')">Cursos ZAO</div>
        <div class="nav-item"         onclick="setSecao('keola')">Keola</div>
        <div class="nav-item"         onclick="setSecao('loja')">Loja</div>
        <div class="nav-item"         onclick="setSecao('eventos')">Eventos</div>
        <div class="nav-item"         onclick="setSecao('configuracoes')">⚙ Config</div>
    </div>

    <div class="content" id="main-content">
        <div class="loading"><div class="spin"></div>A verificar acesso...</div>
    </div>

    <div class="footer">
        <div class="footer-links">
            <a class="footer-link" href="https://zionchurch.org.br/" target="_blank">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="12" height="12"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                Site Oficial
            </a>
            <a class="footer-link" href="https://www.instagram.com/zionlisboa/" target="_blank">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="12" height="12"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"/></svg>
                @ZionLisboa
            </a>
        </div>
        <div class="footer-div"></div>
        <div class="footer-copy">© 2026 Zion Lisboa — Todos os direitos reservados</div>
        <div class="footer-addr">Rua do Centro Cultural, 11 · 1700-036 Alvalade · Lisboa, Portugal</div>
    </div>
</div>

<div class="overlay hidden" id="overlay" onclick="closeDrawerOutside(event)">
    <div class="drawer" id="drawer">
        <div class="drawer-head">
            <div class="drawer-title" id="drawer-title">Novo Registo</div>
            <button class="drawer-x" onclick="closeDrawer()">✕</button>
        </div>
        <div class="drawer-body" id="drawer-body"></div>
    </div>
</div>

<script>
    ZionAuth.protect();
    const currentUser = ZionAuth.getUser();
    const SUPA_URL    = window.SUPABASE_URL      || '';
    const SUPA_KEY    = window.SUPABASE_ANON_KEY || '';

    let secaoAtiva       = 'membros';
    let subTabAtiva      = 0;
    let registos         = [];
    let filtroInativo    = false;
    let membros          = [];
    let links_cache      = [];
    let ministeriosCache = [];

    // ── SUPABASE ─────────────────────────────────────────────────────────────
    async function sb(path, opts = {}) {
        const r = await fetch(`${SUPA_URL}/rest/v1/${path}`, {
            ...opts,
            headers: {
                'apikey': SUPA_KEY, 'Authorization': `Bearer ${SUPA_KEY}`,
                'Content-Type': 'application/json', 'Prefer': 'return=representation',
                ...opts.headers,
            },
        });
        if (!r.ok) { const e = await r.json().catch(() => {}); throw e; }
        const txt = await r.text();
        return txt ? JSON.parse(txt) : [];
    }

    // ── INIT ─────────────────────────────────────────────────────────────────
    async function init() {
        document.getElementById('top-user').textContent =
            currentUser.nome?.split(' ')[0] || '';
        const hoje = new Date().toLocaleDateString('pt-PT',
            { weekday:'long', day:'numeric', month:'long' });
        document.getElementById('data-hoje').textContent =
            hoje.charAt(0).toUpperCase() + hoje.slice(1);

        const check = await sb(
            `membros?select=e_admin,e_presbitero&email=eq.${encodeURIComponent(currentUser.email)}&ativo=eq.true`
        );
        const m = check?.[0];
        if (!m || (!m.e_admin && !m.e_presbitero)) {
            document.getElementById('nav-bar').style.display = 'none';
            document.getElementById('main-content').innerHTML = `
            <div class="acesso-negado">
                <div class="acesso-negado-icon">✕</div>
                <div class="acesso-negado-title">Acesso Restrito</div>
                <div class="acesso-negado-txt">Esta área é exclusiva para Administradores e Presbíteros.</div>
            </div>`;
            return;
        }
        membros = await sb('membros?select=id,nome&ativo=eq.true&order=nome') || [];
        await setSecao('membros');
    }

    // ── SECÇÕES ───────────────────────────────────────────────────────────────
    async function setSecao(secao) {
        secaoAtiva = secao; filtroInativo = false; subTabAtiva = 0;
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        const nomes = {
            membros:'Membros', pastores:'Pastores', links:'Links', cultos:'Cultos',
            ministerios:'Ministérios', salas:'Salas', cursos:'Cursos ZAO',
            keola:'Keola — Menu', loja:'Loja', eventos:'Eventos', configuracoes:'Configurações',
        };
        const sl = document.getElementById('secao-label');
        if (sl) sl.textContent = nomes[secao] || 'Cadastros';
        const idx = ['membros','pastores','links','cultos','ministerios','salas',
            'cursos','keola','loja','eventos','configuracoes'];
        const ni = document.querySelectorAll('.nav-item')[idx.indexOf(secao)];
        if (ni) ni.classList.add('active');
        await carregarSecao();
    }

    async function carregarSecao() {
        document.getElementById('main-content').innerHTML =
            '<div class="loading"><div class="spin"></div>A carregar...</div>';
        if (secaoAtiva === 'eventos') {
            eventosData = await sb('eventos?select=*&order=data_inicio') || [];
            eventoAtivo = null; eventoSubTab = 0;
            renderEventos(); return;
        }
        if (secaoAtiva === 'configuracoes') {
            await carregarConfiguracoes(); return;
        }
        const cfg = SECOES[secaoAtiva];
        registos = await sb(`${cfg.tabela}?select=*&order=${cfg.orderBy||'nome'}`) || [];
        if (secaoAtiva === 'membros') {
            if (!links_cache.length)
                links_cache = await sb('links?select=id,nome&ativo=eq.true&order=nome') || [];
            await carregarVisitantes();
        }
        renderSecao();
    }

    // ── CONFIG DAS SECÇÕES ────────────────────────────────────────────────────
    const SECOES = {
        membros:     { tabela:'membros',       orderBy:'nome',          campos:camposMembros,    subTabs:['Membro','Filhos','Visitantes'] },
        pastores:    { tabela:'pastores',      orderBy:'nome',          campos:camposPastores },
        links:       { tabela:'links',         orderBy:'nome',          campos:camposLinks },
        cultos:      { tabela:'cultos',        orderBy:'nome',          campos:camposCultos },
        ministerios: { tabela:'ministerios',   orderBy:'nome',          campos:camposMinisterios, subTabs:['Ministério','Líderes'] },
        salas:       { tabela:'salas',         orderBy:'nome',          campos:camposSalas },
        cursos:      { tabela:'zao_cursos',    orderBy:'nome',          campos:camposCursos,      subTabs:['Curso','Instrutores'] },
        keola:       { tabela:'keola_menu',    orderBy:'categoria,nome',campos:camposKeola,       ativoKey:'disponivel' },
        loja:        { tabela:'loja_produtos', orderBy:'categoria,nome',campos:camposLoja },
        eventos:     { tabela:'eventos',       orderBy:'data_inicio',   campos:camposEventos,     customRender:true },
    };

    // ── RENDER SECÇÃO ─────────────────────────────────────────────────────────
    function getQ() {
        const el = document.getElementById('toolbar-search-input');
        return el ? el.value.toLowerCase() : '';
    }

    function restoreSearch(q) {
        const el = document.getElementById('toolbar-search-input');
        if (el && q) { el.value = q; el.focus(); el.setSelectionRange(q.length, q.length); }
    }

    function handleSearch() {
        if (secaoAtiva === 'eventos')       { renderEventos();        return; }
        if (secaoAtiva === 'configuracoes') { renderConfiguracoes();   return; }
        renderSecao();
    }

    function renderSecao() {
        const cfg      = SECOES[secaoAtiva];
        if (!cfg) return;
        const ativoKey = cfg.ativoKey || 'ativo';
        const q        = getQ();

        const temSubTabs = !!cfg.subTabs;
        if (temSubTabs && subTabAtiva >= 1) {
            if (secaoAtiva === 'membros' && subTabAtiva === 1) { renderInfoSubTab(); return; }
            if (secaoAtiva === 'membros' && subTabAtiva === 2) { renderVisitantesTab(); return; }
            if (secaoAtiva !== 'membros'  && subTabAtiva === 1) { renderInfoSubTab(); return; }
        }

        let lista = [...registos];
        if (!filtroInativo) lista = lista.filter(r => r[ativoKey] !== false);
        else                lista = lista.filter(r => r[ativoKey] === false);
        if (q) lista = lista.filter(r =>
            (r.nome||r.categoria||r.titulo||'').toLowerCase().includes(q)
        );

        let html = `
    <div class="section-toolbar" style="position:sticky;top:0;z-index:10">
        <input class="toolbar-search" id="toolbar-search-input"
               placeholder="Pesquisar..." oninput="handleSearch()" value="">
        <button class="toolbar-filter ${filtroInativo?'active':''}" onclick="toggleFiltroInativo()">Inativos</button>
        <button class="btn-new" onclick="abrirForm(null)">+ Novo</button>
    </div>`;

        if (temSubTabs) {
            html += `<div class="sub-tabs">
            ${cfg.subTabs.map((t,i)=>`<button class="sub-tab ${subTabAtiva===i?'active':''}" onclick="setSubTab(${i})">${t}</button>`).join('')}
        </div>`;
        }

        if (!lista.length) {
            html += `<div class="empty"><div class="empty-icon">—</div>
            <div class="empty-txt">${filtroInativo?'Nenhum registo inativo.':'Nenhum registo. Clica em + Novo.'}</div></div>`;
            document.getElementById('main-content').innerHTML = html;
            restoreSearch(q); return;
        }

        html += '<div class="admin-list">';
        lista.forEach((r, i) => {
            const ativo   = r[ativoKey] !== false;
            const imgUrl  = r.foto_url || r.imagem_url;
            let fotoHtml;
            if (imgUrl) {
                const ini = (r.nome||r.categoria||'-')[0];
                fotoHtml = `<div class="admin-row-foto" style="overflow:hidden;padding:0">
                <img src="${imgUrl}" alt="${r.nome||''}"
                     style="width:100%;height:100%;object-fit:cover"
                     onerror="this.parentElement.style.padding='';this.parentElement.innerHTML='${ini}'">
            </div>`;
            } else {
                fotoHtml = `<div class="admin-row-foto">${(r.nome||r.categoria||'-')[0]}</div>`;
            }
            const sub    = buildSub(r);
            const badges = buildBadges(r);
            html += `
        <div class="admin-row ${ativo?'':'inativo'}" style="animation-delay:${Math.min(i,12)*0.02}s">
            ${fotoHtml}
            <div class="admin-row-info">
                <div class="admin-row-nome">${r.nome||r.categoria||'—'}</div>
                ${sub    ? `<div class="admin-row-sub">${sub}</div>`       : ''}
                ${badges ? `<div class="admin-row-badges">${badges}</div>` : ''}
            </div>
            <div class="admin-row-actions">
                <button class="btn-edit" onclick="abrirForm('${r.id}')">Editar</button>
                <button class="btn-toggle ${ativo?'ativo':'inativo'}"
                        onclick="toggleAtivo('${r.id}','${ativoKey}',${ativo})">
                    ${ativo?'Inativar':'Ativar'}
                </button>
            </div>
        </div>`;
        });
        html += '</div>';
        document.getElementById('main-content').innerHTML = html;
        restoreSearch(q);
    }

    function renderInfoSubTab() {
        const cfg    = SECOES[secaoAtiva];
        const labels = {ministerios:'líderes', cursos:'instrutores', membros:'filhos'};
        const parent = {ministerios:'ministério', cursos:'curso', membros:'membro'};
        let html = `<div class="sub-tabs">
        ${cfg.subTabs.map((t,i)=>`<button class="sub-tab ${subTabAtiva===i?'active':''}" onclick="setSubTab(${i})">${t}</button>`).join('')}
    </div>
    <div class="admin-list">
        <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:20px;text-align:center;color:var(--text-faint);font-size:13px;line-height:1.8">
            Para gerir ${labels[secaoAtiva]||'itens'}, abre o registo do ${parent[secaoAtiva]||'item'} e edita a partir daí.
        </div>
    </div>`;
        document.getElementById('main-content').innerHTML = html;
    }

    function renderVisitantesTab() {
        const cfg = SECOES['membros'];
        const q   = getQ();
        let lista = [...visitantes];
        if (!filtroInativo) lista = lista.filter(r => r.ativo !== false && !r.convertido);
        else                lista = lista.filter(r => r.convertido || r.ativo === false);
        if (q) lista = lista.filter(r => (r.nome||'').toLowerCase().includes(q));

        let html = `
    <div class="sub-tabs">
        ${cfg.subTabs.map((t,i)=>`<button class="sub-tab ${subTabAtiva===i?'active':''}" onclick="setSubTab(${i})">${t}</button>`).join('')}
    </div>
    <div class="section-toolbar" style="position:sticky;top:0;z-index:10">
        <input class="toolbar-search" id="toolbar-search-input"
               placeholder="Pesquisar visitante..." oninput="handleSearch()" value="">
        <button class="toolbar-filter ${filtroInativo?'active':''}" onclick="toggleFiltroInativo()">
            ${filtroInativo?'Ativos':'Convertidos'}
        </button>
        <button class="btn-new" onclick="abrirFormVisitante(null)">+ Novo</button>
    </div>`;

        if (!lista.length) {
            html += '<div class="empty"><div class="empty-icon">—</div><div class="empty-txt">Nenhum visitante encontrado.</div></div>';
            document.getElementById('main-content').innerHTML = html;
            restoreSearch(q); return;
        }

        html += '<div class="admin-list">';
        lista.forEach((v, i) => {
            const ativo = v.ativo !== false;
            const conv  = v.convertido ? '<span class="badge badge-green">Convertido</span>' : '';
            html += `
        <div class="admin-row ${ativo?'':'inativo'}" style="animation-delay:${Math.min(i,12)*0.02}s">
            <div class="admin-row-foto">${(v.nome||'V')[0]}</div>
            <div class="admin-row-info">
                <div class="admin-row-nome">${v.nome||'—'}</div>
                <div class="admin-row-sub">${[v.zona,v.data_visita?new Date(v.data_visita).toLocaleDateString('pt-PT'):null].filter(Boolean).join(' · ')}</div>
                <div class="admin-row-badges">${conv}</div>
            </div>
            <div class="admin-row-actions">
                <button class="btn-edit" onclick="abrirFormVisitante('${v.id}')">Editar</button>
                ${!v.convertido?`<button class="btn-toggle ativo" onclick="converterEmMembro('${v.id}')">Converter</button>`:''}
                <button class="btn-toggle ${ativo?'ativo':'inativo'}" onclick="toggleAtivoVisitante('${v.id}',${ativo})">${ativo?'Inativar':'Ativar'}</button>
            </div>
        </div>`;
        });
        html += '</div>';
        document.getElementById('main-content').innerHTML = html;
        restoreSearch(q);
    }

    function buildSub(r) {
        const s = secaoAtiva;
        if (s==='membros')     return [r.tipo,r.zona,r.genero].filter(Boolean).join(' · ');
        if (s==='pastores')    return [r.cargo,r.email].filter(Boolean).join(' — ');
        if (s==='links')       return [r.tipo,r.zona,r.dia].filter(Boolean).join(' · ');
        if (s==='cultos')      return [r.dia_semana,r.hora_inicio].filter(Boolean).join(' — ');
        if (s==='ministerios') return [r.tipo?'['+r.tipo+']':null,r.descricao?.substring(0,50)].filter(Boolean).join(' — ');
        if (s==='salas')       return [r.espaco,r.capacidade?r.capacidade+' pessoas':null].filter(Boolean).join(' · ');
        if (s==='cursos')      return [r.carga_horaria,r.gratuito?'Gratuito':r.valor?'€'+r.valor:null].filter(Boolean).join(' · ');
        if (s==='keola')       return [r.categoria,r.preco?'€'+Number(r.preco).toFixed(2):null].filter(Boolean).join(' · ');
        if (s==='loja')        return [r.categoria,r.preco?'€'+Number(r.preco).toFixed(2):null].filter(Boolean).join(' · ');
        return '';
    }

    function buildBadges(r) {
        const b = [];
        if (r.e_lider)       b.push(`<span class="badge badge-primary">Líder</span>`);
        if (r.e_presbitero)  b.push(`<span class="badge badge-primary">Presbítero</span>`);
        if (r.e_voluntario)  b.push(`<span class="badge badge-green">Voluntário</span>`);
        if (r.e_admin)       b.push(`<span class="badge badge-red">Admin</span>`);
        if (r.online)        b.push(`<span class="badge badge-primary">Online</span>`);
        if (r.recorrente)    b.push(`<span class="badge badge-green">Recorrente</span>`);
        if (r.gratuito)      b.push(`<span class="badge badge-green">Gratuito</span>`);
        if (r.especial_hoje) b.push(`<span class="badge badge-primary">Especial hoje</span>`);
        if (r.destaque)      b.push(`<span class="badge badge-primary">Destaque</span>`);
        if (r.disponivel===false||r.ativo===false) b.push(`<span class="badge badge-gray">Inativo</span>`);
        return b.join('');
    }

    function toggleFiltroInativo() { filtroInativo = !filtroInativo; renderSecao(); }
    function setSubTab(idx) { subTabAtiva = idx; renderSecao(); }

    // ── VISITANTES ────────────────────────────────────────────────────────────
    let visitantes = [];
    async function carregarVisitantes() {
        visitantes = await sb('visitantes?select=*&order=nome') || [];
    }

    function abrirFormVisitante(id) {
        const v = id ? visitantes.find(x=>x.id===id) : null;
        document.getElementById('drawer-title').textContent = v ? 'Editar Visitante' : 'Novo Visitante';
        document.getElementById('drawer-body').innerHTML = buildFormVisitante(v);
        document.getElementById('overlay').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function buildFormVisitante(v) {
        const fv = (k, d='') => v?.[k] ?? d;
        return `<div class="form-grid">
        <div class="msg-form" id="form-msg"></div>
        <div class="form-group form-full"><label class="form-label">Nome</label><input class="form-input" id="fv_nome" type="text" value="${fv('nome')}"></div>
        <div class="form-group"><label class="form-label">Email</label><input class="form-input" id="fv_email" type="email" value="${fv('email')}"></div>
        <div class="form-group"><label class="form-label">Telefone</label><input class="form-input" id="fv_telefone" type="tel" value="${fv('telefone')}"></div>
        <div class="form-group"><label class="form-label">Zona</label><input class="form-input" id="fv_zona" value="${fv('zona')}"></div>
        <div class="form-group"><label class="form-label">Data da Visita</label><input class="form-input" id="fv_data_visita" type="date" value="${fv('data_visita')}"></div>
        <div class="form-group form-full"><label class="form-label">Onde Conheceu</label><input class="form-input" id="fv_onde_conheceu" value="${fv('onde_conheceu')}"></div>
        <div class="form-group form-full"><label class="form-label">Observações</label><textarea class="form-textarea" id="fv_observacoes">${fv('observacoes')}</textarea></div>
        <div class="form-group"><label class="form-toggle"><input type="checkbox" id="fv_convertido" ${fv('convertido')?'checked':''}><span>Convertido</span></label></div>
        <div class="form-group"><label class="form-toggle"><input type="checkbox" id="fv_ativo" ${fv('ativo')!==false?'checked':''}><span>Ativo</span></label></div>
        <div class="form-actions">
            <button class="btn-cancel-form" onclick="closeDrawer()">Cancelar</button>
            <button class="btn-save" id="btn-save" onclick="salvarVisitante('${v?.id||''}')">Guardar</button>
        </div>
    </div>`;
    }

    async function salvarVisitante(id) {
        const get = k => { const el=document.getElementById('fv_'+k); return el?el.value||null:null; };
        const chk = k => { const el=document.getElementById('fv_'+k); return el?el.checked:false; };
        const body = { nome:get('nome'), email:get('email'), telefone:get('telefone'), zona:get('zona'),
            data_visita:get('data_visita'), onde_conheceu:get('onde_conheceu'),
            observacoes:get('observacoes'), convertido:chk('convertido'), ativo:chk('ativo') };
        if (!body.nome) { showFormMsg('Nome obrigatório.','error'); return; }
        const btn = document.getElementById('btn-save');
        btn.disabled=true; btn.textContent='A guardar...';
        try {
            if (!id) await sb('visitantes',{method:'POST',body:JSON.stringify(body)});
            else     await sb(`visitantes?id=eq.${id}`,{method:'PATCH',body:JSON.stringify(body)});
            showFormMsg('Guardado!','success');
            await carregarVisitantes();
            setTimeout(closeDrawer, 700);
        } catch(e) {
            showFormMsg(`Erro: ${e?.message||JSON.stringify(e)}`,'error');
            btn.disabled=false; btn.textContent='Guardar';
        }
    }

    async function toggleAtivoVisitante(id, ativoAtual) {
        await sb(`visitantes?id=eq.${id}`,{method:'PATCH',body:JSON.stringify({ativo:!ativoAtual})});
        await carregarVisitantes(); renderSecao();
    }

    async function converterEmMembro(visitanteId) {
        if (!confirm('Converter este visitante em membro?')) return;
        const v = visitantes.find(x=>x.id===visitanteId);
        if (!v) return;
        try {
            const nm = await sb('membros',{method:'POST',body:JSON.stringify({
                    nome:v.nome, email:v.email, telefone:v.telefone, zona:v.zona,
                    onde_conheceu:v.onde_conheceu, tipo:'membro', ativo:true,
                    convertido_de_visitante_id:visitanteId,
                    data_entrada:new Date().toISOString().split('T')[0],
                })});
            await sb(`visitantes?id=eq.${visitanteId}`,{method:'PATCH',body:JSON.stringify({convertido:true,membro_id:nm?.[0]?.id})});
            alert('Visitante convertido com sucesso!');
            await carregarVisitantes(); renderSecao();
        } catch(e) { alert('Erro ao converter: '+JSON.stringify(e)); }
    }

    // ── TOGGLE ATIVO ──────────────────────────────────────────────────────────
    async function toggleAtivo(id, key, ativoAtual) {
        try {
            await sb(`${SECOES[secaoAtiva].tabela}?id=eq.${id}`,
                {method:'PATCH', body:JSON.stringify({[key]:!ativoAtual})});
            await carregarSecao();
        } catch(e) { alert('Erro ao alterar estado.'); }
    }

    // ── FORM ──────────────────────────────────────────────────────────────────
    async function abrirForm(id) {
        const cfg     = SECOES[secaoAtiva];
        const registo = id ? registos.find(r=>r.id===id) : null;
        const isNovo  = !registo;

        if (secaoAtiva==='ministerios'||secaoAtiva==='cursos') {
            try {
                const res = await sb('membros?select=id,nome&ativo=eq.true&order=nome');
                if (Array.isArray(res)&&res.length) membros = res;
            } catch(e){}
        }
        if (secaoAtiva==='membros') {
            try {
                const rm = await sb('membros?select=id,nome&ativo=eq.true&order=nome');
                if (Array.isArray(rm)&&rm.length) membros = rm;
                ministeriosCache = await sb('ministerios?select=id,nome,tipo&ativo=eq.true&order=tipo,nome')||[];
            } catch(e){}
        }

        document.getElementById('drawer-title').textContent =
            isNovo ? `Novo — ${cfg.label||secaoAtiva}` : 'Editar';
        document.getElementById('drawer-body').innerHTML = buildForm(cfg, registo);
        document.getElementById('overlay').classList.remove('hidden');
        document.body.style.overflow = 'hidden';

        if (!isNovo&&secaoAtiva==='membros') {
            await carregarFilhos(registo.id);
            await carregarMembroMinisterios(registo.id);
        } else if (!isNovo&&(secaoAtiva==='ministerios'||secaoAtiva==='cursos')) {
            await carregarSubList(registo.id);
        }
    }

    function buildForm(cfg, r) {
        const campos = typeof cfg.campos==='function' ? cfg.campos(r) : cfg.campos;
        let html = `<div class="form-grid"><div class="msg-form" id="form-msg"></div>`;
        campos.forEach(c => {
            if (c.key==='link_id'&&secaoAtiva==='membros') {
                const val2 = r?.[c.key]??'';
                const opts2 = links_cache.map(l=>`<option value="${l.id}" ${val2===l.id?'selected':''}>${l.nome}</option>`).join('');
                html += `<div class="form-group form-full"><label class="form-label">${c.label}</label>
                <select class="form-select" id="f_link_id"><option value="">-- Sem Link --</option>${opts2}</select></div>`;
                return;
            }
            if (c.type==='section') { html += `<div class="form-section-title">${c.label}</div>`; return; }
            const val = r?.[c.key]??c.default??'';
            const fc  = c.full?'form-full':'';
            if (c.type==='checkbox') {
                html += `<div class="form-group ${fc}"><label class="form-toggle">
                <input type="checkbox" id="f_${c.key}" ${val?'checked':''}><span>${c.label}</span></label></div>`;
            } else if (c.type==='select') {
                const opts = c.options.map(o=>`<option value="${o.v}" ${val==o.v?'selected':''}>${o.l}</option>`).join('');
                html += `<div class="form-group ${fc}"><label class="form-label">${c.label}</label>
                <select class="form-select" id="f_${c.key}"><option value="">-- Seleciona --</option>${opts}</select></div>`;
            } else if (c.type==='textarea') {
                html += `<div class="form-group ${fc}"><label class="form-label">${c.label}</label>
                <textarea class="form-textarea" id="f_${c.key}" placeholder="${c.ph||''}">${val}</textarea></div>`;
            } else if (c.type==='image') {
                html += buildImageUpload(c.key, c.label, val, c.bucket||'imagens');
            } else {
                html += `<div class="form-group ${fc}"><label class="form-label">${c.label}</label>
                <input class="form-input" id="f_${c.key}" type="${c.type||'text'}" placeholder="${c.ph||''}" value="${val}"></div>`;
            }
        });

        if (r&&secaoAtiva==='membros') {
            html += `
        <div class="form-section-title">Filhos</div>
        <div class="form-full"><div class="sub-list" id="sub-list"><div class="sub-list-empty">A carregar...</div></div></div>
        <div class="sub-add-row">
            <select class="form-select" id="sub-filho-id"><option value="">Seleciona filho</option>${membros.map(m=>`<option value="${m.id}">${m.nome}</option>`).join('')}</select>
            <button class="btn-sub-add" onclick="addFilho('${r.id}')">Adicionar</button>
        </div>
        <div class="form-section-title">Ministérios e Áreas</div>
        <div class="form-full"><div class="sub-list" id="sub-list-mins"><div class="sub-list-empty">A carregar...</div></div></div>
        <div class="sub-add-row">
            <select class="form-select" id="sub-min-id"><option value="">Seleciona ministério/área</option>${ministeriosCache.map(m=>`<option value="${m.id}">[${m.tipo||'?'}] ${m.nome}</option>`).join('')}</select>
            <input class="form-input" id="sub-min-papel" placeholder="Papel" style="max-width:120px">
            <button class="btn-sub-add" onclick="addMembroMinisterio('${r.id}')">Adicionar</button>
        </div>`;
        }

        if (r&&(secaoAtiva==='ministerios'||secaoAtiva==='cursos')) {
            const sublabel = secaoAtiva==='ministerios'?'Líderes':'Instrutores';
            html += `
        <div class="form-section-title">${sublabel}</div>
        <div class="form-full"><div class="sub-list" id="sub-list"><div class="sub-list-empty">A carregar...</div></div></div>
        <div class="sub-add-row">
            <select class="form-select" id="sub-membro-id"><option value="">Seleciona membro</option>${membros.map(m=>`<option value="${m.id}">${m.nome}</option>`).join('')}</select>
            <input class="form-input" id="sub-cargo" placeholder="Cargo" style="max-width:110px">
            ${secaoAtiva==='cursos'?`<input class="form-input" id="sub-nome-instrutor" placeholder="Nome externo" style="max-width:110px">`:''}
            <button class="btn-sub-add" onclick="addSubItem('${r.id}')">Adicionar</button>
        </div>`;
        }

        html += `<div class="form-actions">
        <button class="btn-cancel-form" onclick="closeDrawer()">Cancelar</button>
        <button class="btn-save" id="btn-save" onclick="salvar('${r?.id||''}')">Guardar</button>
    </div></div>`;
        return html;
    }

    async function salvar(id) {
        const cfg    = SECOES[secaoAtiva];
        const isNovo = !id;
        const campos = typeof cfg.campos==='function' ? cfg.campos(null) : cfg.campos;
        const body   = {};
        campos.forEach(c => {
            if (c.type==='section') return;
            const el = document.getElementById(`f_${c.key}`);
            if (!el) return;
            if (c.type==='checkbox')  body[c.key] = el.checked;
            else if (c.type==='number') body[c.key] = el.value?Number(el.value):null;
            else body[c.key] = el.value||null;
        });
        if (cfg.ativoKey&&!(cfg.ativoKey in body)&&isNovo) body[cfg.ativoKey] = true;
        if (!('ativo' in body)&&isNovo&&cfg.tabela!=='keola_menu') body.ativo = true;

        const btn = document.getElementById('btn-save');
        btn.disabled=true; btn.textContent='A guardar...';
        try {
            if (isNovo) await sb(cfg.tabela,{method:'POST',body:JSON.stringify(body)});
            else        await sb(`${cfg.tabela}?id=eq.${id}`,{method:'PATCH',body:JSON.stringify(body)});
            showFormMsg('Guardado com sucesso!','success');
            await carregarSecao();
            setTimeout(closeDrawer, 800);
        } catch(e) {
            showFormMsg(`Erro: ${e?.message||e?.details||JSON.stringify(e)}`,'error');
            btn.disabled=false; btn.textContent='Guardar';
        }
    }

    function showFormMsg(txt, tipo) {
        const el = document.getElementById('form-msg');
        if (!el) return;
        el.textContent = txt; el.className = `msg-form ${tipo}`;
        el.scrollIntoView({behavior:'smooth', block:'nearest'});
    }

    // ── SUB-ITEMS ─────────────────────────────────────────────────────────────
    let membroMinisteriosData = [];

    async function carregarMembroMinisterios(membroId) {
        const items = await sb(`membro_ministerios?select=*,ministerios(id,nome,tipo)&membro_id=eq.${membroId}&ativo=eq.true&order=id`)||[];
        membroMinisteriosData = items;
        renderSubListMins(membroId);
    }

    function renderSubListMins(membroId) {
        const el = document.getElementById('sub-list-mins');
        if (!el) return;
        if (!membroMinisteriosData.length) {
            el.innerHTML = '<div class="sub-list-empty">Sem ministérios/áreas.</div>'; return;
        }
        el.innerHTML = membroMinisteriosData.map(item => {
            const tipo = item.ministerios?.tipo||'?';
            const nome = item.ministerios?.nome||'—';
            return `<div class="sub-list-item">
            <span class="badge badge-gray" style="flex-shrink:0">${tipo==='ministerio'?'MIN':'AE'}</span>
            <div class="sub-list-nome">${nome}</div>
            <div class="sub-list-cargo">${item.papel||''}</div>
            <button class="sub-list-remove" onclick="removeMembroMinisterio('${item.id}','${membroId}')">Remover</button>
        </div>`;
        }).join('');
    }

    async function addMembroMinisterio(membroId) {
        const minId = document.getElementById('sub-min-id')?.value;
        const papel = document.getElementById('sub-min-papel')?.value?.trim();
        if (!minId) { alert('Seleciona um ministério ou área.'); return; }
        if (membroMinisteriosData.find(m=>m.ministerio_id===minId)) { alert('Já associado.'); return; }
        try {
            await sb('membro_ministerios',{method:'POST',body:JSON.stringify({membro_id:membroId,ministerio_id:minId,papel:papel||null,ativo:true})});
            await carregarMembroMinisterios(membroId);
            document.getElementById('sub-min-id').value='';
            document.getElementById('sub-min-papel').value='';
        } catch(e) { alert('Erro: '+JSON.stringify(e)); }
    }

    async function removeMembroMinisterio(itemId, membroId) {
        if (!confirm('Remover desta área/ministério?')) return;
        await sb(`membro_ministerios?id=eq.${itemId}`,{method:'PATCH',body:JSON.stringify({ativo:false})});
        await carregarMembroMinisterios(membroId);
    }

    async function carregarFilhos(membroId) {
        const items = await sb(`membros_filhos?select=*&pai_id=eq.${membroId}&order=created_at`)||[];
        const el = document.getElementById('sub-list');
        if (!el) return;
        if (!items.length) { el.innerHTML='<div class="sub-list-empty">Sem filhos.</div>'; return; }
        el.innerHTML = items.map(item => {
            const filho = membros.find(m=>m.id===item.filho_id);
            return `<div class="sub-list-item">
            <div class="sub-list-nome">${filho?.nome||item.filho_id}</div>
            <div class="sub-list-cargo">Filho/a</div>
            <button class="sub-list-remove" onclick="removeFilho('${item.id}','${membroId}')">Remover</button>
        </div>`;
        }).join('');
    }

    async function addFilho(paiId) {
        const filhoId = document.getElementById('sub-filho-id')?.value;
        if (!filhoId) { alert('Seleciona um membro.'); return; }
        try {
            await sb('membros_filhos',{method:'POST',body:JSON.stringify({pai_id:paiId,filho_id:filhoId})});
            membros = await sb('membros?select=id,nome&ativo=eq.true&order=nome')||[];
            await carregarFilhos(paiId);
            document.getElementById('sub-filho-id').value='';
        } catch(e) { alert('Erro: '+JSON.stringify(e)); }
    }

    async function removeFilho(itemId, paiId) {
        if (!confirm('Remover este filho?')) return;
        await sb(`membros_filhos?id=eq.${itemId}`,{method:'DELETE'});
        await carregarFilhos(paiId);
    }

    async function carregarSubList(parentId) {
        const isMin  = secaoAtiva==='ministerios';
        const tabela = isMin?'ministerio_lideres':'zao_curso_instrutores';
        const fkKey  = isMin?'ministerio_id':'curso_id';
        const items  = await sb(`${tabela}?select=*&${fkKey}=eq.${parentId}&order=created_at`)||[];
        const el     = document.getElementById('sub-list');
        if (!el) return;
        if (!items.length) { el.innerHTML='<div class="sub-list-empty">Sem registos.</div>'; return; }
        el.innerHTML = items.map(item => {
            const membro = membros.find(m=>m.id===item.membro_id);
            const nome   = membro?.nome||item.nome_instrutor||'—';
            return `<div class="sub-list-item">
            <div class="sub-list-nome">${nome}</div>
            <div class="sub-list-cargo">${item.cargo||''}</div>
            <button class="sub-list-remove" onclick="removeSubItem('${item.id}','${tabela}','${parentId}')">Remover</button>
        </div>`;
        }).join('');
    }

    async function addSubItem(parentId) {
        const isMin  = secaoAtiva==='ministerios';
        const tabela = isMin?'ministerio_lideres':'zao_curso_instrutores';
        const fkKey  = isMin?'ministerio_id':'curso_id';
        const memId  = document.getElementById('sub-membro-id')?.value;
        const cargo  = document.getElementById('sub-cargo')?.value;
        const nomeExt= document.getElementById('sub-nome-instrutor')?.value;
        if (!memId&&!nomeExt) { alert('Seleciona um membro ou indica um nome.'); return; }
        const body = {[fkKey]:parentId, cargo:cargo||null};
        if (memId) body.membro_id = memId;
        if (!isMin&&nomeExt) body.nome_instrutor = nomeExt;
        try {
            await sb(tabela,{method:'POST',body:JSON.stringify(body)});
            await carregarSubList(parentId);
            ['sub-membro-id','sub-cargo','sub-nome-instrutor'].forEach(k=>{ const el=document.getElementById(k); if(el) el.value=''; });
        } catch(e) { alert('Erro ao adicionar.'); }
    }

    async function removeSubItem(itemId, tabela, parentId) {
        if (!confirm('Remover?')) return;
        await sb(`${tabela}?id=eq.${itemId}`,{method:'DELETE'});
        await carregarSubList(parentId);
    }

    // ── IMAGE UPLOAD ──────────────────────────────────────────────────────────
    function buildImageUpload(key, label, currentUrl, bucket) {
        const hasImg = !!currentUrl;
        const imgHtml = hasImg
            ? `<img class="img-upload-preview" src="${currentUrl}" alt="${label}" onerror="this.style.display='none'">`
            : `<div class="img-upload-placeholder">
               <div class="img-upload-placeholder-icon">+</div>
               <div class="img-upload-placeholder-txt">Clica para escolher imagem</div>
           </div>`;
        return `<div class="form-group img-upload-wrap">
        <label class="form-label">${label}</label>
        <div class="img-upload-box ${hasImg?'has-img':''}" id="img-box-${key}" onclick="triggerFileInput('${key}')">
            ${imgHtml}
        </div>
        <div class="img-upload-progress" id="img-prog-${key}">
            <div class="img-upload-progress-bar" id="img-prog-bar-${key}"></div>
        </div>
        <div class="img-upload-status" id="img-status-${key}"></div>
        <div class="img-upload-actions">
            <button type="button" class="img-upload-btn" onclick="triggerFileInput('${key}')">Ficheiro</button>
            <button type="button" class="img-upload-btn" onclick="triggerCamera('${key}')">Câmara</button>
            ${currentUrl?`<button type="button" class="img-upload-btn danger" onclick="removeImage('${key}','f_${key}')">Remover</button>`:''}
        </div>
        <div class="img-upload-url">
            <input type="text" id="img-url-input-${key}" placeholder="Ou cola um URL..." value="${currentUrl||''}">
            <button type="button" class="img-upload-btn" onclick="applyUrlInput('${key}')">Usar URL</button>
        </div>
        <input type="hidden" id="f_${key}" value="${currentUrl||''}">
        <input type="file" id="img-file-${key}" accept="image/*" style="display:none" onchange="handleFileSelect('${key}','${bucket}',this)">
        <input type="file" id="img-cam-${key}"  accept="image/*" capture="environment" style="display:none" onchange="handleFileSelect('${key}','${bucket}',this)">
    </div>`;
    }

    function triggerFileInput(key) { document.getElementById('img-file-'+key)?.click(); }
    function triggerCamera(key)    { document.getElementById('img-cam-'+key)?.click();  }

    function applyUrlInput(key) {
        const url = document.getElementById('img-url-input-'+key)?.value?.trim();
        if (!url) return;
        document.getElementById('f_'+key).value = url;
        updateImagePreview(key, url);
        setImgStatus(key,'URL aplicado.','ok');
    }

    function removeImage(key, hiddenId) {
        document.getElementById(hiddenId).value='';
        document.getElementById('img-url-input-'+key).value='';
        const box = document.getElementById('img-box-'+key);
        box.innerHTML=`<div class="img-upload-placeholder"><div class="img-upload-placeholder-icon">+</div><div class="img-upload-placeholder-txt">Clica para escolher imagem</div></div>`;
        box.classList.remove('has-img');
        setImgStatus(key,'','');
    }

    function updateImagePreview(key, url) {
        const box = document.getElementById('img-box-'+key);
        if (!box) return;
        box.classList.add('has-img');
        box.innerHTML=`<img class="img-upload-preview" src="${url}" alt="preview" onerror="this.parentElement.classList.remove('has-img');this.style.display='none'">`;
    }

    function setImgStatus(key, msg, tipo) {
        const el = document.getElementById('img-status-'+key);
        if (!el) return;
        el.textContent=msg; el.className='img-upload-status'+(tipo?' '+tipo:'');
    }

    function resizeImage(file, maxW=800, maxH=800, quality=0.82) {
        return new Promise(resolve => {
            const img = new Image();
            const url = URL.createObjectURL(file);
            img.onload = () => {
                let {width:w, height:h} = img;
                if (w>maxW||h>maxH) { const r=Math.min(maxW/w,maxH/h); w=Math.round(w*r); h=Math.round(h*r); }
                const canvas=document.createElement('canvas');
                canvas.width=w; canvas.height=h;
                canvas.getContext('2d').drawImage(img,0,0,w,h);
                URL.revokeObjectURL(url);
                canvas.toBlob(blob=>resolve(blob),'image/jpeg',quality);
            };
            img.onerror=()=>{ URL.revokeObjectURL(url); resolve(file); };
            img.src=url;
        });
    }

    async function handleFileSelect(key, bucket, input) {
        const file = input.files?.[0];
        if (!file) return;
        updateImagePreview(key, URL.createObjectURL(file));
        setImgStatus(key,'A comprimir...','');
        const prog=document.getElementById('img-prog-'+key);
        const bar =document.getElementById('img-prog-bar-'+key);
        if (prog) prog.classList.add('active');
        if (bar)  bar.style.width='20%';
        try {
            const blob     = await resizeImage(file);
            const filename = `${Date.now()}-${Math.random().toString(36).slice(2)}.jpg`;
            const path     = `${secaoAtiva}/${filename}`;
            setImgStatus(key,'A fazer upload...','');
            if (bar) bar.style.width='50%';

            const formData = new FormData();
            formData.append('file', new File([blob], filename, {type:'image/jpeg'}));
            formData.append('path', path);
            formData.append('bucket', bucket);

            const res = await fetch('/api/upload', {
                method:'POST',
                headers:{'Authorization':`Bearer ${currentUser?.token||''}`},
                body:formData,
            });
            if (!res.ok) {
                const err = await res.json().catch(()=>({}));
                throw new Error(err?.error||err?.message||`Erro ${res.status}`);
            }
            const data = await res.json();
            if (bar) bar.style.width='100%';
            document.getElementById('f_'+key).value = data.url;
            document.getElementById('img-url-input-'+key).value = data.url;
            updateImagePreview(key, data.url);
            setImgStatus(key,`Upload concluído! (${Math.round(blob.size/1024)} KB)`,'ok');
        } catch(e) {
            setImgStatus(key,'Erro: '+e.message,'err');
            console.error('Upload error:', e);
        } finally {
            setTimeout(()=>{ if(prog) prog.classList.remove('active'); if(bar) bar.style.width='0%'; }, 2000);
            input.value='';
        }
    }

    // ── DRAWER ────────────────────────────────────────────────────────────────
    function closeDrawer() {
        document.getElementById('overlay').classList.add('hidden');
        document.body.style.overflow='';
    }
    function closeDrawerOutside(e) {
        if (e.target===document.getElementById('overlay')) closeDrawer();
    }
    document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeDrawer(); });

    // ══════════════════════════════════════════════════════════════════════════
    // CONFIGURAÇÕES
    // ══════════════════════════════════════════════════════════════════════════
    let configData = [];

    async function carregarConfiguracoes() {
        configData = await sb('configuracoes?select=*&order=chave') || [];
        renderConfiguracoes();
    }

    function renderConfiguracoes() {
        const q = getQ();
        let lista = [...configData];
        if (q) lista = lista.filter(c =>
            c.chave.toLowerCase().includes(q) ||
            (c.valor||'').toLowerCase().includes(q) ||
            (c.descricao||'').toLowerCase().includes(q)
        );

        let html = `
    <div class="section-toolbar" style="position:sticky;top:0;z-index:10">
        <input class="toolbar-search" id="toolbar-search-input"
               placeholder="Pesquisar configuração..." oninput="handleSearch()" value="">
        <button class="btn-new" onclick="abrirFormConfig(null)">+ Nova</button>
    </div>
    <div style="padding:8px 16px 4px">
        <div style="font-size:11px;color:var(--text-faint);line-height:1.6">
            Cada <strong>chave</strong> é usada dinamicamente no código — edita aqui sem tocar nos ficheiros HTML.
        </div>
    </div>`;

        if (!lista.length) {
            html += '<div class="empty"><div class="empty-icon">⚙</div><div class="empty-txt">Nenhuma configuração encontrada.</div></div>';
            document.getElementById('main-content').innerHTML = html;
            restoreSearch(q); return;
        }

        html += `<div style="padding:0 16px 16px;overflow-x:auto">
    <table class="config-table"><thead><tr>
        <th>Chave</th><th>Valor</th><th>Descrição</th><th>Atualizado</th><th></th>
    </tr></thead><tbody>`;

        lista.forEach(c => {
            const dt    = c.updated_at ? new Date(c.updated_at).toLocaleDateString('pt-PT',{day:'2-digit',month:'short',year:'numeric'}) : '—';
            const isUrl = (c.valor||'').startsWith('http');
            const valHtml = isUrl
                ? `<a href="${c.valor}" target="_blank" style="color:var(--primary);font-size:12px;word-break:break-all">${c.valor}</a>`
                : `<span style="word-break:break-all">${c.valor||'—'}</span>`;
            html += `<tr>
            <td><span class="config-chave">${c.chave}</span></td>
            <td>${valHtml}</td>
            <td><span class="config-desc">${c.descricao||'—'}</span></td>
            <td><span class="config-date">${dt}</span></td>
            <td><div class="config-actions">
                <button class="btn-edit" onclick="abrirFormConfig('${c.chave}')">Editar</button>
                <button class="btn-toggle ativo" onclick="eliminarConfig('${c.chave}')">Apagar</button>
            </div></td>
        </tr>`;
        });

        html += `</tbody></table></div>`;
        document.getElementById('main-content').innerHTML = html;
        restoreSearch(q);
    }

    function abrirFormConfig(chave) {
        const c = chave ? configData.find(x=>x.chave===chave) : null;
        document.getElementById('drawer-title').textContent = c ? 'Editar Configuração' : 'Nova Configuração';
        document.getElementById('drawer-body').innerHTML = `<div class="form-grid">
        <div class="msg-form" id="form-msg"></div>
        <div class="form-group form-full">
            <label class="form-label">Chave <span style="color:var(--text-faint);font-size:10px">(sem espaços, letras minúsculas)</span></label>
            <input class="form-input" id="fc_chave" type="text" placeholder="ex: endereco"
                   value="${c?.chave||''}" ${c?'readonly':''} style="${c?'background:var(--bg-input);color:var(--text-faint)':''}">
        </div>
        <div class="form-group form-full">
            <label class="form-label">Valor</label>
            <textarea class="form-textarea" id="fc_valor" placeholder="Valor desta configuração..." style="height:80px">${c?.valor||''}</textarea>
        </div>
        <div class="form-group form-full">
            <label class="form-label">Descrição</label>
            <input class="form-input" id="fc_descricao" type="text" placeholder="Para que serve?" value="${c?.descricao||''}">
        </div>
        <div class="form-actions">
            <button class="btn-cancel-form" onclick="closeDrawer()">Cancelar</button>
            <button class="btn-save" id="btn-save" onclick="salvarConfig('${c?.chave||''}')">Guardar</button>
        </div>
    </div>`;
        document.getElementById('overlay').classList.remove('hidden');
        document.body.style.overflow='hidden';
    }

    async function salvarConfig(chaveOriginal) {
        const chave    = document.getElementById('fc_chave')?.value?.trim().toLowerCase().replace(/\s+/g,'_');
        const valor    = document.getElementById('fc_valor')?.value?.trim();
        const descricao= document.getElementById('fc_descricao')?.value?.trim();
        if (!chave) { showFormMsg('Chave obrigatória.','error'); return; }
        if (!valor) { showFormMsg('Valor obrigatório.','error'); return; }
        const btn = document.getElementById('btn-save');
        btn.disabled=true; btn.textContent='A guardar...';
        try {
            const body = {chave, valor, descricao:descricao||null, updated_at:new Date().toISOString()};
            if (!chaveOriginal) await sb('configuracoes',{method:'POST',body:JSON.stringify(body)});
            else await sb(`configuracoes?chave=eq.${chaveOriginal}`,{method:'PATCH',body:JSON.stringify(body)});
            showFormMsg('Guardado!','success');
            await carregarConfiguracoes();
            setTimeout(closeDrawer, 700);
        } catch(e) {
            showFormMsg(`Erro: ${e?.message||e?.details||JSON.stringify(e)}`,'error');
            btn.disabled=false; btn.textContent='Guardar';
        }
    }

    async function eliminarConfig(chave) {
        if (!confirm(`Apagar a configuração "${chave}"? Esta ação não pode ser desfeita.`)) return;
        try {
            await sb(`configuracoes?chave=eq.${chave}`,{method:'DELETE'});
            await carregarConfiguracoes();
        } catch(e) { alert('Erro ao apagar: '+JSON.stringify(e)); }
    }

    // ══════════════════════════════════════════════════════════════════════════
    // CAMPOS DAS SECÇÕES
    // ══════════════════════════════════════════════════════════════════════════
    function camposMembros() { return [
        {type:'section',label:'Identificação'},
        {key:'nome',            label:'Nome',              ph:'Nome completo',     full:true},
        {key:'email',           label:'Email',             type:'email',           ph:'email@exemplo.com'},
        {key:'telefone',        label:'Telefone',          ph:'+351 9XX XXX XXX'},
        {key:'genero',          label:'Género',            type:'select', options:[{v:'masculino',l:'Masculino'},{v:'feminino',l:'Feminino'},{v:'outro',l:'Outro'}]},
        {key:'data_nascimento', label:'Data Nascimento',   type:'date'},
        {key:'estado_civil',    label:'Estado Civil',      type:'select', options:[{v:'solteiro',l:'Solteiro'},{v:'casado',l:'Casado'},{v:'divorciado',l:'Divorciado'},{v:'viuvo',l:'Viúvo'}]},
        {key:'nif',             label:'NIF',               ph:'000 000 000'},
        {key:'foto_url',        label:'Foto',              type:'image', bucket:'imagens', full:true},
        {type:'section',label:'Morada'},
        {key:'rua',             label:'Rua',               ph:'Nome da rua',       full:true},
        {key:'numero',          label:'Número',            ph:'Nr'},
        {key:'complemento',     label:'Complemento',       ph:'Andar, porta...'},
        {key:'cidade',          label:'Cidade',            ph:'Lisboa'},
        {key:'codigo_postal',   label:'Código Postal',     ph:'0000-000'},
        {key:'pais',            label:'País',              ph:'Portugal',          default:'Portugal'},
        {key:'zona',            label:'Zona (Link)',        ph:'Ex: Montijo'},
        {type:'section',label:'Igreja'},
        {key:'tipo',            label:'Tipo',              type:'select', options:[{v:'membro',l:'Membro'},{v:'admin',l:'Administrador'}]},
        {key:'data_entrada',    label:'Membro Desde',      type:'date'},
        {key:'onde_conheceu',   label:'Onde Conheceu',     ph:'Como soube da Zion?', full:true},
        {key:'foi_batizado',    label:'Foi Batizado',      type:'checkbox'},
        {key:'data_batismo',    label:'Data Batismo',      type:'date'},
        {key:'tem_filhos',      label:'Tem Filhos',        type:'checkbox'},
        {key:'numero_filhos',   label:'Nr Filhos',         type:'number', ph:'0'},
        {type:'section',label:'Funções'},
        {key:'e_lider',         label:'Líder',             type:'checkbox'},
        {key:'e_presbitero',    label:'Presbítero',        type:'checkbox'},
        {key:'e_voluntario',    label:'Voluntário',        type:'checkbox'},
        {key:'e_admin',         label:'Administrador',     type:'checkbox'},
        {key:'professor',       label:'Professor',         type:'checkbox'},
        {type:'section',label:'História'},
        {key:'historia',        label:'História',          type:'textarea', ph:'História do membro...', full:true},
        {key:'ativo',           label:'Ativo',             type:'checkbox', default:true},
    ];}

    function camposPastores() { return [
        {key:'nome',      label:'Nome',      ph:'Nome completo',     full:true},
        {key:'cargo',     label:'Cargo',     ph:'Ex: Pastor Principal'},
        {key:'email',     label:'Email',     type:'email',           ph:'email@exemplo.com'},
        {key:'telefone',  label:'Telefone',  ph:'+351 9XX XXX XXX'},
        {key:'instagram', label:'Instagram', ph:'@handle'},
        {key:'foto_url',  label:'Foto',      type:'image', bucket:'imagens', full:true},
        {key:'bio',       label:'Biografia', type:'textarea',        ph:'Breve biografia...', full:true},
        {key:'ativo',     label:'Ativo',     type:'checkbox',        default:true},
    ];}

    function camposLinks() { return [
        {type:'section',       label:'Identificação'},
        {key:'nome',           label:'Nome',              ph:'Ex: LINK Montijo',  full:true},
        {key:'tipo',           label:'Tipo',              type:'select', options:[
                {v:'Familias',l:'Famílias'},{v:'FLOW',l:'FLOW'},{v:'VOX',l:'VOX'},
                {v:'Diamantes',l:'Diamantes'},{v:'EKLECTOS',l:'EKLECTOS'}
            ]},
        {key:'faixa_etaria',   label:'Faixa Etária',      ph:'Ex: 18-35 anos'},
        {key:'capacidade',     label:'Capacidade',        type:'number', ph:'20'},
        {type:'section',       label:'Liderança'},
        {key:'responsavel',    label:'Responsável',       ph:'Nome do líder',     full:true},
        {key:'co_responsavel', label:'Co-Responsável',    ph:'Nome do co-líder',  full:true},
        {key:'anfitrioes',     label:'Anfitriões',        ph:'Nomes...',          full:true},
        {type:'section',       label:'Horário'},
        {key:'dia',            label:'Dia',               type:'select', options:[
                {v:'Segunda-feira',l:'Segunda-feira'},{v:'Terça-feira',l:'Terça-feira'},
                {v:'Quarta-feira',l:'Quarta-feira'},{v:'Quinta-feira',l:'Quinta-feira'},
                {v:'Sexta-feira',l:'Sexta-feira'},{v:'Sábado',l:'Sábado'},{v:'Domingo',l:'Domingo'}
            ]},
        {key:'horario',        label:'Horário',           ph:'Ex: 20h00'},
        {key:'online',         label:'É Online',          type:'checkbox'},
        {type:'section',       label:'Localização'},
        {key:'zona',           label:'Zona',              ph:'Ex: Montijo'},
        {key:'distrito',       label:'Distrito',          ph:'Ex: Setúbal'},
        {key:'morada',         label:'Morada',            ph:'Rua...', full:true},
        {key:'codigo_postal',  label:'Cód. Postal',       ph:'Ex: 2870-001'},
        {type:'section',       label:'Contacto'},
        {key:'contato',        label:'Contacto (WhatsApp)',ph:'+351 9XX XXX XXX', full:true},
        {key:'ativo',          label:'Ativo',             type:'checkbox', default:true},
    ];}

    function camposCultos() { return [
        {key:'nome',            label:'Nome',           ph:'Ex: Culto de Domingo', full:true},
        {key:'dia_semana',      label:'Dia',            type:'select', options:[
                {v:'Domingo',l:'Domingo'},{v:'Segunda-feira',l:'Segunda-feira'},
                {v:'Terça-feira',l:'Terça-feira'},{v:'Quarta-feira',l:'Quarta-feira'},
                {v:'Quinta-feira',l:'Quinta-feira'},{v:'Sexta-feira',l:'Sexta-feira'},{v:'Sábado',l:'Sábado'}
            ]},
        {key:'hora_inicio',     label:'Hora Início',    type:'time'},
        {key:'hora_fim',        label:'Hora Fim',        type:'time'},
        {key:'recorrente',      label:'Recorrente',     type:'checkbox', default:true},
        {key:'data_especifica', label:'Data Específica', type:'date', full:true},
        {key:'descricao',       label:'Descrição',      type:'textarea', ph:'...', full:true},
        {key:'ativo',           label:'Ativo',           type:'checkbox', default:true},
    ];}

    function camposMinisterios() { return [
        {key:'nome',         label:'Nome',         ph:'Ex: Ministério de Louvor', full:true},
        {key:'tipo',         label:'Tipo',         type:'select', options:[{v:'ministerio',l:'Ministério'},{v:'area',l:'Área de Equipa'}]},
        {key:'slug',         label:'Slug',         ph:'Ex: louvor'},
        {key:'faixa_etaria', label:'Faixa Etária', ph:'Ex: Todas as idades'},
        {key:'instagram',    label:'Instagram',    ph:'@handle'},
        {key:'descricao',    label:'Descrição',    type:'textarea', ph:'...', full:true},
        {key:'ativo',        label:'Ativo',        type:'checkbox', default:true},
    ];}

    function camposSalas() { return [
        {key:'nome',               label:'Nome',          ph:'Ex: Sala Principal', full:true},
        {key:'espaco',             label:'Espaço',        ph:'Ex: Piso 1'},
        {key:'capacidade',         label:'Capacidade',    type:'number', ph:'20'},
        {key:'hora_inicio',        label:'Hora Abertura', type:'time'},
        {key:'hora_fim',           label:'Hora Fecho',    type:'time'},
        {key:'descricao',          label:'Descrição',     type:'textarea', ph:'...', full:true},
        {key:'aviso_entrega',      label:'Aviso Entrega', type:'textarea', ph:'...', full:true},
        {key:'foto_url',           label:'Foto',          type:'image', bucket:'imagens', full:true},
        {key:'google_calendar_id', label:'Google Calendar ID', ph:'calendar@...', full:true},
        {type:'section',label:'Equipamentos'},
        {key:'tem_som',            label:'Som',           type:'checkbox'},
        {key:'tem_iluminacao',     label:'Iluminação',    type:'checkbox'},
        {key:'tem_projecao',       label:'Projeção',      type:'checkbox'},
        {key:'tem_mesas',          label:'Mesas',         type:'checkbox'},
        {key:'tem_cadeiras',       label:'Cadeiras',      type:'checkbox'},
        {key:'ativo',              label:'Ativo',         type:'checkbox', default:true},
    ];}

    function camposCursos() { return [
        {key:'nome',          label:'Nome',           ph:'Ex: Curso de Louvor', full:true},
        {key:'carga_horaria', label:'Carga Horária',  ph:'Ex: 40 horas'},
        {key:'valor',         label:'Valor (€)',       type:'number', ph:'0.00'},
        {key:'gratuito',      label:'Gratuito',        type:'checkbox'},
        {key:'descricao',     label:'Descrição',       type:'textarea', ph:'...', full:true},
        {key:'ativo',         label:'Ativo',           type:'checkbox', default:true},
    ];}

    function camposKeola() { return [
        {key:'nome',          label:'Nome',            ph:'Ex: Café Especial', full:true},
        {key:'categoria',     label:'Categoria',       type:'select', options:[
                {v:'almoco',l:'🍽️ Almoço'},{v:'bebidas',l:'☕ Bebidas'},{v:'sumos',l:'🧃 Sumos'},
                {v:'snacks',l:'🥪 Snacks'},{v:'sobremesas',l:'🍰 Sobremesas'},{v:'outro',l:'🛒 Outros'}
            ]},
        {key:'descricao',     label:'Descrição',       type:'textarea', ph:'Breve descrição...', full:true},
        {key:'preco',         label:'Preço (€)',        type:'number', ph:'0.00'},
        {key:'ordem',         label:'Ordem',            type:'number', ph:'1'},
        {key:'imagem_url',    label:'Foto do Produto',  type:'image', bucket:'imagens', full:true},
        {key:'disponivel',    label:'Disponível',       type:'checkbox', default:true},
        {key:'especial_hoje', label:'Especial Hoje',    type:'checkbox'},
    ];}

    function camposLoja() { return [
        {type:'section',label:'Identificação'},
        {key:'nome',              label:'Nome',              ph:'Ex: Camisola ZION', full:true},
        {key:'categoria',         label:'Categoria',         type:'select', options:[
                {v:'Vestuario',l:'Vestuário'},{v:'Acessorios',l:'Acessórios'},{v:'Livros',l:'Livros'},
                {v:'Musica',l:'Música'},{v:'Decoracao',l:'Decoração'},{v:'Infantil',l:'Infantil'},{v:'Outros',l:'Outros'}
            ]},
        {key:'descricao',         label:'Descrição',         type:'textarea', ph:'...', full:true},
        {type:'section',label:'Preços'},
        {key:'preco',             label:'Preço (€)',          type:'number', ph:'0.00'},
        {key:'preco_promocional', label:'Preço Promo (€)',   type:'number', ph:'0.00'},
        {type:'section',label:'Estoque'},
        {key:'stock',             label:'Quantidade',        type:'number', ph:'0'},
        {key:'controlar_estoque', label:'Controlar Estoque', type:'checkbox', default:true},
        {type:'section',label:'Imagem e Destaque'},
        {key:'imagem_url',        label:'Imagem',            type:'image', bucket:'imagens', full:true},
        {key:'ordem',             label:'Ordem',             type:'number', ph:'1'},
        {key:'disponivel',        label:'Disponível',        type:'checkbox', default:true},
        {key:'ativo',             label:'Ativo',             type:'checkbox', default:true},
        {key:'destaque',          label:'Destaque',          type:'checkbox'},
    ];}

    // ══════════════════════════════════════════════════════════════════════════
    // EVENTOS
    // ══════════════════════════════════════════════════════════════════════════
    const STATUS_EVENTO = {
        aberto:   {label:'Aberto',    cls:'badge-green'},
        em_curso: {label:'Em Curso',  cls:'badge-primary'},
        concluido:{label:'Concluído', cls:'badge-gray'},
        cancelado:{label:'Cancelado', cls:'badge-red'},
    };

    let eventosData    = [];
    let presencasData  = [];
    let lideresMinisterios = {};
    let presSearchQ    = '';
    let eventoAtivo    = null;
    let eventoSubTab   = 0;

    function renderEventos() {
        const q        = getQ();
        const filtroSt = document.getElementById('evt-filtro-status')?.value||'';
        let lista = [...eventosData].sort((a,b)=>new Date(a.data_inicio)-new Date(b.data_inicio));
        if (q)       lista = lista.filter(e=>(e.titulo||'').toLowerCase().includes(q)||(e.local||'').toLowerCase().includes(q));
        if (filtroSt) lista = lista.filter(e=>e.status===filtroSt);

        if (eventoAtivo&&eventoSubTab===1) { renderPresencas(); return; }

        let html = `
    <div class="section-toolbar" style="position:sticky;top:0;z-index:10">
        <input class="toolbar-search" id="toolbar-search-input"
               placeholder="Pesquisar evento..." oninput="handleSearch()" value="${q}">
        <select class="toolbar-filter" id="evt-filtro-status" onchange="renderEventos()"
                style="border-radius:20px;padding:7px 12px;border:1px solid var(--border);background:var(--bg-input);font-family:var(--font-title);font-size:9px;color:var(--text-muted);cursor:pointer">
            <option value="">Todos</option>
            <option value="aberto">Abertos</option>
            <option value="em_curso">Em Curso</option>
            <option value="concluido">Concluídos</option>
            <option value="cancelado">Cancelados</option>
        </select>
        <button class="btn-new" onclick="abrirFormEvento(null)">+ Novo</button>
    </div>`;

        if (!lista.length) {
            html+='<div class="empty"><div class="empty-icon">—</div><div class="empty-txt">Nenhum evento.</div></div>';
            document.getElementById('main-content').innerHTML=html;
            restoreSearch(q); return;
        }

        html+='<div class="admin-list" style="padding:12px 16px">';
        lista.forEach((e,i)=>{
            const st     = STATUS_EVENTO[e.status]||STATUS_EVENTO.aberto;
            const dI     = e.data_inicio?new Date(e.data_inicio).toLocaleDateString('pt-PT',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}):'—';
            const dF     = e.data_fim?new Date(e.data_fim).toLocaleDateString('pt-PT',{day:'2-digit',month:'short'}):'';
            const btns   = [];
            if(e.status==='aberto')    { btns.push(`<button class="btn-edit" onclick="abrirFormEvento('${e.id}')">Editar</button>`); btns.push(`<button class="btn-toggle ativo" onclick="iniciarEvento('${e.id}')">Iniciar</button>`); }
            if(e.status==='em_curso')  { btns.push(`<button class="btn-edit" onclick="abrirPresencas('${e.id}')">Presenças</button>`); btns.push(`<button class="btn-toggle ativo" onclick="concluirEvento('${e.id}')">Concluir</button>`); }
            if(e.status!=='cancelado'&&e.status!=='concluido') btns.push(`<button class="btn-toggle ativo" onclick="cancelarEvento('${e.id}')">Cancelar</button>`);
            if(e.status==='concluido'||e.status==='cancelado') btns.push(`<button class="btn-edit" onclick="abrirPresencas('${e.id}')">Ver Resumo</button>`);
            if(e.status==='concluido') btns.push(`<button class="btn-edit" style="color:var(--red);border-color:var(--red-border)" onclick="gerarRelatorioEvento('${e.id}')">PDF</button>`);
            html+=`
        <div class="admin-row" style="animation-delay:${Math.min(i,12)*0.02}s;flex-direction:column;align-items:stretch;gap:8px">
            <div style="display:flex;align-items:center;gap:12px">
                <div class="admin-row-foto" style="background:var(--primary-faint)">${(e.titulo||'E')[0]}</div>
                <div class="admin-row-info">
                    <div class="admin-row-nome">${e.titulo||'—'}</div>
                    <div class="admin-row-sub">${dI}${dF?' — '+dF:''} ${e.local?'· '+e.local:''}</div>
                    <div class="admin-row-badges">
                        <span class="badge ${st.cls}">${st.label}</span>
                        ${e.gratuito?'<span class="badge badge-green">Gratuito</span>':''}
                        ${e.destaque?'<span class="badge badge-primary">Destaque</span>':''}
                        ${e.tipo?`<span class="badge badge-gray">${e.tipo}</span>`:''}
                    </div>
                </div>
            </div>
            <div class="admin-row-actions" style="justify-content:flex-end">${btns.join('')}</div>
        </div>`;
        });
        html+='</div>';
        document.getElementById('main-content').innerHTML=html;
        restoreSearch(q);
    }

    async function iniciarEvento(id) {
        if(!confirm('Iniciar este evento? Será criada a lista de presenças com todos os líderes.')) return;
        await sb(`eventos?id=eq.${id}`,{method:'PATCH',body:JSON.stringify({status:'em_curso'})});
        const lideres = await sb('membros?select=id,nome&e_lider=eq.true&ativo=eq.true');
        if(lideres?.length) {
            const rows = lideres.map(l=>({evento_id:id,membro_id:l.id,status:'pendente'}));
            await sb('evento_presencas',{method:'POST',body:JSON.stringify(rows)});
        }
        eventosData = await sb('eventos?select=*&order=data_inicio')||[];
        renderEventos();
    }

    async function cancelarEvento(id) {
        if(!confirm('Cancelar este evento?')) return;
        await sb(`eventos?id=eq.${id}`,{method:'PATCH',body:JSON.stringify({status:'cancelado'})});
        eventosData = await sb('eventos?select=*&order=data_inicio')||[];
        renderEventos();
    }

    async function concluirEvento(id) {
        if(!confirm('Concluir? Pendentes serão marcados como faltaram.')) return;
        await sb(`evento_presencas?evento_id=eq.${id}&status=eq.pendente`,{method:'PATCH',body:JSON.stringify({status:'faltou'})});
        await sb(`eventos?id=eq.${id}`,{method:'PATCH',body:JSON.stringify({status:'concluido'})});
        eventosData = await sb('eventos?select=*&order=data_inicio')||[];
        eventoAtivo=null; eventoSubTab=0; renderEventos();
    }

    async function abrirPresencas(id) {
        eventoAtivo  = eventosData.find(e=>e.id===id);
        eventoSubTab = 1;
        presencasData= await sb(`evento_presencas?select=*,membros(id,nome,telefone,foto_url)&evento_id=eq.${id}&order=created_at`)||[];
        const membroIds = presencasData.map(p=>p.membro_id).filter(Boolean);
        lideresMinisterios={};
        if(membroIds.length) {
            const vincs = await sb(`membro_ministerios?select=membro_id,papel,ministerios(id,nome,tipo)&membro_id=in.(${membroIds.join(',')})&ativo=eq.true`)||[];
            vincs.forEach(v=>{
                if(!lideresMinisterios[v.membro_id]) lideresMinisterios[v.membro_id]=[];
                lideresMinisterios[v.membro_id].push({papel:v.papel,nome:v.ministerios?.nome||'—',tipo:v.ministerios?.tipo||'—'});
            });
        }
        renderPresencas();
    }

    function renderPresencas() {
        const evento  = eventoAtivo;
        const st      = STATUS_EVENTO[evento?.status]||STATUS_EVENTO.aberto;
        const emCurso = evento?.status==='em_curso';
        const q       = presSearchQ.toLowerCase();
        let lista     = [...presencasData];
        if(q) lista = lista.filter(p=>(p.membros?.nome||'').toLowerCase().includes(q));

        const presentes= presencasData.filter(p=>p.status==='presente').length;
        const faltaram = presencasData.filter(p=>p.status==='faltou').length;
        const comMotivo= presencasData.filter(p=>p.status==='faltou_motivo').length;
        const pendentes= presencasData.filter(p=>p.status==='pendente').length;

        let html=`
    <div class="section-toolbar" style="position:sticky;top:0;z-index:10;flex-wrap:wrap;gap:6px">
        <button class="btn-edit" onclick="voltarListaEventos()">← Voltar</button>
        ${eventoAtivo?.status==='concluido'?`<button class="btn-edit" style="color:var(--red);border-color:var(--red-border)" onclick="gerarRelatorioEvento('${eventoAtivo.id}')">PDF</button>`:''}
        <input class="toolbar-search" id="pres-search" placeholder="Pesquisar líder..."
               oninput="presSearchQ=this.value;renderPresencas()" style="flex:1;min-width:120px">
        ${emCurso?`<button class="btn-new" onclick="finalizarEntradas()">Finalizar Entradas</button>`:''}
    </div>
    <div style="padding:10px 16px 4px">
        <div style="font-family:var(--font-title);font-size:13px;color:var(--primary-dark);margin-bottom:4px">${evento?.titulo||'—'}</div>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
            <span class="badge ${st.cls}">${st.label}</span>
            <span class="badge badge-green">Presentes: ${presentes}</span>
            <span class="badge badge-red">Faltaram: ${faltaram+comMotivo}</span>
            ${comMotivo?`<span class="badge badge-primary">Com motivo: ${comMotivo}</span>`:''}
            ${pendentes?`<span class="badge badge-gray">Pendentes: ${pendentes}</span>`:''}
        </div>
    </div>
    <div class="gold-line" style="margin:8px 16px"></div>`;

        if(!lista.length) {
            html+='<div class="empty"><div class="empty-txt">Nenhum líder encontrado.</div></div>';
            document.getElementById('main-content').innerHTML=html;
            const si=document.getElementById('pres-search');
            if(si){si.value=presSearchQ;si.focus();si.setSelectionRange(si.value.length,si.value.length);}
            return;
        }

        const grupos=[
            {key:'presente',      label:'Presentes',           items:lista.filter(p=>p.status==='presente')},
            {key:'pendente',      label:'Pendentes',            items:lista.filter(p=>p.status==='pendente')},
            {key:'faltou_motivo', label:'Faltaram c/ Motivo',  items:lista.filter(p=>p.status==='faltou_motivo')},
            {key:'faltou',        label:'Faltaram',             items:lista.filter(p=>p.status==='faltou')},
        ].filter(g=>g.items.length>0);

        grupos.forEach(grupo=>{
            html+=`<div style="padding:8px 16px 2px;font-family:var(--font-title);font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--text-faint)">${grupo.label} (${grupo.items.length})</div>`;
            html+='<div class="admin-list" style="padding:4px 16px 8px">';
            grupo.items.forEach((p,i)=>{
                const nome  = p.membros?.nome||'—';
                const stIcon= {presente:'✓',faltou:'✗',faltou_motivo:'!',pendente:'·'}[p.status]||'·';
                const stColor={presente:'var(--green)',faltou:'var(--red)',faltou_motivo:'var(--orange)',pendente:'var(--border)'}[p.status]||'var(--border)';
                const mins  = lideresMinisterios[p.membro_id]||[];
                const minsHtml=mins.map(m=>`<span class="badge badge-gray" style="font-size:8px">${m.tipo==='ministerio'?'MIN':'AE'} · ${m.nome}${m.papel?' · '+m.papel:''}</span>`).join('');

                let btns='';
                if(emCurso&&p.status!=='presente')      btns+=`<button class="btn-toggle inativo" onclick="marcarPresenca('${p.id}','presente')">Presente</button>`;
                if(emCurso&&p.status!=='faltou')        btns+=`<button class="btn-toggle ativo" onclick="marcarPresenca('${p.id}','faltou')">Faltou</button>`;
                if(emCurso&&p.status!=='faltou_motivo') btns+=`<button class="btn-edit" onclick="abrirMotivo('${p.id}','${nome.replace(/'/g,"\\'")}')">Com Motivo</button>`;
                if(emCurso&&p.status!=='pendente')      btns+=`<button class="btn-edit" style="color:var(--text-faint)" onclick="marcarPresenca('${p.id}','pendente')" title="Desfazer">↩</button>`;

                let zapBtn='';
                if(p.membros?.telefone){
                    const tel=p.membros.telefone.replace(/\D/g,'');
                    const dEvt=eventoAtivo?.data_inicio?new Date(eventoAtivo.data_inicio).toLocaleDateString('pt-PT',{weekday:'long',day:'numeric',month:'long',hour:'2-digit',minute:'2-digit'}):'';
                    const msg=encodeURIComponent(`Olá ${p.membros.nome?.split(' ')[0]}! Gostaríamos de confirmar a tua presença na ${eventoAtivo?.titulo||'reunião'} a realizar ${dEvt}. Podes confirmar?`);
                    zapBtn=`<a href="https://api.whatsapp.com/send?phone=${tel}&text=${msg}" target="_blank" rel="noopener"
                    style="display:inline-flex;align-items:center;gap:4px;font-size:11px;color:#25D366;text-decoration:none;padding:2px 6px;border-radius:6px;border:1px solid rgba(37,211,102,0.3);background:rgba(37,211,102,0.06)">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="#25D366"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>Zap</a>`;
                }
                const fotoSrc=p.membros?.foto_url;
                const fotoHtml=fotoSrc
                    ?`<img src="${fotoSrc}" style="width:36px;height:36px;border-radius:50%;object-fit:cover;flex-shrink:0;border:2px solid ${stColor}" onerror="this.style.display='none'">`
                    :`<div class="admin-row-foto" style="font-size:13px;font-weight:bold;color:${stColor}">${stIcon}</div>`;

                html+=`<div class="admin-row" style="animation-delay:${Math.min(i,20)*0.01}s;flex-wrap:wrap;gap:6px">
                ${fotoHtml}
                <div class="admin-row-info" style="min-width:0;flex:1">
                    <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
                        <span class="admin-row-nome">${nome}</span>${zapBtn}
                    </div>
                    <div class="admin-row-badges" style="margin-top:3px;flex-wrap:wrap;gap:3px">
                        ${minsHtml||'<span style="font-size:10px;color:var(--text-faint)">Sem áreas</span>'}
                    </div>
                    ${p.motivo?`<div class="admin-row-sub" style="color:var(--orange);margin-top:3px">Motivo: ${p.motivo}</div>`:''}
                </div>
                <div class="admin-row-actions">${btns}</div>
            </div>`;
            });
            html+='</div>';
        });
        document.getElementById('main-content').innerHTML=html;
        const si=document.getElementById('pres-search');
        if(si){si.value=presSearchQ;si.focus();si.setSelectionRange(si.value.length,si.value.length);}
    }

    function voltarListaEventos() { eventoAtivo=null; eventoSubTab=0; presSearchQ=''; renderEventos(); }

    async function marcarPresenca(presencaId, novoStatus) {
        const patch={status:novoStatus,registado_em:new Date().toISOString()};
        if(novoStatus==='pendente') patch.motivo='';
        await sb(`evento_presencas?id=eq.${presencaId}`,{method:'PATCH',body:JSON.stringify(patch)});
        const idx=presencasData.findIndex(p=>p.id===presencaId);
        if(idx>=0){presencasData[idx].status=novoStatus;if(novoStatus==='pendente') presencasData[idx].motivo='';}
        renderPresencas();
    }

    async function finalizarEntradas() {
        if(!eventoAtivo) return;
        if(!confirm('Pendentes serão marcados como faltaram.')) return;
        await sb(`evento_presencas?evento_id=eq.${eventoAtivo.id}&status=eq.pendente`,{method:'PATCH',body:JSON.stringify({status:'faltou'})});
        presencasData.forEach(p=>{if(p.status==='pendente') p.status='faltou';});
        renderPresencas();
    }

    let motivoPresencaId=null;

    function abrirMotivo(presencaId, nome) {
        motivoPresencaId=presencaId;
        document.getElementById('drawer-title').textContent=`Motivo — ${nome}`;
        document.getElementById('drawer-body').innerHTML=`<div class="form-grid">
        <div class="form-group form-full">
            <label class="form-label">Motivo da Falta</label>
            <textarea class="form-textarea" id="motivo-txt" placeholder="Descreve o motivo..." style="height:100px"></textarea>
        </div>
        <div class="form-actions">
            <button class="btn-cancel-form" onclick="closeDrawer()">Cancelar</button>
            <button class="btn-save" onclick="guardarMotivo()">Guardar</button>
        </div>
    </div>`;
        document.getElementById('overlay').classList.remove('hidden');
        document.body.style.overflow='hidden';
    }

    async function guardarMotivo() {
        const motivo=document.getElementById('motivo-txt')?.value?.trim();
        if(!motivo){alert('Escreve o motivo.');return;}
        await sb(`evento_presencas?id=eq.${motivoPresencaId}`,{method:'PATCH',body:JSON.stringify({status:'faltou_motivo',motivo,registado_em:new Date().toISOString()})});
        const idx=presencasData.findIndex(p=>p.id===motivoPresencaId);
        if(idx>=0){presencasData[idx].status='faltou_motivo';presencasData[idx].motivo=motivo;}
        closeDrawer(); renderPresencas();
    }

    function abrirFormEvento(id) {
        const e=id?eventosData.find(x=>x.id===id):null;
        document.getElementById('drawer-title').textContent=e?'Editar Evento':'Novo Evento';
        document.getElementById('drawer-body').innerHTML=buildFormEvento(e);
        document.getElementById('overlay').classList.remove('hidden');
        document.body.style.overflow='hidden';
    }

    function buildFormEvento(e) {
        const fv =(k,d='')=>e?.[k]??d;
        const fdt=k=>{const v=e?.[k];if(!v)return'';return new Date(v).toISOString().slice(0,16);};
        return `<div class="form-grid">
        <div class="msg-form" id="form-msg"></div>
        <div class="form-section-title">Identificação</div>
        <div class="form-group form-full"><label class="form-label">Título</label><input class="form-input" id="fe_titulo" type="text" placeholder="Nome do evento" value="${fv('titulo')}"></div>
        <div class="form-group"><label class="form-label">Tipo</label>
            <select class="form-select" id="fe_tipo">
                <option value="">-- Seleciona --</option>
                ${['Reunião de Líderes','Culto Especial','Conferência','Retiro','Treinamento','Workshop','Outro'].map(t=>`<option value="${t}" ${fv('tipo')===t?'selected':''}>${t}</option>`).join('')}
            </select>
        </div>
        <div class="form-group"><label class="form-label">Local</label><input class="form-input" id="fe_local" type="text" placeholder="Ex: Sede Lisboa" value="${fv('local')}"></div>
        <div class="form-group form-full"><label class="form-label">Descrição</label><textarea class="form-textarea" id="fe_descricao">${fv('descricao')}</textarea></div>
        <div class="form-section-title">Data e Hora</div>
        <div class="form-group"><label class="form-label">Data Início</label><input class="form-input" id="fe_data_inicio" type="datetime-local" value="${fdt('data_inicio')}"></div>
        <div class="form-group"><label class="form-label">Data Fim</label><input class="form-input" id="fe_data_fim" type="datetime-local" value="${fdt('data_fim')}"></div>
        <div class="form-section-title">Inscrição</div>
        <div class="form-group"><label class="form-label">Valor (€)</label><input class="form-input" id="fe_valor" type="number" placeholder="0.00" value="${fv('valor')}"></div>
        <div class="form-group"><label class="form-label">Link Inscrição</label><input class="form-input" id="fe_link_inscricao" type="url" placeholder="https://..." value="${fv('link_inscricao')}"></div>
        <div class="form-group"><label class="form-toggle"><input type="checkbox" id="fe_gratuito" ${fv('gratuito')?'checked':''}><span>Gratuito</span></label></div>
        <div class="form-group"><label class="form-toggle"><input type="checkbox" id="fe_destaque" ${fv('destaque')?'checked':''}><span>Destaque</span></label></div>
        <div class="form-group"><label class="form-toggle"><input type="checkbox" id="fe_ativo" ${fv('ativo')!==false?'checked':''}><span>Ativo</span></label></div>
        <div class="form-actions">
            <button class="btn-cancel-form" onclick="closeDrawer()">Cancelar</button>
            <button class="btn-save" id="btn-save" onclick="salvarEvento('${e?.id||''}')">Guardar</button>
        </div>
    </div>`;
    }

    async function salvarEvento(id) {
        const get=k=>{const el=document.getElementById('fe_'+k);return el?el.value||null:null;};
        const chk=k=>{const el=document.getElementById('fe_'+k);return el?el.checked:false;};
        const body={titulo:get('titulo'),tipo:get('tipo'),local:get('local'),descricao:get('descricao'),
            data_inicio:get('data_inicio'),data_fim:get('data_fim'),
            valor:get('valor')?Number(get('valor')):null,link_inscricao:get('link_inscricao'),
            gratuito:chk('gratuito'),destaque:chk('destaque'),ativo:chk('ativo')};
        if(!body.titulo){showFormMsg('Título obrigatório.','error');return;}
        const btn=document.getElementById('btn-save');
        btn.disabled=true;btn.textContent='A guardar...';
        try {
            if(!id){body.status='aberto';await sb('eventos',{method:'POST',body:JSON.stringify(body)});}
            else await sb(`eventos?id=eq.${id}`,{method:'PATCH',body:JSON.stringify(body)});
            showFormMsg('Guardado!','success');
            eventosData=await sb('eventos?select=*&order=data_inicio')||[];
            setTimeout(()=>{closeDrawer();renderEventos();},700);
        } catch(err) {
            showFormMsg('Erro: '+(err?.message||JSON.stringify(err)),'error');
            btn.disabled=false;btn.textContent='Guardar';
        }
    }

    function camposEventos(){return[];}

    // ── RELATÓRIO PDF ─────────────────────────────────────────────────────────
    async function gerarRelatorioEvento(eventoId) {
        const evento=eventosData.find(e=>e.id===eventoId);
        if(!evento) return;
        const pres=await sb(`evento_presencas?select=*,membros(id,nome,foto_url,telefone)&evento_id=eq.${eventoId}&order=created_at`)||[];
        const membroIds=pres.map(p=>p.membro_id).filter(Boolean);
        let minsMap={};
        if(membroIds.length){
            const vincs=await sb(`membro_ministerios?select=membro_id,papel,ministerios(nome,tipo)&membro_id=in.(${membroIds.join(',')})&ativo=eq.true`)||[];
            vincs.forEach(v=>{
                if(!minsMap[v.membro_id]) minsMap[v.membro_id]=[];
                minsMap[v.membro_id].push({tipo:v.ministerios?.tipo||'?',nome:v.ministerios?.nome||'—',papel:v.papel||''});
            });
        }
        const presentes=pres.filter(p=>p.status==='presente');
        const faltaram=pres.filter(p=>p.status==='faltou');
        const comMotivo=pres.filter(p=>p.status==='faltou_motivo');
        const dEvt=evento.data_inicio?new Date(evento.data_inicio).toLocaleDateString('pt-PT',{weekday:'long',day:'numeric',month:'long',year:'numeric',hour:'2-digit',minute:'2-digit'}):'—';
        const porArea={};
        pres.forEach(p=>{
            const mins=minsMap[p.membro_id]||[{tipo:'Sem área',nome:'Sem área',papel:''}];
            mins.forEach(m=>{
                const k=`${m.tipo}||${m.nome}`;
                if(!porArea[k]) porArea[k]={tipo:m.tipo,nome:m.nome,presentes:0,faltaram:0};
                if(p.status==='presente') porArea[k].presentes++;
                else if(p.status==='faltou'||p.status==='faltou_motivo') porArea[k].faltaram++;
            });
        });
        const rowM=p=>{
            const mins=minsMap[p.membro_id]||[];
            const as=mins.map(m=>`[${m.tipo==='ministerio'?'MIN':'AE'}] ${m.nome}${m.papel?' · '+m.papel:''}`).join(' | ');
            return `<tr><td style="padding:6px 8px;border-bottom:1px solid #eee">${p.membros?.nome||'—'}</td><td style="padding:6px 8px;border-bottom:1px solid #eee;font-size:11px;color:#666">${as||'—'}</td><td style="padding:6px 8px;border-bottom:1px solid #eee;font-size:11px;color:#c07000">${p.motivo||'—'}</td></tr>`;
        };
        const rowA=a=>`<tr>
        <td style="padding:6px 8px;border-bottom:1px solid #eee">${a.tipo==='ministerio'?'Ministério':'Área de Equipa'}</td>
        <td style="padding:6px 8px;border-bottom:1px solid #eee;font-weight:600">${a.nome}</td>
        <td style="padding:6px 8px;border-bottom:1px solid #eee;color:green;text-align:center">${a.presentes}</td>
        <td style="padding:6px 8px;border-bottom:1px solid #eee;color:red;text-align:center">${a.faltaram}</td>
        <td style="padding:6px 8px;border-bottom:1px solid #eee;text-align:center">${Math.round(a.presentes/(a.presentes+a.faltaram||1)*100)}%</td>
    </tr>`;
        const htm=`<!DOCTYPE html><html lang="pt"><head><meta charset="UTF-8"><title>Relatório — ${evento.titulo}</title>
    <style>body{font-family:Arial,sans-serif;color:#222;padding:32px;max-width:900px;margin:0 auto}
    h1{font-size:22px;margin-bottom:4px;color:#006b70}h2{font-size:15px;margin:28px 0 10px;color:#006b70;border-bottom:2px solid #009098;padding-bottom:4px}
    .meta{font-size:13px;color:#555;margin-bottom:24px}.badges{display:flex;gap:10px;margin-bottom:20px}
    .badge{padding:6px 14px;border-radius:20px;font-size:12px;font-weight:bold}
    .g{background:#e8f5e9;color:#2e7d32}.r{background:#ffebee;color:#c62828}.o{background:#fff8e1;color:#e65100}.gr{background:#f5f5f5;color:#555}
    table{width:100%;border-collapse:collapse;font-size:13px}th{background:#f0f7f8;padding:8px;text-align:left;font-size:11px;letter-spacing:1px;text-transform:uppercase;color:#888}
    @media print{body{padding:16px}}</style></head><body>
    <h1>${evento.titulo}</h1><div class="meta">${dEvt}${evento.local?' · '+evento.local:''}</div>
    <div class="badges">
        <span class="badge g">Presentes: ${presentes.length}</span>
        <span class="badge r">Faltaram: ${faltaram.length}</span>
        <span class="badge o">Com motivo: ${comMotivo.length}</span>
        <span class="badge gr">Total: ${pres.length}</span>
    </div>
    <h2>Presentes (${presentes.length})</h2>
    <table><thead><tr><th>Nome</th><th>Áreas / Ministérios</th><th>—</th></tr></thead><tbody>${presentes.map(rowM).join('')}</tbody></table>
    ${comMotivo.length?`<h2>Faltaram c/ Motivo (${comMotivo.length})</h2><table><thead><tr><th>Nome</th><th>Áreas</th><th>Motivo</th></tr></thead><tbody>${comMotivo.map(rowM).join('')}</tbody></table>`:''}
    ${faltaram.length?`<h2>Faltaram (${faltaram.length})</h2><table><thead><tr><th>Nome</th><th>Áreas</th><th>—</th></tr></thead><tbody>${faltaram.map(rowM).join('')}</tbody></table>`:''}
    <h2>Resumo por Área / Ministério</h2>
    <table><thead><tr><th>Tipo</th><th>Nome</th><th style="text-align:center">Presentes</th><th style="text-align:center">Faltaram</th><th style="text-align:center">%</th></tr></thead>
    <tbody>${Object.values(porArea).sort((a,b)=>a.nome.localeCompare(b.nome)).map(rowA).join('')}</tbody></table>
    <div style="margin-top:40px;font-size:11px;color:#aaa;text-align:center">
        Gerado em ${new Date().toLocaleDateString('pt-PT',{day:'2-digit',month:'long',year:'numeric',hour:'2-digit',minute:'2-digit'})} · Zion Lisboa
    </div><script>window.onload=()=>window.print();<\/script></body></html>`;
        const win=window.open('','_blank');
        win.document.write(htm);
        win.document.close();
    }

    init();
</script>
</body>
</html>
