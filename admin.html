<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Painel Admin — Zion Lisboa</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="config.js"></script>
    <script src="auth.js"></script>
    <style>
        :root{
            --gold:#B8922A;--gold-light:#D4A843;--gold-dark:#8B6914;
            --border:rgba(184,146,42,0.22);--bg-page:#F5EFE4;--bg-card:#FFFFFF;
            --bg-input:#FAF7F2;--bg-footer:#F0E8D8;--text-main:#1A1410;
            --text-muted:#7A6A52;--text-faint:#A89878;
            --shadow:0 8px 40px rgba(100,70,20,0.13);
            --green:#2e7d32;--green-bg:rgba(46,125,50,0.08);--green-border:rgba(46,125,50,0.25);
            --red:#c0392b;--red-bg:rgba(192,57,43,0.08);--red-border:rgba(192,57,43,0.25);
            --orange:#e65100;--orange-bg:rgba(230,81,0,0.08);
        }
        *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
        html,body{height:100%;background:var(--bg-page);font-family:'Lato',sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh}
        body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 15% 15%,rgba(201,168,76,0.09) 0%,transparent 55%),radial-gradient(ellipse at 85% 85%,rgba(201,168,76,0.06) 0%,transparent 55%);pointer-events:none;z-index:0}
        .page-wrapper{position:relative;z-index:1;display:flex;flex-direction:column;width:640px;max-width:96vw;height:96vh;max-height:900px;background:var(--bg-card);border-radius:16px;box-shadow:var(--shadow),0 0 0 1px var(--border);overflow:hidden}

        /* Top bar */
        .banner{width:100%;position:relative;background:#111;flex-shrink:0}
        .banner img{width:100%;height:110px;object-fit:cover;display:block}
        .banner-fallback{display:none;width:100%;height:110px;background:linear-gradient(135deg,#0d0d0d 0%,#1c1408 50%,#0d0d0d 100%);align-items:center;justify-content:center;flex-direction:column;gap:8px}
        .banner-fallback.show{display:flex}
        .banner-title{font-family:'Cinzel',serif;color:#C9A84C;font-size:26px;font-weight:700;letter-spacing:10px}
        .banner-sub{color:rgba(201,168,76,0.6);font-size:10px;letter-spacing:4px;text-transform:uppercase}
        .banner-overlay{position:absolute;bottom:0;left:0;right:0;height:55px;background:linear-gradient(to top,rgba(255,255,255,0.97),transparent)}
        .banner-nav{position:absolute;bottom:10px;left:0;right:0;display:flex;align-items:center;justify-content:space-between;padding:0 16px}
        .back-btn{display:flex;align-items:center;gap:6px;background:rgba(255,255,255,0.92);border:1px solid var(--border);border-radius:20px;padding:5px 14px;font-family:'Cinzel',serif;font-size:10px;letter-spacing:1.5px;color:var(--gold-dark);text-decoration:none;backdrop-filter:blur(8px)}
        .page-badge{font-family:'Cinzel',serif;font-size:10px;letter-spacing:2px;color:var(--gold);text-transform:uppercase;background:rgba(255,255,255,0.92);border:1px solid var(--border);border-radius:20px;padding:5px 14px;backdrop-filter:blur(8px)}
        .gold-line{height:2px;background:linear-gradient(90deg,transparent,var(--gold-light),transparent);flex-shrink:0;opacity:0.5}
        .user-bar{display:flex;align-items:center;gap:10px;padding:10px 16px;background:linear-gradient(135deg,rgba(201,168,76,0.08),rgba(201,168,76,0.02));border-bottom:1px solid var(--border);flex-shrink:0}
        .user-bar-info{flex:1}
        .user-bar-nome{font-family:'Cinzel',serif;font-size:12px;color:var(--gold-dark)}
        .user-bar-tipo{font-size:10px;color:var(--text-faint)}
        .logout-btn{display:flex;align-items:center;gap:5px;padding:5px 10px;border-radius:8px;border:1px solid rgba(220,80,60,0.3);background:rgba(220,80,60,0.06);color:#c0392b;font-family:'Cinzel',serif;font-size:9px;letter-spacing:1px;cursor:pointer;flex-shrink:0;transition:all 0.2s}

        /* Nav sections */
        .nav-bar{display:flex;overflow-x:auto;background:var(--bg-input);border-bottom:1px solid var(--border);flex-shrink:0}
        .nav-bar::-webkit-scrollbar{height:0}
        .nav-item{flex-shrink:0;padding:9px 14px;font-family:'Cinzel',serif;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-faint);cursor:pointer;border-bottom:2px solid transparent;transition:all 0.2s;white-space:nowrap}
        .nav-item:hover{color:var(--gold)}
        .nav-item.active{color:var(--gold);border-bottom-color:var(--gold)}

        /* Content */
        .content{flex:1;overflow-y:auto;background:var(--bg-input)}
        .content::-webkit-scrollbar{width:4px}
        .content::-webkit-scrollbar-thumb{background:rgba(184,146,42,0.25);border-radius:2px}

        /* Section toolbar */
        .section-toolbar{display:flex;align-items:center;gap:8px;padding:12px 16px;background:var(--bg-card);border-bottom:1px solid var(--border);flex-shrink:0;position:sticky;top:0;z-index:10}
        .toolbar-search{flex:1;background:var(--bg-input);border:1px solid var(--border);border-radius:20px;padding:7px 14px;font-family:'Lato',sans-serif;font-size:13px;color:var(--text-main);outline:none;transition:border-color 0.2s}
        .toolbar-search::placeholder{color:var(--text-faint)}
        .toolbar-search:focus{border-color:var(--gold-light)}
        .toolbar-filter{padding:7px 12px;border-radius:20px;border:1px solid var(--border);background:var(--bg-input);font-family:'Cinzel',serif;font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--text-muted);cursor:pointer;transition:all 0.2s;flex-shrink:0}
        .toolbar-filter.active{background:rgba(230,81,0,0.1);color:var(--orange);border-color:rgba(230,81,0,0.3)}
        .btn-new{display:flex;align-items:center;gap:5px;padding:7px 14px;border-radius:20px;border:none;background:linear-gradient(135deg,var(--gold-dark),var(--gold-light));color:#fff;font-family:'Cinzel',serif;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;cursor:pointer;flex-shrink:0;transition:all 0.2s;box-shadow:0 2px 8px rgba(139,105,20,0.2)}
        .btn-new:hover{filter:brightness(1.08)}

        /* Tabs (for ministerios, cursos) */
        .sub-tabs{display:flex;background:var(--bg-input);border-bottom:1px solid var(--border);flex-shrink:0}
        .sub-tab{flex:1;padding:9px;font-family:'Cinzel',serif;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-faint);background:none;border:none;border-bottom:2px solid transparent;cursor:pointer;transition:all 0.2s}
        .sub-tab.active{color:var(--gold);border-bottom-color:var(--gold)}

        /* List */
        .admin-list{padding:12px 16px;display:flex;flex-direction:column;gap:6px}
        .admin-row{display:flex;align-items:center;gap:12px;background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:10px 14px;transition:all 0.2s;animation:fadeUp 0.25s ease both}
        .admin-row.inativo{opacity:0.5}
        .admin-row:hover{border-color:var(--gold-light);box-shadow:0 2px 10px rgba(100,70,20,0.08)}
        .admin-row-foto{width:40px;height:40px;border-radius:8px;object-fit:cover;flex-shrink:0;background:linear-gradient(135deg,rgba(201,168,76,0.12),rgba(201,168,76,0.04));display:flex;align-items:center;justify-content:center;font-size:16px;overflow:hidden;border:1px solid var(--border)}
        .admin-row-foto img{width:100%;height:100%;object-fit:cover;display:block}
        .admin-row-info{flex:1;min-width:0}
        .admin-row-nome{font-family:'Cinzel',serif;font-size:12px;font-weight:600;color:var(--text-main);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .admin-row-sub{font-size:11px;color:var(--text-faint);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .admin-row-badges{display:flex;gap:4px;flex-wrap:wrap;margin-top:3px}
        .badge{font-family:'Cinzel',serif;font-size:8px;letter-spacing:0.5px;padding:2px 7px;border-radius:8px;border:1px solid transparent;white-space:nowrap}
        .badge-gold{background:rgba(184,146,42,0.1);color:var(--gold-dark);border-color:rgba(184,146,42,0.2)}
        .badge-green{background:var(--green-bg);color:var(--green);border-color:var(--green-border)}
        .badge-red{background:var(--red-bg);color:var(--red);border-color:var(--red-border)}
        .badge-gray{background:rgba(100,100,100,0.08);color:var(--text-faint);border-color:rgba(100,100,100,0.15)}
        .admin-row-actions{display:flex;gap:6px;flex-shrink:0}
        .btn-edit{padding:5px 10px;border-radius:7px;border:1px solid var(--border);background:var(--bg-input);font-family:'Cinzel',serif;font-size:8px;letter-spacing:1px;text-transform:uppercase;color:var(--gold-dark);cursor:pointer;transition:all 0.2s}
        .btn-edit:hover{border-color:var(--gold-light);background:rgba(184,146,42,0.06)}
        .btn-toggle{padding:5px 10px;border-radius:7px;border:1px solid transparent;font-family:'Cinzel',serif;font-size:8px;letter-spacing:1px;text-transform:uppercase;cursor:pointer;transition:all 0.2s}
        .btn-toggle.ativo{background:var(--red-bg);color:var(--red);border-color:var(--red-border)}
        .btn-toggle.ativo:hover{background:rgba(192,57,43,0.14)}
        .btn-toggle.inativo{background:var(--green-bg);color:var(--green);border-color:var(--green-border)}
        .btn-toggle.inativo:hover{background:rgba(46,125,50,0.14)}

        /* Loading / Empty */
        .loading{text-align:center;padding:40px;color:var(--text-faint);font-size:13px}
        .spin{width:24px;height:24px;border:2px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 10px}
        .empty{text-align:center;padding:40px 20px;color:var(--text-faint)}
        .empty-icon{font-size:36px;margin-bottom:8px;opacity:0.3}
        .empty-txt{font-size:13px}

        /* Acesso negado */
        .acesso-negado{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;padding:32px;text-align:center}
        .acesso-negado-icon{font-size:48px;margin-bottom:14px;opacity:0.4}
        .acesso-negado-title{font-family:'Cinzel',serif;font-size:16px;color:var(--gold-dark);margin-bottom:8px}
        .acesso-negado-txt{font-size:13px;color:var(--text-faint);line-height:1.6}

        /* Modal / Drawer */
        .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index:200;display:flex;align-items:flex-end;justify-content:center;backdrop-filter:blur(4px);animation:fadeIn 0.2s ease}
        .overlay.hidden{display:none}
        .drawer{width:640px;max-width:100vw;background:var(--bg-card);border-radius:16px 16px 0 0;max-height:90vh;overflow-y:auto;animation:slideUp 0.3s ease}
        .drawer::-webkit-scrollbar{width:4px}
        .drawer::-webkit-scrollbar-thumb{background:rgba(184,146,42,0.25);border-radius:2px}
        .drawer-head{padding:14px 18px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--bg-card);z-index:1}
        .drawer-title{font-family:'Cinzel',serif;font-size:13px;color:var(--gold-dark)}
        .drawer-x{width:28px;height:28px;border-radius:50%;border:1px solid var(--border);background:none;color:var(--text-faint);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
        .drawer-x:hover{border-color:var(--red);color:var(--red)}
        .drawer-body{padding:16px 18px 24px}

        /* Form */
        .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        .form-full{grid-column:1/-1}
        .form-group{display:flex;flex-direction:column;gap:5px}
        .form-label{font-family:'Cinzel',serif;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--text-faint)}
        .form-input,.form-select,.form-textarea{width:100%;background:var(--bg-input);border:1px solid var(--border);border-radius:8px;padding:9px 12px;color:var(--text-main);font-family:'Lato',sans-serif;font-size:13px;outline:none;transition:border-color 0.2s}
        .form-input::placeholder,.form-textarea::placeholder{color:var(--text-faint)}
        .form-input:focus,.form-select:focus,.form-textarea:focus{border-color:var(--gold-light);box-shadow:0 0 0 3px rgba(201,168,76,0.08)}
        .form-textarea{resize:none;height:72px;line-height:1.5}
        .form-select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23A89878' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;padding-right:28px}
        .form-toggle{display:flex;align-items:center;gap:8px}
        .form-toggle input[type=checkbox]{width:16px;height:16px;accent-color:var(--gold);cursor:pointer}
        .form-toggle span{font-size:13px;color:var(--text-main)}
        .form-section-title{font-family:'Cinzel',serif;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--text-faint);padding:10px 0 6px;border-bottom:1px solid var(--border);grid-column:1/-1;margin-top:4px}
        .form-actions{display:flex;gap:8px;margin-top:16px;grid-column:1/-1}
        .btn-save{flex:2;padding:11px;border-radius:8px;border:none;background:linear-gradient(135deg,var(--gold-dark),var(--gold-light));color:#fff;font-family:'Cinzel',serif;font-size:10px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:all 0.2s;box-shadow:0 2px 8px rgba(139,105,20,0.2)}
        .btn-save:hover{filter:brightness(1.08)}
        .btn-save:disabled{opacity:0.5;cursor:not-allowed}
        .btn-cancel-form{flex:1;padding:11px;border-radius:8px;border:1px solid var(--border);background:none;color:var(--text-muted);font-family:'Cinzel',serif;font-size:10px;letter-spacing:1px;cursor:pointer;transition:all 0.2s}
        .msg-form{padding:9px 12px;border-radius:8px;font-size:12px;margin-bottom:10px;display:none;grid-column:1/-1}
        .msg-form.error{background:var(--red-bg);border:1px solid var(--red-border);color:var(--red);display:block}
        .msg-form.success{background:var(--green-bg);border:1px solid var(--green-border);color:var(--green);display:block}

        /* Sub-list (lideres, instrutores dentro de form) */
        .sub-list{background:var(--bg-input);border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-top:4px}
        .sub-list-item{display:flex;align-items:center;gap:10px;padding:9px 12px;border-bottom:1px solid rgba(184,146,42,0.07)}
        .sub-list-item:last-child{border-bottom:none}
        .sub-list-nome{flex:1;font-size:12px;color:var(--text-main)}
        .sub-list-cargo{font-size:11px;color:var(--text-faint)}
        .sub-list-remove{padding:3px 8px;border-radius:6px;border:1px solid var(--red-border);background:var(--red-bg);color:var(--red);font-family:'Cinzel',serif;font-size:8px;cursor:pointer;flex-shrink:0}
        .sub-list-empty{padding:14px;text-align:center;font-size:12px;color:var(--text-faint)}
        .sub-add-row{display:flex;gap:6px;margin-top:8px;grid-column:1/-1}
        .sub-add-row .form-select{flex:1}
        .sub-add-row .form-input{flex:1}
        .btn-sub-add{padding:9px 14px;border-radius:8px;border:none;background:rgba(184,146,42,0.12);color:var(--gold-dark);font-family:'Cinzel',serif;font-size:9px;letter-spacing:1px;cursor:pointer;transition:all 0.2s;flex-shrink:0;border:1px solid rgba(184,146,42,0.2)}
        .btn-sub-add:hover{background:rgba(184,146,42,0.2)}

        @keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
        @keyframes spin{to{transform:rotate(360deg)}}
    </style>
</head>
<body>
<div class="page-wrapper">
    <div class="banner">
        <img src="banner zion.jpg" alt="Zion Lisboa" onerror="this.style.display='none';document.querySelector('.banner-fallback').classList.add('show');">
        <div class="banner-fallback"><div class="banner-title">ZION</div><div class="banner-sub">Lisboa · Portugal</div></div>
        <div class="banner-overlay"></div>
        <div class="banner-nav">
            <a href="index.html" class="back-btn">← Inicio</a>
            <span class="page-badge">Admin</span>
        </div>
    </div>
    <div class="gold-line"></div>
    <div class="user-bar">
        <div class="user-bar-info">
            <div class="user-bar-nome" id="top-user"></div>
            <div class="user-bar-tipo">Administrador</div>
        </div>
        <button class="logout-btn" onclick="ZionAuth.logout()">Sair</button>
    </div>

    <!-- Nav -->
    <div class="nav-bar" id="nav-bar">
        <div class="nav-item active" onclick="setSecao('pastores')">Pastores</div>
        <div class="nav-item" onclick="setSecao('links')">Links</div>
        <div class="nav-item" onclick="setSecao('cultos')">Cultos</div>
        <div class="nav-item" onclick="setSecao('ministerios')">Ministerios</div>
        <div class="nav-item" onclick="setSecao('salas')">Salas</div>
        <div class="nav-item" onclick="setSecao('cursos')">Cursos ZAO</div>
        <div class="nav-item" onclick="setSecao('keola')">Keola</div>
        <div class="nav-item" onclick="setSecao('loja')">Loja</div>
    </div>

    <!-- Content -->
    <div class="content" id="main-content">
        <div class="loading"><div class="spin"></div>A verificar acesso...</div>
    </div>
</div>

<!-- Drawer / Modal de form -->
<div class="overlay hidden" id="overlay" onclick="closeDrawerOutside(event)">
    <div class="drawer" id="drawer">
        <div class="drawer-head">
            <div class="drawer-title" id="drawer-title">Novo Registo</div>
            <button class="drawer-x" onclick="closeDrawer()">x</button>
        </div>
        <div class="drawer-body" id="drawer-body">
        </div>
    </div>
</div>

<script>
    ZionAuth.protect();
    const currentUser = ZionAuth.getUser();
    const SUPA_URL    = window.SUPABASE_URL || '';
    const SUPA_KEY    = window.SUPABASE_ANON_KEY || '';

    let secaoAtiva  = 'pastores';
    let subTabAtiva = 0;
    let registos    = [];
    let filtroInativo = false;
    let membros     = []; // para selects de lideres/instrutores

    // ── SUPABASE ───────────────────────────────────────────────
    async function sb(path, opts = {}) {
        const r = await fetch(`${SUPA_URL}/rest/v1/${path}`, {
            ...opts,
            headers:{
                'apikey':SUPA_KEY,'Authorization':`Bearer ${SUPA_KEY}`,
                'Content-Type':'application/json','Prefer':'return=representation',
                ...opts.headers
            }
        });
        if (!r.ok) { const e = await r.json().catch(()=>{}); throw e; }
        const txt = await r.text();
        return txt ? JSON.parse(txt) : [];
    }

    // ── INIT ───────────────────────────────────────────────────
    async function init() {
        document.getElementById('top-user').textContent = currentUser.nome?.split(' ')[0] || '';

        // Verifica acesso
        const check = await sb(`membros?select=e_admin,e_presbitero&email=eq.${encodeURIComponent(currentUser.email)}&ativo=eq.true`);
        const m = check?.[0];
        if (!m || (!m.e_admin && !m.e_presbitero)) {
            document.getElementById('nav-bar').style.display = 'none';
            document.getElementById('main-content').innerHTML = `
      <div class="acesso-negado">
        <div class="acesso-negado-icon">X</div>
        <div class="acesso-negado-title">Acesso Restrito</div>
        <div class="acesso-negado-txt">Esta area e exclusiva para Administradores e Presbiteros.</div>
      </div>`;
            return;
        }

        // Pre-carrega membros para selects
        membros = await sb('membros?select=id,nome&ativo=eq.true&order=nome') || [];
        await setSecao('pastores');
    }

    // ── SECOES ─────────────────────────────────────────────────
    async function setSecao(secao) {
        secaoAtiva    = secao;
        filtroInativo = false;
        subTabAtiva   = 0;

        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        const idx = ['pastores','links','cultos','ministerios','salas','cursos','keola','loja'];
        const ni  = document.querySelectorAll('.nav-item')[idx.indexOf(secao)];
        if (ni) ni.classList.add('active');

        await carregarSecao();
    }

    async function carregarSecao() {
        document.getElementById('main-content').innerHTML = '<div class="loading"><div class="spin"></div>A carregar...</div>';
        const cfg = SECOES[secaoAtiva];
        registos  = await sb(`${cfg.tabela}?select=*&order=${cfg.orderBy||'nome'}`) || [];
        renderSecao();
    }

    // ── CONFIG DAS SECOES ──────────────────────────────────────
    const SECOES = {
        pastores:    { tabela:'pastores',    label:'Pastores',       orderBy:'nome',      campos: camposPastores },
        links:       { tabela:'links',       label:'Links',          orderBy:'nome',      campos: camposLinks },
        cultos:      { tabela:'cultos',      label:'Cultos',         orderBy:'nome',      campos: camposCultos },
        ministerios: { tabela:'ministerios', label:'Ministerios',    orderBy:'nome',      campos: camposMinisterios, subTabs:['Ministerio','Lideres'] },
        salas:       { tabela:'salas',       label:'Salas',          orderBy:'nome',      campos: camposSalas },
        cursos:      { tabela:'zao_cursos',  label:'Cursos ZAO',     orderBy:'nome',      campos: camposCursos, subTabs:['Curso','Instrutores'] },
        keola:       { tabela:'keola_menu',  label:'Menu Keola',     orderBy:'categoria,nome', campos: camposKeola, ativoKey:'disponivel' },
        loja:        { tabela:'loja_produtos',label:'Loja',          orderBy:'categoria,nome', campos: camposLoja },
    };

    // ── RENDER SECAO ───────────────────────────────────────────
    function renderSecao() {
        const cfg      = SECOES[secaoAtiva];
        const ativoKey = cfg.ativoKey || 'ativo';
        const temSubTabs = !!cfg.subTabs;
        const q        = document.querySelector('.toolbar-search')?.value?.toLowerCase() || '';

        let lista = [...registos];
        if (!filtroInativo) lista = lista.filter(r => r[ativoKey] !== false);
        else lista = lista.filter(r => r[ativoKey] === false);
        if (q) lista = lista.filter(r => (r.nome||r.categoria||'').toLowerCase().includes(q));

        let html = `
    <div class="section-toolbar" style="top:0">
      <input class="toolbar-search" placeholder="Pesquisar..." oninput="renderSecao()">
      <button class="toolbar-filter ${filtroInativo?'active':''}" onclick="toggleFiltroInativo()">Inativos</button>
      <button class="btn-new" onclick="abrirForm(null)">+ Novo</button>
    </div>`;

        if (temSubTabs && subTabAtiva === 1) {
            html += renderSubTabLideres();
            document.getElementById('main-content').innerHTML = html;
            return;
        }

        if (temSubTabs) {
            html += `<div class="sub-tabs">
      ${cfg.subTabs.map((t,i)=>`<button class="sub-tab ${subTabAtiva===i?'active':''}" onclick="setSubTab(${i})">${t}</button>`).join('')}
    </div>`;
        }

        if (lista.length === 0) {
            html += `<div class="empty"><div class="empty-icon">-</div><div class="empty-txt">${filtroInativo?'Nenhum registo inativo.':'Nenhum registo. Clica em Novo.'}</div></div>`;
            document.getElementById('main-content').innerHTML = html;
            return;
        }

        html += '<div class="admin-list">';
        lista.forEach((r, i) => {
            const ativo    = r[ativoKey] !== false;
            const fotoHtml = r.foto_url || r.imagem_url
                ? `<div class="admin-row-foto"><img src="${r.foto_url||r.imagem_url}" alt="${r.nome}"></div>`
                : `<div class="admin-row-foto">${(r.nome||r.categoria||'-')[0]}</div>`;

            const sub = buildSub(r);
            const badges = buildBadges(r);

            html += `
      <div class="admin-row ${ativo?'':'inativo'}" style="animation-delay:${Math.min(i,12)*0.02}s">
        ${fotoHtml}
        <div class="admin-row-info">
          <div class="admin-row-nome">${r.nome||r.categoria||'-'}</div>
          ${sub ? `<div class="admin-row-sub">${sub}</div>` : ''}
          ${badges ? `<div class="admin-row-badges">${badges}</div>` : ''}
        </div>
        <div class="admin-row-actions">
          <button class="btn-edit" onclick="abrirForm('${r.id}')">Editar</button>
          <button class="btn-toggle ${ativo?'ativo':'inativo'}" onclick="toggleAtivo('${r.id}','${ativoKey}',${ativo})">${ativo?'Inativar':'Ativar'}</button>
        </div>
      </div>`;
        });
        html += '</div>';
        document.getElementById('main-content').innerHTML = html;
    }

    function buildSub(r) {
        const s = secaoAtiva;
        if (s==='pastores')    return [r.cargo,r.email].filter(Boolean).join(' — ');
        if (s==='links')       return [r.tipo,r.zona,r.dia].filter(Boolean).join(' · ');
        if (s==='cultos')      return [r.dia_semana,r.hora_inicio].filter(Boolean).join(' — ');
        if (s==='ministerios') return r.descricao?.substring(0,60)||'';
        if (s==='salas')       return [r.espaco,r.capacidade?r.capacidade+' pessoas':null].filter(Boolean).join(' · ');
        if (s==='cursos')      return [r.carga_horaria,r.gratuito?'Gratuito':r.valor?'€'+r.valor:null].filter(Boolean).join(' · ');
        if (s==='keola')       return [r.categoria,r.preco?'€'+Number(r.preco).toFixed(2):null].filter(Boolean).join(' · ');
        if (s==='loja')        return [r.categoria,r.preco?'€'+Number(r.preco).toFixed(2):null].filter(Boolean).join(' · ');
        return '';
    }

    function buildBadges(r) {
        const badges = [];
        if (r.online)        badges.push(`<span class="badge badge-gold">Online</span>`);
        if (r.recorrente)    badges.push(`<span class="badge badge-green">Recorrente</span>`);
        if (r.gratuito)      badges.push(`<span class="badge badge-green">Gratuito</span>`);
        if (r.especial_hoje) badges.push(`<span class="badge badge-gold">Especial hoje</span>`);
        if (r.destaque)      badges.push(`<span class="badge badge-gold">Destaque</span>`);
        if (r.disponivel===false || r.ativo===false) badges.push(`<span class="badge badge-gray">Inativo</span>`);
        return badges.join('');
    }

    function toggleFiltroInativo() {
        filtroInativo = !filtroInativo;
        renderSecao();
    }

    function setSubTab(idx) {
        subTabAtiva = idx;
        renderSecao();
    }

    // ── SUB-TAB LIDERES / INSTRUTORES ──────────────────────────
    function renderSubTabLideres() {
        const cfg     = SECOES[secaoAtiva];
        const isMin   = secaoAtiva === 'ministerios';
        const tabela  = isMin ? 'ministerio_lideres' : 'zao_curso_instrutores';
        const label   = isMin ? 'Lideres' : 'Instrutores';
        const parentLabel = isMin ? 'Ministerio' : 'Curso';

        return `
    <div class="sub-tabs">
      ${cfg.subTabs.map((t,i)=>`<button class="sub-tab ${subTabAtiva===i?'active':''}" onclick="setSubTab(${i})">${t}</button>`).join('')}
    </div>
    <div class="admin-list">
      <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:16px;text-align:center;color:var(--text-faint);font-size:13px;line-height:1.7">
        Para gerir ${label.toLowerCase()}, abre o registo do ${parentLabel.toLowerCase()} e edita a partir dai.
      </div>
    </div>`;
    }

    // ── TOGGLE ATIVO ───────────────────────────────────────────
    async function toggleAtivo(id, key, ativoAtual) {
        try {
            await sb(`${SECOES[secaoAtiva].tabela}?id=eq.${id}`, {
                method:'PATCH', body:JSON.stringify({[key]: !ativoAtual})
            });
            await carregarSecao();
        } catch(e) { alert('Erro ao alterar estado.'); }
    }

    // ── FORM ───────────────────────────────────────────────────
    async function abrirForm(id) {
        const cfg     = SECOES[secaoAtiva];
        const registo = id ? registos.find(r=>r.id===id) : null;
        const isNovo  = !registo;

        document.getElementById('drawer-title').textContent = isNovo ? `Novo ${cfg.label}` : `Editar ${cfg.label}`;
        document.getElementById('drawer-body').innerHTML    = buildForm(cfg, registo);
        document.getElementById('overlay').classList.remove('hidden');
        document.body.style.overflow = 'hidden';

        // Se for ministerios/cursos com lideres/instrutores, carrega lista
        if (!isNovo && (secaoAtiva==='ministerios'||secaoAtiva==='cursos')) {
            await carregarSubList(registo.id);
        }
    }

    function buildForm(cfg, r) {
        const campos = typeof cfg.campos === 'function' ? cfg.campos(r) : cfg.campos;
        let html = `<div class="form-grid"><div class="msg-form" id="form-msg"></div>`;
        campos.forEach(c => {
            if (c.type === 'section') {
                html += `<div class="form-section-title">${c.label}</div>`;
                return;
            }
            const val = r?.[c.key] ?? c.default ?? '';
            const fullClass = c.full ? 'form-full' : '';
            if (c.type === 'checkbox') {
                html += `<div class="form-group ${fullClass}"><label class="form-toggle"><input type="checkbox" id="f_${c.key}" ${val?'checked':''}><span>${c.label}</span></label></div>`;
            } else if (c.type === 'select') {
                const opts = c.options.map(o => `<option value="${o.v}" ${val==o.v?'selected':''}>${o.l}</option>`).join('');
                html += `<div class="form-group ${fullClass}"><label class="form-label">${c.label}</label><select class="form-select" id="f_${c.key}"><option value="">-- Seleciona --</option>${opts}</select></div>`;
            } else if (c.type === 'textarea') {
                html += `<div class="form-group ${fullClass}"><label class="form-label">${c.label}</label><textarea class="form-textarea" id="f_${c.key}" placeholder="${c.ph||''}">${val}</textarea></div>`;
            } else {
                html += `<div class="form-group ${fullClass}"><label class="form-label">${c.label}</label><input class="form-input" id="f_${c.key}" type="${c.type||'text'}" placeholder="${c.ph||''}" value="${val}"></div>`;
            }
        });

        // Sub-list de lideres/instrutores se for edição
        if (r && (secaoAtiva==='ministerios'||secaoAtiva==='cursos')) {
            const sublabel = secaoAtiva==='ministerios' ? 'Lideres' : 'Instrutores';
            html += `
      <div class="form-section-title">${sublabel}</div>
      <div class="form-full">
        <div class="sub-list" id="sub-list"><div class="sub-list-empty">A carregar...</div></div>
      </div>
      <div class="sub-add-row">
        <select class="form-select" id="sub-membro-id"><option value="">Seleciona membro</option>${membros.map(m=>`<option value="${m.id}">${m.nome}</option>`).join('')}</select>
        <input class="form-input" id="sub-cargo" placeholder="Cargo" style="max-width:130px">
        <button class="btn-sub-add" onclick="addSubItem('${r.id}')">Adicionar</button>
      </div>`;
        }

        // Se cursos, campo nome_instrutor tambem
        if (r && secaoAtiva==='cursos') {
            html = html.replace(
                `<button class="btn-sub-add" onclick="addSubItem('${r.id}')">Adicionar</button>`,
                `<input class="form-input" id="sub-nome-instrutor" placeholder="Nome (se nao membro)" style="max-width:130px"><button class="btn-sub-add" onclick="addSubItem('${r.id}')">Adicionar</button>`
            );
        }

        html += `
    <div class="form-actions">
      <button class="btn-cancel-form" onclick="closeDrawer()">Cancelar</button>
      <button class="btn-save" id="btn-save" onclick="salvar('${r?.id||''}')">Guardar</button>
    </div>
  </div>`;
        return html;
    }

    // ── GUARDAR ────────────────────────────────────────────────
    async function salvar(id) {
        const cfg    = SECOES[secaoAtiva];
        const isNovo = !id;
        const campos = typeof cfg.campos === 'function' ? cfg.campos(null) : cfg.campos;
        const body   = {};

        campos.forEach(c => {
            if (c.type==='section') return;
            const el = document.getElementById(`f_${c.key}`);
            if (!el) return;
            if (c.type==='checkbox') body[c.key] = el.checked;
            else if (c.type==='number') body[c.key] = el.value ? Number(el.value) : null;
            else body[c.key] = el.value || null;
        });

        if (cfg.ativoKey && !(cfg.ativoKey in body) && isNovo) body[cfg.ativoKey] = true;
        if (!('ativo' in body) && isNovo && cfg.tabela !== 'keola_menu') body.ativo = true;

        const btn = document.getElementById('btn-save');
        btn.disabled = true; btn.textContent = 'A guardar...';

        try {
            if (isNovo) {
                await sb(cfg.tabela, { method:'POST', body:JSON.stringify(body) });
            } else {
                await sb(`${cfg.tabela}?id=eq.${id}`, { method:'PATCH', body:JSON.stringify(body) });
            }
            showFormMsg('Guardado com sucesso!', 'success');
            await carregarSecao();
            setTimeout(closeDrawer, 800);
        } catch(e) {
            showFormMsg(`Erro: ${e?.message||e?.details||JSON.stringify(e)}`, 'error');
            btn.disabled = false; btn.textContent = 'Guardar';
        }
    }

    function showFormMsg(txt, tipo) {
        const el = document.getElementById('form-msg');
        if (!el) return;
        el.textContent = txt; el.className = `msg-form ${tipo}`;
        el.scrollIntoView({behavior:'smooth',block:'nearest'});
    }

    // ── SUB-ITEMS (lideres / instrutores) ──────────────────────
    async function carregarSubList(parentId) {
        const isMin   = secaoAtiva === 'ministerios';
        const tabela  = isMin ? 'ministerio_lideres' : 'zao_curso_instrutores';
        const fkKey   = isMin ? 'ministerio_id' : 'curso_id';
        const items   = await sb(`${tabela}?select=*&${fkKey}=eq.${parentId}&order=created_at`) || [];
        const el      = document.getElementById('sub-list');
        if (!el) return;

        if (!items.length) {
            el.innerHTML = '<div class="sub-list-empty">Sem registos.</div>';
            return;
        }

        el.innerHTML = items.map(item => {
            const membro = membros.find(m=>m.id===item.membro_id);
            const nome   = membro?.nome || item.nome_instrutor || '—';
            return `
      <div class="sub-list-item">
        <div class="sub-list-nome">${nome}</div>
        <div class="sub-list-cargo">${item.cargo||''}</div>
        <button class="sub-list-remove" onclick="removeSubItem('${item.id}','${tabela}','${parentId}')">Remover</button>
      </div>`;
        }).join('');
    }

    async function addSubItem(parentId) {
        const isMin   = secaoAtiva === 'ministerios';
        const tabela  = isMin ? 'ministerio_lideres' : 'zao_curso_instrutores';
        const fkKey   = isMin ? 'ministerio_id' : 'curso_id';
        const memId   = document.getElementById('sub-membro-id')?.value;
        const cargo   = document.getElementById('sub-cargo')?.value;
        const nomeExt = document.getElementById('sub-nome-instrutor')?.value;

        if (!memId && !nomeExt) { alert('Seleciona um membro ou indica um nome.'); return; }

        const body = { [fkKey]: parentId, cargo: cargo||null };
        if (memId) body.membro_id = memId;
        if (!isMin && nomeExt) body.nome_instrutor = nomeExt;

        try {
            await sb(tabela, { method:'POST', body:JSON.stringify(body) });
            await carregarSubList(parentId);
            if(document.getElementById('sub-membro-id')) document.getElementById('sub-membro-id').value = '';
            if(document.getElementById('sub-cargo')) document.getElementById('sub-cargo').value = '';
            if(document.getElementById('sub-nome-instrutor')) document.getElementById('sub-nome-instrutor').value = '';
        } catch(e) { alert('Erro ao adicionar.'); }
    }

    async function removeSubItem(itemId, tabela, parentId) {
        if (!confirm('Remover?')) return;
        await sb(`${tabela}?id=eq.${itemId}`, { method:'DELETE' });
        await carregarSubList(parentId);
    }

    // ── DRAWER ─────────────────────────────────────────────────
    function closeDrawer() {
        document.getElementById('overlay').classList.add('hidden');
        document.body.style.overflow = '';
    }
    function closeDrawerOutside(e) {
        if (e.target === document.getElementById('overlay')) closeDrawer();
    }
    document.addEventListener('keydown', e => { if (e.key==='Escape') closeDrawer(); });

    // ══════════════════════════════════════════════════════════
    // CAMPOS DAS SECOES
    // ══════════════════════════════════════════════════════════

    function camposPastores() { return [
        {key:'nome',       label:'Nome',         ph:'Nome completo',      full:true},
        {key:'cargo',      label:'Cargo',        ph:'Ex: Pastor Principal'},
        {key:'email',      label:'Email',        type:'email',            ph:'email@exemplo.com'},
        {key:'telefone',   label:'Telefone',     ph:'+351 9XX XXX XXX'},
        {key:'instagram',  label:'Instagram',    ph:'@handle'},
        {key:'foto_url',   label:'Foto URL',     ph:'https://...',        full:true},
        {key:'bio',        label:'Biografia',    type:'textarea',         ph:'Breve biografia...', full:true},
        {key:'ativo',      label:'Ativo',        type:'checkbox',         default:true},
    ];}

    function camposLinks() { return [
        {key:'nome',          label:'Nome',           ph:'Ex: LINK Montijo',       full:true},
        {key:'tipo',          label:'Tipo',           type:'select', options:[
                {v:'Familias',l:'Familias'},{v:'FLOW',l:'FLOW'},{v:'VOX',l:'VOX'},{v:'Diamantes',l:'Diamantes'},{v:'EKLECTOS',l:'EKLECTOS'}
            ]},
        {key:'faixa_etaria',  label:'Faixa Etaria',   ph:'Ex: 18-35 anos'},
        {key:'responsavel',   label:'Responsavel',    ph:'Nome do lider',          full:true},
        {key:'co_responsavel',label:'Co-Responsavel', ph:'Nome do co-lider',       full:true},
        {key:'dia',           label:'Dia',            type:'select', options:[
                {v:'Segunda-feira',l:'Segunda-feira'},{v:'Terca-feira',l:'Terca-feira'},
                {v:'Quarta-feira',l:'Quarta-feira'},{v:'Quinta-feira',l:'Quinta-feira'},
                {v:'Sexta-feira',l:'Sexta-feira'},{v:'Sabado',l:'Sabado'},{v:'Domingo',l:'Domingo'}
            ]},
        {key:'horario',       label:'Horario',        ph:'Ex: 20h00'},
        {key:'zona',          label:'Zona',           ph:'Ex: Montijo'},
        {key:'morada',        label:'Morada',         ph:'Rua...',                 full:true},
        {key:'contato',       label:'Contato (WhatsApp)', ph:'+351 9XX XXX XXX',  full:true},
        {key:'online',        label:'E Online',       type:'checkbox'},
        {key:'ativo',         label:'Ativo',          type:'checkbox', default:true},
    ];}

    function camposCultos() { return [
        {key:'nome',           label:'Nome',          ph:'Ex: Culto de Domingo',    full:true},
        {key:'dia_semana',     label:'Dia da Semana', type:'select', options:[
                {v:'Domingo',l:'Domingo'},{v:'Segunda-feira',l:'Segunda-feira'},
                {v:'Terca-feira',l:'Terca-feira'},{v:'Quarta-feira',l:'Quarta-feira'},
                {v:'Quinta-feira',l:'Quinta-feira'},{v:'Sexta-feira',l:'Sexta-feira'},{v:'Sabado',l:'Sabado'}
            ]},
        {key:'hora_inicio',    label:'Hora Inicio',   type:'time'},
        {key:'hora_fim',       label:'Hora Fim',      type:'time'},
        {key:'recorrente',     label:'Recorrente',    type:'checkbox', default:true},
        {key:'data_especifica',label:'Data Especifica (se nao recorrente)', type:'date', full:true},
        {key:'descricao',      label:'Descricao',     type:'textarea', ph:'Descricao do culto...', full:true},
        {key:'ativo',          label:'Ativo',         type:'checkbox', default:true},
    ];}

    function camposMinisterios() { return [
        {key:'nome',        label:'Nome',         ph:'Ex: Ministerio de Louvor',  full:true},
        {key:'slug',        label:'Slug',         ph:'Ex: louvor'},
        {key:'faixa_etaria',label:'Faixa Etaria', ph:'Ex: Todas as idades'},
        {key:'instagram',   label:'Instagram',    ph:'@handle'},
        {key:'descricao',   label:'Descricao',    type:'textarea', ph:'Descricao do ministerio...', full:true},
        {key:'ativo',       label:'Ativo',        type:'checkbox', default:true},
    ];}

    function camposSalas() { return [
        {key:'nome',          label:'Nome',         ph:'Ex: Sala Principal',  full:true},
        {key:'espaco',        label:'Espaco',       ph:'Ex: Piso 1'},
        {key:'capacidade',    label:'Capacidade',   type:'number', ph:'Ex: 20'},
        {key:'hora_inicio',   label:'Hora Abertura',type:'time'},
        {key:'hora_fim',      label:'Hora Fecho',   type:'time'},
        {key:'descricao',     label:'Descricao',    type:'textarea', ph:'Descricao da sala...', full:true},
        {key:'aviso_entrega', label:'Aviso de Entrega', type:'textarea', ph:'Ex: Entregar limpa...', full:true},
        {key:'foto_url',      label:'Foto URL',     ph:'https://...', full:true},
        {key:'google_calendar_id', label:'Google Calendar ID', ph:'calendar@group.calendar.google.com', full:true},
        {type:'section', label:'Equipamentos'},
        {key:'tem_som',       label:'Som',          type:'checkbox'},
        {key:'tem_iluminacao',label:'Iluminacao',   type:'checkbox'},
        {key:'tem_projecao',  label:'Projecao',     type:'checkbox'},
        {key:'tem_mesas',     label:'Mesas',        type:'checkbox'},
        {key:'tem_cadeiras',  label:'Cadeiras',     type:'checkbox'},
        {key:'ativo',         label:'Ativo',        type:'checkbox', default:true},
    ];}

    function camposCursos() { return [
        {key:'nome',          label:'Nome',           ph:'Ex: Curso de Louvor',   full:true},
        {key:'carga_horaria', label:'Carga Horaria',  ph:'Ex: 40 horas'},
        {key:'valor',         label:'Valor (€)',      type:'number', ph:'0.00'},
        {key:'gratuito',      label:'Gratuito',       type:'checkbox'},
        {key:'descricao',     label:'Descricao',      type:'textarea', ph:'Descricao do curso...', full:true},
        {key:'ativo',         label:'Ativo',          type:'checkbox', default:true},
    ];}

    function camposKeola() { return [
        {key:'nome',          label:'Nome',          ph:'Ex: Cafe Especial',  full:true},
        {key:'categoria',     label:'Categoria',     ph:'Ex: Bebidas'},
        {key:'preco',         label:'Preco (€)',     type:'number', ph:'0.00'},
        {key:'ordem',         label:'Ordem',         type:'number', ph:'1'},
        {key:'descricao',     label:'Descricao',     type:'textarea', ph:'Descricao...', full:true},
        {key:'imagem_url',    label:'Imagem URL',    ph:'https://...',        full:true},
        {key:'disponivel',    label:'Disponivel',    type:'checkbox', default:true},
        {key:'especial_hoje', label:'Especial Hoje', type:'checkbox'},
    ];}

    function camposLoja() { return [
        {key:'nome',             label:'Nome',              ph:'Ex: Camisola ZION',  full:true},
        {key:'categoria',        label:'Categoria',         ph:'Ex: Vestuario'},
        {key:'preco',            label:'Preco (€)',         type:'number', ph:'0.00'},
        {key:'preco_promocional',label:'Preco Promocional', type:'number', ph:'0.00'},
        {key:'stock',            label:'Stock',             type:'number', ph:'0'},
        {key:'ordem',            label:'Ordem',             type:'number', ph:'1'},
        {key:'descricao',        label:'Descricao',         type:'textarea', ph:'Descricao do produto...', full:true},
        {key:'imagem_url',       label:'Imagem URL',        ph:'https://...',        full:true},
        {key:'disponivel',       label:'Disponivel',        type:'checkbox', default:true},
        {key:'destaque',         label:'Destaque',          type:'checkbox'},
    ];}

    init();
</script>
</body>
</html>
