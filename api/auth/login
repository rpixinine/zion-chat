import { createClient } from "@supabase/supabase-js";
import bcrypt from "bcryptjs";
import jwt from "jsonwebtoken";

const supabase = createClient(
    process.env.SUPABASE_URL,
    process.env.SUPABASE_SERVICE_KEY  // service key para auth (não anon)
);

export default async function handler(req, res) {
    res.setHeader("Access-Control-Allow-Origin", "*");
    res.setHeader("Access-Control-Allow-Methods", "POST, OPTIONS");
    res.setHeader("Access-Control-Allow-Headers", "Content-Type");
    if (req.method === "OPTIONS") return res.status(200).end();
    if (req.method !== "POST") return res.status(405).json({ error: "Method Not Allowed" });

    try {
        const { email, password } = req.body;

        if (!email || !password)
            return res.status(400).json({ error: "Email e password obrigatórios." });

        // Busca utilizador
        const { data: user, error } = await supabase
            .from("usuarios")
            .select("id, nome, email, password_hash, tipo, membro_id, visitante_id, ativo")
            .eq("email", email.toLowerCase().trim())
            .single();

        if (error || !user)
            return res.status(401).json({ error: "Email ou password incorretos." });

        if (!user.ativo)
            return res.status(401).json({ error: "Conta desativada. Fala com a equipa da Zion." });

        // Verifica password
        const valid = await bcrypt.compare(password, user.password_hash);
        if (!valid)
            return res.status(401).json({ error: "Email ou password incorretos." });

        // Gera token JWT
        const token = jwt.sign(
            { id: user.id, email: user.email, tipo: user.tipo },
            process.env.JWT_SECRET,
            { expiresIn: "7d" }
        );

        return res.status(200).json({
            token,
            user: {
                id:          user.id,
                nome:        user.nome,
                email:       user.email,
                tipo:        user.tipo,
                membro_id:   user.membro_id,
                visitante_id: user.visitante_id,
            }
        });

    } catch (err) {
        console.error("[auth/login]", err);
        return res.status(500).json({ error: "Erro interno. Tenta novamente." });
    }
}
