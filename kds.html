<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tela de Chamada — Zion Keola</title>
<script src="config.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Lato:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root {
    --primary:       #009098;
    --primary-dark:  #007078;
    --primary-light: #00b0b8;
    --primary-faint: rgba(0,144,152,0.08);
    --primary-soft:  rgba(0,144,152,0.14);
    --gold:          #c09040;
    --red:           #c0392b;
    --green:         #2e7d32;
    --green-light:   #388e3c;
    --orange:        #e65100;
    --bg-page:       #f0f4f4;
    --bg-card:       #ffffff;
    --bg-input:      #f5fafa;
    --bg-panel:      #eaf2f2;
    --text-main:     #0a2020;
    --text-muted:    #4a6a6a;
    --text-faint:    #7a9a9a;
    --border:        rgba(0,144,152,0.18);
    --border-md:     rgba(0,144,152,0.30);
    --font-title:    'Cinzel', serif;
    --font-body:     'Lato', sans-serif;
    --shadow:        0 2px 10px rgba(0,112,120,0.09);
    --shadow-md:     0 4px 24px rgba(0,112,120,0.14);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; font-family: var(--font-body); background: var(--bg-page); color: var(--text-main); overflow: hidden; }

.header {
    background: var(--bg-card); border-bottom: 1px solid var(--border);
    height: 50px; display: flex; align-items: center;
    padding: 0 20px; gap: 12px; flex-shrink: 0;
    box-shadow: var(--shadow); z-index: 50;
}
.header-logo { font-family: var(--font-title); font-size: 14px; font-weight: 700; color: var(--primary-dark); letter-spacing: 4px; text-transform: uppercase; }
.header-divider { width: 1px; height: 18px; background: var(--border); }
.header-sub { font-family: var(--font-title); font-size: 9px; letter-spacing: 3px; text-transform: uppercase; color: var(--text-faint); }
.header-right { margin-left: auto; display: flex; align-items: center; gap: 16px; }
.header-clock { font-family: var(--font-title); font-size: 13px; color: var(--text-muted); letter-spacing: 2px; }
.header-date  { font-size: 11px; color: var(--text-faint); }
.header-update { font-size: 10px; color: var(--text-faint); font-family: var(--font-title); letter-spacing: 1px; }
.gold-stripe { height: 2px; background: linear-gradient(90deg, transparent 0%, var(--gold) 40%, var(--primary) 60%, transparent 100%); flex-shrink: 0; }

.main { display: grid; grid-template-columns: 1fr 1px 1fr; height: calc(100vh - 52px); }
.coluna-sep { background: var(--border); }
.coluna { display: flex; flex-direction: column; overflow: hidden; }

.coluna-header {
    padding: 14px 20px 12px; background: var(--bg-card);
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
}
.coluna-titulo { font-family: var(--font-title); font-size: 10px; letter-spacing: 3px; text-transform: uppercase; }
.col-prep   .coluna-titulo { color: var(--orange); }
.col-pronto .coluna-titulo { color: var(--green); }

.coluna-count {
    font-family: var(--font-title); font-size: 24px; font-weight: 700;
    width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 10px;
}
.col-prep   .coluna-count { color: var(--orange); background: rgba(230,81,0,0.07); border: 1px solid rgba(230,81,0,0.18); }
.col-pronto .coluna-count { color: var(--green);  background: rgba(46,125,50,0.07); border: 1px solid rgba(46,125,50,0.2); }

.cards-grid {
    flex: 1; overflow-y: auto;
    display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 14px; padding: 16px; align-content: start;
}
.cards-grid::-webkit-scrollbar { width: 4px; }
.cards-grid::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

.pedido-card {
    background: var(--bg-card); border-radius: 12px; padding: 16px;
    display: flex; flex-direction: column; gap: 10px;
    box-shadow: var(--shadow); animation: fadeUp 0.25s ease;
    border: 1px solid var(--border); border-left: 3px solid transparent;
}
@keyframes fadeUp { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }
.col-prep   .pedido-card { border-left-color: var(--orange); }
.col-pronto .pedido-card { border-left-color: var(--green); }

.card-numero { font-family: var(--font-title); font-size: 38px; font-weight: 700; line-height: 1; text-align: center; letter-spacing: -1px; }
.col-prep   .card-numero { color: var(--orange); }
.col-pronto .card-numero { color: var(--green); }

.card-nome { font-size: 14px; font-weight: 700; text-align: center; color: var(--text-main); border-top: 1px solid var(--border); padding-top: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

.card-itens { font-size: 12px; color: var(--text-muted); line-height: 1.7; background: var(--bg-panel); border-radius: 8px; padding: 8px 10px; }
.card-item-linha { display: flex; gap: 6px; align-items: baseline; }
.card-item-qty { font-family: var(--font-title); font-size: 12px; font-weight: 700; min-width: 22px; }
.col-prep   .card-item-qty { color: var(--orange); }
.col-pronto .card-item-qty { color: var(--green); }

.card-tempo { font-family: var(--font-title); font-size: 9px; letter-spacing: 1.5px; text-transform: uppercase; text-align: center; color: var(--text-faint); }
.card-tempo.urgente { color: var(--red); animation: blink 1.2s ease-in-out infinite; }
@keyframes blink { 0%,100% { opacity:1; } 50% { opacity:0.35; } }

.btn-retirar {
    width: 100%; padding: 10px 14px; border-radius: 8px;
    border: 1px solid rgba(46,125,50,0.3); background: rgba(46,125,50,0.07);
    font-family: var(--font-title); font-size: 10px; letter-spacing: 1.5px; text-transform: uppercase;
    color: var(--green); cursor: pointer; transition: all 0.15s;
}
.btn-retirar:hover { background: rgba(46,125,50,0.15); border-color: var(--green); }
.btn-retirar:active { transform: scale(0.98); }

.empty-col { grid-column: 1/-1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px; gap: 10px; }
.empty-sep  { width: 32px; height: 2px; background: var(--border); border-radius: 2px; margin-bottom: 4px; }
.empty-txt  { font-family: var(--font-title); font-size: 10px; letter-spacing: 2px; color: var(--text-faint); }

.toast {
    position: fixed; bottom: 24px; left: 50%;
    transform: translateX(-50%) translateY(10px);
    background: var(--primary-dark); color: white;
    padding: 10px 24px; border-radius: 30px;
    font-family: var(--font-title); font-size: 11px; letter-spacing: 1px;
    opacity: 0; transition: all 0.3s; pointer-events: none;
    box-shadow: var(--shadow-md); z-index: 200;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
</style>
</head>
<body>

<div class="header">
    <div class="header-logo">Zion Lisboa</div>
    <div class="header-divider"></div>
    <div class="header-sub">Tela de Chamada</div>
    <div class="header-right">
        <div class="header-date"  id="date-str"></div>
        <div class="header-divider"></div>
        <div class="header-clock" id="clock">--:--</div>
        <div class="header-divider"></div>
        <div class="header-update" id="ultimo-update">—</div>
    </div>
</div>
<div class="gold-stripe"></div>

<div class="main">
    <div class="coluna col-prep">
        <div class="coluna-header">
            <div class="coluna-titulo">Em Preparacao</div>
            <div class="coluna-count" id="count-prep">0</div>
        </div>
        <div class="cards-grid" id="grid-prep"></div>
    </div>
    <div class="coluna-sep"></div>
    <div class="coluna col-pronto">
        <div class="coluna-header">
            <div class="coluna-titulo">Pronto para Retirada</div>
            <div class="coluna-count" id="count-pronto">0</div>
        </div>
        <div class="cards-grid" id="grid-pronto"></div>
    </div>
</div>

<div class="toast" id="toast"></div>

<script>
const SUPA_URL = window.SUPABASE_URL      || '';
const SUPA_KEY = window.SUPABASE_ANON_KEY || '';

async function sb(path, opts={}) {
    const r = await fetch(`${SUPA_URL}/rest/v1/${path}`, {
        ...opts, headers: { apikey:SUPA_KEY, Authorization:`Bearer ${SUPA_KEY}`, 'Content-Type':'application/json', Prefer:'return=representation', ...opts.headers },
    });
    if (!r.ok) { const e = await r.json().catch(()=>{}); throw e; }
    const t = await r.text(); return t ? JSON.parse(t) : [];
}

function tickClock() {
    const now = new Date();
    document.getElementById('clock').textContent = now.toLocaleTimeString('pt-PT', {hour:'2-digit', minute:'2-digit'});
    document.getElementById('date-str').textContent = now.toLocaleDateString('pt-PT', {weekday:'long', day:'numeric', month:'long'}).replace(/^\w/, c => c.toUpperCase());
}
tickClock(); setInterval(tickClock, 1000);

let idsProntoAntes = new Set();

function mins(ts) { return Math.floor((Date.now() - new Date(ts)) / 60000); }
function textoTempo(ts) { const m=mins(ts); return m<1?'Agora mesmo':m===1?'1 min':`${m} min`; }
function isUrgente(ts, status) { const m=mins(ts); return (status==='em_preparacao'&&m>15)||(status==='pronto'&&m>5); }

function renderColuna(pedidos, gridId, status) {
    const grid = document.getElementById(gridId);
    if (!pedidos.length) {
        grid.innerHTML = `<div class="empty-col"><div class="empty-sep"></div><div class="empty-txt">${status==='em_preparacao'?'Nenhum pedido em preparacao':'Nenhum pedido pronto'}</div></div>`;
        return;
    }
    grid.innerHTML = pedidos.map(p => {
        const ts = p.updated_at || p.created_at;
        const urgente = isUrgente(ts, status);
        const itensHtml = (p.itens||[]).map(it =>
            `<div class="card-item-linha"><span class="card-item-qty">${Number(it.quantidade)}x</span><span>${it.produto_nome}</span></div>`
        ).join('');
        const btnRetirar = status==='pronto'
            ? `<button class="btn-retirar" onclick="marcarEntregue('${p.id}')">Retirado</button>` : '';
        return `<div class="pedido-card">
            <div class="card-numero">#${String(p.numero).padStart(2,'0')}</div>
            <div class="card-nome">${p.nome_cliente||'Anonimo'}</div>
            ${itensHtml?`<div class="card-itens">${itensHtml}</div>`:''}
            <div class="card-tempo ${urgente?'urgente':''}">${textoTempo(ts)}</div>
            ${btnRetirar}
        </div>`;
    }).join('');
}

async function carregar() {
    const hoje = new Date().toISOString().split('T')[0];
    const peds = await sb(`pedidos?select=*&data_pedido=eq.${hoje}&status=in.(em_preparacao,pronto)&order=numero.asc`).catch(()=>[]);
    const pedIds = (peds||[]).map(p=>p.id);
    let itensMap = {};
    if (pedIds.length) {
        const all = await sb(`pedido_itens?select=*&pedido_id=in.(${pedIds.join(',')})&order=created_at`).catch(()=>[]);
        (all||[]).forEach(it=>{ if(!itensMap[it.pedido_id])itensMap[it.pedido_id]=[]; itensMap[it.pedido_id].push(it); });
    }
    const todos   = (peds||[]).map(p=>({...p, itens:itensMap[p.id]||[]}));
    const emPrep  = todos.filter(p=>p.status==='em_preparacao');
    const prontos = todos.filter(p=>p.status==='pronto');

    prontos.forEach(p => { if(!idsProntoAntes.has(p.id)) showToast(`Pedido #${String(p.numero).padStart(2,'0')} pronto — ${p.nome_cliente||'Anonimo'}`); });
    idsProntoAntes = new Set(prontos.map(p=>p.id));

    document.getElementById('count-prep').textContent   = emPrep.length;
    document.getElementById('count-pronto').textContent = prontos.length;
    renderColuna(emPrep,  'grid-prep',   'em_preparacao');
    renderColuna(prontos, 'grid-pronto', 'pronto');
    document.getElementById('ultimo-update').textContent = new Date().toLocaleTimeString('pt-PT', {hour:'2-digit',minute:'2-digit',second:'2-digit'});
}

async function marcarEntregue(id) {
    await sb(`pedidos?id=eq.${id}`, {method:'PATCH', body:JSON.stringify({status:'entregue',updated_at:new Date().toISOString()})}).catch(console.error);
    await carregar();
}

function showToast(msg) {
    const el = document.getElementById('toast');
    el.textContent = msg; el.classList.add('show');
    setTimeout(()=>el.classList.remove('show'), 3500);
}

carregar();
setInterval(carregar, 8000);
</script>
</body>
</html>
