<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tela de Chamada â€” Zion Keola</title>
<script src="config.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&family=Lato:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root {
    --primary:      #009098;
    --primary-dark: #007078;
    --orange:       #e65100;
    --green:        #2e7d32;
    --green-light:  #43a047;
    --bg:           #0a1a1a;
    --bg-card:      #0f2424;
    --bg-prep:      #1a1200;
    --bg-pronto:    #0a1a0a;
    --border:       rgba(0,144,152,0.2);
    --text:         #e0f0f0;
    --text-faint:   #5a8080;
    --font-title:   'Cinzel', serif;
    --font-body:    'Lato', sans-serif;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; background: var(--bg); color: var(--text); font-family: var(--font-body); overflow: hidden; }

/* â”€â”€ HEADER â”€â”€ */
.header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 24px; height: 56px;
    background: #050e0e;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
}
.header-logo { font-family: var(--font-title); font-size: 16px; color: var(--primary); letter-spacing: 3px; }
.header-clock { font-family: var(--font-title); font-size: 20px; color: var(--text); letter-spacing: 2px; }
.header-date  { font-size: 11px; color: var(--text-faint); letter-spacing: 1px; }

/* â”€â”€ COLUNAS â”€â”€ */
.main {
    display: grid;
    grid-template-columns: 1fr 1fr;
    height: calc(100vh - 56px);
    gap: 0;
}
.coluna {
    display: flex; flex-direction: column;
    overflow: hidden;
    border-right: 1px solid var(--border);
}
.coluna:last-child { border-right: none; }

.coluna-header {
    padding: 14px 20px 12px;
    display: flex; align-items: baseline; gap: 12px;
    flex-shrink: 0;
}
.coluna-titulo {
    font-family: var(--font-title); font-size: 11px; letter-spacing: 3px;
    text-transform: uppercase;
}
.col-prep   .coluna-titulo { color: var(--orange); }
.col-pronto .coluna-titulo { color: var(--green-light); }
.coluna-count {
    font-family: var(--font-title); font-size: 28px; font-weight: 900;
}
.col-prep   .coluna-count { color: var(--orange); }
.col-pronto .coluna-count { color: var(--green-light); }
.coluna-divider {
    height: 1px; background: var(--border); flex-shrink: 0; margin: 0 16px;
}

.cards-grid {
    flex: 1; overflow-y: auto;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 12px;
    padding: 14px 16px;
    align-content: start;
}

/* â”€â”€ CARTÃƒO DE PEDIDO â”€â”€ */
.pedido-card {
    border-radius: 14px; padding: 16px;
    display: flex; flex-direction: column; gap: 10px;
    animation: slideIn 0.3s cubic-bezier(0.4,0,0.2,1);
    transition: transform 0.15s;
}
.pedido-card:hover { transform: scale(1.02); }

@keyframes slideIn {
    from { opacity: 0; transform: translateY(12px) scale(0.97); }
    to   { opacity: 1; transform: translateY(0) scale(1); }
}

.col-prep .pedido-card {
    background: var(--bg-prep);
    border: 1px solid rgba(230,81,0,0.25);
    box-shadow: 0 0 20px rgba(230,81,0,0.08);
}
.col-pronto .pedido-card {
    background: var(--bg-pronto);
    border: 1px solid rgba(46,125,50,0.3);
    box-shadow: 0 0 20px rgba(46,125,50,0.1);
}

/* NÃºmero destaque */
.card-numero {
    font-family: var(--font-title); font-size: 40px; font-weight: 900;
    line-height: 1; letter-spacing: -1px;
    text-align: center;
}
.col-prep   .card-numero { color: var(--orange); }
.col-pronto .card-numero { color: var(--green-light); }

/* Nome do cliente */
.card-nome {
    font-size: 15px; font-weight: 700; text-align: center;
    color: var(--text); letter-spacing: 0.5px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}

/* Itens */
.card-itens {
    font-size: 11px; color: var(--text-faint);
    line-height: 1.7; border-top: 1px solid rgba(255,255,255,0.05);
    padding-top: 8px;
}
.card-item-linha { display: flex; gap: 6px; align-items: baseline; }
.card-item-qty {
    font-family: var(--font-title); font-size: 13px; font-weight: 700;
    min-width: 20px;
}
.col-prep   .card-item-qty { color: var(--orange); }
.col-pronto .card-item-qty { color: var(--green-light); }

/* Tempo */
.card-tempo {
    font-size: 10px; text-align: center; letter-spacing: 1px;
    padding: 4px 8px; border-radius: 20px;
    font-family: var(--font-title);
}
.col-prep .card-tempo   { color: rgba(230,81,0,0.7); background: rgba(230,81,0,0.08); }
.col-pronto .card-tempo { color: rgba(67,160,71,0.8); background: rgba(67,160,71,0.08); }
.card-tempo.urgente     { color: #ff5252 !important; background: rgba(255,82,82,0.12) !important; animation: pulse 1s infinite; }

@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }

/* BotÃ£o retirar */
.card-btn-retirar {
    width: 100%; padding: 10px;
    background: rgba(46,125,50,0.15);
    border: 1px solid rgba(46,125,50,0.4);
    border-radius: 10px; color: var(--green-light);
    font-family: var(--font-title); font-size: 11px; letter-spacing: 1px;
    cursor: pointer; transition: all 0.15s;
}
.card-btn-retirar:hover {
    background: rgba(46,125,50,0.3);
    border-color: var(--green-light);
    transform: translateY(-1px);
}

/* Empty state */
.empty-col {
    flex: 1; display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    color: var(--text-faint); gap: 10px;
}
.empty-col-icon { font-size: 48px; opacity: 0.3; }
.empty-col-txt  { font-family: var(--font-title); font-size: 11px; letter-spacing: 2px; opacity: 0.4; }

/* Scroll bar */
.cards-grid::-webkit-scrollbar { width: 4px; }
.cards-grid::-webkit-scrollbar-track { background: transparent; }
.cards-grid::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

/* NotificaÃ§Ã£o ding */
.notif-toast {
    position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
    background: var(--green); color: white; padding: 12px 24px;
    border-radius: 30px; font-family: var(--font-title); font-size: 13px;
    letter-spacing: 1px; opacity: 0; transition: opacity 0.3s;
    pointer-events: none; z-index: 100;
}
.notif-toast.show { opacity: 1; }
</style>
</head>
<body>

<div class="header">
    <div class="header-logo">ZION Â· KEOLA</div>
    <div style="text-align:center">
        <div class="header-clock" id="clock">--:--</div>
        <div class="header-date"  id="date-str"></div>
    </div>
    <div style="font-size:11px;color:var(--text-faint);text-align:right;font-family:var(--font-title);letter-spacing:1px">
        TELA DE CHAMADA<br>
        <span id="ultimo-update" style="font-size:9px">A carregar...</span>
    </div>
</div>

<div class="main">
    <!-- COLUNA: EM PREPARAÃ‡ÃƒO -->
    <div class="coluna col-prep">
        <div class="coluna-header">
            <div class="coluna-titulo">ğŸ³ Em PreparaÃ§Ã£o</div>
            <div class="coluna-count" id="count-prep">0</div>
        </div>
        <div class="coluna-divider"></div>
        <div class="cards-grid" id="grid-prep"></div>
    </div>

    <!-- COLUNA: PRONTOS -->
    <div class="coluna col-pronto">
        <div class="coluna-header">
            <div class="coluna-titulo">âœ… Pronto para Retirada</div>
            <div class="coluna-count" id="count-pronto">0</div>
        </div>
        <div class="coluna-divider"></div>
        <div class="cards-grid" id="grid-pronto"></div>
    </div>
</div>

<div class="notif-toast" id="notif-toast"></div>

<script src="config.js"></script>
<script>
const SUPA_URL = window.SUPABASE_URL      || '';
const SUPA_KEY = window.SUPABASE_ANON_KEY || '';

async function sb(path, opts = {}) {
    const r = await fetch(`${SUPA_URL}/rest/v1/${path}`, {
        ...opts,
        headers: {
            apikey: SUPA_KEY, Authorization: `Bearer ${SUPA_KEY}`,
            'Content-Type': 'application/json',
            Prefer: 'return=representation',
            ...opts.headers,
        },
    });
    if (!r.ok) { const e = await r.json().catch(()=>{}); throw e; }
    const txt = await r.text();
    return txt ? JSON.parse(txt) : [];
}

// â”€â”€ RELÃ“GIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateClock() {
    const now  = new Date();
    document.getElementById('clock').textContent =
        now.toLocaleTimeString('pt-PT', {hour:'2-digit', minute:'2-digit'});
    document.getElementById('date-str').textContent =
        now.toLocaleDateString('pt-PT', {weekday:'long', day:'numeric', month:'long'})
           .replace(/^\w/, c => c.toUpperCase());
}
updateClock();
setInterval(updateClock, 1000);

// â”€â”€ ESTADO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let pedidosAntes = { prep: new Set(), pronto: new Set() };

function tempo(createdAt) {
    const diff = Math.floor((Date.now() - new Date(createdAt)) / 60000);
    if (diff < 1)  return 'Agora';
    if (diff === 1) return '1 min';
    return `${diff} min`;
}

function tempoUrgente(createdAt, status) {
    const diff = Math.floor((Date.now() - new Date(createdAt)) / 60000);
    // Em preparaÃ§Ã£o > 15 min = urgente; Pronto > 5 min = urgente
    return (status === 'em_preparacao' && diff > 15) ||
           (status === 'pronto' && diff > 5);
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderColuna(pedidos, gridId, status) {
    const grid = document.getElementById(gridId);
    if (!grid) return;

    if (!pedidos.length) {
        grid.innerHTML = `
        <div class="empty-col" style="grid-column:1/-1">
            <div class="empty-col-icon">${status === 'em_preparacao' ? 'ğŸ³' : 'ğŸ””'}</div>
            <div class="empty-col-txt">${status === 'em_preparacao' ? 'Nenhum pedido em preparaÃ§Ã£o' : 'Nenhum pedido pronto'}</div>
        </div>`;
        return;
    }

    grid.innerHTML = pedidos.map(p => {
        const itensHtml = (p.itens||[]).map(it =>
            `<div class="card-item-linha">
                <span class="card-item-qty">${it.quantidade}Ã—</span>
                <span>${it.produto_nome}</span>
            </div>`
        ).join('');

        const urgente = tempoUrgente(p.updated_at || p.created_at, status);
        const tempoStr = tempo(p.updated_at || p.created_at);

        const btnRetirar = status === 'pronto'
            ? `<button class="card-btn-retirar" onclick="marcarEntregue('${p.id}')">ğŸ“¦ Retirado â€” ${p.nome_cliente || 'AnÃ³nimo'}</button>`
            : '';

        return `
        <div class="pedido-card">
            <div class="card-numero">#${String(p.numero).padStart(2,'0')}</div>
            <div class="card-nome">${p.nome_cliente || 'AnÃ³nimo'}</div>
            ${itensHtml ? `<div class="card-itens">${itensHtml}</div>` : ''}
            <div class="card-tempo ${urgente ? 'urgente' : ''}">${urgente ? 'âš  ' : ''}${tempoStr}</div>
            ${btnRetirar}
        </div>`;
    }).join('');
}

// â”€â”€ CARREGAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function carregar() {
    const hoje = new Date().toISOString().split('T')[0];

    const peds = await sb(
        `pedidos?select=*&data_pedido=eq.${hoje}&status=in.(em_preparacao,pronto)&order=numero.asc`
    ).catch(() => []);

    const pedIds = (peds||[]).map(p => p.id);
    let itensMap = {};
    if (pedIds.length) {
        const allItens = await sb(`pedido_itens?select=*&pedido_id=in.(${pedIds.join(',')})&order=created_at`).catch(()=>[]);
        (allItens||[]).forEach(it => {
            if (!itensMap[it.pedido_id]) itensMap[it.pedido_id] = [];
            itensMap[it.pedido_id].push(it);
        });
    }

    const todos = (peds||[]).map(p => ({ ...p, itens: itensMap[p.id] || [] }));
    const emPrep  = todos.filter(p => p.status === 'em_preparacao');
    const prontos = todos.filter(p => p.status === 'pronto');

    // Detectar novos prontos â†’ notificaÃ§Ã£o
    const novosIds = new Set(prontos.map(p => p.id));
    prontos.forEach(p => {
        if (!pedidosAntes.pronto.has(p.id)) {
            mostrarNotif(`âœ… Pedido #${String(p.numero).padStart(2,'0')} pronto â€” ${p.nome_cliente || 'AnÃ³nimo'}`);
        }
    });
    pedidosAntes.pronto = novosIds;

    document.getElementById('count-prep').textContent   = emPrep.length;
    document.getElementById('count-pronto').textContent = prontos.length;

    renderColuna(emPrep,  'grid-prep',   'em_preparacao');
    renderColuna(prontos, 'grid-pronto', 'pronto');

    const agora = new Date().toLocaleTimeString('pt-PT', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
    document.getElementById('ultimo-update').textContent = `Actualizado: ${agora}`;
}

async function marcarEntregue(pedidoId) {
    await sb(`pedidos?id=eq.${pedidoId}`, {
        method: 'PATCH',
        body: JSON.stringify({ status: 'entregue', updated_at: new Date().toISOString() }),
    }).catch(console.error);
    await carregar();
}

// â”€â”€ NOTIFICAÃ‡ÃƒO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mostrarNotif(msg) {
    const el = document.getElementById('notif-toast');
    el.textContent = msg;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 3500);
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
carregar();
setInterval(carregar, 8000); // Actualiza a cada 8 segundos
</script>
</body>
</html>
