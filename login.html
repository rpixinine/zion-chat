<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acesso — Zion Lisboa</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="config.js"></script>
    <script src="auth.js"></script>
    <link rel="stylesheet" href="css/tokens.css">
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Lato', sans-serif;
            background: var(--bg-page);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* ── Lado esquerdo — imagem ─────────────────────── */
        .auth-image {
            flex: 1;
            background: url('assets/zion_auth.png') center center / cover no-repeat;
            position: relative;
            min-width: 0;
        }
        .auth-image::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg,
                rgba(0,80,85,0.55) 0%,
                rgba(0,40,45,0.3) 60%,
                rgba(0,0,0,0.15) 100%);
        }
        .auth-image-brand {
            position: absolute;
            bottom: 48px;
            left: 48px;
            z-index: 2;
        }
        .auth-image-brand-title {
            font-family: 'Cinzel', serif;
            font-size: 42px;
            font-weight: 700;
            letter-spacing: 12px;
            color: #fff;
            line-height: 1;
        }
        .auth-image-brand-sub {
            font-family: 'Cinzel', serif;
            font-size: 11px;
            letter-spacing: 4px;
            color: rgba(255,255,255,0.65);
            text-transform: uppercase;
            margin-top: 6px;
        }
        .auth-image-brand-line {
            width: 48px;
            height: 2px;
            background: var(--primary-light, #00909880);
            margin-bottom: 14px;
            border-radius: 2px;
        }

        /* ── Lado direito — form ────────────────────────── */
        .auth-form {
            width: 480px;
            flex-shrink: 0;
            background: #fff;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            box-shadow: -4px 0 40px rgba(0,0,0,0.08);
        }
        .auth-form::-webkit-scrollbar { width: 4px; }
        .auth-form::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

        .auth-inner {
            padding: 52px 48px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .auth-logo {
            font-family: 'Cinzel', serif;
            font-size: 22px;
            letter-spacing: 6px;
            color: var(--primary-dark, #007078);
            margin-bottom: 32px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .auth-logo-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--primary-light, #009098);
        }

        /* ── Tabs ───────────────────────────────────────── */
        .tabs {
            display: flex;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid var(--border, rgba(0,144,152,0.2));
            margin-bottom: 32px;
            flex-shrink: 0;
        }
        .tab {
            flex: 1;
            padding: 11px;
            cursor: pointer;
            background: var(--bg-input, #F5FAFA);
            border: none;
            font-family: 'Cinzel', serif;
            font-size: 10px;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--text-faint, #7A9A9A);
            transition: all 0.2s;
        }
        .tab:first-child { border-right: 1px solid var(--border, rgba(0,144,152,0.2)); }
        .tab.active {
            background: var(--primary, #009098);
            color: #fff;
        }
        .tab:hover:not(.active) { color: var(--primary-dark, #007078); }

        /* ── Form section ───────────────────────────────── */
        .form-section { display: none; }
        .form-section.active { display: block; }

        .form-group { margin-bottom: 14px; }
        .form-row   { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 14px; }

        .form-label {
            display: block;
            font-family: 'Cinzel', serif;
            font-size: 9px;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--text-faint, #7A9A9A);
            margin-bottom: 6px;
        }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 11px 13px;
            border-radius: 8px;
            border: 1px solid var(--border, rgba(0,144,152,0.2));
            background: var(--bg-input, #F5FAFA);
            font-family: 'Lato', sans-serif;
            font-size: 14px;
            color: var(--text-main, #0A2020);
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input::placeholder, .form-textarea::placeholder { color: var(--text-faint, #7A9A9A); }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            border-color: var(--primary-light, #009098);
            box-shadow: 0 0 0 3px rgba(0,144,152,0.1);
        }
        .form-input.error { border-color: var(--red, #c0392b); box-shadow: 0 0 0 3px rgba(192,57,43,0.08); }
        .form-textarea { resize: none; height: 72px; line-height: 1.5; }

        /* ── Foto upload ─────────────────────────────────── */
        .photo-upload-wrap {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
            padding: 14px;
            background: var(--bg-input, #F5FAFA);
            border: 1px solid var(--border, rgba(0,144,152,0.2));
            border-radius: 10px;
        }
        .photo-preview {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: var(--primary-faint, rgba(0,144,152,0.08)) center center / cover no-repeat;
            border: 2px solid var(--border, rgba(0,144,152,0.2));
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: border-color 0.2s;
        }
        .photo-preview svg { width: 24px; height: 24px; color: var(--primary-light, #009098); }
        .photo-preview.has-image svg { display: none; }
        .photo-preview.error-photo { border-color: var(--red, #c0392b); }
        .photo-info { flex: 1; }
        .photo-info-title {
            font-family: 'Cinzel', serif;
            font-size: 11px;
            color: var(--text-main, #0A2020);
            margin-bottom: 3px;
        }
        .photo-info-sub { font-size: 11px; color: var(--text-faint, #7A9A9A); margin-bottom: 8px; }
        .photo-btn {
            display: inline-flex; align-items: center; gap: 5px;
            padding: 6px 12px; border-radius: 6px;
            border: 1px solid var(--border, rgba(0,144,152,0.2));
            background: #fff; font-family: 'Cinzel', serif;
            font-size: 9px; letter-spacing: 1px; text-transform: uppercase;
            color: var(--primary-dark, #007078); cursor: pointer; transition: all 0.2s;
        }
        .photo-btn:hover { border-color: var(--primary-light, #009098); background: var(--bg-input); }
        .photo-btn svg { width: 11px; height: 11px; }
        #foto-input { display: none; }

        /* ── Submit ─────────────────────────────────────── */
        .submit-btn {
            width: 100%;
            padding: 13px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, var(--primary-dark, #007078), var(--primary-light, #009098));
            color: #fff;
            font-family: 'Cinzel', serif;
            font-size: 11px;
            letter-spacing: 2px;
            text-transform: uppercase;
            cursor: pointer;
            margin-top: 4px;
            transition: all 0.2s;
            box-shadow: 0 2px 12px rgba(0,144,152,0.25);
        }
        .submit-btn:hover    { filter: brightness(1.08); transform: translateY(-1px); }
        .submit-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        /* ── Mensagens ───────────────────────────────────── */
        .msg-box {
            padding: 10px 13px;
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 14px;
            display: none;
            line-height: 1.5;
        }
        .msg-box.error   { background: rgba(192,57,43,0.06); border: 1px solid rgba(192,57,43,0.25); color: var(--red, #c0392b); display: block; }
        .msg-box.success { background: rgba(0,144,152,0.06); border: 1px solid rgba(0,144,152,0.25); color: var(--primary-dark, #007078); display: block; }

        /* ── Divider de secção ───────────────────────────── */
        .form-divider {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 6px 0 14px;
        }
        .form-divider-line { flex: 1; height: 1px; background: var(--border, rgba(0,144,152,0.15)); }
        .form-divider-txt  { font-family: 'Cinzel', serif; font-size: 8px; letter-spacing: 2px; color: var(--text-faint); text-transform: uppercase; }

        /* ── Responsivo ─────────────────────────────────── */
        @media (max-width: 900px) {
            body { flex-direction: column; overflow-y: auto; height: auto; min-height: 100vh; }
            .auth-image { height: 220px; flex: none; width: 100%; }
            .auth-image-brand { bottom: 20px; left: 24px; }
            .auth-image-brand-title { font-size: 28px; letter-spacing: 8px; }
            .auth-form { width: 100%; flex-shrink: 0; }
            .auth-inner { padding: 32px 24px 48px; }
        }
    </style>
</head>
<body>

<!-- ESQUERDA: imagem -->
<div class="auth-image">
    <div class="auth-image-brand">
        <div class="auth-image-brand-line"></div>
        <div class="auth-image-brand-title">ZION</div>
        <div class="auth-image-brand-sub">Lisboa · Portugal</div>
    </div>
</div>

<!-- DIREITA: form -->
<div class="auth-form">
    <div class="auth-inner">

        <div class="auth-logo">
            ZION <div class="auth-logo-dot"></div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('login')">Entrar</button>
            <button class="tab" onclick="switchTab('register')">Registar</button>
        </div>

        <!-- ── LOGIN ────────────────────────────────────── -->
        <div class="form-section active" id="tab-login">
            <div class="msg-box" id="login-msg"></div>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input class="form-input" id="login-email" type="email" placeholder="o.teu@email.com"
                       onkeydown="if(event.key==='Enter') doLogin()">
            </div>
            <div class="form-group">
                <label class="form-label">Password</label>
                <input class="form-input" id="login-password" type="password" placeholder="••••••••"
                       onkeydown="if(event.key==='Enter') doLogin()">
            </div>
            <button class="submit-btn" id="login-btn" onclick="doLogin()">Entrar</button>
            <div style="text-align:center;margin-top:14px">
                <button onclick="abrirForgot()" style="background:none;border:none;cursor:pointer;font-family:'Cinzel',serif;font-size:10px;letter-spacing:1px;color:var(--text-faint,#7A9A9A);text-decoration:underline;text-underline-offset:3px;">
                    Esqueci a password
                </button>
            </div>
        </div>

        <!-- ── REGISTER ─────────────────────────────────── -->
        <div class="form-section" id="tab-register">
            <div class="msg-box" id="reg-msg"></div>

            <!-- Foto -->
            <div class="photo-upload-wrap">
                <div class="photo-preview" id="photo-preview">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                </div>
                <div class="photo-info">
                    <div class="photo-info-title">Foto de perfil</div>
                    <div class="photo-info-sub">Obrigatória · JPG, PNG ou HEIC</div>
                    <button class="photo-btn" onclick="document.getElementById('foto-input').click()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                        Escolher foto
                    </button>
                    <input type="file" id="foto-input" accept="image/*" capture="environment" onchange="previewFoto(event)">
                </div>
            </div>

            <!-- Nome -->
            <div class="form-row">
                <div class="form-group" style="margin-bottom:0">
                    <label class="form-label">Nome</label>
                    <input class="form-input" id="reg-nome" type="text" placeholder="Primeiro nome">
                </div>
                <div class="form-group" style="margin-bottom:0">
                    <label class="form-label">Apelido</label>
                    <input class="form-input" id="reg-apelido" type="text" placeholder="Apelido">
                </div>
            </div>

            <div class="form-divider">
                <div class="form-divider-line"></div>
                <div class="form-divider-txt">Contacto</div>
                <div class="form-divider-line"></div>
            </div>

            <div class="form-group">
                <label class="form-label">Email</label>
                <input class="form-input" id="reg-email" type="email" placeholder="o.teu@email.com">
            </div>
            <div class="form-group">
                <label class="form-label">Telefone</label>
                <input class="form-input" id="reg-telefone" type="tel" placeholder="+351 9XX XXX XXX">
            </div>

            <div class="form-divider">
                <div class="form-divider-line"></div>
                <div class="form-divider-txt">Sobre ti</div>
                <div class="form-divider-line"></div>
            </div>

            <div class="form-group">
                <label class="form-label">Como conheceste a Zion?</label>
                <textarea class="form-textarea" id="reg-onde" placeholder="Ex: através de um amigo, redes sociais, evento..."></textarea>
            </div>

            <div class="form-divider">
                <div class="form-divider-line"></div>
                <div class="form-divider-txt">Acesso</div>
                <div class="form-divider-line"></div>
            </div>

            <div class="form-group">
                <label class="form-label">Password</label>
                <input class="form-input" id="reg-password" type="password" placeholder="Mínimo 6 caracteres">
            </div>
            <div class="form-group">
                <label class="form-label">Confirmar password</label>
                <input class="form-input" id="reg-password2" type="password" placeholder="Repete a password"
                       onkeydown="if(event.key==='Enter') doRegister()">
            </div>

            <button class="submit-btn" id="reg-btn" onclick="doRegister()">Criar Conta</button>
        </div>

    </div>
</div>

<!-- Modal: Esqueci a password -->
<div id="forgot-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:300;display:none;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(4px);">
    <div style="width:100%;max-width:400px;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.15);animation:scaleIn 0.2s ease">
        <div style="padding:16px 20px;border-bottom:1px solid var(--border,rgba(0,144,152,0.2));display:flex;align-items:center;justify-content:space-between;">
            <span style="font-family:'Cinzel',serif;font-size:12px;letter-spacing:1px;color:var(--primary-dark,#007078)">Recuperar Password</span>
            <button onclick="fecharForgot()" style="width:26px;height:26px;border-radius:50%;border:1px solid var(--border,rgba(0,144,152,0.2));background:none;cursor:pointer;font-size:14px;color:var(--text-faint,#7A9A9A);display:flex;align-items:center;justify-content:center;">✕</button>
        </div>
        <div style="padding:20px">
            <p style="font-size:13px;color:var(--text-muted,#4A6A6A);line-height:1.6;margin:0 0 16px">
                Introduz o teu email e enviaremos um link para definires uma nova password.
            </p>
            <div class="msg-box" id="forgot-msg"></div>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input class="form-input" id="forgot-email" type="email" placeholder="o.teu@email.com"
                       onkeydown="if(event.key==='Enter') enviarReset()">
            </div>
            <button class="submit-btn" id="forgot-btn" onclick="enviarReset()" style="margin-top:0">
                Enviar Link de Recuperação
            </button>
        </div>
    </div>
</div>

<style>
@keyframes scaleIn { from { opacity:0;transform:scale(0.95) } to { opacity:1;transform:scale(1) } }
</style>

<script>
// ── Tabs ───────────────────────────────────────────────────
function switchTab(tab) {
    document.querySelectorAll('.tab').forEach((t, i) =>
        t.classList.toggle('active', (i===0&&tab==='login')||(i===1&&tab==='register')));
    document.getElementById('tab-login').classList.toggle('active', tab==='login');
    document.getElementById('tab-register').classList.toggle('active', tab==='register');
    clearMsgs();
}

function clearMsgs() {
    ['login-msg','reg-msg'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.className = 'msg-box';
    });
    document.querySelectorAll('.form-input.error').forEach(el => el.classList.remove('error'));
    document.querySelectorAll('.photo-preview.error-photo').forEach(el => el.classList.remove('error-photo'));
}

function showMsg(id, txt, tipo) {
    const el = document.getElementById(id);
    if (!el) return;
    el.textContent = txt;
    el.className = `msg-box ${tipo}`;
    el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function markError(inputId) {
    const el = document.getElementById(inputId);
    if (el) el.classList.add('error');
}

// ── Foto preview ───────────────────────────────────────────
let fotoFile = null;
function previewFoto(event) {
    const file = event.target.files[0];
    if (!file) return;
    fotoFile = file;
    const reader = new FileReader();
    reader.onload = function() {
        const preview = document.getElementById('photo-preview');
        preview.style.backgroundImage = `url('${reader.result}')`;
        preview.classList.add('has-image');
        preview.classList.remove('error-photo');
    };
    reader.readAsDataURL(file);
}

// ── LOGIN ──────────────────────────────────────────────────
async function doLogin() {
    clearMsgs();
    const email    = document.getElementById('login-email').value.trim();
    const password = document.getElementById('login-password').value;

    if (!email)    { markError('login-email');    return showMsg('login-msg', 'Email obrigatório.', 'error'); }
    if (!password) { markError('login-password'); return showMsg('login-msg', 'Password obrigatória.', 'error'); }

    const btn = document.getElementById('login-btn');
    btn.disabled = true; btn.textContent = 'A entrar...';

    try {
        await ZionAuth.login(email, password);
        showMsg('login-msg', 'Bem-vindo! A redirecionar...', 'success');
        setTimeout(() => {
            const redirect = sessionStorage.getItem('zion_redirect');
            sessionStorage.removeItem('zion_redirect');
            window.location.href = redirect || 'index.html';
        }, 800);
    } catch(e) {
        showMsg('login-msg', e.message || 'Email ou password incorretos.', 'error');
        btn.disabled = false; btn.textContent = 'Entrar';
    }
}

// ── REGISTER ───────────────────────────────────────────────
async function doRegister() {
    clearMsgs();

    const nome      = document.getElementById('reg-nome').value.trim();
    const apelido   = document.getElementById('reg-apelido').value.trim();
    const email     = document.getElementById('reg-email').value.trim();
    const telefone  = document.getElementById('reg-telefone').value.trim();
    const onde      = document.getElementById('reg-onde').value.trim();
    const password  = document.getElementById('reg-password').value;
    const password2 = document.getElementById('reg-password2').value;

    // Validações
    let ok = true;
    if (!fotoFile) {
        document.getElementById('photo-preview').classList.add('error-photo');
        showMsg('reg-msg', 'A foto de perfil é obrigatória.', 'error');
        ok = false;
    }
    if (!nome)   { markError('reg-nome');   if (ok) showMsg('reg-msg', 'Nome obrigatório.', 'error'); ok = false; }
    if (!apelido){ markError('reg-apelido');if (ok) showMsg('reg-msg', 'Apelido obrigatório.', 'error'); ok = false; }
    if (!email)  { markError('reg-email');  if (ok) showMsg('reg-msg', 'Email obrigatório.', 'error'); ok = false; }
    if (!password)  { markError('reg-password');  if (ok) showMsg('reg-msg', 'Password obrigatória.', 'error'); ok = false; }
    if (password.length < 6) { markError('reg-password'); if (ok) showMsg('reg-msg', 'Password deve ter pelo menos 6 caracteres.', 'error'); ok = false; }
    if (password !== password2) { markError('reg-password2'); if (ok) showMsg('reg-msg', 'As passwords não coincidem.', 'error'); ok = false; }
    if (!ok) return;

    const btn = document.getElementById('reg-btn');
    btn.disabled = true; btn.textContent = 'A criar conta...';

    try {
        // 1. Faz upload da foto para o Supabase Storage
        let fotoUrl = null;
        if (fotoFile) {
            const ext      = fotoFile.name.split('.').pop();
            const filename = `visitantes/${Date.now()}_${Math.random().toString(36).slice(2)}.${ext}`;
            const SUPA_URL = window.SUPABASE_URL || '';
            const SUPA_KEY = window.SUPABASE_ANON_KEY || '';

            const uploadRes = await fetch(`${SUPA_URL}/storage/v1/object/fotos/${filename}`, {
                method: 'POST',
                headers: { 'apikey': SUPA_KEY, 'Authorization': `Bearer ${SUPA_KEY}`, 'Content-Type': fotoFile.type },
                body: fotoFile,
            });

            if (uploadRes.ok) {
                fotoUrl = `${SUPA_URL}/storage/v1/object/public/fotos/${filename}`;
            }
            // Se o upload falhar não bloqueia o registo — continua sem foto
        }

        // 2. Regista utilizador
        await ZionAuth.register({
            nome:          `${nome} ${apelido}`.trim(),
            email,
            telefone:      telefone || null,
            onde_conheceu: onde     || null,
            foto_url:      fotoUrl,
            password,
        });

        showMsg('reg-msg', 'Conta criada! A redirecionar...', 'success');
        setTimeout(() => {
            const redirect = sessionStorage.getItem('zion_redirect');
            sessionStorage.removeItem('zion_redirect');
            window.location.href = redirect || 'index.html';
        }, 900);

    } catch(e) {
        showMsg('reg-msg', e.message || 'Erro ao criar conta. Tenta novamente.', 'error');
        btn.disabled = false; btn.textContent = 'Criar Conta';
    }
}

// ── ESQUECI A PASSWORD ─────────────────────────────────────
function abrirForgot() {
    const overlay = document.getElementById('forgot-overlay');
    overlay.style.display = 'flex';
    document.getElementById('forgot-email').value = document.getElementById('login-email').value || '';
    document.getElementById('forgot-msg').className = 'msg-box';
    document.getElementById('forgot-btn').disabled = false;
    document.getElementById('forgot-btn').textContent = 'Enviar Link de Recuperação';
    setTimeout(() => document.getElementById('forgot-email').focus(), 100);
}

function fecharForgot() {
    document.getElementById('forgot-overlay').style.display = 'none';
}

document.getElementById('forgot-overlay').addEventListener('click', function(e) {
    if (e.target === this) fecharForgot();
});

document.addEventListener('keydown', e => { if (e.key === 'Escape') fecharForgot(); });

async function enviarReset() {
    const email = document.getElementById('forgot-email').value.trim();
    const msgEl = document.getElementById('forgot-msg');
    msgEl.className = 'msg-box';

    if (!email) {
        msgEl.textContent = 'Introduz o teu email.';
        msgEl.className = 'msg-box error';
        return;
    }

    const btn = document.getElementById('forgot-btn');
    btn.disabled = true;
    btn.textContent = 'A enviar...';

    try {
        const res = await fetch('/api/auth/forgot-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email }),
        });
        const data = await res.json();

        // Mostra sempre mensagem de sucesso (por segurança não revelamos se email existe)
        msgEl.textContent = 'Email enviado! Verifica a tua caixa de entrada e clica no link recebido.';
        msgEl.className = 'msg-box success';
        btn.textContent = 'Email enviado';

        // Fecha o modal automaticamente após 4 segundos
        setTimeout(() => fecharForgot(), 4000);

    } catch(e) {
        msgEl.textContent = 'Erro ao enviar. Tenta novamente.';
        msgEl.className = 'msg-box error';
        btn.disabled = false;
        btn.textContent = 'Enviar Link de Recuperação';
    }
}

if (ZionAuth.isLoggedIn()) {
    const redirect = sessionStorage.getItem('zion_redirect');
    sessionStorage.removeItem('zion_redirect');
    window.location.href = redirect || 'index.html';
}
</script>
</body>
</html>
