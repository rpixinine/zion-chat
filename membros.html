<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Membros ‚Äî Zion Church Lisboa</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="config.js"></script>
    <script src="auth.js"></script>
    <style>
        :root{
            --gold:#B8922A;--gold-light:#D4A843;--gold-dark:#8B6914;
            --border:rgba(184,146,42,0.22);--bg-page:#F5EFE4;--bg-card:#FFFFFF;
            --bg-input:#FAF7F2;--bg-footer:#F0E8D8;--text-main:#1A1410;
            --text-muted:#7A6A52;--text-faint:#A89878;
            --shadow:0 8px 40px rgba(100,70,20,0.13);
            --green:#2e7d32;--green-bg:rgba(46,125,50,0.08);--green-border:rgba(46,125,50,0.25);
            --red:#c0392b;--orange:#e65100;--orange-bg:rgba(230,81,0,0.08);--orange-border:rgba(230,81,0,0.25);
            --blue:#1565c0;--blue-bg:rgba(21,101,192,0.08);--blue-border:rgba(21,101,192,0.2);
            --purple:#6a0dad;--purple-bg:rgba(106,13,173,0.08);--purple-border:rgba(106,13,173,0.2);
        }
        *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
        html,body{height:100%;background:var(--bg-page);font-family:'Lato',sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh}
        body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 15% 15%,rgba(201,168,76,0.09) 0%,transparent 55%),radial-gradient(ellipse at 85% 85%,rgba(201,168,76,0.06) 0%,transparent 55%);pointer-events:none}
        .page-wrapper{position:relative;z-index:1;display:flex;flex-direction:column;width:640px;max-width:96vw;height:96vh;max-height:900px;background:var(--bg-card);border-radius:16px;box-shadow:var(--shadow),0 0 0 1px var(--border);overflow:hidden}

        /* Banner */
        .banner{width:100%;position:relative;background:#111;flex-shrink:0}
        .banner img{width:100%;height:110px;object-fit:cover;display:block}
        .banner-fallback{display:none;width:100%;height:110px;background:linear-gradient(135deg,#0d0d0d 0%,#1c1408 50%,#0d0d0d 100%);align-items:center;justify-content:center;flex-direction:column;gap:8px}
        .banner-fallback.show{display:flex}
        .banner-title{font-family:'Cinzel',serif;color:#C9A84C;font-size:26px;font-weight:700;letter-spacing:10px}
        .banner-sub{color:rgba(201,168,76,0.6);font-size:10px;letter-spacing:4px;text-transform:uppercase}
        .banner-overlay{position:absolute;bottom:0;left:0;right:0;height:55px;background:linear-gradient(to top,rgba(255,255,255,0.97),transparent)}
        .banner-nav{position:absolute;bottom:10px;left:0;right:0;display:flex;align-items:center;justify-content:space-between;padding:0 16px}
        .back-btn{display:flex;align-items:center;gap:6px;background:rgba(255,255,255,0.92);border:1px solid var(--border);border-radius:20px;padding:5px 14px;font-family:'Cinzel',serif;font-size:10px;letter-spacing:1.5px;color:var(--gold-dark);text-decoration:none;backdrop-filter:blur(8px)}
        .page-badge{font-family:'Cinzel',serif;font-size:10px;letter-spacing:2px;color:var(--gold);text-transform:uppercase;background:rgba(255,255,255,0.92);border:1px solid var(--border);border-radius:20px;padding:5px 14px;backdrop-filter:blur(8px)}
        .gold-line{height:2px;background:linear-gradient(90deg,transparent,var(--gold-light),transparent);flex-shrink:0;opacity:0.5}

        /* User bar */
        .user-bar{display:flex;align-items:center;gap:10px;padding:11px 16px;background:linear-gradient(135deg,rgba(201,168,76,0.08),rgba(201,168,76,0.02));border-bottom:1px solid var(--border);flex-shrink:0}
        .user-bar-avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--gold-dark),var(--gold-light));display:flex;align-items:center;justify-content:center;font-family:'Cinzel',serif;font-size:13px;color:#fff;font-weight:700;flex-shrink:0;overflow:hidden;border:2px solid rgba(184,146,42,0.3)}
        .user-bar-avatar img{width:100%;height:100%;object-fit:cover;display:block}
        .user-bar-info{flex:1}
        .user-bar-nome{font-family:'Cinzel',serif;font-size:12px;color:var(--gold-dark)}
        .user-bar-tipo{font-size:10px;color:var(--text-faint);margin-top:1px}
        .logout-btn{display:flex;align-items:center;gap:5px;padding:5px 10px;border-radius:8px;border:1px solid rgba(220,80,60,0.3);background:rgba(220,80,60,0.06);color:#c0392b;font-family:'Cinzel',serif;font-size:9px;letter-spacing:1px;text-transform:uppercase;cursor:pointer;flex-shrink:0;transition:all 0.2s}
        .logout-btn:hover{background:rgba(220,80,60,0.12)}

        /* Search bar */
        .search-bar{display:flex;align-items:center;gap:8px;padding:10px 16px;border-bottom:1px solid var(--border);background:var(--bg-card);flex-shrink:0}
        .search-input{flex:1;background:var(--bg-input);border:1px solid var(--border);border-radius:20px;padding:8px 14px;font-family:'Lato',sans-serif;font-size:13px;color:var(--text-main);outline:none;transition:border-color 0.2s}
        .search-input::placeholder{color:var(--text-faint)}
        .search-input:focus{border-color:var(--gold-light)}
        .filter-btn{display:flex;align-items:center;gap:5px;padding:7px 12px;border-radius:20px;border:1px solid var(--border);background:var(--bg-input);font-family:'Cinzel',serif;font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--text-muted);cursor:pointer;transition:all 0.2s;white-space:nowrap;flex-shrink:0}
        .filter-btn.active{background:linear-gradient(135deg,var(--orange),#ff6d00);color:#fff;border-color:transparent;box-shadow:0 2px 8px rgba(230,81,0,0.25)}

        /* Content */
        .content{flex:1;overflow-y:auto;background:var(--bg-input)}
        .content::-webkit-scrollbar{width:4px}
        .content::-webkit-scrollbar-thumb{background:rgba(184,146,42,0.25);border-radius:2px}

        /* Stats */
        .stats-bar{display:flex;gap:8px;padding:14px 16px 6px}
        .stat-pill{flex:1;background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:10px;text-align:center}
        .stat-num{font-family:'Cinzel',serif;font-size:20px;font-weight:700;color:var(--gold-dark)}
        .stat-label{font-size:10px;color:var(--text-faint);margin-top:1px;letter-spacing:0.5px}

        /* Birthday banner */
        .birthday-banner{margin:10px 16px 0;background:linear-gradient(135deg,rgba(230,81,0,0.1),rgba(230,81,0,0.03));border:1px solid var(--orange-border);border-radius:12px;padding:12px 16px;display:flex;align-items:center;gap:12px;animation:fadeUp 0.3s ease}
        .birthday-icon{font-size:24px;flex-shrink:0}
        .birthday-txt strong{font-family:'Cinzel',serif;font-size:11px;color:var(--orange);display:block}
        .birthday-txt span{font-size:11px;color:var(--text-faint)}

        /* Section label */
        .section-label{font-family:'Cinzel',serif;font-size:10px;letter-spacing:3px;text-transform:uppercase;color:var(--text-faint);padding:14px 16px 8px}

        /* Member grid */
        .member-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;padding:0 16px 16px}
        .member-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;overflow:hidden;cursor:pointer;transition:all 0.22s;animation:fadeUp 0.35s ease both;text-align:center}
        .member-card:hover{box-shadow:0 4px 18px rgba(100,70,20,0.13);border-color:var(--gold-light);transform:translateY(-2px)}
        .member-card:active{transform:scale(0.97)}
        .member-foto{width:100%;height:100px;object-fit:cover;object-position:center top;display:block}
        .member-foto-ph{width:100%;height:100px;background:linear-gradient(135deg,rgba(201,168,76,0.13),rgba(201,168,76,0.04));display:flex;align-items:center;justify-content:center}
        .member-foto-initials{font-family:'Cinzel',serif;font-size:26px;font-weight:700;color:var(--gold-light)}
        .member-card-body{padding:9px 8px}
        .member-nome{font-family:'Cinzel',serif;font-size:10px;font-weight:600;color:var(--text-main);line-height:1.3;margin-bottom:3px}
        .member-dn{font-size:10px;color:var(--text-faint)}
        .member-badges{display:flex;flex-wrap:wrap;justify-content:center;gap:3px;margin-top:5px}
        .mbadge{font-size:8px;padding:1px 6px;border-radius:8px;font-family:'Cinzel',serif;letter-spacing:0.5px;border:1px solid transparent}
        .mb-lider{background:rgba(139,105,20,0.1);color:var(--gold-dark);border-color:rgba(139,105,20,0.2)}
        .mb-vol{background:var(--green-bg);color:var(--green);border-color:var(--green-border)}
        .mb-aniv{background:var(--orange-bg);color:var(--orange);border-color:var(--orange-border)}
        .mb-presb{background:var(--purple-bg);color:var(--purple);border-color:var(--purple-border)}

        /* Empty / Loading */
        .empty{text-align:center;padding:48px 20px;color:var(--text-faint)}
        .empty-icon{font-size:44px;margin-bottom:10px;opacity:0.35}
        .empty-txt{font-size:13px;line-height:1.6}
        .loading{text-align:center;padding:48px;color:var(--text-faint);font-size:13px}
        .spin{width:26px;height:26px;border:2px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 10px}

        /* Footer */
        .footer{background:var(--bg-footer);border-top:1px solid var(--border);padding:10px 18px;flex-shrink:0}
        .footer-links{display:flex;justify-content:center;gap:12px;margin-bottom:8px}
        .footer-link{display:flex;align-items:center;gap:5px;color:var(--gold);text-decoration:none;font-size:10px;letter-spacing:1.2px;text-transform:uppercase;font-family:'Cinzel',serif;padding:4px 10px;border-radius:4px;border:1px solid var(--border);background:rgba(255,255,255,0.6)}
        .footer-link svg{width:12px;height:12px}
        .footer-div{height:1px;background:var(--border);margin:8px 0}
        .footer-copy{color:var(--text-muted);font-size:10px;letter-spacing:1px;text-transform:uppercase;font-family:'Cinzel',serif;text-align:center}
        .footer-addr{color:var(--text-faint);font-size:10px;text-align:center;margin-top:2px}

        /* ‚îÄ‚îÄ PERFIL MODAL ‚îÄ‚îÄ */
        .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index:200;display:flex;align-items:flex-end;justify-content:center;backdrop-filter:blur(5px);animation:fadeIn 0.2s ease}
        .overlay.hidden{display:none}
        .perfil-sheet{width:640px;max-width:100vw;background:var(--bg-card);border-radius:18px 18px 0 0;max-height:92vh;overflow-y:auto;animation:slideUp 0.32s ease;display:flex;flex-direction:column}
        .perfil-sheet::-webkit-scrollbar{width:4px}
        .perfil-sheet::-webkit-scrollbar-thumb{background:rgba(184,146,42,0.25);border-radius:2px}

        /* Perfil hero */
        .perfil-hero{position:relative;height:150px;background:linear-gradient(135deg,#0d0d0d,#1c1408);flex-shrink:0;overflow:hidden}
        .perfil-hero-pattern{position:absolute;inset:0;background:radial-gradient(ellipse at 20% 50%,rgba(201,168,76,0.2),transparent 60%),radial-gradient(ellipse at 80% 50%,rgba(201,168,76,0.1),transparent 60%)}
        .perfil-close{position:absolute;top:12px;right:14px;width:30px;height:30px;border-radius:50%;border:1px solid rgba(255,255,255,0.2);background:rgba(0,0,0,0.4);color:rgba(255,255,255,0.8);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:5;transition:all 0.2s}
        .perfil-close:hover{background:rgba(200,50,50,0.5);border-color:rgba(200,50,50,0.5)}
        .perfil-avatar{position:absolute;bottom:-44px;left:22px;width:88px;height:88px;border-radius:50%;border:4px solid var(--bg-card);overflow:hidden;background:linear-gradient(135deg,var(--gold-dark),var(--gold-light));display:flex;align-items:center;justify-content:center;box-shadow:0 4px 20px rgba(0,0,0,0.25);z-index:2}
        .perfil-avatar img{width:100%;height:100%;object-fit:cover;object-position:center top;display:block}
        .perfil-avatar-initials{font-family:'Cinzel',serif;font-size:28px;font-weight:700;color:#fff}

        /* Perfil body */
        .perfil-body{padding:54px 20px 28px;flex:1}
        .perfil-nome{font-family:'Cinzel',serif;font-size:22px;font-weight:700;color:var(--gold-dark);margin-bottom:3px}
        .perfil-subtipo{font-size:12px;color:var(--text-faint);margin-bottom:12px}
        .perfil-badges{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:20px}
        .pbadge{display:flex;align-items:center;gap:4px;padding:4px 11px;border-radius:20px;font-family:'Cinzel',serif;font-size:9px;letter-spacing:1px;text-transform:uppercase;border:1px solid transparent}
        .pb-lider{background:rgba(139,105,20,0.1);color:var(--gold-dark);border-color:rgba(139,105,20,0.25)}
        .pb-vol{background:var(--green-bg);color:var(--green);border-color:var(--green-border)}
        .pb-batiz{background:var(--blue-bg);color:var(--blue);border-color:var(--blue-border)}
        .pb-presb{background:var(--purple-bg);color:var(--purple);border-color:var(--purple-border)}
        .pb-aniv{background:var(--orange-bg);color:var(--orange);border-color:var(--orange-border)}

        /* Sections */
        .p-section{margin-bottom:18px}
        .p-section-title{font-family:'Cinzel',serif;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--text-faint);margin-bottom:8px;padding-bottom:5px;border-bottom:1px solid var(--border)}
        .p-rows{background:var(--bg-input);border-radius:12px;border:1px solid var(--border);overflow:hidden}
        .p-row{display:flex;align-items:flex-start;gap:12px;padding:11px 14px;border-bottom:1px solid rgba(184,146,42,0.07)}
        .p-row:last-child{border-bottom:none}
        .p-row-icon{width:32px;height:32px;border-radius:9px;background:rgba(184,146,42,0.1);display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;margin-top:1px}
        .p-row-label{font-size:10px;letter-spacing:1px;text-transform:uppercase;color:var(--text-faint);font-family:'Cinzel',serif;margin-bottom:2px}
        .p-row-value{font-size:13px;color:var(--text-main);line-height:1.5}
        .p-row-value.faint{color:var(--text-faint);font-style:italic}

        /* Fam√≠lia cards */
        .familia-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
        .fam-card{display:flex;align-items:center;gap:9px;background:var(--bg-input);border:1px solid var(--border);border-radius:10px;padding:9px 12px;cursor:pointer;transition:all 0.2s}
        .fam-card:hover{border-color:var(--gold-light);background:rgba(184,146,42,0.05)}
        .fam-avatar{width:36px;height:36px;border-radius:50%;overflow:hidden;background:linear-gradient(135deg,var(--gold-dark),var(--gold-light));display:flex;align-items:center;justify-content:center;font-family:'Cinzel',serif;font-size:13px;color:#fff;font-weight:700;flex-shrink:0}
        .fam-avatar img{width:100%;height:100%;object-fit:cover;object-position:center top}
        .fam-nome{font-family:'Cinzel',serif;font-size:11px;color:var(--gold-dark)}
        .fam-rel{font-size:10px;color:var(--text-faint);margin-top:1px}

        @keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
        @keyframes spin{to{transform:rotate(360deg)}}
    </style>
</head>
<body>
<div class="page-wrapper">
    <div class="banner">
        <img src="banner zion.jpg" alt="Zion Lisboa" onerror="this.style.display='none';document.querySelector('.banner-fallback').classList.add('show');">
        <div class="banner-fallback"><div class="banner-title">ZION</div><div class="banner-sub">Lisboa ¬∑ Portugal</div></div>
        <div class="banner-overlay"></div>
        <div class="banner-nav">
            <a href="index.html" class="back-btn">‚Üê In√≠cio</a>
            <span class="page-badge">Membros</span>
        </div>
    </div>
    <div class="gold-line"></div>

    <!-- User bar -->
    <div class="user-bar" id="user-bar">
        <div class="spin" style="width:20px;height:20px;border-width:2px;margin:0"></div>
    </div>

    <!-- Search & Filter -->
    <div class="search-bar">
        <input class="search-input" id="search-input" type="text" placeholder="üîç  Pesquisar membro..." oninput="filtrar()">
        <button class="filter-btn" id="btn-aniv" onclick="toggleAniversariantes()">üéÇ Aniversariantes</button>
    </div>

    <!-- Content -->
    <div class="content" id="main-content">
        <div class="loading"><div class="spin"></div>A carregar membros...</div>
    </div>

    <div class="footer">
        <div class="footer-links">
            <a class="footer-link" href="https://zionchurch.org.br/" target="_blank"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>Site Oficial</a>
            <a class="footer-link" href="https://www.instagram.com/zionlisboa/" target="_blank"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"/></svg>@ZionLisboa</a>
        </div>
        <div class="footer-div"></div>
        <div class="footer-copy">¬© 2026 Zion Lisboa ‚Äî Todos os direitos reservados</div>
        <div class="footer-addr">Rua do Centro Cultural, 11 ¬∑ 1700-036 Alvalade ¬∑ Lisboa, Portugal</div>
    </div>
</div>

<!-- Perfil Modal -->
<div class="overlay hidden" id="overlay" onclick="closeOutside(event)">
    <div class="perfil-sheet" id="perfil-sheet">
        <div class="perfil-hero">
            <div class="perfil-hero-pattern"></div>
            <button class="perfil-close" onclick="closePerfil()">‚úï</button>
            <div class="perfil-avatar" id="p-avatar"></div>
        </div>
        <div class="perfil-body" id="p-body">
            <div class="loading"><div class="spin"></div></div>
        </div>
    </div>
</div>

<script>
    ZionAuth.protect();
    const currentUser = ZionAuth.getUser();

    const SUPA_URL = window.SUPABASE_URL || '';
    const SUPA_KEY = window.SUPABASE_ANON_KEY || '';

    let todosMembros  = [];
    let linksMap      = {};
    let filtroBirthday = false;

    // ‚îÄ‚îÄ SUPABASE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function sb(path) {
        const r = await fetch(`${SUPA_URL}/rest/v1/${path}`, {
            headers:{'apikey':SUPA_KEY,'Authorization':`Bearer ${SUPA_KEY}`,'Content-Type':'application/json'}
        });
        return r.json();
    }

    // ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function init() {
        try {
            const [membros, linksData] = await Promise.all([
                sb('membros?select=*&ativo=eq.true&order=nome'),
                sb('links?select=id,nome,responsavel&ativo=eq.true'),
            ]);
            todosMembros = Array.isArray(membros)  ? membros  : [];
            if (Array.isArray(linksData)) linksData.forEach(l => linksMap[l.id] = l);

            renderUserBar();
            renderMembros(todosMembros);
        } catch(e) {
            document.getElementById('main-content').innerHTML = '<div class="loading">‚ö†Ô∏è Erro ao carregar membros.</div>';
        }
    }

    // ‚îÄ‚îÄ USER BAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderUserBar() {
        const u         = currentUser;
        const initials  = (u.nome||'U').split(' ').map(w=>w[0]).slice(0,2).join('').toUpperCase();
        const tipoLabel = {visitante:'Visitante',membro:'Membro',admin:'Administrador'};
        // Tenta encontrar a foto do utilizador logado nos membros
        const meuMembro = todosMembros.find(m => m.email?.toLowerCase() === u.email?.toLowerCase());
        const avatarHtml = meuMembro?.foto_url
            ? `<img src="${meuMembro.foto_url}" alt="${u.nome}">`
            : initials;

        document.getElementById('user-bar').innerHTML = `
    <div class="user-bar-avatar">${avatarHtml}</div>
    <div class="user-bar-info">
      <div class="user-bar-nome">${u.nome}</div>
      <div class="user-bar-tipo">${tipoLabel[u.tipo]||u.tipo}</div>
    </div>
    <button class="logout-btn" onclick="ZionAuth.logout()">
      <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
      Sair
    </button>`;
    }

    // ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function formatDate(d) {
        if (!d) return null;
        return new Date(d+'T12:00:00').toLocaleDateString('pt-PT',{day:'2-digit',month:'2-digit',year:'numeric'});
    }
    function getMesAtual() { return new Date().getMonth()+1; }
    function isAnivMes(m) {
        if (!m.data_nascimento) return false;
        return parseInt(m.data_nascimento.split('-')[1]) === getMesAtual();
    }
    function initials(nome) {
        return (nome||'?').split(' ').map(w=>w[0]).slice(0,2).join('').toUpperCase();
    }
    function avatarHtml(m, cls='') {
        if (m.foto_url) return `<img src="${m.foto_url}" alt="${m.nome}" class="${cls}" loading="lazy">`;
        return `<div class="member-foto-initials">${initials(m.nome)}</div>`;
    }

    // ‚îÄ‚îÄ FILTROS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function filtrar() {
        const q = document.getElementById('search-input').value.toLowerCase().trim();
        let lista = [...todosMembros];
        if (filtroBirthday) lista = lista.filter(isAnivMes);
        if (q) lista = lista.filter(m => m.nome.toLowerCase().includes(q));
        renderMembros(lista);
    }

    function toggleAniversariantes() {
        filtroBirthday = !filtroBirthday;
        document.getElementById('btn-aniv').classList.toggle('active', filtroBirthday);
        document.getElementById('search-input').value = '';
        filtrar();
    }

    // ‚îÄ‚îÄ RENDER LISTA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderMembros(lista) {
        const total    = todosMembros.length;
        const anivCnt  = todosMembros.filter(isAnivMes).length;
        const lideres  = todosMembros.filter(m=>m.e_lider).length;
        const meses    = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
        const mesNome  = meses[getMesAtual()-1];

        let html = `
    <div class="stats-bar">
      <div class="stat-pill"><div class="stat-num">${total}</div><div class="stat-label">Membros</div></div>
      <div class="stat-pill"><div class="stat-num">${lideres}</div><div class="stat-label">L√≠deres</div></div>
      <div class="stat-pill"><div class="stat-num">${anivCnt}</div><div class="stat-label">Aniv. ${mesNome}</div></div>
    </div>`;

        if (filtroBirthday) {
            html += `
      <div class="birthday-banner">
        <div class="birthday-icon">üéÇ</div>
        <div class="birthday-txt">
          <strong>Aniversariantes de ${mesNome}</strong>
          <span>${lista.length === 0 ? 'Nenhum aniversariante este m√™s.' : `${lista.length} membro${lista.length!==1?'s':''} fazem anos este m√™s`}</span>
        </div>
      </div>`;
        }

        if (lista.length === 0) {
            html += `<div class="empty">
      <div class="empty-icon">${filtroBirthday?'üéÇ':'üîç'}</div>
      <div class="empty-txt">${filtroBirthday?'Nenhum aniversariante este m√™s.':'Nenhum membro encontrado.'}</div>
    </div>`;
            document.getElementById('main-content').innerHTML = html;
            return;
        }

        const label = filtroBirthday ? `üéÇ ${mesNome}` : 'Comunidade';
        html += `<div class="section-label">${label} ¬∑ ${lista.length} ${lista.length===1?'membro':'membros'}</div>`;
        html += '<div class="member-grid">';

        lista.forEach((m, i) => {
            const dn    = m.data_nascimento ? formatDate(m.data_nascimento) : null;
            const aniv  = isAnivMes(m);
            const badges = [
                m.e_lider      ? `<span class="mbadge mb-lider">L√≠der</span>` : '',
                m.e_presbitero ? `<span class="mbadge mb-presb">Presb.</span>` : '',
                m.e_voluntario ? `<span class="mbadge mb-vol">Vol.</span>` : '',
                aniv           ? `<span class="mbadge mb-aniv">üéÇ</span>` : '',
            ].filter(Boolean).join('');

            const fotoHtml = m.foto_url
                ? `<img class="member-foto" src="${m.foto_url}" alt="${m.nome}" loading="lazy">`
                : `<div class="member-foto-ph"><div class="member-foto-initials">${initials(m.nome)}</div></div>`;

            html += `
      <div class="member-card" style="animation-delay:${Math.min(i,12)*0.03}s" onclick="abrirPerfil('${m.id}')">
        ${fotoHtml}
        <div class="member-card-body">
          <div class="member-nome">${m.nome}</div>
          ${dn ? `<div class="member-dn">${dn}</div>` : ''}
          ${badges ? `<div class="member-badges">${badges}</div>` : ''}
        </div>
      </div>`;
        });

        html += '</div>';
        document.getElementById('main-content').innerHTML = html;
    }

    // ‚îÄ‚îÄ PERFIL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function abrirPerfil(id) {
        const m = todosMembros.find(x=>x.id===id);
        if (!m) return;

        // Abre modal com loading
        document.getElementById('overlay').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        document.getElementById('p-body').innerHTML = '<div class="loading"><div class="spin"></div></div>';

        // Avatar no hero
        const av = document.getElementById('p-avatar');
        if (m.foto_url) {
            av.innerHTML = `<img src="${m.foto_url}" alt="${m.nome}">`;
        } else {
            av.innerHTML = `<div class="perfil-avatar-initials">${initials(m.nome)}</div>`;
        }

        // Busca dados relacionados em paralelo
        const [conjugeRes, paiRes, maeRes, filhosRes] = await Promise.all([
            m.conjuge_id ? sb(`membros?select=id,nome,foto_url&id=eq.${m.conjuge_id}`) : Promise.resolve([]),
            m.pai_id     ? sb(`membros?select=id,nome,foto_url&id=eq.${m.pai_id}`)     : Promise.resolve([]),
            m.mae_id     ? sb(`membros?select=id,nome,foto_url&id=eq.${m.mae_id}`)     : Promise.resolve([]),
            sb(`membros_filhos?select=filho_id&pai_id=eq.${id}`),
        ]);

        const conjuge = conjugeRes?.[0] || null;
        const pai     = paiRes?.[0]     || null;
        const mae     = maeRes?.[0]     || null;

        // Filhos
        let filhos = [];
        if (filhosRes?.length > 0) {
            const ids      = filhosRes.map(f=>f.filho_id).join(',');
            const filhosInfo = await sb(`membros?select=id,nome,foto_url&id=in.(${ids})`);
            filhos = Array.isArray(filhosInfo) ? filhosInfo : [];
        }

        const link   = m.link_id ? linksMap[m.link_id] : null;
        const aniv   = isAnivMes(m);
        const meses  = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];

        // Badges
        const badgesHtml = [
            m.e_lider      ? `<span class="pbadge pb-lider">‚≠ê L√≠der</span>` : '',
            m.e_presbitero ? `<span class="pbadge pb-presb">‚úùÔ∏è Presb√≠tero</span>` : '',
            m.e_voluntario ? `<span class="pbadge pb-vol">ü§ù Volunt√°rio</span>` : '',
            m.foi_batizado ? `<span class="pbadge pb-batiz">üíß Batizado</span>` : '',
            aniv           ? `<span class="pbadge pb-aniv">üéÇ Aniversariante</span>` : '',
        ].filter(Boolean).join('');

        // Row helper
        function row(icon, label, value, faint=false) {
            const empty = !value;
            return `<div class="p-row">
      <div class="p-row-icon">${icon}</div>
      <div style="flex:1">
        <div class="p-row-label">${label}</div>
        <div class="p-row-value ${empty||faint?'faint':''}">${empty?'N√£o informado':value}</div>
      </div>
    </div>`;
        }

        // Fam√≠lia card helper
        function famCard(pessoa, rel) {
            if (!pessoa) return '';
            const fotoAv = pessoa.foto_url
                ? `<div class="fam-avatar"><img src="${pessoa.foto_url}" alt="${pessoa.nome}"></div>`
                : `<div class="fam-avatar">${initials(pessoa.nome)}</div>`;
            return `
      <div class="fam-card" onclick="closePerfil();setTimeout(()=>abrirPerfil('${pessoa.id}'),250)">
        ${fotoAv}
        <div>
          <div class="fam-nome">${pessoa.nome.split(' ')[0]}</div>
          <div class="fam-rel">${rel}</div>
        </div>
      </div>`;
        }

        const familiaCards = [
            famCard(conjuge,'C√¥njuge'),
            famCard(pai,'Pai'),
            famCard(mae,'M√£e'),
            ...filhos.map(f=>famCard(f,'Filho/a')),
        ].filter(Boolean);

        // Endere√ßo
        const endParts = [m.rua,m.numero,m.complemento,m.bairro,m.cidade,m.codigo_postal,m.pais].filter(Boolean);
        const endereco = endParts.length ? endParts.join(', ') : null;

        document.getElementById('p-body').innerHTML = `
    <div class="perfil-nome">${m.nome}</div>
    <div class="perfil-subtipo">${m.tipo||'Membro'} ¬∑ Zion Lisboa</div>
    ${badgesHtml ? `<div class="perfil-badges">${badgesHtml}</div>` : ''}

    <div class="p-section">
      <div class="p-section-title">Informa√ß√£o Pessoal</div>
      <div class="p-rows">
        ${row('üìß','Email',m.email)}
        ${row('üìû','Telefone',m.telefone)}
        ${row('üéÇ','Data de Nascimento', m.data_nascimento
            ? `${formatDate(m.data_nascimento)}${aniv?' &nbsp;üéâ Este m√™s!':''}`
            : null)}
        ${row('üíë','Estado Civil',m.estado_civil)}
        ${row('‚öß','G√©nero',m.genero)}
      </div>
    </div>

    ${familiaCards.length ? `
    <div class="p-section">
      <div class="p-section-title">Fam√≠lia</div>
      <div class="familia-grid">${familiaCards.join('')}</div>
    </div>` : ''}

    <div class="p-section">
      <div class="p-section-title">Na Igreja</div>
      <div class="p-rows">
        ${row('üìÖ','Membro desde',formatDate(m.data_entrada))}
        ${row('üíß','Batismo',m.foi_batizado
            ? (m.data_batismo ? `Sim ¬∑ ${formatDate(m.data_batismo)}` : 'Sim')
            : 'N√£o')}
        ${row('üîó','Link',link
            ? `${link.nome}${link.responsavel?' ¬∑ '+link.responsavel:''}`
            : null)}
        ${row('üìç','Zona',m.zona)}
      </div>
    </div>

    ${endereco ? `
    <div class="p-section">
      <div class="p-section-title">Morada</div>
      <div class="p-rows">
        ${row('üè†','Endere√ßo',endereco)}
      </div>
    </div>` : ''}

    ${m.historia ? `
    <div class="p-section">
      <div class="p-section-title">Hist√≥ria</div>
      <div class="p-rows">
        <div class="p-row">
          <div class="p-row-icon">‚úùÔ∏è</div>
          <div style="flex:1"><div class="p-row-value" style="white-space:pre-line;line-height:1.7">${m.historia}</div></div>
        </div>
      </div>
    </div>` : ''}
  `;
    }

    function closePerfil() {
        document.getElementById('overlay').classList.add('hidden');
        document.body.style.overflow = '';
    }
    function closeOutside(e) {
        if (e.target === document.getElementById('overlay')) closePerfil();
    }
    document.addEventListener('keydown', e=>{ if(e.key==='Escape') closePerfil(); });

    init();
</script>
</body>
</html>
