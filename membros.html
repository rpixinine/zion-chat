<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Membros â€” Zion Church Lisboa</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="config.js"></script>
    <script src="auth.js"></script>
    <link rel="stylesheet" href="css/tokens.css">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/components.css">
    <style>
        /* â”€â”€ Content scroll â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .content {
            flex: 1; overflow-y: auto; background: var(--bg-input);
        }
        .content::-webkit-scrollbar { width: 4px; }
        .content::-webkit-scrollbar-thumb { background: rgba(0,144,152,0.25); border-radius: 2px; }

        /* â”€â”€ User bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .user-bar {
            display: flex; align-items: center; gap: 10px; padding: 10px 16px;
            background: linear-gradient(135deg, var(--primary-faint), rgba(0,144,152,0.01));
            border-bottom: 1px solid var(--border); flex-shrink: 0;
        }
        .user-bar-avatar {
            width: 34px; height: 34px; border-radius: 50%; flex-shrink: 0;
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-light));
            display: flex; align-items: center; justify-content: center;
            font-family: var(--font-title); font-size: 12px; color: #fff; font-weight: 700;
            overflow: hidden; border: 2px solid rgba(0,144,152,0.25);
        }
        .user-bar-avatar img { width: 100%; height: 100%; object-fit: cover; object-position: center top; display: block; }
        .user-bar-info { flex: 1; }
        .user-bar-nome { font-family: var(--font-title); font-size: 12px; color: var(--primary-dark); }
        .user-bar-tipo { font-size: 10px; color: var(--text-faint); }
        .logout-btn {
            display: flex; align-items: center; gap: 5px; padding: 5px 10px;
            border-radius: var(--radius-sm); border: 1px solid rgba(220,80,60,0.3);
            background: rgba(220,80,60,0.06); color: var(--red);
            font-family: var(--font-title); font-size: 9px; letter-spacing: 1px;
            cursor: pointer; flex-shrink: 0; transition: all 0.2s;
        }
        .logout-btn:hover { background: rgba(220,80,60,0.12); }

        /* â”€â”€ Search bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .search-bar {
            display: flex; align-items: center; gap: 8px; padding: 10px 16px;
            border-bottom: 1px solid var(--border); background: var(--bg-card); flex-shrink: 0;
        }
        .search-wrap { flex: 1; position: relative; }
        .search-icon {
            position: absolute; left: 11px; top: 50%; transform: translateY(-50%);
            width: 14px; height: 14px; color: var(--text-faint); pointer-events: none;
        }
        .search-input {
            width: 100%; background: var(--bg-input); border: 1px solid var(--border);
            border-radius: var(--radius-full); padding: 8px 14px 8px 32px;
            font-family: var(--font-body); font-size: 13px; color: var(--text-main);
            outline: none; transition: border-color 0.2s;
        }
        .search-input::placeholder { color: var(--text-faint); }
        .search-input:focus { border-color: var(--primary-light); box-shadow: 0 0 0 3px var(--primary-faint); }
        .filter-btn {
            display: flex; align-items: center; gap: 5px; padding: 7px 12px;
            border-radius: var(--radius-full); border: 1px solid var(--border);
            background: var(--bg-input); font-family: var(--font-title); font-size: 9px;
            letter-spacing: 1px; text-transform: uppercase; color: var(--text-muted);
            cursor: pointer; transition: all 0.2s; white-space: nowrap; flex-shrink: 0;
        }
        .filter-btn.active {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-light));
            color: #fff; border-color: transparent;
        }

        /* â”€â”€ Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .stats-bar { display: flex; gap: 8px; padding: 12px 16px 4px; }
        .stat-pill {
            flex: 1; background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius-md); padding: 9px; text-align: center;
        }
        .stat-num { font-family: var(--font-title); font-size: 18px; font-weight: 700; color: var(--primary-dark); }
        .stat-label { font-size: 10px; color: var(--text-faint); margin-top: 1px; }

        /* â”€â”€ Birthday banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .birthday-banner {
            margin: 8px 16px 0;
            background: var(--primary-faint); border: 1px solid var(--border);
            border-radius: var(--radius-md); padding: 10px 14px;
            display: flex; align-items: center; gap: 10px;
        }
        .birthday-banner svg { width: 22px; height: 22px; color: var(--primary-light); flex-shrink: 0; }
        .birthday-txt strong { font-family: var(--font-title); font-size: 11px; color: var(--primary-dark); display: block; }
        .birthday-txt span   { font-size: 11px; color: var(--text-faint); }

        .section-label {
            font-family: var(--font-title); font-size: 10px; letter-spacing: 3px;
            text-transform: uppercase; color: var(--text-faint); padding: 12px 16px 6px;
        }

        /* â”€â”€ Member list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .member-list { display: flex; flex-direction: column; gap: 6px; padding: 0 16px 16px; }
        .member-row {
            display: flex; align-items: center; gap: 12px;
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius-md); padding: 10px 14px;
            cursor: pointer; transition: all 0.2s; animation: fadeUp 0.3s ease both;
        }
        .member-row:hover { box-shadow: var(--shadow); border-color: var(--primary-light); transform: translateX(2px); }

        .member-avatar {
            width: 52px; height: 52px; border-radius: 50%; flex-shrink: 0;
            overflow: hidden; background: linear-gradient(135deg, var(--primary-dark), var(--primary-light));
            display: flex; align-items: center; justify-content: center;
            border: 2px solid rgba(0,144,152,0.2);
        }
        .member-avatar img { width: 100%; height: 100%; object-fit: cover; object-position: center top; display: block; }
        .member-avatar-initials { font-family: var(--font-title); font-size: 16px; font-weight: 700; color: #fff; }

        .member-row-info { flex: 1; min-width: 0; }
        .member-row-nome {
            font-family: var(--font-title); font-size: 13px; font-weight: 600;
            color: var(--text-main); margin-bottom: 4px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .member-row-badges { display: flex; gap: 4px; flex-wrap: wrap; }
        .mbadge {
            font-size: 9px; padding: 2px 7px; border-radius: var(--radius-sm);
            font-family: var(--font-title); letter-spacing: 0.5px;
            border: 1px solid transparent; white-space: nowrap;
        }
        .mb-membro  { background: var(--primary-faint); color: var(--primary-dark); border-color: var(--border); }
        .mb-lider   { background: rgba(0,100,80,0.08); color: #006450; border-color: rgba(0,100,80,0.2); }
        .mb-vol     { background: rgba(46,125,50,0.08); color: var(--green); border-color: rgba(46,125,50,0.25); }
        .mb-presb   { background: rgba(90,20,150,0.08); color: #5a1496; border-color: rgba(90,20,150,0.2); }
        .mb-aniv    { background: rgba(230,81,0,0.08); color: var(--orange,#e65100); border-color: rgba(230,81,0,0.2); }

        /* WhatsApp btn na linha */
        .member-row-actions { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
        .btn-wpp {
            width: 32px; height: 32px; border-radius: 50%; border: none;
            background: #25D366; display: flex; align-items: center; justify-content: center;
            cursor: pointer; flex-shrink: 0; transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(37,211,102,0.3);
        }
        .btn-wpp:hover { transform: scale(1.1); box-shadow: 0 3px 12px rgba(37,211,102,0.45); }
        .btn-wpp svg { width: 16px; height: 16px; fill: #fff; }
        .member-row-arrow { color: var(--text-faint); font-size: 14px; flex-shrink: 0; }

        /* â”€â”€ Overlay / modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.55); z-index: 200;
            display: flex; align-items: flex-end; justify-content: center;
            backdrop-filter: blur(5px); animation: fadeIn 0.2s ease;
        }
        .overlay.hidden { display: none; }
        .perfil-sheet {
            width: 640px; max-width: 100vw; background: var(--bg-card);
            border-radius: 18px 18px 0 0; max-height: 90vh; overflow-y: auto;
            animation: slideUp 0.3s ease;
        }
        .perfil-sheet::-webkit-scrollbar { width: 4px; }
        .perfil-sheet::-webkit-scrollbar-thumb { background: rgba(0,144,152,0.25); border-radius: 2px; }

        /* Hero */
        .perfil-hero {
            position: relative; height: 100px;
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-light) 100%);
            overflow: visible; flex-shrink: 0;
        }
        .perfil-hero-pattern {
            position: absolute; inset: 0; opacity: 0.08;
            background-image: radial-gradient(circle, #fff 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .perfil-close {
            position: absolute; top: 10px; right: 12px;
            width: 28px; height: 28px; border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.3); background: rgba(0,0,0,0.25);
            color: rgba(255,255,255,0.9); font-size: 13px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; z-index: 5; transition: all 0.2s;
        }
        .perfil-close:hover { background: rgba(200,50,50,0.5); }

        /* Avatar: posicionado para sair do hero */
        .perfil-avatar-wrap {
            position: absolute; bottom: -44px; left: 20px;
            width: 88px; height: 88px; border-radius: 50%;
            border: 3px solid var(--bg-card);
            overflow: hidden;
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-light));
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15); z-index: 3;
        }
        .perfil-avatar-wrap img {
            width: 100%; height: 100%; object-fit: cover; object-position: center top; display: block;
        }
        .perfil-avatar-initials { font-family: var(--font-title); font-size: 26px; font-weight: 700; color: #fff; }

        /* Body */
        .perfil-body { padding: 56px 18px 28px; }
        .perfil-nome { font-family: var(--font-title); font-size: 18px; font-weight: 700; color: var(--primary-dark); margin-bottom: 2px; }
        .perfil-subtipo { font-size: 11px; color: var(--text-faint); margin-bottom: 10px; }
        .perfil-badges { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 14px; }
        .pbadge {
            display: flex; align-items: center; gap: 4px; padding: 3px 10px;
            border-radius: var(--radius-full); font-family: var(--font-title);
            font-size: 9px; letter-spacing: 1px; border: 1px solid transparent;
        }
        .pb-membro { background: var(--primary-faint); color: var(--primary-dark); border-color: var(--border); }
        .pb-lider  { background: rgba(0,100,80,0.08); color: #006450; border-color: rgba(0,100,80,0.2); }
        .pb-vol    { background: rgba(46,125,50,0.08); color: var(--green); border-color: rgba(46,125,50,0.25); }
        .pb-presb  { background: rgba(90,20,150,0.08); color: #5a1496; border-color: rgba(90,20,150,0.2); }
        .pb-batiz  { background: rgba(21,101,192,0.08); color: #1565c0; border-color: rgba(21,101,192,0.2); }
        .pb-aniv   { background: rgba(230,81,0,0.08); color: var(--orange,#e65100); border-color: rgba(230,81,0,0.2); }

        /* AcÃ§Ãµes do perfil (WhatsApp, etc.) */
        .perfil-actions { display: flex; gap: 8px; margin-bottom: 18px; }
        .btn-wpp-perfil {
            display: flex; align-items: center; gap: 7px;
            padding: 9px 16px; border-radius: var(--radius-sm); border: none;
            background: #25D366; color: #fff; cursor: pointer; transition: all 0.2s;
            font-family: var(--font-title); font-size: 10px; letter-spacing: 1px;
            box-shadow: 0 2px 10px rgba(37,211,102,0.3);
        }
        .btn-wpp-perfil:hover { filter: brightness(1.08); transform: translateY(-1px); }
        .btn-wpp-perfil svg { width: 15px; height: 15px; fill: #fff; }

        /* Sections */
        .p-section { margin-bottom: 14px; }
        .p-section-title {
            font-family: var(--font-title); font-size: 9px; letter-spacing: 3px;
            text-transform: uppercase; color: var(--text-faint);
            margin-bottom: 7px; padding-bottom: 4px; border-bottom: 1px solid var(--border);
        }
        .p-grid {
            background: var(--bg-input); border-radius: var(--radius-md);
            border: 1px solid var(--border); overflow: hidden;
            display: grid; grid-template-columns: 1fr 1fr;
        }
        .p-grid .p-cell:nth-child(odd) { border-right: 1px solid rgba(0,144,152,0.08); }
        .p-grid-full { grid-template-columns: 1fr; }
        .p-cell { padding: 9px 12px; border-bottom: 1px solid rgba(0,144,152,0.07); }
        .p-cell:last-child, .p-cell:nth-last-child(2):not(.p-grid-full .p-cell) { border-bottom: none; }
        .p-cell-full { grid-column: 1 / -1; border-right: none !important; }
        .p-cell-label { font-size: 9px; letter-spacing: 1px; text-transform: uppercase; color: var(--text-faint); font-family: var(--font-title); margin-bottom: 2px; }
        .p-cell-value { font-size: 12px; color: var(--text-main); line-height: 1.4; }
        .p-cell-value.faint { color: var(--text-faint); font-style: italic; font-size: 11px; }

        /* MinistÃ©rios tags */
        .ministerios-wrap { display: flex; flex-wrap: wrap; gap: 6px; }
        .min-tag {
            display: flex; align-items: center; gap: 5px;
            padding: 5px 11px; border-radius: var(--radius-full);
            background: var(--primary-faint); border: 1px solid var(--border);
            font-family: var(--font-title); font-size: 9px; letter-spacing: 1px;
            color: var(--primary-dark);
        }
        .min-tag svg { width: 11px; height: 11px; }

        /* FamÃ­lia */
        .familia-list { display: flex; flex-direction: column; gap: 6px; }
        .fam-card {
            display: flex; align-items: center; gap: 10px;
            background: var(--bg-input); border: 1px solid var(--border);
            border-radius: var(--radius-sm); padding: 8px 12px;
            cursor: pointer; transition: all 0.2s;
        }
        .fam-card:hover { border-color: var(--primary-light); background: var(--primary-faint); }
        .fam-avatar {
            width: 36px; height: 36px; border-radius: 50%; overflow: hidden;
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-light));
            display: flex; align-items: center; justify-content: center;
            font-family: var(--font-title); font-size: 12px; color: #fff; font-weight: 700; flex-shrink: 0;
        }
        .fam-avatar img { width: 100%; height: 100%; object-fit: cover; object-position: center top; }
        .fam-nome { font-family: var(--font-title); font-size: 12px; color: var(--primary-dark); }
        .fam-rel  { font-size: 10px; color: var(--text-faint); margin-top: 1px; }
        .fam-arrow { margin-left: auto; color: var(--text-faint); font-size: 13px; }

        @keyframes slideUp { from { transform: translateY(100%) } to { transform: translateY(0) } }
    </style>
</head>
<body>
<div class="page-wrapper">

    <div class="banner">
        <img src="banner zion.jpg" alt="Zion Lisboa"
             onerror="this.style.display='none';document.querySelector('.banner-fallback').classList.add('show');">
        <div class="banner-fallback">
            <div class="banner-title">ZION</div>
            <div class="banner-sub">Lisboa Â· Portugal</div>
        </div>
        <div class="banner-overlay"></div>
        <div class="banner-nav">
            <a href="index.html" class="back-btn">â† InÃ­cio</a>
            <span class="page-badge">Membros</span>
        </div>
    </div>

    <div class="gold-line"></div>
    <div class="user-bar" id="user-bar"><div class="spin" style="width:18px;height:18px;border-width:2px;margin:0"></div></div>

    <div class="search-bar">
        <div class="search-wrap">
            <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            <input class="search-input" id="search-input" type="text" placeholder="Pesquisar membro..." oninput="filtrar()">
        </div>
        <button class="filter-btn" id="btn-aniv" onclick="toggleAniversariantes()">
            <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            AniversÃ¡rios
        </button>
    </div>

    <div class="content" id="main-content">
        <div class="loading"><div class="spin"></div>A carregar membros...</div>
    </div>

    <div class="footer">
        <div class="footer-links">
            <a class="footer-link" href="https://zionchurch.org.br/" target="_blank">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                Site Oficial
            </a>
            <a class="footer-link" href="https://www.instagram.com/zionlisboa/" target="_blank">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"/></svg>
                @ZionLisboa
            </a>
        </div>
        <div class="footer-divider"></div>
        <div class="footer-bottom">
            <div class="footer-copy">Â© 2026 Zion Lisboa â€” Todos os direitos reservados</div>
            <div class="footer-address">Rua do Centro Cultural, 11 Â· 1700-036 Alvalade Â· Lisboa, Portugal</div>
        </div>
    </div>
</div>

<!-- Perfil Modal -->
<div class="overlay hidden" id="overlay" onclick="closeOutside(event)">
    <div class="perfil-sheet" id="perfil-sheet">
        <div class="perfil-hero">
            <div class="perfil-hero-pattern"></div>
            <button class="perfil-close" onclick="closePerfil()">âœ•</button>
            <div class="perfil-avatar-wrap" id="p-avatar"></div>
        </div>
        <div class="perfil-body" id="p-body">
            <div class="loading"><div class="spin"></div></div>
        </div>
    </div>
</div>

<script>
ZionAuth.protect();
const currentUser = ZionAuth.getUser();
const SUPA_URL    = window.SUPABASE_URL      || '';
const SUPA_KEY    = window.SUPABASE_ANON_KEY || '';

let todosMembros   = [];
let ministeriosMap = {}; // id â†’ { nome }
let linksMap       = {};
let filtroBirthday = false;

async function sb(path) {
    const r = await fetch(`${SUPA_URL}/rest/v1/${path}`, {
        headers: { 'apikey': SUPA_KEY, 'Authorization': `Bearer ${SUPA_KEY}`, 'Content-Type': 'application/json' }
    });
    return r.json();
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
    try {
        const [membros, ministeriosData, linksData] = await Promise.all([
            sb('membros?select=*&ativo=eq.true&order=nome.asc'),
            sb('ministerios?select=id,nome&ativo=eq.true'),
            sb('links?select=id,nome,responsavel&ativo=eq.true'),
        ]);

        // Ordena alfabeticamente (redundante mas garante)
        todosMembros = (Array.isArray(membros) ? membros : [])
            .sort((a, b) => (a.nome || '').localeCompare(b.nome || '', 'pt'));

        if (Array.isArray(ministeriosData)) ministeriosData.forEach(m => ministeriosMap[m.id] = m);
        if (Array.isArray(linksData))       linksData.forEach(l => linksMap[l.id] = l);

        renderUserBar();
        renderMembros(todosMembros);
    } catch(e) {
        document.getElementById('main-content').innerHTML = '<div class="loading">Erro ao carregar membros.</div>';
    }
}

// â”€â”€ USER BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderUserBar() {
    const u         = currentUser;
    const ini       = (u.nome||'U').split(' ').map(w=>w[0]).slice(0,2).join('').toUpperCase();
    const tipoLabel = { visitante:'Visitante', membro:'Membro', admin:'Administrador' };
    const meuMembro = todosMembros.find(m => m.email?.toLowerCase() === u.email?.toLowerCase());
    const avHtml    = meuMembro?.foto_url
        ? `<img src="${meuMembro.foto_url}" alt="${u.nome}">`
        : ini;
    document.getElementById('user-bar').innerHTML = `
    <div class="user-bar-avatar">${avHtml}</div>
    <div class="user-bar-info">
        <div class="user-bar-nome">${u.nome}</div>
        <div class="user-bar-tipo">${tipoLabel[u.tipo] || u.tipo}</div>
    </div>
    <button class="logout-btn" onclick="ZionAuth.logout()">
        <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        Sair
    </button>`;
}

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function formatDate(d) {
    if (!d) return null;
    return new Date(d + 'T12:00:00').toLocaleDateString('pt-PT', { day:'2-digit', month:'2-digit', year:'numeric' });
}
function getMes()       { return new Date().getMonth() + 1; }
function isAnivMes(m)   { if (!m.data_nascimento) return false; return parseInt(m.data_nascimento.split('-')[1]) === getMes(); }
function getInitials(n) { return (n||'?').split(' ').map(w=>w[0]).slice(0,2).join('').toUpperCase(); }

function limparTelefone(tel) {
    if (!tel) return null;
    return tel.replace(/\s+/g,'').replace(/[^0-9+]/g,'');
}

function wppUrl(tel) {
    const t = limparTelefone(tel);
    if (!t) return null;
    const num = t.startsWith('+') ? t.slice(1) : t;
    return `https://wa.me/${num}`;
}

// â”€â”€ FILTROS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function filtrar() {
    const q = document.getElementById('search-input').value.toLowerCase().trim();
    let lista = [...todosMembros];
    if (filtroBirthday) lista = lista.filter(isAnivMes);
    if (q) lista = lista.filter(m => (m.nome||'').toLowerCase().includes(q));
    renderMembros(lista);
}
function toggleAniversariantes() {
    filtroBirthday = !filtroBirthday;
    document.getElementById('btn-aniv').classList.toggle('active', filtroBirthday);
    document.getElementById('search-input').value = '';
    filtrar();
}

// â”€â”€ SVG WhatsApp â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SVG_WPP = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 0 1-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 0 1-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 0 1 2.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0 0 12.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 0 0 5.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 0 0-3.48-8.413Z"/></svg>`;

// â”€â”€ RENDER LISTA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMembros(lista) {
    const total   = todosMembros.length;
    const anivCnt = todosMembros.filter(isAnivMes).length;
    const lideres = todosMembros.filter(m => m.e_lider).length;
    const meses   = ['Janeiro','Fevereiro','MarÃ§o','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
    const mesNome = meses[getMes()-1];

    let html = `
    <div class="stats-bar">
        <div class="stat-pill"><div class="stat-num">${total}</div><div class="stat-label">Membros</div></div>
        <div class="stat-pill"><div class="stat-num">${lideres}</div><div class="stat-label">LÃ­deres</div></div>
        <div class="stat-pill"><div class="stat-num">${anivCnt}</div><div class="stat-label">Aniv. ${mesNome}</div></div>
    </div>`;

    if (filtroBirthday) {
        html += `
        <div class="birthday-banner">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            <div class="birthday-txt">
                <strong>Aniversariantes de ${mesNome}</strong>
                <span>${lista.length === 0 ? 'Nenhum este mÃªs.' : `${lista.length} membro${lista.length!==1?'s':''} fazem anos este mÃªs`}</span>
            </div>
        </div>`;
    }

    if (!lista.length) {
        html += `<div class="empty"><div class="empty-txt">${filtroBirthday ? 'Nenhum aniversariante este mÃªs.' : 'Nenhum membro encontrado.'}</div></div>`;
        document.getElementById('main-content').innerHTML = html;
        return;
    }

    html += `<div class="section-label">${filtroBirthday ? `AniversÃ¡rios Â· ${mesNome}` : 'Comunidade'} Â· ${lista.length} ${lista.length===1?'membro':'membros'}</div>`;
    html += '<div class="member-list">';

    lista.forEach((m, i) => {
        const aniv  = isAnivMes(m);
        const wpp   = wppUrl(m.telefone);

        // Badge por tipo/funÃ§Ã£o
        const badges = [
            m.e_presbitero                ? `<span class="mbadge mb-presb">PresbÃ­tero</span>` : '',
            m.e_lider                     ? `<span class="mbadge mb-lider">LÃ­der</span>`      : '',
            m.e_voluntario                ? `<span class="mbadge mb-vol">VoluntÃ¡rio</span>`   : '',
            (!m.e_lider && !m.e_presbitero && !m.e_voluntario) ? `<span class="mbadge mb-membro">Membro</span>` : '',
            aniv                          ? `<span class="mbadge mb-aniv">ğŸ‚ AniversÃ¡rio</span>` : '',
        ].filter(Boolean).join('');

        const avHtml = m.foto_url
            ? `<img src="${m.foto_url}" alt="${m.nome}">`
            : `<div class="member-avatar-initials">${getInitials(m.nome)}</div>`;

        html += `
        <div class="member-row" style="animation-delay:${Math.min(i,15)*0.025}s" onclick="abrirPerfil('${m.id}')">
            <div class="member-avatar">${avHtml}</div>
            <div class="member-row-info">
                <div class="member-row-nome">${m.nome}</div>
                <div class="member-row-badges">${badges}</div>
            </div>
            <div class="member-row-actions">
                ${wpp ? `
                <button class="btn-wpp" title="WhatsApp" onclick="event.stopPropagation();window.open('${wpp}','_blank')">
                    ${SVG_WPP}
                </button>` : ''}
                <div class="member-row-arrow">â€º</div>
            </div>
        </div>`;
    });

    html += '</div>';
    document.getElementById('main-content').innerHTML = html;
}

// â”€â”€ PERFIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function abrirPerfil(id) {
    const m = todosMembros.find(x => x.id === id);
    if (!m) return;

    document.getElementById('overlay').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    document.getElementById('p-body').innerHTML = '<div class="loading"><div class="spin"></div></div>';

    // Avatar
    const av = document.getElementById('p-avatar');
    av.innerHTML = m.foto_url
        ? `<img src="${m.foto_url}" alt="${m.nome}">`
        : `<div class="perfil-avatar-initials">${getInitials(m.nome)}</div>`;

    // Queries paralelas: famÃ­lia + ministÃ©rios do membro
    const [conjugeRes, paiRes, maeRes, filhosRes, memMinRes] = await Promise.all([
        m.conjuge_id ? sb(`membros?select=id,nome,foto_url&id=eq.${m.conjuge_id}`) : Promise.resolve([]),
        m.pai_id     ? sb(`membros?select=id,nome,foto_url&id=eq.${m.pai_id}`)     : Promise.resolve([]),
        m.mae_id     ? sb(`membros?select=id,nome,foto_url&id=eq.${m.mae_id}`)     : Promise.resolve([]),
        sb(`membros_filhos?select=filho_id&pai_id=eq.${id}`),
        sb(`membro_ministerios?select=ministerio_id&membro_id=eq.${id}&ativo=eq.true`),
    ]);

    const conjuge = conjugeRes?.[0] || null;
    const pai     = paiRes?.[0]     || null;
    const mae     = maeRes?.[0]     || null;

    // Filhos
    let filhos = [];
    if (filhosRes?.length > 0) {
        const ids      = filhosRes.map(f => f.filho_id).join(',');
        const filhosInfo = await sb(`membros?select=id,nome,foto_url&id=in.(${ids})`);
        filhos = Array.isArray(filhosInfo) ? filhosInfo : [];
    }

    // MinistÃ©rios que o membro lidera/participa
    const meusMinisterios = Array.isArray(memMinRes)
        ? memMinRes.map(r => ministeriosMap[r.ministerio_id]).filter(Boolean)
        : [];

    const link  = m.link_id ? linksMap[m.link_id] : null;
    const aniv  = isAnivMes(m);
    const meses = ['Janeiro','Fevereiro','MarÃ§o','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
    const wpp   = wppUrl(m.telefone);

    // Badges perfil
    const badgesHtml = [
        m.e_presbitero ? `<span class="pbadge pb-presb">PresbÃ­tero</span>`  : '',
        m.e_lider      ? `<span class="pbadge pb-lider">LÃ­der</span>`       : '',
        m.e_voluntario ? `<span class="pbadge pb-vol">VoluntÃ¡rio</span>`    : '',
        (!m.e_lider && !m.e_presbitero && !m.e_voluntario) ? `<span class="pbadge pb-membro">Membro</span>` : '',
        m.foi_batizado ? `<span class="pbadge pb-batiz">Batizado</span>`    : '',
        aniv           ? `<span class="pbadge pb-aniv">ğŸ‚ Aniversariante</span>` : '',
    ].filter(Boolean).join('');

    // Helpers
    function cell(label, value) {
        const empty = !value;
        return `<div class="p-cell"><div class="p-cell-label">${label}</div><div class="p-cell-value ${empty?'faint':''}">${empty?'â€”':value}</div></div>`;
    }
    function cellFull(label, value) {
        const empty = !value;
        return `<div class="p-cell p-cell-full"><div class="p-cell-label">${label}</div><div class="p-cell-value ${empty?'faint':''}">${empty?'â€”':value}</div></div>`;
    }
    function famCard(pessoa, rel) {
        if (!pessoa) return '';
        const avHtml = pessoa.foto_url
            ? `<div class="fam-avatar"><img src="${pessoa.foto_url}" alt="${pessoa.nome}"></div>`
            : `<div class="fam-avatar">${getInitials(pessoa.nome)}</div>`;
        return `
        <div class="fam-card" onclick="closePerfil();setTimeout(()=>abrirPerfil('${pessoa.id}'),250)">
            ${avHtml}
            <div><div class="fam-nome">${pessoa.nome}</div><div class="fam-rel">${rel}</div></div>
            <div class="fam-arrow">â€º</div>
        </div>`;
    }

    const familiaCards = [
        famCard(conjuge,'CÃ´njuge'),
        famCard(pai,'Pai'),
        famCard(mae,'MÃ£e'),
        ...filhos.map(f => famCard(f,'Filho/a')),
    ].filter(Boolean);

    const SVG_MIN = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`;

    document.getElementById('p-body').innerHTML = `
    <div class="perfil-nome">${m.nome}</div>
    <div class="perfil-subtipo">Membro Â· Zion Lisboa${aniv ? ` Â· ğŸ‚ ${meses[new Date(m.data_nascimento+'T12:00:00').getMonth()]}` : ''}</div>
    ${badgesHtml ? `<div class="perfil-badges">${badgesHtml}</div>` : ''}

    ${wpp ? `
    <div class="perfil-actions">
        <button class="btn-wpp-perfil" onclick="window.open('${wpp}','_blank')">
            ${SVG_WPP}
            WhatsApp
        </button>
    </div>` : ''}

    <div class="p-section">
        <div class="p-section-title">InformaÃ§Ã£o Pessoal</div>
        <div class="p-grid">
            ${cellFull('Email', m.email)}
            ${cell('Telefone', m.telefone)}
            ${cell('Data de Nascimento', m.data_nascimento ? `${formatDate(m.data_nascimento)}${aniv?' ğŸ‰':''}` : null)}
            ${cell('Estado Civil', m.estado_civil)}
            ${cell('GÃ©nero', m.genero)}
        </div>
    </div>

    ${familiaCards.length ? `
    <div class="p-section">
        <div class="p-section-title">FamÃ­lia</div>
        <div class="familia-list">${familiaCards.join('')}</div>
    </div>` : ''}

    <div class="p-section">
        <div class="p-section-title">Na Igreja</div>
        <div class="p-grid">
            ${cell('Membro desde', formatDate(m.data_entrada))}
            ${cell('Batismo', m.foi_batizado ? (m.data_batismo ? formatDate(m.data_batismo) : 'Sim') : 'NÃ£o')}
            ${cellFull('Link', link ? `${link.nome}${link.responsavel?' Â· '+link.responsavel:''}` : null)}
        </div>
    </div>

    ${meusMinisterios.length ? `
    <div class="p-section">
        <div class="p-section-title">MinistÃ©rios</div>
        <div class="ministerios-wrap">
            ${meusMinisterios.map(mn => `<div class="min-tag">${SVG_MIN}${mn.nome}</div>`).join('')}
        </div>
    </div>` : ''}

    ${m.historia ? `
    <div class="p-section">
        <div class="p-section-title">HistÃ³ria</div>
        <div class="p-grid p-grid-full">
            <div class="p-cell p-cell-full">
                <div class="p-cell-value" style="white-space:pre-line;line-height:1.7">${m.historia}</div>
            </div>
        </div>
    </div>` : ''}`;
}

function closePerfil() {
    document.getElementById('overlay').classList.add('hidden');
    document.body.style.overflow = '';
}
function closeOutside(e) {
    if (e.target === document.getElementById('overlay')) closePerfil();
}
document.addEventListener('keydown', e => { if (e.key === 'Escape') closePerfil(); });

init();
</script>
</body>
</html>
