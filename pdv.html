<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PDV â€” Zion Lisboa</title>
<script src="config.js"></script>
<script src="auth.js"></script>
<style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Inter:wght@300;400;500;600;700&display=swap');

    :root {
        --bg:          #0d0f14;
        --bg-card:     #141720;
        --bg-panel:    #1a1e2a;
        --border:      #2a2e3d;
        --border-light:#353a4d;
        --primary:     #6c8aff;
        --primary-dk:  #4a6aef;
        --green:       #22c55e;
        --green-dk:    #16a34a;
        --red:         #ef4444;
        --orange:      #f97316;
        --yellow:      #eab308;
        --text:        #e8eaf0;
        --text-muted:  #8b8fa8;
        --text-faint:  #4a4e61;
        --mono:        'JetBrains Mono', monospace;
        --sans:        'Inter', sans-serif;
        --radius:      10px;
        --shadow:      0 4px 24px rgba(0,0,0,0.4);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: var(--sans); background: var(--bg); color: var(--text); min-height: 100vh; display: flex; flex-direction: column; }

    /* â”€â”€ HEADER â”€â”€ */
    .header {
        background: var(--bg-card);
        border-bottom: 1px solid var(--border);
        padding: 0 16px;
        height: 52px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: sticky;
        top: 0;
        z-index: 100;
        gap: 12px;
    }
    .header-logo {
        font-family: var(--mono);
        font-size: 13px;
        font-weight: 700;
        color: var(--primary);
        letter-spacing: 2px;
        white-space: nowrap;
    }
    .header-tabs { display: flex; gap: 2px; }
    .header-tab {
        padding: 6px 14px;
        border-radius: 7px;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        border: none;
        background: transparent;
        color: var(--text-muted);
        transition: all 0.15s;
    }
    .header-tab.active { background: var(--primary); color: #fff; }
    .header-tab:hover:not(.active) { background: var(--bg-panel); color: var(--text); }
    .header-right { display: flex; align-items: center; gap: 10px; font-size: 12px; color: var(--text-muted); }
    .clock { font-family: var(--mono); font-size: 13px; color: var(--text); }

    /* â”€â”€ LAYOUT PDV â”€â”€ */
    .pdv-layout {
        display: grid;
        grid-template-columns: 1fr 380px;
        gap: 0;
        flex: 1;
        height: calc(100vh - 52px);
        overflow: hidden;
    }

    /* â”€â”€ LADO ESQUERDO â€” PRODUTOS â”€â”€ */
    .produtos-panel {
        display: flex;
        flex-direction: column;
        border-right: 1px solid var(--border);
        overflow: hidden;
    }

    .produtos-toolbar {
        padding: 12px 16px;
        background: var(--bg-card);
        border-bottom: 1px solid var(--border);
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
    }

    .search-bar {
        display: flex;
        align-items: center;
        gap: 8px;
        background: var(--bg-panel);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 0 12px;
        flex: 1;
        min-width: 200px;
    }
    .search-bar svg { flex-shrink: 0; color: var(--text-muted); }
    .search-bar input {
        background: none;
        border: none;
        outline: none;
        color: var(--text);
        font-size: 13px;
        font-family: var(--sans);
        width: 100%;
        height: 38px;
    }
    .search-bar input::placeholder { color: var(--text-faint); }

    .cat-filters {
        display: flex;
        gap: 6px;
        padding: 10px 16px;
        overflow-x: auto;
        border-bottom: 1px solid var(--border);
        scrollbar-width: none;
        flex-shrink: 0;
    }
    .cat-filters::-webkit-scrollbar { display: none; }
    .cat-btn {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 500;
        cursor: pointer;
        border: 1px solid var(--border);
        background: transparent;
        color: var(--text-muted);
        white-space: nowrap;
        transition: all 0.15s;
    }
    .cat-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }
    .cat-btn:hover:not(.active) { border-color: var(--primary); color: var(--primary); }

    /* SecÃ§Ã£o Keola / Loja toggle */
    .source-toggle {
        display: flex;
        gap: 4px;
        background: var(--bg-panel);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 3px;
    }
    .source-btn {
        padding: 5px 12px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        background: transparent;
        color: var(--text-muted);
        transition: all 0.15s;
    }
    .source-btn.active { background: var(--bg-card); color: var(--text); box-shadow: 0 1px 4px rgba(0,0,0,0.3); }

    .produtos-grid {
        flex: 1;
        overflow-y: auto;
        padding: 12px 16px;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 10px;
        align-content: start;
    }

    .produto-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        cursor: pointer;
        transition: all 0.15s;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        position: relative;
    }
    .produto-card:hover { border-color: var(--primary); transform: translateY(-1px); box-shadow: 0 4px 16px rgba(108,138,255,0.15); }
    .produto-card:active { transform: translateY(0); }
    .produto-card.sem-estoque { opacity: 0.45; }
    .produto-img {
        width: 100%;
        aspect-ratio: 1;
        object-fit: cover;
        background: var(--bg-panel);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 32px;
        color: var(--text-faint);
    }
    .produto-img img { width: 100%; height: 100%; object-fit: cover; }
    .produto-info { padding: 8px; flex: 1; display: flex; flex-direction: column; gap: 3px; }
    .produto-nome { font-size: 11px; font-weight: 600; color: var(--text); line-height: 1.3; }
    .produto-sku  { font-family: var(--mono); font-size: 9px; color: var(--text-faint); }
    .produto-preco { font-family: var(--mono); font-size: 13px; font-weight: 700; color: var(--green); margin-top: auto; }
    .produto-preco-promo { font-family: var(--mono); font-size: 9px; color: var(--text-faint); text-decoration: line-through; }
    .produto-stock-badge {
        position: absolute;
        top: 6px; right: 6px;
        background: rgba(0,0,0,0.7);
        border-radius: 4px;
        padding: 2px 5px;
        font-family: var(--mono);
        font-size: 9px;
        color: var(--text-muted);
    }
    .produto-stock-badge.low { color: var(--orange); }
    .produto-stock-badge.zero { color: var(--red); }
    .badge-destaque {
        position: absolute; top: 6px; left: 6px;
        background: var(--yellow); color: #000;
        border-radius: 4px; padding: 2px 5px;
        font-size: 8px; font-weight: 700;
    }

    .empty-produtos {
        grid-column: 1/-1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 60px;
        color: var(--text-faint);
        font-size: 13px;
    }

    /* â”€â”€ LADO DIREITO â€” CAIXA â”€â”€ */
    .caixa-panel {
        display: flex;
        flex-direction: column;
        background: var(--bg-card);
        overflow: hidden;
    }

    .caixa-header {
        padding: 12px 16px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .caixa-title { font-family: var(--mono); font-size: 11px; font-weight: 700; color: var(--text-muted); letter-spacing: 2px; }
    .btn-limpar { font-size: 11px; color: var(--red); background: none; border: none; cursor: pointer; padding: 4px 8px; border-radius: 6px; }
    .btn-limpar:hover { background: rgba(239,68,68,0.1); }

    /* Cliente */
    .cliente-section {
        padding: 10px 16px;
        border-bottom: 1px solid var(--border);
    }
    .cliente-label { font-size: 10px; font-weight: 600; color: var(--text-faint); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 6px; }
    .cliente-select {
        width: 100%;
        background: var(--bg-panel);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 8px 10px;
        color: var(--text);
        font-size: 12px;
        font-family: var(--sans);
        outline: none;
        cursor: pointer;
    }
    .cliente-select:focus { border-color: var(--primary); }

    /* Itens da venda */
    .itens-lista {
        flex: 1;
        overflow-y: auto;
        padding: 8px 0;
    }
    .item-venda {
        padding: 8px 16px;
        border-bottom: 1px solid var(--border);
        display: flex;
        gap: 10px;
        align-items: flex-start;
        transition: background 0.1s;
    }
    .item-venda:hover { background: var(--bg-panel); }
    .item-nome { font-size: 12px; font-weight: 500; flex: 1; line-height: 1.3; }
    .item-sku  { font-family: var(--mono); font-size: 9px; color: var(--text-faint); }
    .item-qtd-ctrl { display: flex; align-items: center; gap: 4px; margin-top: 4px; }
    .btn-qtd {
        width: 22px; height: 22px;
        border-radius: 6px;
        border: 1px solid var(--border);
        background: var(--bg-panel);
        color: var(--text);
        font-size: 14px;
        cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        transition: all 0.1s;
    }
    .btn-qtd:hover { border-color: var(--primary); color: var(--primary); }
    .qtd-val { font-family: var(--mono); font-size: 12px; font-weight: 700; min-width: 20px; text-align: center; }
    .item-right { text-align: right; flex-shrink: 0; }
    .item-unit  { font-family: var(--mono); font-size: 10px; color: var(--text-muted); }
    .item-total { font-family: var(--mono); font-size: 13px; font-weight: 700; color: var(--green); }
    .btn-remover { background: none; border: none; color: var(--text-faint); cursor: pointer; font-size: 14px; padding: 2px; margin-top: 4px; display: block; margin-left: auto; }
    .btn-remover:hover { color: var(--red); }

    .empty-caixa {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 8px;
        color: var(--text-faint);
        font-size: 12px;
    }

    /* Totais */
    .totais-section {
        border-top: 1px solid var(--border);
        padding: 12px 16px;
        background: var(--bg-panel);
    }
    .total-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    .total-label { font-size: 11px; color: var(--text-muted); }
    .total-val   { font-family: var(--mono); font-size: 11px; color: var(--text); }
    .total-geral-row {
        display: flex; justify-content: space-between; align-items: center;
        margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border);
    }
    .total-geral-label { font-size: 13px; font-weight: 700; }
    .total-geral-val   { font-family: var(--mono); font-size: 20px; font-weight: 700; color: var(--green); }

    /* Desconto */
    .desconto-row { display: flex; align-items: center; gap: 6px; margin-bottom: 6px; }
    .desconto-row label { font-size: 11px; color: var(--text-muted); flex-shrink: 0; }
    .desconto-input {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 4px 8px;
        color: var(--text);
        font-family: var(--mono);
        font-size: 12px;
        width: 70px;
        outline: none;
        text-align: right;
    }
    .desconto-input:focus { border-color: var(--primary); }
    .desconto-tipo {
        display: flex; gap: 3px;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 2px;
    }
    .desconto-tipo button {
        border: none; cursor: pointer; background: transparent; color: var(--text-muted);
        font-size: 10px; padding: 3px 6px; border-radius: 4px;
    }
    .desconto-tipo button.active { background: var(--primary); color: #fff; }

    /* Pagamento */
    .pagamento-section { padding: 10px 16px; border-top: 1px solid var(--border); }
    .pag-label { font-size: 10px; font-weight: 600; color: var(--text-faint); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; }
    .pag-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
    .pag-btn {
        padding: 10px 8px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: var(--bg-panel);
        color: var(--text-muted);
        font-size: 11px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        transition: all 0.15s;
    }
    .pag-btn .pag-icon { font-size: 18px; }
    .pag-btn.active { border-color: var(--primary); background: rgba(108,138,255,0.12); color: var(--primary); }
    .pag-btn:hover:not(.active) { border-color: var(--border-light); color: var(--text); }

    /* Troco (dinheiro) */
    .troco-section { padding: 6px 16px; display: none; }
    .troco-section.visible { display: block; }
    .troco-row { display: flex; align-items: center; gap: 8px; }
    .troco-label { font-size: 11px; color: var(--text-muted); }
    .troco-input {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 6px 8px;
        color: var(--text);
        font-family: var(--mono);
        font-size: 13px;
        width: 90px;
        outline: none;
        text-align: right;
    }
    .troco-input:focus { border-color: var(--primary); }
    .troco-val { font-family: var(--mono); font-size: 13px; font-weight: 700; color: var(--yellow); }

    /* BotÃ£o finalizar */
    .btn-finalizar {
        margin: 10px 16px;
        width: calc(100% - 32px);
        padding: 14px;
        border-radius: var(--radius);
        border: none;
        background: linear-gradient(135deg, var(--green), var(--green-dk));
        color: #fff;
        font-size: 15px;
        font-weight: 700;
        cursor: pointer;
        letter-spacing: 0.5px;
        transition: all 0.15s;
        box-shadow: 0 4px 16px rgba(34,197,94,0.25);
    }
    .btn-finalizar:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(34,197,94,0.35); }
    .btn-finalizar:disabled { background: var(--bg-panel); color: var(--text-faint); box-shadow: none; transform: none; cursor: not-allowed; }

    /* â”€â”€ ABA ADMIN â”€â”€ */
    .admin-panel {
        padding: 16px;
        overflow-y: auto;
        flex: 1;
        display: none;
    }
    .admin-panel.active { display: block; }
    .admin-section { margin-bottom: 24px; }
    .admin-section-title {
        font-family: var(--mono);
        font-size: 9px;
        letter-spacing: 2px;
        text-transform: uppercase;
        color: var(--text-faint);
        margin-bottom: 12px;
        padding-bottom: 6px;
        border-bottom: 1px solid var(--border);
    }
    .admin-form { display: flex; flex-direction: column; gap: 10px; }
    .admin-label { font-size: 11px; font-weight: 500; color: var(--text-muted); margin-bottom: 4px; display: block; }
    .admin-input, .admin-textarea, .admin-select {
        width: 100%;
        background: var(--bg-panel);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 9px 12px;
        color: var(--text);
        font-size: 13px;
        font-family: var(--sans);
        outline: none;
        transition: border-color 0.15s;
    }
    .admin-input:focus, .admin-textarea:focus, .admin-select:focus { border-color: var(--primary); }
    .admin-textarea { resize: vertical; min-height: 70px; }
    .btn-admin-save {
        padding: 10px 20px;
        background: var(--primary);
        color: #fff;
        border: none;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.15s;
    }
    .btn-admin-save:hover { background: var(--primary-dk); }
    .admin-msg { font-size: 12px; padding: 8px 12px; border-radius: 8px; display: none; }
    .admin-msg.ok    { display: block; background: rgba(34,197,94,0.12); color: var(--green); border: 1px solid rgba(34,197,94,0.3); }
    .admin-msg.error { display: block; background: rgba(239,68,68,0.12); color: var(--red);   border: 1px solid rgba(239,68,68,0.3); }

    /* â”€â”€ MODAL FINALIZAÃ‡ÃƒO â”€â”€ */
    .modal-overlay {
        position: fixed; inset: 0;
        background: rgba(0,0,0,0.7);
        z-index: 200;
        display: flex; align-items: center; justify-content: center;
        opacity: 0; pointer-events: none; transition: opacity 0.2s;
    }
    .modal-overlay.open { opacity: 1; pointer-events: all; }
    .modal-box {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 24px;
        width: min(95vw, 400px);
        box-shadow: var(--shadow);
        transform: translateY(20px); transition: transform 0.2s;
    }
    .modal-overlay.open .modal-box { transform: translateY(0); }
    .modal-title { font-family: var(--mono); font-size: 14px; font-weight: 700; margin-bottom: 16px; }
    .modal-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 12px; }
    .modal-row span { color: var(--text-muted); }
    .modal-row strong { font-family: var(--mono); color: var(--text); }
    .modal-total { display: flex; justify-content: space-between; margin: 12px 0; padding: 12px 0; border-top: 1px solid var(--border); }
    .modal-total span { font-size: 14px; font-weight: 700; }
    .modal-total strong { font-family: var(--mono); font-size: 20px; color: var(--green); }
    .modal-actions { display: flex; gap: 8px; margin-top: 16px; }
    .btn-modal-cancel {
        flex: 1; padding: 11px; border-radius: 8px; border: 1px solid var(--border);
        background: transparent; color: var(--text-muted); font-size: 13px; cursor: pointer;
    }
    .btn-modal-confirm {
        flex: 2; padding: 11px; border-radius: 8px; border: none;
        background: var(--green); color: #fff; font-size: 13px; font-weight: 700; cursor: pointer;
    }
    .btn-modal-print {
        flex: 1; padding: 11px; border-radius: 8px; border: 1px solid var(--primary);
        background: rgba(108,138,255,0.1); color: var(--primary); font-size: 13px; cursor: pointer;
    }

    /* â”€â”€ CUPOM IMPRESSÃƒO â”€â”€ */
    @media print {
        body * { display: none !important; }
        #cupom-print { display: block !important; }
    }
    #cupom-print {
        display: none;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        max-width: 280px;
        margin: 0 auto;
        padding: 10px;
        color: #000;
        background: #fff;
    }
    #cupom-print .cup-center { text-align: center; }
    #cupom-print .cup-line   { border-top: 1px dashed #000; margin: 6px 0; }
    #cupom-print .cup-row    { display: flex; justify-content: space-between; }
    #cupom-print .cup-bold   { font-weight: bold; }
    #cupom-print .cup-total  { font-size: 15px; font-weight: bold; margin-top: 4px; }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

    /* Loading */
    .pdv-loading {
        position: fixed; inset: 0;
        background: var(--bg);
        display: flex; align-items: center; justify-content: center;
        flex-direction: column; gap: 12px; z-index: 500;
    }
    .pdv-loading .spin {
        width: 28px; height: 28px;
        border: 2px solid var(--border);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* NotificaÃ§Ã£o toast */
    .toast {
        position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
        background: var(--bg-card); border: 1px solid var(--border);
        border-radius: 10px; padding: 10px 18px;
        font-size: 13px; color: var(--text);
        z-index: 300; opacity: 0; transition: opacity 0.2s;
        pointer-events: none; white-space: nowrap;
        box-shadow: var(--shadow);
    }
    .toast.show { opacity: 1; }
    .toast.ok  { border-color: var(--green); color: var(--green); }
    .toast.err { border-color: var(--red);   color: var(--red);   }
</style>
</head>
<body>

<div class="pdv-loading" id="pdv-loading">
    <div class="spin"></div>
    <div style="font-family:var(--mono);font-size:11px;color:var(--text-muted);letter-spacing:2px">A CARREGAR PDV...</div>
</div>

<!-- HEADER -->
<div class="header">
    <div class="header-logo">âš¡ ZION PDV</div>
    <div class="header-tabs">
        <button class="header-tab active" onclick="setAba('venda')" id="tab-venda">Venda</button>
        <button class="header-tab"        onclick="setAba('admin')" id="tab-admin">ConfiguraÃ§Ã£o</button>
    </div>
    <div class="header-right">
        <span id="operador-nome" style="color:var(--primary)"></span>
        <span class="clock" id="clock">--:--</span>
    </div>
</div>

<!-- ABA VENDA -->
<div class="pdv-layout" id="aba-venda">
    <!-- PRODUTOS -->
    <div class="produtos-panel">
        <div class="produtos-toolbar">
            <div class="search-bar">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                <input type="text" id="prod-search" placeholder="Nome, SKU ou cÃ³digo de barras..." oninput="filtrarProdutos()" onkeydown="handleSearchKey(event)">
            </div>
            <div class="source-toggle">
                <button class="source-btn active" id="src-loja" onclick="setSource('loja')">ğŸ› Loja</button>
                <button class="source-btn" id="src-keola" onclick="setSource('keola')">ğŸ½ Keola</button>
            </div>
        </div>
        <div class="cat-filters" id="cat-filters"></div>
        <div class="produtos-grid" id="produtos-grid">
            <div class="empty-produtos">
                <div style="font-size:32px">â³</div>
                <div>A carregar produtos...</div>
            </div>
        </div>
    </div>

    <!-- CAIXA -->
    <div class="caixa-panel">
        <div class="caixa-header">
            <div class="caixa-title">CAIXA</div>
            <button class="btn-limpar" onclick="limparCaixa()">âœ• Limpar</button>
        </div>

        <div class="cliente-section">
            <div class="cliente-label">Cliente (opcional)</div>
            <select class="cliente-select" id="cliente-select">
                <option value="">â€” Venda sem identificaÃ§Ã£o â€”</option>
            </select>
        </div>

        <div id="itens-area">
            <div class="empty-caixa">
                <div style="font-size:36px">ğŸ›’</div>
                <div>Seleciona produtos para adicionar</div>
            </div>
        </div>

        <div class="totais-section" id="totais-section" style="display:none">
            <div class="total-row">
                <span class="total-label">Subtotal</span>
                <span class="total-val" id="subtotal-val">â‚¬0.00</span>
            </div>
            <div class="desconto-row">
                <label class="total-label">Desconto</label>
                <input class="desconto-input" id="desconto-input" type="number" min="0" placeholder="0" oninput="calcTotais()">
                <div class="desconto-tipo">
                    <button id="desc-pct" class="active" onclick="setDescontoTipo('pct')">%</button>
                    <button id="desc-eur" onclick="setDescontoTipo('eur')">â‚¬</button>
                </div>
            </div>
            <div class="total-row" id="row-desconto" style="display:none">
                <span class="total-label" style="color:var(--orange)">Desconto</span>
                <span class="total-val" id="desconto-val" style="color:var(--orange)">-â‚¬0.00</span>
            </div>
            <div class="total-geral-row">
                <span class="total-geral-label">TOTAL</span>
                <span class="total-geral-val" id="total-val">â‚¬0.00</span>
            </div>
        </div>

        <div class="pagamento-section" id="pag-section" style="display:none">
            <div class="pag-label">Forma de Pagamento</div>
            <div class="pag-grid">
                <button class="pag-btn active" onclick="setPagamento('dinheiro')" id="pag-dinheiro">
                    <span class="pag-icon">ğŸ’¶</span>Dinheiro
                </button>
                <button class="pag-btn" onclick="setPagamento('mbway')" id="pag-mbway">
                    <span class="pag-icon">ğŸ“±</span>MB Way
                </button>
                <button class="pag-btn" onclick="setPagamento('multibanco')" id="pag-multibanco">
                    <span class="pag-icon">ğŸ’³</span>Multibanco
                </button>
                <button class="pag-btn" onclick="setPagamento('transferencia')" id="pag-transferencia">
                    <span class="pag-icon">ğŸ¦</span>TransferÃªncia
                </button>
            </div>
        </div>

        <div class="troco-section" id="troco-section">
            <div class="troco-row">
                <span class="troco-label">Recebido:</span>
                <input class="troco-input" id="recebido-input" type="number" min="0" placeholder="0.00" oninput="calcTroco()">
                <span class="troco-label">Troco:</span>
                <span class="troco-val" id="troco-val">â‚¬0.00</span>
            </div>
        </div>

        <button class="btn-finalizar" id="btn-finalizar" onclick="abrirModalFinalizar()" disabled>
            Finalizar Venda
        </button>
    </div>
</div>

<!-- ABA ADMIN -->
<div class="admin-panel" id="aba-admin">
    <div class="admin-section">
        <div class="admin-section-title">ConfiguraÃ§Ã£o do Ponto de Venda</div>
        <div class="admin-form">
            <div>
                <label class="admin-label">Nome do Estabelecimento</label>
                <input class="admin-input" id="cfg-nome" type="text" placeholder="Ex: Zion Lisboa â€” Loja Oficial">
            </div>
            <div>
                <label class="admin-label">Morada</label>
                <input class="admin-input" id="cfg-morada" type="text" placeholder="Ex: Rua da Igreja, 10 â€” Lisboa">
            </div>
            <div>
                <label class="admin-label">NIF</label>
                <input class="admin-input" id="cfg-nif" type="text" placeholder="Ex: 500 000 000">
            </div>
            <div>
                <label class="admin-label">Telefone</label>
                <input class="admin-input" id="cfg-telefone" type="text" placeholder="Ex: +351 910 000 000">
            </div>
            <div>
                <label class="admin-label">Email</label>
                <input class="admin-input" id="cfg-email" type="email" placeholder="Ex: loja@zionlisboa.pt">
            </div>
            <div>
                <label class="admin-label">Website</label>
                <input class="admin-input" id="cfg-website" type="text" placeholder="Ex: zionlisboa.pt">
            </div>
            <div>
                <label class="admin-label">Mensagem no RodapÃ© do Cupom</label>
                <textarea class="admin-textarea" id="cfg-rodape" placeholder="Ex: Obrigado pela visita! Que Deus te abenÃ§oe ğŸ™"></textarea>
            </div>
            <div>
                <label class="admin-label">Nome do Operador (este dispositivo)</label>
                <input class="admin-input" id="cfg-operador" type="text" placeholder="Ex: Caixa 1 â€” RecepÃ§Ã£o">
            </div>
            <div class="admin-msg" id="admin-msg"></div>
            <button class="btn-admin-save" onclick="salvarConfig()">Guardar ConfiguraÃ§Ã£o</button>
        </div>
    </div>
</div>

<!-- MODAL FINALIZAR -->
<div class="modal-overlay" id="modal-finalizar">
    <div class="modal-box">
        <div class="modal-title">Confirmar Venda</div>
        <div id="modal-resumo"></div>
        <div class="modal-actions">
            <button class="btn-modal-cancel" onclick="fecharModal()">Cancelar</button>
            <button class="btn-modal-print" onclick="imprimirCupom()">ğŸ–¨ Imprimir</button>
            <button class="btn-modal-confirm" onclick="confirmarVenda()">âœ“ Confirmar</button>
        </div>
    </div>
</div>

<!-- CUPOM IMPRESSÃƒO -->
<div id="cupom-print"></div>

<div class="toast" id="toast"></div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INIT & AUTH
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SUPA_URL = window.SUPABASE_URL      || '';
const SUPA_KEY = window.SUPABASE_ANON_KEY || '';

async function sb(path, opts = {}) {
    const r = await fetch(`${SUPA_URL}/rest/v1/${path}`, {
        ...opts,
        headers: {
            'apikey': SUPA_KEY, 'Authorization': `Bearer ${SUPA_KEY}`,
            'Content-Type': 'application/json', 'Prefer': 'return=representation',
            ...opts.headers,
        },
    });
    if (!r.ok) { const e = await r.json().catch(() => ({})); throw e; }
    const txt = await r.text();
    return txt ? JSON.parse(txt) : [];
}

// Verificar autenticaÃ§Ã£o e permissÃµes
// ZionAuth.protect() redireciona para login.html se nÃ£o autenticado
// Para presbÃ­teros verificamos o campo e_presbitero na tabela membros
function verificarAcesso() {
    // Redireciona para login.html se nÃ£o logado (igual ao admin.html)
    ZionAuth.protect({ tipo: 'membro' });
    return ZionAuth.getUser();
}

async function verificarPermissao(user) {
    if (!user) return false;
    // Admin tem sempre acesso
    if (user.tipo === 'admin') return true;
    // Verifica se Ã© presbÃ­tero
    if (user.membro_id) {
        try {
            const m = await sb(`membros?id=eq.${user.membro_id}&select=e_presbitero,e_admin`);
            if (m?.[0]?.e_presbitero || m?.[0]?.e_admin) return true;
        } catch { return true; } // dev mode
    }
    return false;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ESTADO
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let produtos      = [];  // todos os produtos carregados
let membros       = [];  // para o select de cliente
let itensVenda    = [];  // [{produto, qtd}]
let pagamentoTipo = 'dinheiro';
let descontoTipo  = 'pct';
let sourceAtivo   = 'loja';
let catAtiva      = '';
let userAtual     = null;

// Config do PDV (localStorage)
let cfg = {};
function loadCfg() {
    try { cfg = JSON.parse(localStorage.getItem('zion_pdv_cfg') || '{}'); } catch { cfg = {}; }
}
function saveCfg() {
    localStorage.setItem('zion_pdv_cfg', JSON.stringify(cfg));
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CLOCK
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateClock() {
    const now = new Date();
    const h = String(now.getHours()).padStart(2,'0');
    const m = String(now.getMinutes()).padStart(2,'0');
    const s = String(now.getSeconds()).padStart(2,'0');
    document.getElementById('clock').textContent = `${h}:${m}:${s}`;
}
setInterval(updateClock, 1000);
updateClock();

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CARREGAR DADOS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function carregarProdutosLoja() {
    const data = await sb('loja_produtos?select=*&ativo=eq.true&disponivel=eq.true&order=categoria,nome') || [];
    return data;
}

async function carregarProdutosKeola() {
    const data = await sb('keola_itens?select=*&ativo=eq.true&disponivel=eq.true&order=categoria,nome').catch(() => []) || [];
    return data.map(k => ({
        ...k,
        _keola: true,
        preco: k.preco || 0,
        categoria: k.categoria || 'Keola',
        imagem_url: k.imagem_url || k.foto_url,
    }));
}

async function carregarMembros() {
    const data = await sb('membros?select=id,nome&ativo=eq.true&order=nome').catch(() => []) || [];
    membros = data;
    const sel = document.getElementById('cliente-select');
    sel.innerHTML = '<option value="">â€” Venda sem identificaÃ§Ã£o â€”</option>';
    membros.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.id;
        opt.textContent = m.nome;
        sel.appendChild(opt);
    });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ABAS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setAba(aba) {
    document.getElementById('aba-venda').style.display  = aba === 'venda' ? 'grid' : 'none';
    document.getElementById('aba-admin').style.display  = aba === 'admin' ? 'block' : 'none';
    document.getElementById('tab-venda').classList.toggle('active', aba === 'venda');
    document.getElementById('tab-admin').classList.toggle('active', aba === 'admin');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SOURCE (loja / keola)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function setSource(src) {
    sourceAtivo = src;
    catAtiva = '';
    document.getElementById('src-loja').classList.toggle('active', src === 'loja');
    document.getElementById('src-keola').classList.toggle('active', src === 'keola');

    if (src === 'keola') {
        document.getElementById('produtos-grid').innerHTML = '<div class="empty-produtos"><div style="font-size:32px">â³</div><div>A carregar...</div></div>';
        const keola = await carregarProdutosKeola();
        produtos = keola;
    } else {
        const loja = await carregarProdutosLoja();
        produtos = loja;
    }
    renderCategorias();
    filtrarProdutos();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CATEGORIAS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCategorias() {
    const cats = [...new Set(produtos.map(p => p.categoria).filter(Boolean))].sort();
    const el = document.getElementById('cat-filters');
    el.innerHTML = `<button class="cat-btn ${catAtiva===''?'active':''}" onclick="setCat('')">Todos</button>`;
    cats.forEach(c => {
        el.innerHTML += `<button class="cat-btn ${catAtiva===c?'active':''}" onclick="setCat('${c}')">${c}</button>`;
    });
}

function setCat(cat) {
    catAtiva = cat;
    renderCategorias();
    filtrarProdutos();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FILTRAR E RENDERIZAR PRODUTOS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function filtrarProdutos() {
    const q = document.getElementById('prod-search').value.toLowerCase().trim();
    let lista = [...produtos];
    if (catAtiva) lista = lista.filter(p => p.categoria === catAtiva);
    if (q) lista = lista.filter(p =>
        (p.nome||'').toLowerCase().includes(q) ||
        (p.sku||'').toLowerCase().includes(q) ||
        (p.codigo_barras||'').toLowerCase().includes(q)
    );
    renderProdutos(lista);
}

function handleSearchKey(e) {
    if (e.key === 'Enter') {
        const q = e.target.value.trim();
        if (!q) return;
        // Tenta encontrar por cÃ³digo de barras exacto
        const match = produtos.find(p => p.codigo_barras === q || p.sku === q);
        if (match) {
            addToCart(match);
            e.target.value = '';
            filtrarProdutos();
        }
    }
}

function renderProdutos(lista) {
    const el = document.getElementById('produtos-grid');
    if (!lista.length) {
        el.innerHTML = '<div class="empty-produtos"><div style="font-size:32px">ğŸ”</div><div>Nenhum produto encontrado</div></div>';
        return;
    }

    el.innerHTML = lista.map(p => {
        const stock = p.stock ?? p.quantidade ?? null;
        const stockBadge = p.controlar_estoque !== false && stock !== null
            ? `<div class="produto-stock-badge ${stock <= 0 ? 'zero' : stock <= (p.stock_minimo||3) ? 'low' : ''}">${stock <= 0 ? 'Esgotado' : stock}</div>`
            : '';
        const promo = p.preco_promocional && p.preco_promocional < p.preco;
        const precoFinal = promo ? p.preco_promocional : p.preco;
        const emoji = catEmoji(p.categoria);
        const imgHtml = p.imagem_url
            ? `<img src="${p.imagem_url}" alt="" style="width:100%;height:100%;object-fit:cover" onerror="this.parentElement.innerHTML='${emoji}'">`
            : emoji;
        const semEst = p.controlar_estoque && stock <= 0 && !p.venda_sem_estoque;

        return `<div class="produto-card ${semEst?'sem-estoque':''}" onclick="${semEst?'':` addToCart_id('${p.id}')`}">
            <div class="produto-img">${imgHtml}</div>
            ${stockBadge}
            ${p.destaque ? '<div class="badge-destaque">â˜…</div>' : ''}
            <div class="produto-info">
                <div class="produto-nome">${p.nome}</div>
                ${p.sku ? `<div class="produto-sku">${p.sku}</div>` : ''}
                ${promo ? `<div class="produto-preco-promo">â‚¬${Number(p.preco).toFixed(2)}</div>` : ''}
                <div class="produto-preco">â‚¬${Number(precoFinal).toFixed(2)}</div>
            </div>
        </div>`;
    }).join('');
}

function catEmoji(cat) {
    const map = { Livros:'ğŸ“š', Biblia:'ğŸ“–', Vestuario:'ğŸ‘•', Acessorios:'ğŸ‘œ', Musica:'ğŸµ', Decoracao:'ğŸ•¯', Infantil:'ğŸ§¸', Keola:'ğŸ½', Outros:'ğŸ›' };
    return map[cat] || 'ğŸ›';
}

function addToCart_id(id) {
    const p = produtos.find(x => x.id === id);
    if (p) addToCart(p);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CARRINHO
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addToCart(produto) {
    const preco = produto.preco_promocional && produto.preco_promocional < produto.preco
        ? produto.preco_promocional : produto.preco;
    const existing = itensVenda.find(i => i.produto.id === produto.id);
    if (existing) {
        existing.qtd++;
    } else {
        itensVenda.push({ produto, qtd: 1, preco: Number(preco) });
    }
    renderCaixa();
    toast(`${produto.nome} adicionado`, 'ok');
}

function alterarQtd(idx, delta) {
    itensVenda[idx].qtd += delta;
    if (itensVenda[idx].qtd <= 0) itensVenda.splice(idx, 1);
    renderCaixa();
}

function removerItem(idx) {
    itensVenda.splice(idx, 1);
    renderCaixa();
}

function limparCaixa() {
    if (itensVenda.length && !confirm('Limpar todos os itens?')) return;
    itensVenda = [];
    document.getElementById('desconto-input').value = '';
    renderCaixa();
}

function renderCaixa() {
    const area = document.getElementById('itens-area');
    const totaisEl = document.getElementById('totais-section');
    const pagEl = document.getElementById('pag-section');
    const btnFin = document.getElementById('btn-finalizar');

    if (!itensVenda.length) {
        area.innerHTML = `<div class="empty-caixa"><div style="font-size:36px">ğŸ›’</div><div>Seleciona produtos para adicionar</div></div>`;
        totaisEl.style.display = 'none';
        pagEl.style.display = 'none';
        document.getElementById('troco-section').classList.remove('visible');
        btnFin.disabled = true;
        return;
    }

    area.innerHTML = `<div class="itens-lista">${itensVenda.map((item, idx) => `
        <div class="item-venda">
            <div style="flex:1">
                <div class="item-nome">${item.produto.nome}</div>
                ${item.produto.sku ? `<div class="item-sku">${item.produto.sku}</div>` : ''}
                <div class="item-qtd-ctrl">
                    <button class="btn-qtd" onclick="alterarQtd(${idx},-1)">âˆ’</button>
                    <span class="qtd-val">${item.qtd}</span>
                    <button class="btn-qtd" onclick="alterarQtd(${idx},1)">+</button>
                </div>
            </div>
            <div class="item-right">
                <div class="item-unit">â‚¬${item.preco.toFixed(2)}/un</div>
                <div class="item-total">â‚¬${(item.preco * item.qtd).toFixed(2)}</div>
                <button class="btn-remover" onclick="removerItem(${idx})">ğŸ—‘</button>
            </div>
        </div>`).join('')}
    </div>`;

    totaisEl.style.display = 'block';
    pagEl.style.display = 'block';
    btnFin.disabled = false;
    calcTotais();
}

function calcTotais() {
    const subtotal = itensVenda.reduce((s, i) => s + i.preco * i.qtd, 0);
    const descVal = parseFloat(document.getElementById('desconto-input').value) || 0;
    let desconto = descontoTipo === 'pct' ? subtotal * descVal / 100 : descVal;
    desconto = Math.min(desconto, subtotal);
    const total = subtotal - desconto;

    document.getElementById('subtotal-val').textContent = `â‚¬${subtotal.toFixed(2)}`;
    document.getElementById('total-val').textContent = `â‚¬${total.toFixed(2)}`;
    const rowDesc = document.getElementById('row-desconto');
    if (desconto > 0) {
        rowDesc.style.display = 'flex';
        document.getElementById('desconto-val').textContent = `-â‚¬${desconto.toFixed(2)}`;
    } else {
        rowDesc.style.display = 'none';
    }
    calcTroco();
}

function getTotal() {
    const subtotal = itensVenda.reduce((s, i) => s + i.preco * i.qtd, 0);
    const descVal = parseFloat(document.getElementById('desconto-input').value) || 0;
    let desconto = descontoTipo === 'pct' ? subtotal * descVal / 100 : descVal;
    return Math.max(0, subtotal - Math.min(desconto, subtotal));
}

function setDescontoTipo(tipo) {
    descontoTipo = tipo;
    document.getElementById('desc-pct').classList.toggle('active', tipo === 'pct');
    document.getElementById('desc-eur').classList.toggle('active', tipo === 'eur');
    calcTotais();
}

function setPagamento(tipo) {
    pagamentoTipo = tipo;
    document.querySelectorAll('.pag-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`pag-${tipo}`).classList.add('active');
    const trocoSec = document.getElementById('troco-section');
    if (tipo === 'dinheiro') {
        trocoSec.classList.add('visible');
    } else {
        trocoSec.classList.remove('visible');
    }
}

function calcTroco() {
    const recebido = parseFloat(document.getElementById('recebido-input')?.value) || 0;
    const total = getTotal();
    const troco = Math.max(0, recebido - total);
    const el = document.getElementById('troco-val');
    if (el) el.textContent = `â‚¬${troco.toFixed(2)}`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MODAL FINALIZAR
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function abrirModalFinalizar() {
    if (!itensVenda.length) return;
    const total = getTotal();
    const cliente = document.getElementById('cliente-select');
    const nomeCliente = cliente.options[cliente.selectedIndex]?.text || 'â€” Sem identificaÃ§Ã£o â€”';
    const pagLabels = { dinheiro:'Dinheiro ğŸ’¶', mbway:'MB Way ğŸ“±', multibanco:'Multibanco ğŸ’³', transferencia:'TransferÃªncia ğŸ¦' };

    const itensHtml = itensVenda.map(i =>
        `<div class="modal-row"><span>${i.produto.nome} Ã— ${i.qtd}</span><strong>â‚¬${(i.preco * i.qtd).toFixed(2)}</strong></div>`
    ).join('');

    document.getElementById('modal-resumo').innerHTML = `
        ${itensHtml}
        <div class="modal-total">
            <span>Total</span>
            <strong>â‚¬${total.toFixed(2)}</strong>
        </div>
        <div class="modal-row"><span>Cliente</span><strong>${nomeCliente}</strong></div>
        <div class="modal-row"><span>Pagamento</span><strong>${pagLabels[pagamentoTipo]||pagamentoTipo}</strong></div>
    `;
    document.getElementById('modal-finalizar').classList.add('open');
}

function fecharModal() {
    document.getElementById('modal-finalizar').classList.remove('open');
}

async function confirmarVenda() {
    const total = getTotal();
    const clienteSel = document.getElementById('cliente-select').value;
    const clienteNome = document.getElementById('cliente-select').options[document.getElementById('cliente-select').selectedIndex]?.text;

    // Guarda cada item como um pedido (tabela loja_pedidos)
    try {
        for (const item of itensVenda) {
            const body = {
                membro_id:     clienteSel || null,
                nome_cliente:  clienteSel ? null : 'AnÃ³nimo',
                produto_id:    item.produto.id,
                quantidade:    item.qtd,
                valor_total:   Number((item.preco * item.qtd).toFixed(2)),
                status:        'concluido',
                observacao:    `Pagamento: ${pagamentoTipo}`,
            };
            await sb('loja_pedidos', { method: 'POST', body: JSON.stringify(body) });
        }
        fecharModal();
        gerarCupom();
        setTimeout(() => {
            itensVenda = [];
            document.getElementById('desconto-input').value = '';
            renderCaixa();
            toast('âœ“ Venda registada com sucesso!', 'ok');
        }, 300);
    } catch(e) {
        toast('Erro ao gravar venda: ' + (e?.message || JSON.stringify(e)), 'err');
    }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CUPOM IMPRESSÃƒO
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function gerarCupom(imprimir = false) {
    const total    = getTotal();
    const subtotal = itensVenda.reduce((s, i) => s + i.preco * i.qtd, 0);
    const descVal  = parseFloat(document.getElementById('desconto-input')?.value) || 0;
    const desconto = descontoTipo === 'pct' ? subtotal * descVal / 100 : descVal;
    const agora    = new Date();
    const dataStr  = agora.toLocaleDateString('pt-PT') + ' ' + agora.toLocaleTimeString('pt-PT', {hour:'2-digit',minute:'2-digit'});
    const pagLabels = { dinheiro:'Dinheiro', mbway:'MB Way', multibanco:'Multibanco', transferencia:'TransferÃªncia' };
    const clienteNome = document.getElementById('cliente-select').options[document.getElementById('cliente-select').selectedIndex]?.text || '';
    const nomeEst = cfg.nome || 'Zion Lisboa';
    const rodape  = cfg.rodape || 'Obrigado pela visita!';

    const itensHtml = itensVenda.map(i =>
        `<div class="cup-row"><span>${i.produto.nome.substring(0,20)}</span><span></span></div>
         <div class="cup-row"><span style="padding-left:8px">${i.qtd}x â‚¬${i.preco.toFixed(2)}</span><span>â‚¬${(i.preco*i.qtd).toFixed(2)}</span></div>`
    ).join('');

    document.getElementById('cupom-print').innerHTML = `
    <div class="cup-center cup-bold" style="font-size:14px">${nomeEst}</div>
    ${cfg.morada ? `<div class="cup-center" style="font-size:10px">${cfg.morada}</div>` : ''}
    ${cfg.nif ? `<div class="cup-center" style="font-size:10px">NIF: ${cfg.nif}</div>` : ''}
    <div class="cup-center" style="font-size:10px">${dataStr}</div>
    ${cfg.operador ? `<div class="cup-center" style="font-size:10px">Operador: ${cfg.operador}</div>` : ''}
    <div class="cup-line"></div>
    ${itensHtml}
    <div class="cup-line"></div>
    <div class="cup-row"><span>Subtotal</span><span>â‚¬${subtotal.toFixed(2)}</span></div>
    ${desconto > 0 ? `<div class="cup-row"><span>Desconto</span><span>-â‚¬${desconto.toFixed(2)}</span></div>` : ''}
    <div class="cup-row cup-total"><span>TOTAL</span><span>â‚¬${total.toFixed(2)}</span></div>
    <div class="cup-row" style="font-size:10px"><span>Pagamento</span><span>${pagLabels[pagamentoTipo]||pagamentoTipo}</span></div>
    ${clienteNome && clienteNome !== 'â€” Venda sem identificaÃ§Ã£o â€”' ? `<div class="cup-row" style="font-size:10px"><span>Cliente</span><span>${clienteNome.substring(0,20)}</span></div>` : ''}
    <div class="cup-line"></div>
    <div class="cup-center" style="font-size:10px;line-height:1.5">${rodape}</div>
    ${cfg.website ? `<div class="cup-center" style="font-size:10px">${cfg.website}</div>` : ''}
    `;

    if (imprimir) window.print();
}

function imprimirCupom() {
    gerarCupom(true);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CONFIG ADMIN
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function carregarFormConfig() {
    const fields = ['nome','morada','nif','telefone','email','website','rodape','operador'];
    fields.forEach(f => {
        const el = document.getElementById(`cfg-${f}`);
        if (el) el.value = cfg[f] || '';
    });
}

function salvarConfig() {
    const fields = ['nome','morada','nif','telefone','email','website','rodape','operador'];
    fields.forEach(f => { cfg[f] = document.getElementById(`cfg-${f}`)?.value?.trim() || ''; });
    saveCfg();
    const msg = document.getElementById('admin-msg');
    msg.className = 'admin-msg ok';
    msg.textContent = 'âœ“ ConfiguraÃ§Ã£o guardada!';
    document.getElementById('operador-nome').textContent = cfg.operador || '';
    setTimeout(() => { msg.className = 'admin-msg'; }, 3000);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TOAST
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let toastTimer;
function toast(msg, tipo = 'ok') {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.className = `toast ${tipo} show`;
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => { el.classList.remove('show'); }, 2500);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INICIALIZAÃ‡ÃƒO
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
    loadCfg();
    carregarFormConfig();

    // Auth â€” igual ao admin.html (ZionAuth.protect jÃ¡ redireciona se nÃ£o logado)
    userAtual = verificarAcesso();

    // Verifica permissÃ£o (presbÃ­tero / admin)
    const temPermissao = await verificarPermissao(userAtual);
    if (!temPermissao && userAtual) {
        document.getElementById('pdv-loading').innerHTML = `
            <div style="font-size:32px">ğŸ”’</div>
            <div style="font-family:var(--mono);font-size:11px;color:var(--red);letter-spacing:2px;margin-top:8px">ACESSO RESTRITO</div>
            <div style="font-size:12px;color:var(--text-muted);margin-top:6px">Apenas PresbÃ­teros e Administradores</div>
            <a href="index.html" style="margin-top:16px;color:var(--primary);font-size:12px">â† Voltar ao inÃ­cio</a>`;
        return;
    }

    document.getElementById('operador-nome').textContent = cfg.operador || (userAtual?.nome?.split(' ')[0] || '');

    // Carrega produtos da loja
    try {
        produtos = await carregarProdutosLoja();
        await carregarMembros();
        renderCategorias();
        filtrarProdutos();
    } catch(e) {
        console.error('Erro ao carregar:', e);
        document.getElementById('produtos-grid').innerHTML =
            `<div class="empty-produtos"><div style="font-size:32px">âš ï¸</div><div>Erro ao carregar produtos</div></div>`;
    }

    document.getElementById('pdv-loading').style.display = 'none';
}

init();
</script>
</body>
</html>
