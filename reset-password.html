<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nova Password — Zion Lisboa</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/tokens.css">
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Lato', sans-serif;
            background: var(--bg-page, #F5FAFA);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        body::before {
            content: '';
            position: fixed; inset: 0;
            background:
                    radial-gradient(ellipse at 20% 20%, rgba(0,144,152,0.07) 0%, transparent 55%),
                    radial-gradient(ellipse at 80% 80%, rgba(0,144,152,0.05) 0%, transparent 55%);
            pointer-events: none;
        }

        .card {
            width: 100%;
            max-width: 420px;
            background: #fff;
            border-radius: 14px;
            overflow: hidden;
            box-shadow: 0 8px 40px rgba(0,80,85,0.12), 0 0 0 1px rgba(0,144,152,0.1);
            position: relative;
            z-index: 1;
        }

        .card-header {
            background: linear-gradient(135deg, #007078, #009098);
            padding: 28px 32px;
            text-align: center;
        }
        .card-header-title {
            font-family: 'Cinzel', serif;
            font-size: 24px;
            font-weight: 700;
            letter-spacing: 8px;
            color: #fff;
        }
        .card-header-sub {
            font-family: 'Cinzel', serif;
            font-size: 9px;
            letter-spacing: 3px;
            color: rgba(255,255,255,0.65);
            text-transform: uppercase;
            margin-top: 5px;
        }

        .card-body { padding: 32px; }

        .card-title {
            font-family: 'Cinzel', serif;
            font-size: 14px;
            color: var(--primary-dark, #007078);
            margin-bottom: 6px;
        }
        .card-sub {
            font-size: 13px;
            color: var(--text-faint, #7A9A9A);
            line-height: 1.6;
            margin-bottom: 24px;
        }

        .form-group { margin-bottom: 16px; }
        .form-label {
            display: block;
            font-family: 'Cinzel', serif;
            font-size: 9px;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--text-faint, #7A9A9A);
            margin-bottom: 6px;
        }
        .form-input {
            width: 100%;
            padding: 12px 14px;
            border-radius: 8px;
            border: 1px solid var(--border, rgba(0,144,152,0.2));
            background: var(--bg-input, #F5FAFA);
            font-family: 'Lato', sans-serif;
            font-size: 14px;
            color: var(--text-main, #0A2020);
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input::placeholder { color: var(--text-faint, #7A9A9A); }
        .form-input:focus {
            border-color: var(--primary-light, #009098);
            box-shadow: 0 0 0 3px rgba(0,144,152,0.1);
        }
        .form-input.error { border-color: var(--red, #c0392b); box-shadow: 0 0 0 3px rgba(192,57,43,0.08); }

        /* Indicador de força da password */
        .password-strength {
            display: flex;
            gap: 4px;
            margin-top: 6px;
        }
        .strength-bar {
            flex: 1; height: 3px; border-radius: 2px;
            background: var(--border, rgba(0,144,152,0.15));
            transition: background 0.3s;
        }
        .strength-bar.weak   { background: var(--red, #c0392b); }
        .strength-bar.medium { background: var(--orange, #e65100); }
        .strength-bar.strong { background: var(--green, #2e7d32); }
        .strength-label { font-size: 10px; color: var(--text-faint); margin-top: 4px; }

        .submit-btn {
            width: 100%;
            padding: 13px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, var(--primary-dark, #007078), var(--primary-light, #009098));
            color: #fff;
            font-family: 'Cinzel', serif;
            font-size: 11px;
            letter-spacing: 2px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 12px rgba(0,144,152,0.25);
            margin-top: 4px;
        }
        .submit-btn:hover    { filter: brightness(1.08); transform: translateY(-1px); }
        .submit-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        .msg-box {
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 16px;
            display: none;
            line-height: 1.5;
        }
        .msg-box.error   { background: rgba(192,57,43,0.06); border: 1px solid rgba(192,57,43,0.25); color: var(--red, #c0392b); display: block; }
        .msg-box.success { background: rgba(0,144,152,0.06); border: 1px solid rgba(0,144,152,0.25); color: var(--primary-dark, #007078); display: block; }

        /* Estado: token inválido */
        .state-invalid, .state-success {
            text-align: center;
            padding: 8px 0 16px;
        }
        .state-icon { margin-bottom: 14px; }
        .state-icon svg { width: 48px; height: 48px; }
        .state-title { font-family: 'Cinzel', serif; font-size: 14px; margin-bottom: 8px; }
        .state-txt   { font-size: 13px; color: var(--text-faint); line-height: 1.6; margin-bottom: 20px; }
        .state-invalid .state-icon svg { color: var(--red, #c0392b); }
        .state-invalid .state-title    { color: var(--red, #c0392b); }
        .state-success .state-icon svg { color: var(--green, #2e7d32); }
        .state-success .state-title    { color: var(--green, #2e7d32); }

        .back-link {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 10px 20px; border-radius: 8px;
            border: 1px solid var(--border, rgba(0,144,152,0.2));
            background: var(--bg-input, #F5FAFA);
            font-family: 'Cinzel', serif; font-size: 10px; letter-spacing: 1.5px;
            text-transform: uppercase; color: var(--primary-dark, #007078);
            text-decoration: none; transition: all 0.2s;
        }
        .back-link:hover { border-color: var(--primary-light); background: #fff; }

        /* Loading spinner */
        .spin {
            width: 28px; height: 28px;
            border: 2px solid rgba(0,144,152,0.2);
            border-top-color: var(--primary, #009098);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 12px;
        }
        .loading-state { text-align: center; padding: 8px 0 16px; color: var(--text-faint); font-size: 13px; }

        @keyframes spin { to { transform: rotate(360deg) } }
        @keyframes fadeUp { from { opacity:0;transform:translateY(8px) } to { opacity:1;transform:translateY(0) } }
        .card { animation: fadeUp 0.3s ease; }
    </style>
</head>
<body>
<div class="card">
    <div class="card-header">
        <div class="card-header-title">ZION</div>
        <div class="card-header-sub">Lisboa · Portugal</div>
    </div>
    <div class="card-body" id="card-body">
        <div class="loading-state">
            <div class="spin"></div>
            A verificar link...
        </div>
    </div>
</div>

<script>
    const token = new URLSearchParams(window.location.search).get('token');

    // ── Verifica token ao carregar ─────────────────────────────
    window.addEventListener('DOMContentLoaded', () => {
        if (!token) {
            renderInvalido('Link inválido.', 'Este link de recuperação não é válido. Pede um novo na página de login.');
            return;
        }
        // Mostra form directamente — a validação real acontece no submit
        // (evita um request extra só para validar)
        renderForm();
    });

    // ── Força da password ──────────────────────────────────────
    function avaliarForca(password) {
        if (password.length < 6) return { nivel: 0, label: '' };
        let score = 0;
        if (password.length >= 8) score++;
        if (/[A-Z]/.test(password)) score++;
        if (/[0-9]/.test(password)) score++;
        if (/[^A-Za-z0-9]/.test(password)) score++;
        if (score <= 1) return { nivel: 1, label: 'Fraca' };
        if (score <= 2) return { nivel: 2, label: 'Média' };
        return { nivel: 3, label: 'Forte' };
    }

    function atualizarForca(val) {
        const { nivel, label } = avaliarForca(val);
        const bars  = document.querySelectorAll('.strength-bar');
        const texto = document.querySelector('.strength-label');
        const classes = ['', 'weak', 'medium', 'strong'];
        bars.forEach((b, i) => {
            b.className = 'strength-bar';
            if (i < nivel) b.classList.add(classes[nivel]);
        });
        if (texto) texto.textContent = val.length >= 6 ? label : '';
    }

    // ── Render: form ───────────────────────────────────────────
    function renderForm() {
        document.getElementById('card-body').innerHTML = `
    <div class="card-title">Nova password</div>
    <div class="card-sub">Define uma nova password para a tua conta.</div>
    <div class="msg-box" id="reset-msg"></div>
    <div class="form-group">
        <label class="form-label">Nova password</label>
        <input class="form-input" id="new-password" type="password" placeholder="Mínimo 6 caracteres"
               oninput="atualizarForca(this.value)"
               onkeydown="if(event.key==='Enter') doReset()">
        <div class="password-strength">
            <div class="strength-bar"></div>
            <div class="strength-bar"></div>
            <div class="strength-bar"></div>
        </div>
        <div class="strength-label"></div>
    </div>
    <div class="form-group">
        <label class="form-label">Confirmar password</label>
        <input class="form-input" id="confirm-password" type="password" placeholder="Repete a password"
               onkeydown="if(event.key==='Enter') doReset()">
    </div>
    <button class="submit-btn" id="reset-btn" onclick="doReset()">Guardar Nova Password</button>
    <div style="text-align:center;margin-top:16px">
        <a href="login.html" class="back-link">← Voltar ao login</a>
    </div>`;
    }

    // ── Render: inválido ───────────────────────────────────────
    function renderInvalido(titulo, texto) {
        document.getElementById('card-body').innerHTML = `
    <div class="state-invalid">
        <div class="state-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <line x1="15" y1="9" x2="9" y2="15"/>
                <line x1="9" y1="9" x2="15" y2="15"/>
            </svg>
        </div>
        <div class="state-title">${titulo}</div>
        <div class="state-txt">${texto}</div>
        <a href="login.html" class="back-link">← Voltar ao login</a>
    </div>`;
    }

    // ── Render: sucesso ────────────────────────────────────────
    function renderSucesso() {
        document.getElementById('card-body').innerHTML = `
    <div class="state-success">
        <div class="state-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
        </div>
        <div class="state-title">Password alterada!</div>
        <div class="state-txt">A tua password foi actualizada com sucesso.<br>Podes fazer login com a nova password.</div>
        <a href="login.html" class="back-link">Ir para o login →</a>
    </div>`;
        // Redireciona automaticamente após 3s
        setTimeout(() => { window.location.href = 'login.html'; }, 3000);
    }

    // ── Submit ─────────────────────────────────────────────────
    async function doReset() {
        const password  = document.getElementById('new-password').value;
        const password2 = document.getElementById('confirm-password').value;
        const msgEl     = document.getElementById('reset-msg');
        msgEl.className = 'msg-box';

        // Validações client-side
        if (password.length < 6) {
            document.getElementById('new-password').classList.add('error');
            msgEl.textContent = 'A password deve ter pelo menos 6 caracteres.';
            msgEl.className = 'msg-box error';
            return;
        }
        if (password !== password2) {
            document.getElementById('confirm-password').classList.add('error');
            msgEl.textContent = 'As passwords não coincidem.';
            msgEl.className = 'msg-box error';
            return;
        }

        const btn = document.getElementById('reset-btn');
        btn.disabled = true; btn.textContent = 'A guardar...';

        try {
            const res = await fetch('/api/auth/reset-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token, password }),
            });
            const data = await res.json();

            if (!res.ok) {
                // Token expirado ou já usado — mostra estado de erro
                if (res.status === 400 && (data.error?.includes('expirou') || data.error?.includes('inválido'))) {
                    renderInvalido('Link expirado', data.error + ' Clica abaixo para pedir um novo link.');
                    return;
                }
                throw new Error(data.error || 'Erro ao alterar password.');
            }

            renderSucesso();

        } catch(e) {
            msgEl.textContent = e.message || 'Erro ao guardar. Tenta novamente.';
            msgEl.className = 'msg-box error';
            btn.disabled = false; btn.textContent = 'Guardar Nova Password';
        }
    }
</script>
</body>
</html>
