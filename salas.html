<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Salas ‚Äî Zion Church Lisboa</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
<script src="config.js"></script>
<script src="auth.js"></script>
<style>
:root{
  --gold:#B8922A;--gold-light:#D4A843;--gold-dark:#8B6914;
  --border:rgba(184,146,42,0.22);--bg-page:#F5EFE4;--bg-card:#FFFFFF;
  --bg-input:#FAF7F2;--bg-footer:#F0E8D8;--text-main:#1A1410;
  --text-muted:#7A6A52;--text-faint:#A89878;
  --shadow:0 8px 40px rgba(100,70,20,0.13);
  --green:#2e7d32;--green-bg:rgba(46,125,50,0.08);--green-border:rgba(46,125,50,0.25);
  --red:#c0392b;--red-bg:rgba(192,57,43,0.08);--red-border:rgba(192,57,43,0.25);
  --orange:#e65100;--orange-bg:rgba(230,81,0,0.08);--orange-border:rgba(230,81,0,0.25);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;background:var(--bg-page);font-family:'Lato',sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 15% 15%,rgba(201,168,76,0.09) 0%,transparent 55%),radial-gradient(ellipse at 85% 85%,rgba(201,168,76,0.06) 0%,transparent 55%);pointer-events:none}
.page-wrapper{position:relative;z-index:1;display:flex;flex-direction:column;width:640px;max-width:96vw;height:96vh;max-height:900px;background:var(--bg-card);border-radius:16px;box-shadow:var(--shadow),0 0 0 1px var(--border);overflow:hidden}
.banner{width:100%;position:relative;background:#111;flex-shrink:0}
.banner img{width:100%;height:110px;object-fit:cover;display:block}
.banner-fallback{display:none;width:100%;height:110px;background:linear-gradient(135deg,#0d0d0d 0%,#1c1408 50%,#0d0d0d 100%);align-items:center;justify-content:center;flex-direction:column;gap:8px}
.banner-fallback.show{display:flex}
.banner-title{font-family:'Cinzel',serif;color:#C9A84C;font-size:26px;font-weight:700;letter-spacing:10px}
.banner-sub{color:rgba(201,168,76,0.6);font-size:10px;letter-spacing:4px;text-transform:uppercase}
.banner-overlay{position:absolute;bottom:0;left:0;right:0;height:55px;background:linear-gradient(to top,rgba(255,255,255,0.97),transparent)}
.banner-nav{position:absolute;bottom:10px;left:0;right:0;display:flex;align-items:center;justify-content:space-between;padding:0 16px}
.back-btn{display:flex;align-items:center;gap:6px;background:rgba(255,255,255,0.92);border:1px solid var(--border);border-radius:20px;padding:5px 14px;font-family:'Cinzel',serif;font-size:10px;letter-spacing:1.5px;color:var(--gold-dark);text-decoration:none;backdrop-filter:blur(8px);transition:all 0.2s}
.page-badge{font-family:'Cinzel',serif;font-size:10px;letter-spacing:2px;color:var(--gold);text-transform:uppercase;background:rgba(255,255,255,0.92);border:1px solid var(--border);border-radius:20px;padding:5px 14px;backdrop-filter:blur(8px)}
.gold-line{height:2px;background:linear-gradient(90deg,transparent,var(--gold-light),transparent);flex-shrink:0;opacity:0.5}
.tab-bar{display:flex;background:var(--bg-input);border-bottom:1px solid var(--border);flex-shrink:0}
.tab-btn{flex:1;padding:11px;font-family:'Cinzel',serif;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--text-faint);background:none;border:none;border-bottom:2px solid transparent;cursor:pointer;transition:all 0.2s}
.tab-btn.active{color:var(--gold);border-bottom-color:var(--gold)}
.content{flex:1;overflow-y:auto;background:var(--bg-input)}
.content::-webkit-scrollbar{width:4px}
.content::-webkit-scrollbar-thumb{background:rgba(184,146,42,0.25);border-radius:2px}
/* User card */
.user-card{display:flex;align-items:center;gap:14px;background:linear-gradient(135deg,rgba(201,168,76,0.1),rgba(201,168,76,0.03));border:1px solid rgba(184,146,42,0.35);border-radius:12px;padding:14px 16px;margin:14px 16px 0;animation:fadeUp 0.3s ease both}
.user-avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--gold-dark),var(--gold-light));display:flex;align-items:center;justify-content:center;font-family:'Cinzel',serif;font-size:15px;color:#fff;font-weight:700;flex-shrink:0}
.user-info{flex:1}
.user-name{font-family:'Cinzel',serif;font-size:13px;font-weight:600;color:var(--gold-dark)}
.user-tipo{display:inline-block;margin-top:3px;padding:2px 9px;border-radius:20px;font-family:'Cinzel',serif;font-size:8px;letter-spacing:1.5px;text-transform:uppercase;color:#fff}
.tipo-visitante{background:rgba(100,130,200,0.7)}.tipo-membro{background:rgba(139,105,20,0.8)}.tipo-admin{background:rgba(180,50,50,0.8)}
.logout-btn{display:flex;align-items:center;gap:6px;padding:6px 11px;border-radius:8px;border:1px solid rgba(220,80,60,0.3);background:rgba(220,80,60,0.06);color:#c0392b;font-family:'Cinzel',serif;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;cursor:pointer;transition:all 0.2s;flex-shrink:0}
.logout-btn:hover{background:rgba(220,80,60,0.12);border-color:rgba(220,80,60,0.5)}
/* Salas */
.section-label{font-family:'Cinzel',serif;font-size:10px;letter-spacing:3px;text-transform:uppercase;color:var(--text-faint);padding:14px 16px 8px}
.espaco-title{font-family:'Cinzel',serif;font-size:11px;letter-spacing:2px;text-transform:uppercase;color:var(--gold-dark);padding:10px 16px 6px;border-top:1px solid var(--border)}
.salas-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:0 16px 10px}
.sala-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;overflow:hidden;cursor:pointer;transition:all 0.25s;animation:fadeUp 0.4s ease both}
.sala-card:not(.ocupada):hover{box-shadow:0 4px 20px rgba(100,70,20,0.14);border-color:var(--gold-light);transform:translateY(-2px)}
.sala-foto{width:100%;height:90px;object-fit:cover;display:block}
.sala-foto-ph{width:100%;height:90px;background:linear-gradient(135deg,rgba(201,168,76,0.12),rgba(201,168,76,0.04));display:flex;align-items:center;justify-content:center;font-size:30px;color:var(--gold-light)}
.sala-info{padding:10px}
.sala-nome{font-family:'Cinzel',serif;font-size:11px;font-weight:600;color:var(--text-main);margin-bottom:3px}
.sala-cap{font-size:11px;color:var(--text-faint);margin-bottom:5px}
.sala-tags{display:flex;flex-wrap:wrap;gap:3px;margin-bottom:6px}
.sala-tag{font-size:9px;padding:2px 6px;border-radius:10px;background:rgba(184,146,42,0.1);color:var(--gold-dark)}
.sala-status{display:flex;align-items:center;gap:5px;font-size:10px;font-weight:700}
.sala-dot{width:6px;height:6px;border-radius:50%}
.livre .sala-dot{background:var(--green)}.livre{color:var(--green)}
.ocupada-st .sala-dot{background:var(--red)}.ocupada-st{color:var(--red)}
.sala-btn{width:100%;margin-top:7px;padding:7px;border-radius:7px;border:none;background:linear-gradient(135deg,var(--gold-dark),var(--gold-light));color:#fff;font-family:'Cinzel',serif;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;cursor:pointer;transition:all 0.2s}
.sala-btn:hover{filter:brightness(1.1)}
.sala-btn:disabled{background:rgba(184,146,42,0.15);color:var(--text-faint);cursor:not-allowed}
/* Agenda */
.agenda-header{padding:14px 16px 8px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.date-nav-btn{width:30px;height:30px;border-radius:50%;border:1px solid var(--border);background:var(--bg-card);color:var(--gold);font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.agenda-date-label{font-family:'Cinzel',serif;font-size:12px;color:var(--text-main);flex:1;text-align:center;text-transform:capitalize}
.agenda-date-input{border:1px solid var(--border);border-radius:8px;padding:5px 10px;font-size:12px;color:var(--text-main);background:var(--bg-card);outline:none}
.agenda-date-input:focus{border-color:var(--gold-light)}
.agenda-list{padding:0 16px 16px}
.agenda-esp-title{font-family:'Cinzel',serif;font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--gold-dark);margin:12px 0 6px;padding-bottom:4px;border-bottom:1px solid var(--border)}
.agenda-item{background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:10px 12px;margin-bottom:6px;display:flex;align-items:flex-start;gap:10px;animation:fadeUp 0.3s ease both}
.a-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;margin-top:5px}
.a-dot.aprovado{background:var(--green)}.a-dot.pendente{background:var(--orange)}.a-dot.recusado{background:var(--red)}
.a-info{flex:1}
.a-sala{font-family:'Cinzel',serif;font-size:11px;color:var(--text-main);font-weight:600}
.a-hora{font-size:12px;color:var(--gold);margin:2px 0}
.a-quem{font-size:11px;color:var(--text-muted)}
.a-titulo{font-size:11px;color:var(--text-faint);font-style:italic}
.a-badge{font-family:'Cinzel',serif;font-size:8px;letter-spacing:1px;text-transform:uppercase;padding:2px 8px;border-radius:10px;flex-shrink:0}
.a-badge.aprovado{background:var(--green-bg);color:var(--green);border:1px solid var(--green-border)}
.a-badge.pendente{background:var(--orange-bg);color:var(--orange);border:1px solid var(--orange-border)}
.a-badge.recusado{background:var(--red-bg);color:var(--red);border:1px solid var(--red-border)}
.empty{text-align:center;padding:32px;color:var(--text-faint);font-size:13px}
.empty-icon{font-size:36px;margin-bottom:10px;opacity:0.4}
/* Modal */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.52);z-index:200;display:flex;align-items:flex-end;justify-content:center;backdrop-filter:blur(4px);animation:fadeIn 0.2s ease}
.overlay.hidden{display:none}
.modal{width:640px;max-width:100vw;background:var(--bg-card);border-radius:16px 16px 0 0;max-height:90vh;overflow-y:auto;animation:slideUp 0.3s ease}
.modal::-webkit-scrollbar{width:4px}
.modal::-webkit-scrollbar-thumb{background:rgba(184,146,42,0.25);border-radius:2px}
.modal-head{padding:15px 18px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--bg-card);z-index:1}
.modal-head-title{font-family:'Cinzel',serif;font-size:13px;color:var(--gold-dark)}
.modal-x{width:28px;height:28px;border-radius:50%;border:1px solid var(--border);background:none;color:var(--text-faint);font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.modal-x:hover{border-color:var(--red);color:var(--red)}
.modal-body{padding:16px 18px}
.sala-preview{display:flex;align-items:center;gap:12px;background:var(--bg-input);border-radius:10px;padding:11px;margin-bottom:16px;border:1px solid var(--border)}
.sala-preview-foto{width:58px;height:42px;border-radius:7px;object-fit:cover;flex-shrink:0}
.sala-preview-ph{width:58px;height:42px;border-radius:7px;background:rgba(184,146,42,0.1);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.sala-preview-nome{font-family:'Cinzel',serif;font-size:13px;color:var(--gold-dark)}
.sala-preview-esp{font-size:11px;color:var(--text-faint);margin-top:2px}
.form-group{margin-bottom:13px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.form-label{display:block;font-family:'Cinzel',serif;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--text-faint);margin-bottom:6px}
.form-input,.form-select,.form-textarea{width:100%;background:var(--bg-input);border:1px solid var(--border);border-radius:8px;padding:10px 12px;color:var(--text-main);font-family:'Lato',sans-serif;font-size:14px;outline:none;transition:border-color 0.2s,box-shadow 0.2s}
.form-input::placeholder,.form-textarea::placeholder{color:var(--text-faint)}
.form-input:focus,.form-select:focus,.form-textarea:focus{border-color:var(--gold-light);box-shadow:0 0 0 3px rgba(201,168,76,0.1)}
.form-textarea{resize:none;height:68px;line-height:1.5}
.form-select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23A89878' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;padding-right:28px}
.hora-row{display:flex;gap:6px;align-items:center}
.hora-sep{color:var(--text-faint);font-size:11px;flex-shrink:0}
.aviso-box{background:var(--orange-bg);border:1px solid var(--orange-border);border-radius:8px;padding:11px 12px;margin-bottom:13px;display:flex;gap:10px}
.aviso-icon{font-size:17px;flex-shrink:0;margin-top:1px}
.aviso-txt{font-size:12px;color:var(--orange);line-height:1.6}
.aviso-check{display:flex;align-items:center;gap:7px;margin-top:7px;cursor:pointer}
.aviso-check input{width:14px;height:14px;accent-color:var(--gold);cursor:pointer}
.aviso-check span{font-size:12px;color:var(--text-muted)}
.conflito-box{background:var(--red-bg);border:1px solid var(--red-border);border-radius:8px;padding:9px 12px;margin-bottom:13px;font-size:12px;color:var(--red);display:none}
.msg-box{padding:10px 13px;border-radius:8px;font-size:13px;margin-bottom:13px;display:none}
.msg-box.error{background:var(--red-bg);border:1px solid var(--red-border);color:var(--red);display:block}
.msg-box.success{background:var(--green-bg);border:1px solid var(--green-border);color:var(--green);display:block}
.submit-btn{width:100%;padding:13px;background:linear-gradient(135deg,var(--gold-dark),var(--gold-light));border:none;border-radius:8px;color:#fff;font-family:'Cinzel',serif;font-size:11px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:all 0.2s;box-shadow:0 2px 8px rgba(139,105,20,0.25)}
.submit-btn:hover{filter:brightness(1.08)}
.submit-btn:disabled{opacity:0.5;cursor:not-allowed}
.loading{text-align:center;padding:36px;color:var(--text-faint);font-size:13px}
.spin{width:26px;height:26px;border:2px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 10px}
.footer{background:var(--bg-footer);border-top:1px solid var(--border);padding:10px 18px;flex-shrink:0}
.footer-links{display:flex;justify-content:center;gap:12px;margin-bottom:8px}
.footer-link{display:flex;align-items:center;gap:5px;color:var(--gold);text-decoration:none;font-size:10px;letter-spacing:1.2px;text-transform:uppercase;font-family:'Cinzel',serif;padding:4px 10px;border-radius:4px;border:1px solid var(--border);background:rgba(255,255,255,0.6)}
.footer-link svg{width:12px;height:12px}
.footer-div{height:1px;background:var(--border);margin:8px 0}
.footer-copy{color:var(--text-muted);font-size:10px;letter-spacing:1px;text-transform:uppercase;font-family:'Cinzel',serif;text-align:center}
.footer-addr{color:var(--text-faint);font-size:10px;text-align:center;margin-top:2px}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<div class="page-wrapper">
  <div class="banner">
    <img src="banner zion.jpg" alt="Zion Lisboa" onerror="this.style.display='none';document.querySelector('.banner-fallback').classList.add('show');">
    <div class="banner-fallback"><div class="banner-title">ZION</div><div class="banner-sub">Lisboa ¬∑ Portugal</div></div>
    <div class="banner-overlay"></div>
    <div class="banner-nav">
      <a href="index.html" class="back-btn">‚Üê In√≠cio</a>
      <span class="page-badge">Salas</span>
    </div>
  </div>
  <div class="gold-line"></div>
  <div class="tab-bar">
    <button class="tab-btn active" onclick="switchTab('salas')">üèõÔ∏è Salas</button>
    <button class="tab-btn" onclick="switchTab('agenda')">üìÖ Agenda</button>
  </div>
  <div class="content" id="main-content">
    <div class="loading"><div class="spin"></div>A carregar salas...</div>
  </div>
  <div class="footer">
    <div class="footer-links">
      <a class="footer-link" href="https://zionchurch.org.br/" target="_blank"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>Site Oficial</a>
      <a class="footer-link" href="https://www.instagram.com/zionlisboa/" target="_blank"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"/></svg>@ZionLisboa</a>
    </div>
    <div class="footer-div"></div>
    <div class="footer-copy">¬© 2026 Zion Lisboa ‚Äî Todos os direitos reservados</div>
    <div class="footer-addr">Rua do Centro Cultural, 11 ¬∑ 1700-036 Alvalade ¬∑ Lisboa, Portugal</div>
  </div>
</div>

<!-- Modal -->
<div class="overlay hidden" id="overlay" onclick="closeOutside(event)">
  <div class="modal" id="modal">
    <div class="modal-head">
      <div class="modal-head-title" id="modal-title">Agendar Sala</div>
      <button class="modal-x" onclick="closeModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="sala-preview">
        <img class="sala-preview-foto" id="m-foto" src="" alt="" style="display:none">
        <div class="sala-preview-ph" id="m-foto-ph">üèõÔ∏è</div>
        <div>
          <div class="sala-preview-nome" id="m-nome"></div>
          <div class="sala-preview-esp" id="m-esp"></div>
          <div style="display:flex;gap:3px;flex-wrap:wrap;margin-top:4px" id="m-tags"></div>
        </div>
      </div>
      <div class="msg-box" id="m-msg"></div>
      <div class="conflito-box" id="conflito-box">‚ö†Ô∏è J√° existe um agendamento neste hor√°rio. Escolhe outro hor√°rio.</div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Nome completo</label>
          <input class="form-input" id="f-nome" type="text" placeholder="O teu nome">
        </div>
        <div class="form-group">
          <label class="form-label">Telefone</label>
          <input class="form-input" id="f-tel" type="tel" placeholder="+351 9XX XXX XXX">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Email de contacto</label>
        <input class="form-input" id="f-email" type="email" placeholder="o.teu@email.com">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Data</label>
          <input class="form-input" id="f-data" type="date" onchange="checkConflito()">
        </div>
        <div class="form-group">
          <label class="form-label">Hor√°rio</label>
          <div class="hora-row">
            <select class="form-select" id="f-ini" onchange="checkConflito()" style="flex:1"></select>
            <span class="hora-sep">‚Üí</span>
            <select class="form-select" id="f-fim" onchange="checkConflito()" style="flex:1"></select>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Motivo do agendamento</label>
        <textarea class="form-textarea" id="f-motivo" placeholder="Descreve o motivo..."></textarea>
      </div>
      <div class="aviso-box">
        <div class="aviso-icon">üßπ</div>
        <div>
          <div class="aviso-txt">Entregue a sala <strong>limpa e organizada</strong>, tal como a encontrou. Obrigado! üôè</div>
          <label class="aviso-check">
            <input type="checkbox" id="f-aviso">
            <span>Li e aceito esta condi√ß√£o</span>
          </label>
        </div>
      </div>
      <button class="submit-btn" id="submit-btn" onclick="submeter()">Enviar Pedido de Agendamento</button>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
ZionAuth.protect();
const currentUser = ZionAuth.getUser();

// ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SUPA_URL = window.SUPABASE_URL || '';
const SUPA_KEY = window.SUPABASE_ANON_KEY || '';

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let salas = [], agendHoje = [], salaAtiva = null, abaAtiva = 'salas';
let agendaData = new Date();

// ‚îÄ‚îÄ RENDER USER CARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderUserCard() {
  const initials  = (currentUser.nome||'U').split(' ').map(w=>w[0]).slice(0,2).join('').toUpperCase();
  const tipoLabel = {visitante:'Visitante', membro:'Membro', admin:'Administrador'};
  const tipoClass = {visitante:'tipo-visitante', membro:'tipo-membro', admin:'tipo-admin'};

  const card = document.createElement('div');
  card.className = 'user-card';
  card.innerHTML = `
    <div class="user-avatar">${initials}</div>
    <div class="user-info">
      <div class="user-name">${currentUser.nome}</div>
      <span class="user-tipo ${tipoClass[currentUser.tipo]||'tipo-visitante'}">${tipoLabel[currentUser.tipo]||currentUser.tipo}</span>
    </div>
    <button class="logout-btn" onclick="ZionAuth.logout()">
      <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
      Sair
    </button>`;

  // Insere antes do main-content
  const content = document.querySelector('.content');
  content.insertBefore(card, content.firstChild);
}

// ‚îÄ‚îÄ SUPABASE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function sb(path, opts = {}) {
  const r = await fetch(`${SUPA_URL}/rest/v1/${path}`, {
    ...opts,
    headers: {
      'apikey': SUPA_KEY, 'Authorization': `Bearer ${SUPA_KEY}`,
      'Content-Type': 'application/json', 'Prefer': 'return=representation',
      ...opts.headers
    }
  });
  return r.json();
}

async function init() {
  renderUserCard();
  try {
    salas = await sb('salas?select=*&ativo=eq.true&order=espaco,nome');
    const hoje = toDateStr(new Date());
    const raw  = await sb(`sala_agendamentos?select=*&data_inicio=gte.${hoje}T00:00:00&data_inicio=lte.${hoje}T23:59:59&status=in.(aprovado,pendente)`);
    agendHoje  = Array.isArray(raw) ? raw : [];
    preencherHoras();
    renderSalas();
  } catch(e) {
    document.getElementById('main-content').innerHTML = '<div class="loading">‚ö†Ô∏è Erro ao carregar. Verifica a configura√ß√£o Supabase.</div>';
  }
}

function toDateStr(d) { return d.toISOString().split('T')[0]; }

function tags(s) {
  const t = [];
  if(s.tem_som) t.push('üîä Som');
  if(s.tem_iluminacao) t.push('üí° Luz');
  if(s.tem_projecao) t.push('üìΩ Proje√ß√£o');
  if(s.tem_mesas) t.push('ü™ë Mesas');
  else if(s.tem_cadeiras) t.push('ü™ë Cadeiras');
  return t.map(x=>`<span class="sala-tag">${x}</span>`).join('');
}

function isOcupada(id) {
  const agora = new Date();
  return agendHoje.some(a => a.sala_id === id && agora >= new Date(a.data_inicio) && agora <= new Date(a.data_fim));
}

function renderSalas() {
  const grupos = {};
  (Array.isArray(salas)?salas:[]).forEach(s => {
    const e = s.espaco||'Outros';
    if(!grupos[e]) grupos[e]=[];
    grupos[e].push(s);
  });

  let html = '<div class="section-label">Seleciona uma sala para agendar</div>';
  Object.entries(grupos).forEach(([esp, list]) => {
    html += `<div class="espaco-title">${esp}</div><div class="salas-grid">`;
    list.forEach((s, i) => {
      const oc  = isOcupada(s.id);
      const cap = s.capacidade ? `${s.capacidade} pessoas` : 'Capacidade a definir';
      html += `<div class="sala-card${oc?' ocupada':''}" style="animation-delay:${i*0.05}s">
        ${s.foto_url ? `<img class="sala-foto" src="${s.foto_url}" alt="${s.nome}" loading="lazy">` : `<div class="sala-foto-ph">üèõÔ∏è</div>`}
        <div class="sala-info">
          <div class="sala-nome">${s.nome}</div>
          <div class="sala-cap">${cap}</div>
          <div class="sala-tags">${tags(s)}</div>
          <div class="sala-status ${oc?'ocupada-st':'livre'}">
            <div class="sala-dot"></div>${oc?'Ocupada agora':'Dispon√≠vel'}
          </div>
          <button class="sala-btn" ${oc?'disabled':''} onclick="abrirModal('${s.id}')">
            ${oc?'Indispon√≠vel':'Agendar'}
          </button>
        </div>
      </div>`;
    });
    html += '</div>';
  });
  document.getElementById('main-content').innerHTML = html;
}

async function renderAgenda() {
  const ds    = toDateStr(agendaData);
  const label = agendaData.toLocaleDateString('pt-PT',{weekday:'long',day:'numeric',month:'long'});
  document.getElementById('main-content').innerHTML = `
    <div class="agenda-header">
      <button class="date-nav-btn" onclick="mudarData(-1)">‚Äπ</button>
      <div class="agenda-date-label">${label}</div>
      <button class="date-nav-btn" onclick="mudarData(1)">‚Ä∫</button>
      <input class="agenda-date-input" type="date" value="${ds}" onchange="setData(this.value)">
    </div>
    <div class="agenda-list" id="agenda-list"><div class="loading"><div class="spin"></div>A carregar...</div></div>`;
  await loadAgenda(ds);
}

async function loadAgenda(ds) {
  const el = document.getElementById('agenda-list');
  if(!el) return;
  try {
    const data = await sb(`sala_agendamentos?select=*&data_inicio=gte.${ds}T00:00:00&data_inicio=lte.${ds}T23:59:59&order=data_inicio`);
    if(!data||!data.length){
      el.innerHTML='<div class="empty"><div class="empty-icon">üìÖ</div>Nenhum agendamento para este dia.</div>';
      return;
    }
    const grupos = {};
    data.forEach(a => {
      const s = salas.find(x=>x.id===a.sala_id);
      const e = s?.espaco||'Outros';
      if(!grupos[e]) grupos[e]=[];
      grupos[e].push({...a,sala:s});
    });
    let html='';
    Object.entries(grupos).forEach(([esp,items])=>{
      html+=`<div class="agenda-esp-title">${esp}</div>`;
      items.forEach((a,i)=>{
        const ini = new Date(a.data_inicio);
        const fim = new Date(a.data_fim);
        const hi  = ini.toLocaleTimeString('pt-PT',{hour:'2-digit',minute:'2-digit'});
        const hf  = fim.toLocaleTimeString('pt-PT',{hour:'2-digit',minute:'2-digit'});
        html+=`<div class="agenda-item" style="animation-delay:${i*0.04}s">
          <div class="a-dot ${a.status}"></div>
          <div class="a-info">
            <div class="a-sala">${a.sala?.nome||'Sala'}</div>
            <div class="a-hora">üïê ${hi} ‚Üí ${hf}</div>
            <div class="a-quem">üë§ ${a.solicitante_nome||a.titulo||'‚Äî'}</div>
            <div class="a-titulo">${a.titulo||''}</div>
          </div>
          <span class="a-badge ${a.status}">${a.status}</span>
        </div>`;
      });
    });
    el.innerHTML = html;
  } catch(e) {
    el.innerHTML='<div class="empty">‚ö†Ô∏è Erro ao carregar agenda.</div>';
  }
}

function mudarData(d) { agendaData.setDate(agendaData.getDate()+d); renderAgenda(); }
function setData(v)   { agendaData = new Date(v+'T12:00:00'); renderAgenda(); }

function switchTab(tab) {
  abaAtiva = tab;
  document.querySelectorAll('.tab-btn').forEach((b,i)=>b.classList.toggle('active',(i===0&&tab==='salas')||(i===1&&tab==='agenda')));
  tab==='salas' ? renderSalas() : renderAgenda();
}

function abrirModal(id) {
  salaAtiva = salas.find(s=>s.id===id);
  if(!salaAtiva) return;
  document.getElementById('modal-title').textContent = `Agendar ‚Äî ${salaAtiva.nome}`;
  document.getElementById('m-nome').textContent = salaAtiva.nome;
  document.getElementById('m-esp').textContent  = salaAtiva.espaco||'';
  document.getElementById('m-tags').innerHTML   = tags(salaAtiva);
  const foto = document.getElementById('m-foto');
  const ph   = document.getElementById('m-foto-ph');
  if(salaAtiva.foto_url){ foto.src=salaAtiva.foto_url; foto.style.display=''; ph.style.display='none'; }
  else { foto.style.display='none'; ph.style.display=''; }
  const hoje = toDateStr(new Date());
  document.getElementById('f-data').min   = hoje;
  document.getElementById('f-data').value = hoje;
  ['f-nome','f-tel','f-email','f-motivo'].forEach(x=>document.getElementById(x).value='');
  // Pr√©-preenche com dados do utilizador logado
  document.getElementById('f-nome').value  = currentUser.nome  || '';
  document.getElementById('f-email').value = currentUser.email || '';
  document.getElementById('f-aviso').checked = false;
  document.getElementById('conflito-box').style.display = 'none';
  document.getElementById('m-msg').className = 'msg-box';
  document.getElementById('overlay').classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}

function closeModal()       { document.getElementById('overlay').classList.add('hidden'); document.body.style.overflow=''; salaAtiva=null; }
function closeOutside(e)    { if(e.target===document.getElementById('overlay')) closeModal(); }

function preencherHoras() {
  const si = document.getElementById('f-ini');
  const sf = document.getElementById('f-fim');
  si.innerHTML = '<option value="">In√≠cio</option>';
  sf.innerHTML = '<option value="">Fim</option>';
  for(let h=6;h<=23;h++){
    const t=`${String(h).padStart(2,'0')}:00`;
    si.add(new Option(t,t));
    sf.add(new Option(t,t));
  }
  sf.add(new Option('00:00','00:00'));
}

async function checkConflito() {
  if(!salaAtiva) return;
  const data = document.getElementById('f-data').value;
  const ini  = document.getElementById('f-ini').value;
  const fim  = document.getElementById('f-fim').value;
  const box  = document.getElementById('conflito-box');
  if(!data||!ini||!fim){ box.style.display='none'; return; }
  const c = await sb(`sala_agendamentos?sala_id=eq.${salaAtiva.id}&status=in.(aprovado,pendente)&data_inicio=lt.${data}T${fim}:00&data_fim=gt.${data}T${ini}:00`);
  box.style.display = (c&&c.length>0) ? 'block' : 'none';
}

async function submeter() {
  const nome  = document.getElementById('f-nome').value.trim();
  const tel   = document.getElementById('f-tel').value.trim();
  const email = document.getElementById('f-email').value.trim();
  const data  = document.getElementById('f-data').value;
  const ini   = document.getElementById('f-ini').value;
  const fim   = document.getElementById('f-fim').value;
  const mot   = document.getElementById('f-motivo').value.trim();
  const aviso = document.getElementById('f-aviso').checked;

  if(!nome)      return msg('Nome obrigat√≥rio.','error');
  if(!email)     return msg('Email obrigat√≥rio.','error');
  if(!data)      return msg('Data obrigat√≥ria.','error');
  if(!ini||!fim) return msg('Hor√°rio obrigat√≥rio.','error');
  if(fim<=ini)   return msg('Hora de fim deve ser depois do in√≠cio.','error');
  if(!aviso)     return msg('Confirma que entregas a sala limpa e organizada.','error');
  if(document.getElementById('conflito-box').style.display==='block')
    return msg('Existe conflito de hor√°rio. Escolhe outro.','error');

  const btn = document.getElementById('submit-btn');
  btn.disabled=true; btn.textContent='A enviar...';

  try {
    await sb('sala_agendamentos', {
      method:'POST',
      body: JSON.stringify({
        sala_id:            salaAtiva.id,
        solicitante_id:     currentUser.id,
        solicitante_nome:   nome,
        solicitante_tel:    tel,
        solicitante_email:  email,
        titulo:             mot||`Pedido de ${nome}`,
        descricao:          mot,
        data_inicio:        `${data}T${ini}:00`,
        data_fim:           `${data}T${fim}:00`,
        status:             'pendente',
        aviso_lido:         true,
      })
    });
    msg('‚úÖ Pedido enviado! Aguarda aprova√ß√£o ‚Äî receber√°s confirma√ß√£o por email.','success');
    btn.textContent = 'Pedido Enviado ‚úì';
    setTimeout(()=>{ closeModal(); init(); }, 2500);
  } catch(e) {
    msg('Erro ao enviar. Tenta novamente.','error');
    btn.disabled=false; btn.textContent='Enviar Pedido de Agendamento';
  }
}

function msg(txt, tipo) {
  const el = document.getElementById('m-msg');
  el.textContent=txt; el.className=`msg-box ${tipo}`;
  el.scrollIntoView({behavior:'smooth',block:'nearest'});
}

document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeModal(); });

init();
</script>
</body>
</html>
